<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"><title>migrate.c source code [linux-5.3.1/mm/migrate.c] - Woboq Code Browser</title>
<link rel="stylesheet" href="../../../data/qtcreator.css" title="QtCreator"/>
<link rel="alternate stylesheet" href="../../../data/kdevelop.css" title="KDevelop"/>
<script type="text/javascript" src="../../../data/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../../data/jquery/jquery-ui.min.js"></script>
<script>var file = 'linux-5.3.1/mm/migrate.c'; var root_path = '../..'; var data_path = '../../../data'; var ecma_script_api_version = 2;</script>
<script src='../../../data/codebrowser.js'></script>
</head>
<body><div id='header'><h1 id='breadcrumb'><span>Browse the source code of </span><a href='..'>linux-5.3.1</a>/<a href='./'>mm</a>/<a href='migrate.c.html'>migrate.c</a></h1></div>
<hr/><div id='content'><table class="code">
<tr><th id="1">1</th><td><i>// SPDX-License-Identifier: GPL-2.0</i></td></tr>
<tr><th id="2">2</th><td><i>/*</i></td></tr>
<tr><th id="3">3</th><td><i> * Memory Migration functionality - linux/mm/migrate.c</i></td></tr>
<tr><th id="4">4</th><td><i> *</i></td></tr>
<tr><th id="5">5</th><td><i> * Copyright (C) 2006 Silicon Graphics, Inc., Christoph Lameter</i></td></tr>
<tr><th id="6">6</th><td><i> *</i></td></tr>
<tr><th id="7">7</th><td><i> * Page migration was first developed in the context of the memory hotplug</i></td></tr>
<tr><th id="8">8</th><td><i> * project. The main authors of the migration code are:</i></td></tr>
<tr><th id="9">9</th><td><i> *</i></td></tr>
<tr><th id="10">10</th><td><i> * IWAMOTO Toshihiro &lt;iwamoto@valinux.co.jp&gt;</i></td></tr>
<tr><th id="11">11</th><td><i> * Hirokazu Takahashi &lt;taka@valinux.co.jp&gt;</i></td></tr>
<tr><th id="12">12</th><td><i> * Dave Hansen &lt;haveblue@us.ibm.com&gt;</i></td></tr>
<tr><th id="13">13</th><td><i> * Christoph Lameter</i></td></tr>
<tr><th id="14">14</th><td><i> */</i></td></tr>
<tr><th id="15">15</th><td></td></tr>
<tr><th id="16">16</th><td><u>#include <a href="../include/linux/migrate.h.html">&lt;linux/migrate.h&gt;</a></u></td></tr>
<tr><th id="17">17</th><td><u>#include <a href="../include/linux/export.h.html">&lt;linux/export.h&gt;</a></u></td></tr>
<tr><th id="18">18</th><td><u>#include <a href="../include/linux/swap.h.html">&lt;linux/swap.h&gt;</a></u></td></tr>
<tr><th id="19">19</th><td><u>#include <a href="../include/linux/swapops.h.html">&lt;linux/swapops.h&gt;</a></u></td></tr>
<tr><th id="20">20</th><td><u>#include <a href="../include/linux/pagemap.h.html">&lt;linux/pagemap.h&gt;</a></u></td></tr>
<tr><th id="21">21</th><td><u>#include <a href="../include/linux/buffer_head.h.html">&lt;linux/buffer_head.h&gt;</a></u></td></tr>
<tr><th id="22">22</th><td><u>#include <a href="../include/linux/mm_inline.h.html">&lt;linux/mm_inline.h&gt;</a></u></td></tr>
<tr><th id="23">23</th><td><u>#include <a href="../include/linux/nsproxy.h.html">&lt;linux/nsproxy.h&gt;</a></u></td></tr>
<tr><th id="24">24</th><td><u>#include <a href="../include/linux/pagevec.h.html">&lt;linux/pagevec.h&gt;</a></u></td></tr>
<tr><th id="25">25</th><td><u>#include <a href="../include/linux/ksm.h.html">&lt;linux/ksm.h&gt;</a></u></td></tr>
<tr><th id="26">26</th><td><u>#include <a href="../include/linux/rmap.h.html">&lt;linux/rmap.h&gt;</a></u></td></tr>
<tr><th id="27">27</th><td><u>#include <a href="../include/linux/topology.h.html">&lt;linux/topology.h&gt;</a></u></td></tr>
<tr><th id="28">28</th><td><u>#include <a href="../include/linux/cpu.h.html">&lt;linux/cpu.h&gt;</a></u></td></tr>
<tr><th id="29">29</th><td><u>#include <a href="../include/linux/cpuset.h.html">&lt;linux/cpuset.h&gt;</a></u></td></tr>
<tr><th id="30">30</th><td><u>#include <a href="../include/linux/writeback.h.html">&lt;linux/writeback.h&gt;</a></u></td></tr>
<tr><th id="31">31</th><td><u>#include <a href="../include/linux/mempolicy.h.html">&lt;linux/mempolicy.h&gt;</a></u></td></tr>
<tr><th id="32">32</th><td><u>#include <a href="../include/linux/vmalloc.h.html">&lt;linux/vmalloc.h&gt;</a></u></td></tr>
<tr><th id="33">33</th><td><u>#include <a href="../include/linux/security.h.html">&lt;linux/security.h&gt;</a></u></td></tr>
<tr><th id="34">34</th><td><u>#include <a href="../include/linux/backing-dev.h.html">&lt;linux/backing-dev.h&gt;</a></u></td></tr>
<tr><th id="35">35</th><td><u>#include <a href="../include/linux/compaction.h.html">&lt;linux/compaction.h&gt;</a></u></td></tr>
<tr><th id="36">36</th><td><u>#include <a href="../include/linux/syscalls.h.html">&lt;linux/syscalls.h&gt;</a></u></td></tr>
<tr><th id="37">37</th><td><u>#include <a href="../include/linux/compat.h.html">&lt;linux/compat.h&gt;</a></u></td></tr>
<tr><th id="38">38</th><td><u>#include <a href="../include/linux/hugetlb.h.html">&lt;linux/hugetlb.h&gt;</a></u></td></tr>
<tr><th id="39">39</th><td><u>#include <a href="../include/linux/hugetlb_cgroup.h.html">&lt;linux/hugetlb_cgroup.h&gt;</a></u></td></tr>
<tr><th id="40">40</th><td><u>#include <a href="../include/linux/gfp.h.html">&lt;linux/gfp.h&gt;</a></u></td></tr>
<tr><th id="41">41</th><td><u>#include <a href="../include/linux/pfn_t.h.html">&lt;linux/pfn_t.h&gt;</a></u></td></tr>
<tr><th id="42">42</th><td><u>#include <a href="../include/linux/memremap.h.html">&lt;linux/memremap.h&gt;</a></u></td></tr>
<tr><th id="43">43</th><td><u>#include <a href="../include/linux/userfaultfd_k.h.html">&lt;linux/userfaultfd_k.h&gt;</a></u></td></tr>
<tr><th id="44">44</th><td><u>#include <a href="../include/linux/balloon_compaction.h.html">&lt;linux/balloon_compaction.h&gt;</a></u></td></tr>
<tr><th id="45">45</th><td><u>#include <a href="../include/linux/mmu_notifier.h.html">&lt;linux/mmu_notifier.h&gt;</a></u></td></tr>
<tr><th id="46">46</th><td><u>#include <a href="../include/linux/page_idle.h.html">&lt;linux/page_idle.h&gt;</a></u></td></tr>
<tr><th id="47">47</th><td><u>#include <a href="../include/linux/page_owner.h.html">&lt;linux/page_owner.h&gt;</a></u></td></tr>
<tr><th id="48">48</th><td><u>#include <a href="../include/linux/sched/mm.h.html">&lt;linux/sched/mm.h&gt;</a></u></td></tr>
<tr><th id="49">49</th><td><u>#include <a href="../include/linux/ptrace.h.html">&lt;linux/ptrace.h&gt;</a></u></td></tr>
<tr><th id="50">50</th><td></td></tr>
<tr><th id="51">51</th><td><u>#include <a href="../arch/x86/include/asm/tlbflush.h.html">&lt;asm/tlbflush.h&gt;</a></u></td></tr>
<tr><th id="52">52</th><td></td></tr>
<tr><th id="53">53</th><td><u>#define <dfn class="macro" id="_M/CREATE_TRACE_POINTS" data-ref="_M/CREATE_TRACE_POINTS">CREATE_TRACE_POINTS</dfn></u></td></tr>
<tr><th id="54">54</th><td><u>#include <a href="../include/trace/events/migrate.h.html">&lt;trace/events/migrate.h&gt;</a></u></td></tr>
<tr><th id="55">55</th><td></td></tr>
<tr><th id="56">56</th><td><u>#include <a href="internal.h.html">"internal.h"</a></u></td></tr>
<tr><th id="57">57</th><td></td></tr>
<tr><th id="58">58</th><td><i>/*</i></td></tr>
<tr><th id="59">59</th><td><i> * migrate_prep() needs to be called before we start compiling a list of pages</i></td></tr>
<tr><th id="60">60</th><td><i> * to be migrated using isolate_lru_page(). If scheduling work on other CPUs is</i></td></tr>
<tr><th id="61">61</th><td><i> * undesirable, use migrate_prep_local()</i></td></tr>
<tr><th id="62">62</th><td><i> */</i></td></tr>
<tr><th id="63">63</th><td><em>int</em> <dfn class="decl def fn" id="migrate_prep" title='migrate_prep' data-ref="migrate_prep" data-ref-filename="migrate_prep">migrate_prep</dfn>(<em>void</em>)</td></tr>
<tr><th id="64">64</th><td>{</td></tr>
<tr><th id="65">65</th><td>	<i>/*</i></td></tr>
<tr><th id="66">66</th><td><i>	 * Clear the LRU lists so pages can be isolated.</i></td></tr>
<tr><th id="67">67</th><td><i>	 * Note that pages may be moved off the LRU after we have</i></td></tr>
<tr><th id="68">68</th><td><i>	 * drained them. Those pages will fail to migrate like other</i></td></tr>
<tr><th id="69">69</th><td><i>	 * pages that may be busy.</i></td></tr>
<tr><th id="70">70</th><td><i>	 */</i></td></tr>
<tr><th id="71">71</th><td>	<a class="ref fn" href="../include/linux/swap.h.html#lru_add_drain_all" title='lru_add_drain_all' data-ref="lru_add_drain_all" data-ref-filename="lru_add_drain_all">lru_add_drain_all</a>();</td></tr>
<tr><th id="72">72</th><td></td></tr>
<tr><th id="73">73</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="74">74</th><td>}</td></tr>
<tr><th id="75">75</th><td></td></tr>
<tr><th id="76">76</th><td><i>/* Do the necessary work of migrate_prep but not if it involves other CPUs */</i></td></tr>
<tr><th id="77">77</th><td><em>int</em> <dfn class="decl def fn" id="migrate_prep_local" title='migrate_prep_local' data-ref="migrate_prep_local" data-ref-filename="migrate_prep_local">migrate_prep_local</dfn>(<em>void</em>)</td></tr>
<tr><th id="78">78</th><td>{</td></tr>
<tr><th id="79">79</th><td>	<a class="ref fn" href="../include/linux/swap.h.html#lru_add_drain" title='lru_add_drain' data-ref="lru_add_drain" data-ref-filename="lru_add_drain">lru_add_drain</a>();</td></tr>
<tr><th id="80">80</th><td></td></tr>
<tr><th id="81">81</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="82">82</th><td>}</td></tr>
<tr><th id="83">83</th><td></td></tr>
<tr><th id="84">84</th><td><em>int</em> <dfn class="decl def fn" id="isolate_movable_page" title='isolate_movable_page' data-ref="isolate_movable_page" data-ref-filename="isolate_movable_page">isolate_movable_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col3 decl" id="73page" title='page' data-type='struct page *' data-ref="73page" data-ref-filename="73page">page</dfn>, <a class="typedef" href="../include/linux/mmzone.h.html#isolate_mode_t" title='isolate_mode_t' data-type='unsigned int' data-ref="isolate_mode_t" data-ref-filename="isolate_mode_t">isolate_mode_t</a> <dfn class="local col4 decl" id="74mode" title='mode' data-type='isolate_mode_t' data-ref="74mode" data-ref-filename="74mode">mode</dfn>)</td></tr>
<tr><th id="85">85</th><td>{</td></tr>
<tr><th id="86">86</th><td>	<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col5 decl" id="75mapping" title='mapping' data-type='struct address_space *' data-ref="75mapping" data-ref-filename="75mapping">mapping</dfn>;</td></tr>
<tr><th id="87">87</th><td></td></tr>
<tr><th id="88">88</th><td>	<i>/*</i></td></tr>
<tr><th id="89">89</th><td><i>	 * Avoid burning cycles with pages that are yet under __free_pages(),</i></td></tr>
<tr><th id="90">90</th><td><i>	 * or just got freed under us.</i></td></tr>
<tr><th id="91">91</th><td><i>	 *</i></td></tr>
<tr><th id="92">92</th><td><i>	 * In case we 'win' a race for a movable page being freed under us and</i></td></tr>
<tr><th id="93">93</th><td><i>	 * raise its refcount preventing __free_pages() from doing its job</i></td></tr>
<tr><th id="94">94</th><td><i>	 * the put_page() at the end of this block will take care of</i></td></tr>
<tr><th id="95">95</th><td><i>	 * release this page, thus avoiding a nasty leakage.</i></td></tr>
<tr><th id="96">96</th><td><i>	 */</i></td></tr>
<tr><th id="97">97</th><td>	<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(!get_page_unless_zero(page)), 0)" data-ref="_M/unlikely">unlikely</a>(!<a class="ref fn" href="../include/linux/mm.h.html#get_page_unless_zero" title='get_page_unless_zero' data-ref="get_page_unless_zero" data-ref-filename="get_page_unless_zero">get_page_unless_zero</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>)))</td></tr>
<tr><th id="98">98</th><td>		<b>goto</b> <a class="lbl" href="#76out" data-ref="76out" data-ref-filename="76out">out</a>;</td></tr>
<tr><th id="99">99</th><td></td></tr>
<tr><th id="100">100</th><td>	<i>/*</i></td></tr>
<tr><th id="101">101</th><td><i>	 * Check PageMovable before holding a PG_lock because page's owner</i></td></tr>
<tr><th id="102">102</th><td><i>	 * assumes anybody doesn't touch PG_lock of newly allocated page</i></td></tr>
<tr><th id="103">103</th><td><i>	 * so unconditionally grabbing the lock ruins page's owner side.</i></td></tr>
<tr><th id="104">104</th><td><i>	 */</i></td></tr>
<tr><th id="105">105</th><td>	<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(!__PageMovable(page)), 0)" data-ref="_M/unlikely">unlikely</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>)))</td></tr>
<tr><th id="106">106</th><td>		<b>goto</b> <a class="lbl" href="#77out_putpage" data-ref="77out_putpage" data-ref-filename="77out_putpage">out_putpage</a>;</td></tr>
<tr><th id="107">107</th><td>	<i>/*</i></td></tr>
<tr><th id="108">108</th><td><i>	 * As movable pages are not isolated from LRU lists, concurrent</i></td></tr>
<tr><th id="109">109</th><td><i>	 * compaction threads can race against page migration functions</i></td></tr>
<tr><th id="110">110</th><td><i>	 * as well as race against the releasing a page.</i></td></tr>
<tr><th id="111">111</th><td><i>	 *</i></td></tr>
<tr><th id="112">112</th><td><i>	 * In order to avoid having an already isolated movable page</i></td></tr>
<tr><th id="113">113</th><td><i>	 * being (wrongly) re-isolated while it is under migration,</i></td></tr>
<tr><th id="114">114</th><td><i>	 * or to avoid attempting to isolate pages being released,</i></td></tr>
<tr><th id="115">115</th><td><i>	 * lets be sure we have the page lock</i></td></tr>
<tr><th id="116">116</th><td><i>	 * before proceeding with the movable page isolation steps.</i></td></tr>
<tr><th id="117">117</th><td><i>	 */</i></td></tr>
<tr><th id="118">118</th><td>	<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(!trylock_page(page)), 0)" data-ref="_M/unlikely">unlikely</a>(!<a class="ref fn" href="../include/linux/pagemap.h.html#trylock_page" title='trylock_page' data-ref="trylock_page" data-ref-filename="trylock_page">trylock_page</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>)))</td></tr>
<tr><th id="119">119</th><td>		<b>goto</b> <a class="lbl" href="#77out_putpage" data-ref="77out_putpage" data-ref-filename="77out_putpage">out_putpage</a>;</td></tr>
<tr><th id="120">120</th><td></td></tr>
<tr><th id="121">121</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/migrate.h.html#PageMovable" title='PageMovable' data-ref="PageMovable" data-ref-filename="PageMovable">PageMovable</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>) || <a class="ref fn" href="../include/linux/page-flags.h.html#769" title='PageIsolated' data-ref="PageIsolated" data-ref-filename="PageIsolated">PageIsolated</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>))</td></tr>
<tr><th id="122">122</th><td>		<b>goto</b> <a class="lbl" href="#78out_no_isolated" data-ref="78out_no_isolated" data-ref-filename="78out_no_isolated">out_no_isolated</a>;</td></tr>
<tr><th id="123">123</th><td></td></tr>
<tr><th id="124">124</th><td>	<a class="local col5 ref" href="#75mapping" title='mapping' data-ref="75mapping" data-ref-filename="75mapping">mapping</a> = <a class="ref fn" href="../include/linux/mm.h.html#page_mapping" title='page_mapping' data-ref="page_mapping" data-ref-filename="page_mapping">page_mapping</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>);</td></tr>
<tr><th id="125">125</th><td>	<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!mapping))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="local col5 ref" href="#75mapping" title='mapping' data-ref="75mapping" data-ref-filename="75mapping">mapping</a>, page);</td></tr>
<tr><th id="126">126</th><td></td></tr>
<tr><th id="127">127</th><td>	<b>if</b> (!<a class="local col5 ref" href="#75mapping" title='mapping' data-ref="75mapping" data-ref-filename="75mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::a_ops" title='address_space::a_ops' data-ref="address_space::a_ops" data-ref-filename="address_space..a_ops">a_ops</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space_operations::isolate_page" title='address_space_operations::isolate_page' data-ref="address_space_operations::isolate_page" data-ref-filename="address_space_operations..isolate_page">isolate_page</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>, <a class="local col4 ref" href="#74mode" title='mode' data-ref="74mode" data-ref-filename="74mode">mode</a>))</td></tr>
<tr><th id="128">128</th><td>		<b>goto</b> <a class="lbl" href="#78out_no_isolated" data-ref="78out_no_isolated" data-ref-filename="78out_no_isolated">out_no_isolated</a>;</td></tr>
<tr><th id="129">129</th><td></td></tr>
<tr><th id="130">130</th><td>	<i>/* Driver shouldn't use PG_isolated bit of page-&gt;flags */</i></td></tr>
<tr><th id="131">131</th><td>	<a class="macro" href="../include/asm-generic/bug.h.html#68" title="({ int __ret_warn_on = !!(PageIsolated(page)); if (__builtin_expect(!!(__ret_warn_on), 0)) do { do { asm volatile(&quot;1:\t&quot; &quot;.byte 0x0f, 0x0b&quot; &quot;\n&quot; &quot;.pushsection __bug_table,\&quot;aw\&quot;\n&quot; &quot;2:\t&quot; &quot;.long &quot; &quot;1b&quot; &quot; - 2b&quot; &quot;\t# bug_entry::bug_addr\n&quot; &quot;\t&quot; &quot;.long &quot; &quot;%c0&quot; &quot; - 2b&quot; &quot;\t# bug_entry::file\n&quot; &quot;\t.word %c1&quot; &quot;\t# bug_entry::line\n&quot; &quot;\t.word %c2&quot; &quot;\t# bug_entry::flags\n&quot; &quot;\t.org 2b+%c3\n&quot; &quot;.popsection&quot; : : &quot;i&quot; (&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;), &quot;i&quot; (131), &quot;i&quot; ((1 &lt;&lt; 0)|((1 &lt;&lt; 1)|((9) &lt;&lt; 8))), &quot;i&quot; (sizeof(struct bug_entry))); } while (0); ({ asm volatile(&quot;%c0:\n\t&quot; &quot;.pushsection .discard.reachable\n\t&quot; &quot;.long %c0b - .\n\t&quot; &quot;.popsection\n\t&quot; : : &quot;i&quot; (106)); }); } while (0); __builtin_expect(!!(__ret_warn_on), 0); })" data-ref="_M/WARN_ON_ONCE">WARN_ON_ONCE</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='PageIsolated' data-ref="PageIsolated" data-ref-filename="PageIsolated">PageIsolated</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>));</td></tr>
<tr><th id="132">132</th><td>	<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='__SetPageIsolated' data-ref="__SetPageIsolated" data-ref-filename="__SetPageIsolated">__SetPageIsolated</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>);</td></tr>
<tr><th id="133">133</th><td>	<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>);</td></tr>
<tr><th id="134">134</th><td></td></tr>
<tr><th id="135">135</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="136">136</th><td></td></tr>
<tr><th id="137">137</th><td><dfn class="lbl" id="78out_no_isolated" data-ref="78out_no_isolated" data-ref-filename="78out_no_isolated">out_no_isolated</dfn>:</td></tr>
<tr><th id="138">138</th><td>	<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>);</td></tr>
<tr><th id="139">139</th><td><dfn class="lbl" id="77out_putpage" data-ref="77out_putpage" data-ref-filename="77out_putpage">out_putpage</dfn>:</td></tr>
<tr><th id="140">140</th><td>	<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col3 ref" href="#73page" title='page' data-ref="73page" data-ref-filename="73page">page</a>);</td></tr>
<tr><th id="141">141</th><td><dfn class="lbl" id="76out" data-ref="76out" data-ref-filename="76out">out</dfn>:</td></tr>
<tr><th id="142">142</th><td>	<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#20" title="16" data-ref="_M/EBUSY">EBUSY</a>;</td></tr>
<tr><th id="143">143</th><td>}</td></tr>
<tr><th id="144">144</th><td></td></tr>
<tr><th id="145">145</th><td><i>/* It should be called on page which is PG_movable */</i></td></tr>
<tr><th id="146">146</th><td><em>void</em> <dfn class="decl def fn" id="putback_movable_page" title='putback_movable_page' data-ref="putback_movable_page" data-ref-filename="putback_movable_page">putback_movable_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col9 decl" id="79page" title='page' data-type='struct page *' data-ref="79page" data-ref-filename="79page">page</dfn>)</td></tr>
<tr><th id="147">147</th><td>{</td></tr>
<tr><th id="148">148</th><td>	<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col0 decl" id="80mapping" title='mapping' data-type='struct address_space *' data-ref="80mapping" data-ref-filename="80mapping">mapping</dfn>;</td></tr>
<tr><th id="149">149</th><td></td></tr>
<tr><th id="150">150</th><td>	<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageLocked(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#312" title='PageLocked' data-ref="PageLocked" data-ref-filename="PageLocked">PageLocked</a>(<a class="local col9 ref" href="#79page" title='page' data-ref="79page" data-ref-filename="79page">page</a>), page);</td></tr>
<tr><th id="151">151</th><td>	<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageMovable(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/migrate.h.html#PageMovable" title='PageMovable' data-ref="PageMovable" data-ref-filename="PageMovable">PageMovable</a>(<a class="local col9 ref" href="#79page" title='page' data-ref="79page" data-ref-filename="79page">page</a>), page);</td></tr>
<tr><th id="152">152</th><td>	<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageIsolated(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='PageIsolated' data-ref="PageIsolated" data-ref-filename="PageIsolated">PageIsolated</a>(<a class="local col9 ref" href="#79page" title='page' data-ref="79page" data-ref-filename="79page">page</a>), page);</td></tr>
<tr><th id="153">153</th><td></td></tr>
<tr><th id="154">154</th><td>	<a class="local col0 ref" href="#80mapping" title='mapping' data-ref="80mapping" data-ref-filename="80mapping">mapping</a> = <a class="ref fn" href="../include/linux/mm.h.html#page_mapping" title='page_mapping' data-ref="page_mapping" data-ref-filename="page_mapping">page_mapping</a>(<a class="local col9 ref" href="#79page" title='page' data-ref="79page" data-ref-filename="79page">page</a>);</td></tr>
<tr><th id="155">155</th><td>	<a class="local col0 ref" href="#80mapping" title='mapping' data-ref="80mapping" data-ref-filename="80mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::a_ops" title='address_space::a_ops' data-ref="address_space::a_ops" data-ref-filename="address_space..a_ops">a_ops</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space_operations::putback_page" title='address_space_operations::putback_page' data-ref="address_space_operations::putback_page" data-ref-filename="address_space_operations..putback_page">putback_page</a>(<a class="local col9 ref" href="#79page" title='page' data-ref="79page" data-ref-filename="79page">page</a>);</td></tr>
<tr><th id="156">156</th><td>	<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='__ClearPageIsolated' data-ref="__ClearPageIsolated" data-ref-filename="__ClearPageIsolated">__ClearPageIsolated</a>(<a class="local col9 ref" href="#79page" title='page' data-ref="79page" data-ref-filename="79page">page</a>);</td></tr>
<tr><th id="157">157</th><td>}</td></tr>
<tr><th id="158">158</th><td></td></tr>
<tr><th id="159">159</th><td><i>/*</i></td></tr>
<tr><th id="160">160</th><td><i> * Put previously isolated pages back onto the appropriate lists</i></td></tr>
<tr><th id="161">161</th><td><i> * from where they were once taken off for compaction/migration.</i></td></tr>
<tr><th id="162">162</th><td><i> *</i></td></tr>
<tr><th id="163">163</th><td><i> * This function shall be used whenever the isolated pageset has been</i></td></tr>
<tr><th id="164">164</th><td><i> * built from lru, balloon, hugetlbfs page. See isolate_migratepages_range()</i></td></tr>
<tr><th id="165">165</th><td><i> * and isolate_huge_page().</i></td></tr>
<tr><th id="166">166</th><td><i> */</i></td></tr>
<tr><th id="167">167</th><td><em>void</em> <dfn class="decl def fn" id="putback_movable_pages" title='putback_movable_pages' data-ref="putback_movable_pages" data-ref-filename="putback_movable_pages">putback_movable_pages</dfn>(<b>struct</b> <a class="type" href="../include/linux/types.h.html#list_head" title='list_head' data-ref="list_head" data-ref-filename="list_head">list_head</a> *<dfn class="local col1 decl" id="81l" title='l' data-type='struct list_head *' data-ref="81l" data-ref-filename="81l">l</dfn>)</td></tr>
<tr><th id="168">168</th><td>{</td></tr>
<tr><th id="169">169</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col2 decl" id="82page" title='page' data-type='struct page *' data-ref="82page" data-ref-filename="82page">page</dfn>;</td></tr>
<tr><th id="170">170</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col3 decl" id="83page2" title='page2' data-type='struct page *' data-ref="83page2" data-ref-filename="83page2">page2</dfn>;</td></tr>
<tr><th id="171">171</th><td></td></tr>
<tr><th id="172">172</th><td>	<a class="macro" href="../include/linux/list.h.html#663" title="for (page = ({ void *__mptr = (void *)((l)-&gt;next); do { extern void __compiletime_assert_172(void) ; if (!(!(!__builtin_types_compatible_p(typeof(*((l)-&gt;next)), typeof(((typeof(*page) *)0)-&gt;lru)) &amp;&amp; !__builtin_types_compatible_p(typeof(*((l)-&gt;next)), typeof(void))))) __compiletime_assert_172(); } while (0); ((typeof(*page) *)(__mptr - __builtin_offsetof(typeof(*page), lru))); }), page2 = ({ void *__mptr = (void *)((page)-&gt;lru.next); do { extern void __compiletime_assert_172(void) ; if (!(!(!__builtin_types_compatible_p(typeof(*((page)-&gt;lru.next)), typeof(((typeof(*(page)) *)0)-&gt;lru)) &amp;&amp; !__builtin_types_compatible_p(typeof(*((page)-&gt;lru.next)), typeof(void))))) __compiletime_assert_172(); } while (0); ((typeof(*(page)) *)(__mptr - __builtin_offsetof(typeof(*(page)), lru))); }); &amp;page-&gt;lru != (l); page = page2, page2 = ({ void *__mptr = (void *)((page2)-&gt;lru.next); do { extern void __compiletime_assert_172(void) ; if (!(!(!__builtin_types_compatible_p(typeof(*((page2)-&gt;lru.next)), typeof(((typeof(*(page2)) *)0)-&gt;lru)) &amp;&amp; !__builtin_types_compatible_p(typeof(*((page2)-&gt;lru.next)), typeof(void))))) __compiletime_assert_172(); } while (0); ((typeof(*(page2)) *)(__mptr - __builtin_offsetof(typeof(*(page2)), lru))); }))" data-ref="_M/list_for_each_entry_safe">list_for_each_entry_safe</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>, <a class="local col3 ref" href="#83page2" title='page2' data-ref="83page2" data-ref-filename="83page2">page2</a>, <a class="local col1 ref" href="#81l" title='l' data-ref="81l" data-ref-filename="81l">l</a>, <a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::lru" title='page::(anonymous union)::(anonymous struct)::lru' data-ref="page::(anonymousunion)::(anonymous)::lru" data-ref-filename="page..(anonymousunion)..(anonymous)..lru">lru</a>) {</td></tr>
<tr><th id="173">173</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(PageHuge(page)), 0)" data-ref="_M/unlikely">unlikely</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#PageHuge" title='PageHuge' data-ref="PageHuge" data-ref-filename="PageHuge">PageHuge</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>))) {</td></tr>
<tr><th id="174">174</th><td>			<a class="ref fn" href="../include/linux/hugetlb.h.html#putback_active_hugepage" title='putback_active_hugepage' data-ref="putback_active_hugepage" data-ref-filename="putback_active_hugepage">putback_active_hugepage</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>);</td></tr>
<tr><th id="175">175</th><td>			<b>continue</b>;</td></tr>
<tr><th id="176">176</th><td>		}</td></tr>
<tr><th id="177">177</th><td>		<a class="ref fn" href="../include/linux/list.h.html#list_del" title='list_del' data-ref="list_del" data-ref-filename="list_del">list_del</a>(&amp;<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::lru" title='page::(anonymous union)::(anonymous struct)::lru' data-ref="page::(anonymousunion)::(anonymous)::lru" data-ref-filename="page..(anonymousunion)..(anonymous)..lru">lru</a>);</td></tr>
<tr><th id="178">178</th><td>		<i>/*</i></td></tr>
<tr><th id="179">179</th><td><i>		 * We isolated non-lru movable page so here we can use</i></td></tr>
<tr><th id="180">180</th><td><i>		 * __PageMovable because LRU page's mapping cannot have</i></td></tr>
<tr><th id="181">181</th><td><i>		 * PAGE_MAPPING_MOVABLE.</i></td></tr>
<tr><th id="182">182</th><td><i>		 */</i></td></tr>
<tr><th id="183">183</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(__PageMovable(page)), 0)" data-ref="_M/unlikely">unlikely</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>))) {</td></tr>
<tr><th id="184">184</th><td>			<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageIsolated(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='PageIsolated' data-ref="PageIsolated" data-ref-filename="PageIsolated">PageIsolated</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>), page);</td></tr>
<tr><th id="185">185</th><td>			<a class="ref fn" href="../include/linux/pagemap.h.html#lock_page" title='lock_page' data-ref="lock_page" data-ref-filename="lock_page">lock_page</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>);</td></tr>
<tr><th id="186">186</th><td>			<b>if</b> (<a class="ref fn" href="../include/linux/migrate.h.html#PageMovable" title='PageMovable' data-ref="PageMovable" data-ref-filename="PageMovable">PageMovable</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>))</td></tr>
<tr><th id="187">187</th><td>				<a class="ref fn" href="#putback_movable_page" title='putback_movable_page' data-ref="putback_movable_page" data-ref-filename="putback_movable_page">putback_movable_page</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>);</td></tr>
<tr><th id="188">188</th><td>			<b>else</b></td></tr>
<tr><th id="189">189</th><td>				<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='__ClearPageIsolated' data-ref="__ClearPageIsolated" data-ref-filename="__ClearPageIsolated">__ClearPageIsolated</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>);</td></tr>
<tr><th id="190">190</th><td>			<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>);</td></tr>
<tr><th id="191">191</th><td>			<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>);</td></tr>
<tr><th id="192">192</th><td>		} <b>else</b> {</td></tr>
<tr><th id="193">193</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#mod_node_page_state" title='mod_node_page_state' data-ref="mod_node_page_state" data-ref-filename="mod_node_page_state">mod_node_page_state</a>(<a class="ref fn" href="../include/linux/mm.h.html#page_pgdat" title='page_pgdat' data-ref="page_pgdat" data-ref-filename="page_pgdat">page_pgdat</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>), <a class="enum" href="../include/linux/mmzone.h.html#NR_ISOLATED_ANON" title='NR_ISOLATED_ANON' data-ref="NR_ISOLATED_ANON" data-ref-filename="NR_ISOLATED_ANON">NR_ISOLATED_ANON</a> +</td></tr>
<tr><th id="194">194</th><td>					<a class="ref fn" href="../include/linux/mm_inline.h.html#page_is_file_cache" title='page_is_file_cache' data-ref="page_is_file_cache" data-ref-filename="page_is_file_cache">page_is_file_cache</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>), -<a class="macro" href="../include/linux/huge_mm.h.html#279" title="1" data-ref="_M/hpage_nr_pages">hpage_nr_pages</a>(page));</td></tr>
<tr><th id="195">195</th><td>			<a class="ref fn" href="internal.h.html#putback_lru_page" title='putback_lru_page' data-ref="putback_lru_page" data-ref-filename="putback_lru_page">putback_lru_page</a>(<a class="local col2 ref" href="#82page" title='page' data-ref="82page" data-ref-filename="82page">page</a>);</td></tr>
<tr><th id="196">196</th><td>		}</td></tr>
<tr><th id="197">197</th><td>	}</td></tr>
<tr><th id="198">198</th><td>}</td></tr>
<tr><th id="199">199</th><td></td></tr>
<tr><th id="200">200</th><td><i  data-doc="remove_migration_pte">/*</i></td></tr>
<tr><th id="201">201</th><td><i  data-doc="remove_migration_pte"> * Restore a potential migration pte to a working pte entry</i></td></tr>
<tr><th id="202">202</th><td><i  data-doc="remove_migration_pte"> */</i></td></tr>
<tr><th id="203">203</th><td><em>static</em> <a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="tu decl def fn" id="remove_migration_pte" title='remove_migration_pte' data-type='bool remove_migration_pte(struct page * page, struct vm_area_struct * vma, unsigned long addr, void * old)' data-ref="remove_migration_pte" data-ref-filename="remove_migration_pte">remove_migration_pte</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col4 decl" id="84page" title='page' data-type='struct page *' data-ref="84page" data-ref-filename="84page">page</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#vm_area_struct" title='vm_area_struct' data-ref="vm_area_struct" data-ref-filename="vm_area_struct">vm_area_struct</a> *<dfn class="local col5 decl" id="85vma" title='vma' data-type='struct vm_area_struct *' data-ref="85vma" data-ref-filename="85vma">vma</dfn>,</td></tr>
<tr><th id="204">204</th><td>				 <em>unsigned</em> <em>long</em> <dfn class="local col6 decl" id="86addr" title='addr' data-type='unsigned long' data-ref="86addr" data-ref-filename="86addr">addr</dfn>, <em>void</em> *<dfn class="local col7 decl" id="87old" title='old' data-type='void *' data-ref="87old" data-ref-filename="87old">old</dfn>)</td></tr>
<tr><th id="205">205</th><td>{</td></tr>
<tr><th id="206">206</th><td>	<b>struct</b> <a class="type" href="../include/linux/rmap.h.html#page_vma_mapped_walk" title='page_vma_mapped_walk' data-ref="page_vma_mapped_walk" data-ref-filename="page_vma_mapped_walk">page_vma_mapped_walk</a> <dfn class="local col8 decl" id="88pvmw" title='pvmw' data-type='struct page_vma_mapped_walk' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</dfn> = {</td></tr>
<tr><th id="207">207</th><td>		.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::page" title='page_vma_mapped_walk::page' data-ref="page_vma_mapped_walk::page" data-ref-filename="page_vma_mapped_walk..page">page</a> = <a class="local col7 ref" href="#87old" title='old' data-ref="87old" data-ref-filename="87old">old</a>,</td></tr>
<tr><th id="208">208</th><td>		.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::vma" title='page_vma_mapped_walk::vma' data-ref="page_vma_mapped_walk::vma" data-ref-filename="page_vma_mapped_walk..vma">vma</a> = <a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>,</td></tr>
<tr><th id="209">209</th><td>		.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::address" title='page_vma_mapped_walk::address' data-ref="page_vma_mapped_walk::address" data-ref-filename="page_vma_mapped_walk..address">address</a> = <a class="local col6 ref" href="#86addr" title='addr' data-ref="86addr" data-ref-filename="86addr">addr</a>,</td></tr>
<tr><th id="210">210</th><td>		.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::flags" title='page_vma_mapped_walk::flags' data-ref="page_vma_mapped_walk::flags" data-ref-filename="page_vma_mapped_walk..flags">flags</a> = <a class="macro" href="../include/linux/rmap.h.html#201" title="(1 &lt;&lt; 0)" data-ref="_M/PVMW_SYNC">PVMW_SYNC</a> | <a class="macro" href="../include/linux/rmap.h.html#203" title="(1 &lt;&lt; 1)" data-ref="_M/PVMW_MIGRATION">PVMW_MIGRATION</a>,</td></tr>
<tr><th id="211">211</th><td>	};</td></tr>
<tr><th id="212">212</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col9 decl" id="89new" title='new' data-type='struct page *' data-ref="89new" data-ref-filename="89new">new</dfn>;</td></tr>
<tr><th id="213">213</th><td>	<a class="typedef" href="../arch/x86/include/asm/pgtable_64_types.h.html#pte_t" title='pte_t' data-type='struct pte_t' data-ref="pte_t" data-ref-filename="pte_t">pte_t</a> <dfn class="local col0 decl" id="90pte" title='pte' data-type='pte_t' data-ref="90pte" data-ref-filename="90pte">pte</dfn>;</td></tr>
<tr><th id="214">214</th><td>	<a class="typedef" href="../include/linux/mm_types.h.html#swp_entry_t" title='swp_entry_t' data-type='struct swp_entry_t' data-ref="swp_entry_t" data-ref-filename="swp_entry_t">swp_entry_t</a> <dfn class="local col1 decl" id="91entry" title='entry' data-type='swp_entry_t' data-ref="91entry" data-ref-filename="91entry">entry</dfn>;</td></tr>
<tr><th id="215">215</th><td></td></tr>
<tr><th id="216">216</th><td>	<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(PageTail(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#PageTail" title='PageTail' data-ref="PageTail" data-ref-filename="PageTail">PageTail</a>(<a class="local col4 ref" href="#84page" title='page' data-ref="84page" data-ref-filename="84page">page</a>), page);</td></tr>
<tr><th id="217">217</th><td>	<b>while</b> (<a class="ref fn" href="../include/linux/rmap.h.html#page_vma_mapped_walk" title='page_vma_mapped_walk' data-ref="page_vma_mapped_walk" data-ref-filename="page_vma_mapped_walk">page_vma_mapped_walk</a>(&amp;<a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>)) {</td></tr>
<tr><th id="218">218</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#487" title='PageKsm' data-ref="PageKsm" data-ref-filename="PageKsm">PageKsm</a>(<a class="local col4 ref" href="#84page" title='page' data-ref="84page" data-ref-filename="84page">page</a>))</td></tr>
<tr><th id="219">219</th><td>			<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a> = <a class="local col4 ref" href="#84page" title='page' data-ref="84page" data-ref-filename="84page">page</a>;</td></tr>
<tr><th id="220">220</th><td>		<b>else</b></td></tr>
<tr><th id="221">221</th><td>			<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a> = <a class="local col4 ref" href="#84page" title='page' data-ref="84page" data-ref-filename="84page">page</a> - <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::page" title='page_vma_mapped_walk::page' data-ref="page_vma_mapped_walk::page" data-ref-filename="page_vma_mapped_walk..page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::index" title='page::(anonymous union)::(anonymous struct)::index' data-ref="page::(anonymousunion)::(anonymous)::index" data-ref-filename="page..(anonymousunion)..(anonymous)..index">index</a> +</td></tr>
<tr><th id="222">222</th><td>				<a class="ref fn" href="../include/linux/pagemap.h.html#linear_page_index" title='linear_page_index' data-ref="linear_page_index" data-ref-filename="linear_page_index">linear_page_index</a>(<a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::address" title='page_vma_mapped_walk::address' data-ref="page_vma_mapped_walk::address" data-ref-filename="page_vma_mapped_walk..address">address</a>);</td></tr>
<tr><th id="223">223</th><td></td></tr>
<tr><th id="224">224</th><td><u>#<span data-ppcond="224">ifdef</span> <span class="macro" data-ref="_M/CONFIG_ARCH_ENABLE_THP_MIGRATION">CONFIG_ARCH_ENABLE_THP_MIGRATION</span></u></td></tr>
<tr><th id="225">225</th><td>		<i>/* PMD-mapped THP migration entry */</i></td></tr>
<tr><th id="226">226</th><td>		<b>if</b> (!pvmw.pte) {</td></tr>
<tr><th id="227">227</th><td>			VM_BUG_ON_PAGE(PageHuge(page) || !PageTransCompound(page), page);</td></tr>
<tr><th id="228">228</th><td>			remove_migration_pmd(&amp;pvmw, new);</td></tr>
<tr><th id="229">229</th><td>			<b>continue</b>;</td></tr>
<tr><th id="230">230</th><td>		}</td></tr>
<tr><th id="231">231</th><td><u>#<span data-ppcond="224">endif</span></u></td></tr>
<tr><th id="232">232</th><td></td></tr>
<tr><th id="233">233</th><td>		<a class="ref fn" href="../include/linux/mm.h.html#get_page" title='get_page' data-ref="get_page" data-ref-filename="get_page">get_page</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>);</td></tr>
<tr><th id="234">234</th><td>		<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a> = <a class="ref fn" href="../arch/x86/include/asm/pgtable.h.html#pte_mkold" title='pte_mkold' data-ref="pte_mkold" data-ref-filename="pte_mkold">pte_mkold</a>(<a class="macro" href="../arch/x86/include/asm/pgtable.h.html#821" title="pfn_pte((unsigned long)((new) - ((struct page *)vmemmap_base)), (({ union { typeof(vma-&gt;vm_page_prot) __val; char __c[1]; } __u; if (1) __read_once_size(&amp;(vma-&gt;vm_page_prot), __u.__c, sizeof(vma-&gt;vm_page_prot)); else __read_once_size_nocheck(&amp;(vma-&gt;vm_page_prot), __u.__c, sizeof(vma-&gt;vm_page_prot)); do { } while (0); __u.__val; })))" data-ref="_M/mk_pte">mk_pte</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>, <a class="macro" href="../include/linux/compiler.h.html#269" title="({ union { typeof(vma-&gt;vm_page_prot) __val; char __c[1]; } __u; if (1) __read_once_size(&amp;(vma-&gt;vm_page_prot), __u.__c, sizeof(vma-&gt;vm_page_prot)); else __read_once_size_nocheck(&amp;(vma-&gt;vm_page_prot), __u.__c, sizeof(vma-&gt;vm_page_prot)); do { } while (0); __u.__val; })" data-ref="_M/READ_ONCE">READ_ONCE</a>(<a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#vm_area_struct::vm_page_prot" title='vm_area_struct::vm_page_prot' data-ref="vm_area_struct::vm_page_prot" data-ref-filename="vm_area_struct..vm_page_prot">vm_page_prot</a>)));</td></tr>
<tr><th id="235">235</th><td>		<b>if</b> (<a class="ref fn" href="../arch/x86/include/asm/pgtable.h.html#pte_swp_soft_dirty" title='pte_swp_soft_dirty' data-ref="pte_swp_soft_dirty" data-ref-filename="pte_swp_soft_dirty">pte_swp_soft_dirty</a>(*<a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::pte" title='page_vma_mapped_walk::pte' data-ref="page_vma_mapped_walk::pte" data-ref-filename="page_vma_mapped_walk..pte">pte</a>))</td></tr>
<tr><th id="236">236</th><td>			<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a> = <a class="ref fn" href="../arch/x86/include/asm/pgtable.h.html#pte_mksoft_dirty" title='pte_mksoft_dirty' data-ref="pte_mksoft_dirty" data-ref-filename="pte_mksoft_dirty">pte_mksoft_dirty</a>(<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a>);</td></tr>
<tr><th id="237">237</th><td></td></tr>
<tr><th id="238">238</th><td>		<i>/*</i></td></tr>
<tr><th id="239">239</th><td><i>		 * Recheck VMA as permissions can change since migration started</i></td></tr>
<tr><th id="240">240</th><td><i>		 */</i></td></tr>
<tr><th id="241">241</th><td>		<a class="local col1 ref" href="#91entry" title='entry' data-ref="91entry" data-ref-filename="91entry">entry</a> = <a class="ref fn" href="../include/linux/swapops.h.html#pte_to_swp_entry" title='pte_to_swp_entry' data-ref="pte_to_swp_entry" data-ref-filename="pte_to_swp_entry">pte_to_swp_entry</a>(*<a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::pte" title='page_vma_mapped_walk::pte' data-ref="page_vma_mapped_walk::pte" data-ref-filename="page_vma_mapped_walk..pte">pte</a>);</td></tr>
<tr><th id="242">242</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/swapops.h.html#is_write_migration_entry" title='is_write_migration_entry' data-ref="is_write_migration_entry" data-ref-filename="is_write_migration_entry">is_write_migration_entry</a>(<a class="local col1 ref" href="#91entry" title='entry' data-ref="91entry" data-ref-filename="91entry">entry</a>))</td></tr>
<tr><th id="243">243</th><td>			<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a> = <a class="ref fn" href="../include/linux/mm.h.html#maybe_mkwrite" title='maybe_mkwrite' data-ref="maybe_mkwrite" data-ref-filename="maybe_mkwrite">maybe_mkwrite</a>(<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a>, <a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>);</td></tr>
<tr><th id="244">244</th><td></td></tr>
<tr><th id="245">245</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(is_zone_device_page(new)), 0)" data-ref="_M/unlikely">unlikely</a>(<a class="ref fn" href="../include/linux/mm.h.html#is_zone_device_page" title='is_zone_device_page' data-ref="is_zone_device_page" data-ref-filename="is_zone_device_page">is_zone_device_page</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>))) {</td></tr>
<tr><th id="246">246</th><td>			<b>if</b> (<a class="ref fn" href="../include/linux/mm.h.html#is_device_private_page" title='is_device_private_page' data-ref="is_device_private_page" data-ref-filename="is_device_private_page">is_device_private_page</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>)) {</td></tr>
<tr><th id="247">247</th><td>				<a class="local col1 ref" href="#91entry" title='entry' data-ref="91entry" data-ref-filename="91entry">entry</a> = <a class="ref fn" href="../include/linux/swapops.h.html#make_device_private_entry" title='make_device_private_entry' data-ref="make_device_private_entry" data-ref-filename="make_device_private_entry">make_device_private_entry</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>, <a class="ref fn" href="../arch/x86/include/asm/pgtable.h.html#pte_write" title='pte_write' data-ref="pte_write" data-ref-filename="pte_write">pte_write</a>(<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a>));</td></tr>
<tr><th id="248">248</th><td>				<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a> = <a class="ref fn" href="../include/linux/swapops.h.html#swp_entry_to_pte" title='swp_entry_to_pte' data-ref="swp_entry_to_pte" data-ref-filename="swp_entry_to_pte">swp_entry_to_pte</a>(<a class="local col1 ref" href="#91entry" title='entry' data-ref="91entry" data-ref-filename="91entry">entry</a>);</td></tr>
<tr><th id="249">249</th><td>			}</td></tr>
<tr><th id="250">250</th><td>		}</td></tr>
<tr><th id="251">251</th><td></td></tr>
<tr><th id="252">252</th><td><u>#<span data-ppcond="252">ifdef</span> <a class="macro" href="../include/generated/autoconf.h.html#525" data-ref="_M/CONFIG_HUGETLB_PAGE">CONFIG_HUGETLB_PAGE</a></u></td></tr>
<tr><th id="253">253</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageHuge" title='PageHuge' data-ref="PageHuge" data-ref-filename="PageHuge">PageHuge</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>)) {</td></tr>
<tr><th id="254">254</th><td>			<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a> = <a class="ref fn" href="../arch/x86/include/asm/pgtable.h.html#pte_mkhuge" title='pte_mkhuge' data-ref="pte_mkhuge" data-ref-filename="pte_mkhuge">pte_mkhuge</a>(<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a>);</td></tr>
<tr><th id="255">255</th><td>			<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a> = <a class="ref fn" href="../include/linux/hugetlb.h.html#arch_make_huge_pte" title='arch_make_huge_pte' data-ref="arch_make_huge_pte" data-ref-filename="arch_make_huge_pte">arch_make_huge_pte</a>(<a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a>, <a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>, <a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>, <var>0</var>);</td></tr>
<tr><th id="256">256</th><td>			<a class="ref fn" href="../include/asm-generic/hugetlb.h.html#set_huge_pte_at" title='set_huge_pte_at' data-ref="set_huge_pte_at" data-ref-filename="set_huge_pte_at">set_huge_pte_at</a>(<a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#vm_area_struct::vm_mm" title='vm_area_struct::vm_mm' data-ref="vm_area_struct::vm_mm" data-ref-filename="vm_area_struct..vm_mm">vm_mm</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::address" title='page_vma_mapped_walk::address' data-ref="page_vma_mapped_walk::address" data-ref-filename="page_vma_mapped_walk..address">address</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::pte" title='page_vma_mapped_walk::pte' data-ref="page_vma_mapped_walk::pte" data-ref-filename="page_vma_mapped_walk..pte">pte</a>, <a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a>);</td></tr>
<tr><th id="257">257</th><td>			<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageAnon" title='PageAnon' data-ref="PageAnon" data-ref-filename="PageAnon">PageAnon</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>))</td></tr>
<tr><th id="258">258</th><td>				<a class="ref fn" href="../include/linux/rmap.h.html#hugepage_add_anon_rmap" title='hugepage_add_anon_rmap' data-ref="hugepage_add_anon_rmap" data-ref-filename="hugepage_add_anon_rmap">hugepage_add_anon_rmap</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>, <a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::address" title='page_vma_mapped_walk::address' data-ref="page_vma_mapped_walk::address" data-ref-filename="page_vma_mapped_walk..address">address</a>);</td></tr>
<tr><th id="259">259</th><td>			<b>else</b></td></tr>
<tr><th id="260">260</th><td>				<a class="ref fn" href="../include/linux/rmap.h.html#page_dup_rmap" title='page_dup_rmap' data-ref="page_dup_rmap" data-ref-filename="page_dup_rmap">page_dup_rmap</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>, <a class="enum" href="../include/linux/stddef.h.html#true" title='true' data-ref="true" data-ref-filename="true">true</a>);</td></tr>
<tr><th id="261">261</th><td>		} <b>else</b></td></tr>
<tr><th id="262">262</th><td><u>#<span data-ppcond="252">endif</span></u></td></tr>
<tr><th id="263">263</th><td>		{</td></tr>
<tr><th id="264">264</th><td>			<a class="macro" href="../arch/x86/include/asm/pgtable.h.html#64" title="native_set_pte_at(vma-&gt;vm_mm, pvmw.address, pvmw.pte, pte)" data-ref="_M/set_pte_at">set_pte_at</a>(<a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#vm_area_struct::vm_mm" title='vm_area_struct::vm_mm' data-ref="vm_area_struct::vm_mm" data-ref-filename="vm_area_struct..vm_mm">vm_mm</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::address" title='page_vma_mapped_walk::address' data-ref="page_vma_mapped_walk::address" data-ref-filename="page_vma_mapped_walk..address">address</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::pte" title='page_vma_mapped_walk::pte' data-ref="page_vma_mapped_walk::pte" data-ref-filename="page_vma_mapped_walk..pte">pte</a>, <a class="local col0 ref" href="#90pte" title='pte' data-ref="90pte" data-ref-filename="90pte">pte</a>);</td></tr>
<tr><th id="265">265</th><td></td></tr>
<tr><th id="266">266</th><td>			<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageAnon" title='PageAnon' data-ref="PageAnon" data-ref-filename="PageAnon">PageAnon</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>))</td></tr>
<tr><th id="267">267</th><td>				<a class="ref fn" href="../include/linux/rmap.h.html#page_add_anon_rmap" title='page_add_anon_rmap' data-ref="page_add_anon_rmap" data-ref-filename="page_add_anon_rmap">page_add_anon_rmap</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>, <a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::address" title='page_vma_mapped_walk::address' data-ref="page_vma_mapped_walk::address" data-ref-filename="page_vma_mapped_walk..address">address</a>, <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>);</td></tr>
<tr><th id="268">268</th><td>			<b>else</b></td></tr>
<tr><th id="269">269</th><td>				<a class="ref fn" href="../include/linux/rmap.h.html#page_add_file_rmap" title='page_add_file_rmap' data-ref="page_add_file_rmap" data-ref-filename="page_add_file_rmap">page_add_file_rmap</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>, <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>);</td></tr>
<tr><th id="270">270</th><td>		}</td></tr>
<tr><th id="271">271</th><td>		<b>if</b> (<a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#vm_area_struct::vm_flags" title='vm_area_struct::vm_flags' data-ref="vm_area_struct::vm_flags" data-ref-filename="vm_area_struct..vm_flags">vm_flags</a> &amp; <a class="macro" href="../include/linux/mm.h.html#266" title="0x00002000" data-ref="_M/VM_LOCKED">VM_LOCKED</a> &amp;&amp; !<a class="ref fn" href="../include/linux/page-flags.h.html#686" title='PageTransCompound' data-ref="PageTransCompound" data-ref-filename="PageTransCompound">PageTransCompound</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>))</td></tr>
<tr><th id="272">272</th><td>			<a class="ref fn" href="internal.h.html#mlock_vma_page" title='mlock_vma_page' data-ref="mlock_vma_page" data-ref-filename="mlock_vma_page">mlock_vma_page</a>(<a class="local col9 ref" href="#89new" title='new' data-ref="89new" data-ref-filename="89new">new</a>);</td></tr>
<tr><th id="273">273</th><td></td></tr>
<tr><th id="274">274</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#685" title='PageTransHuge' data-ref="PageTransHuge" data-ref-filename="PageTransHuge">PageTransHuge</a>(<a class="local col4 ref" href="#84page" title='page' data-ref="84page" data-ref-filename="84page">page</a>) &amp;&amp; <a class="ref fn" href="../include/linux/page-flags.h.html#399" title='PageMlocked' data-ref="PageMlocked" data-ref-filename="PageMlocked">PageMlocked</a>(<a class="local col4 ref" href="#84page" title='page' data-ref="84page" data-ref-filename="84page">page</a>))</td></tr>
<tr><th id="275">275</th><td>			<a class="ref fn" href="internal.h.html#clear_page_mlock" title='clear_page_mlock' data-ref="clear_page_mlock" data-ref-filename="clear_page_mlock">clear_page_mlock</a>(<a class="local col4 ref" href="#84page" title='page' data-ref="84page" data-ref-filename="84page">page</a>);</td></tr>
<tr><th id="276">276</th><td></td></tr>
<tr><th id="277">277</th><td>		<i>/* No need to invalidate - it was non-present before */</i></td></tr>
<tr><th id="278">278</th><td>		<a class="ref fn" href="../arch/x86/include/asm/pgtable.h.html#update_mmu_cache" title='update_mmu_cache' data-ref="update_mmu_cache" data-ref-filename="update_mmu_cache">update_mmu_cache</a>(<a class="local col5 ref" href="#85vma" title='vma' data-ref="85vma" data-ref-filename="85vma">vma</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::address" title='page_vma_mapped_walk::address' data-ref="page_vma_mapped_walk::address" data-ref-filename="page_vma_mapped_walk..address">address</a>, <a class="local col8 ref" href="#88pvmw" title='pvmw' data-ref="88pvmw" data-ref-filename="88pvmw">pvmw</a>.<a class="ref field" href="../include/linux/rmap.h.html#page_vma_mapped_walk::pte" title='page_vma_mapped_walk::pte' data-ref="page_vma_mapped_walk::pte" data-ref-filename="page_vma_mapped_walk..pte">pte</a>);</td></tr>
<tr><th id="279">279</th><td>	}</td></tr>
<tr><th id="280">280</th><td></td></tr>
<tr><th id="281">281</th><td>	<b>return</b> <a class="enum" href="../include/linux/stddef.h.html#true" title='true' data-ref="true" data-ref-filename="true">true</a>;</td></tr>
<tr><th id="282">282</th><td>}</td></tr>
<tr><th id="283">283</th><td></td></tr>
<tr><th id="284">284</th><td><i>/*</i></td></tr>
<tr><th id="285">285</th><td><i> * Get rid of all migration entries and replace them by</i></td></tr>
<tr><th id="286">286</th><td><i> * references to the indicated page.</i></td></tr>
<tr><th id="287">287</th><td><i> */</i></td></tr>
<tr><th id="288">288</th><td><em>void</em> <dfn class="decl def fn" id="remove_migration_ptes" title='remove_migration_ptes' data-ref="remove_migration_ptes" data-ref-filename="remove_migration_ptes">remove_migration_ptes</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col2 decl" id="92old" title='old' data-type='struct page *' data-ref="92old" data-ref-filename="92old">old</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col3 decl" id="93new" title='new' data-type='struct page *' data-ref="93new" data-ref-filename="93new">new</dfn>, <a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="local col4 decl" id="94locked" title='locked' data-type='bool' data-ref="94locked" data-ref-filename="94locked">locked</dfn>)</td></tr>
<tr><th id="289">289</th><td>{</td></tr>
<tr><th id="290">290</th><td>	<b>struct</b> <a class="type" href="../include/linux/rmap.h.html#rmap_walk_control" title='rmap_walk_control' data-ref="rmap_walk_control" data-ref-filename="rmap_walk_control">rmap_walk_control</a> <dfn class="local col5 decl" id="95rwc" title='rwc' data-type='struct rmap_walk_control' data-ref="95rwc" data-ref-filename="95rwc">rwc</dfn> = {</td></tr>
<tr><th id="291">291</th><td>		.<a class="ref field" href="../include/linux/rmap.h.html#rmap_walk_control::rmap_one" title='rmap_walk_control::rmap_one' data-ref="rmap_walk_control::rmap_one" data-ref-filename="rmap_walk_control..rmap_one">rmap_one</a> = <a class="tu ref fn" href="#remove_migration_pte" title='remove_migration_pte' data-use='r' data-ref="remove_migration_pte" data-ref-filename="remove_migration_pte">remove_migration_pte</a>,</td></tr>
<tr><th id="292">292</th><td>		.<a class="ref field" href="../include/linux/rmap.h.html#rmap_walk_control::arg" title='rmap_walk_control::arg' data-ref="rmap_walk_control::arg" data-ref-filename="rmap_walk_control..arg">arg</a> = <a class="local col2 ref" href="#92old" title='old' data-ref="92old" data-ref-filename="92old">old</a>,</td></tr>
<tr><th id="293">293</th><td>	};</td></tr>
<tr><th id="294">294</th><td></td></tr>
<tr><th id="295">295</th><td>	<b>if</b> (<a class="local col4 ref" href="#94locked" title='locked' data-ref="94locked" data-ref-filename="94locked">locked</a>)</td></tr>
<tr><th id="296">296</th><td>		<a class="ref fn" href="../include/linux/rmap.h.html#rmap_walk_locked" title='rmap_walk_locked' data-ref="rmap_walk_locked" data-ref-filename="rmap_walk_locked">rmap_walk_locked</a>(<a class="local col3 ref" href="#93new" title='new' data-ref="93new" data-ref-filename="93new">new</a>, &amp;<a class="local col5 ref" href="#95rwc" title='rwc' data-ref="95rwc" data-ref-filename="95rwc">rwc</a>);</td></tr>
<tr><th id="297">297</th><td>	<b>else</b></td></tr>
<tr><th id="298">298</th><td>		<a class="ref fn" href="../include/linux/rmap.h.html#rmap_walk" title='rmap_walk' data-ref="rmap_walk" data-ref-filename="rmap_walk">rmap_walk</a>(<a class="local col3 ref" href="#93new" title='new' data-ref="93new" data-ref-filename="93new">new</a>, &amp;<a class="local col5 ref" href="#95rwc" title='rwc' data-ref="95rwc" data-ref-filename="95rwc">rwc</a>);</td></tr>
<tr><th id="299">299</th><td>}</td></tr>
<tr><th id="300">300</th><td></td></tr>
<tr><th id="301">301</th><td><i>/*</i></td></tr>
<tr><th id="302">302</th><td><i> * Something used the pte of a page under migration. We need to</i></td></tr>
<tr><th id="303">303</th><td><i> * get to the page and wait until migration is finished.</i></td></tr>
<tr><th id="304">304</th><td><i> * When we return from this function the fault will be retried.</i></td></tr>
<tr><th id="305">305</th><td><i> */</i></td></tr>
<tr><th id="306">306</th><td><em>void</em> <dfn class="decl def fn" id="__migration_entry_wait" title='__migration_entry_wait' data-ref="__migration_entry_wait" data-ref-filename="__migration_entry_wait">__migration_entry_wait</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col6 decl" id="96mm" title='mm' data-type='struct mm_struct *' data-ref="96mm" data-ref-filename="96mm">mm</dfn>, <a class="typedef" href="../arch/x86/include/asm/pgtable_64_types.h.html#pte_t" title='pte_t' data-type='struct pte_t' data-ref="pte_t" data-ref-filename="pte_t">pte_t</a> *<dfn class="local col7 decl" id="97ptep" title='ptep' data-type='pte_t *' data-ref="97ptep" data-ref-filename="97ptep">ptep</dfn>,</td></tr>
<tr><th id="307">307</th><td>				<a class="typedef" href="../include/linux/spinlock_types.h.html#spinlock_t" title='spinlock_t' data-type='struct spinlock' data-ref="spinlock_t" data-ref-filename="spinlock_t">spinlock_t</a> *<dfn class="local col8 decl" id="98ptl" title='ptl' data-type='spinlock_t *' data-ref="98ptl" data-ref-filename="98ptl">ptl</dfn>)</td></tr>
<tr><th id="308">308</th><td>{</td></tr>
<tr><th id="309">309</th><td>	<a class="typedef" href="../arch/x86/include/asm/pgtable_64_types.h.html#pte_t" title='pte_t' data-type='struct pte_t' data-ref="pte_t" data-ref-filename="pte_t">pte_t</a> <dfn class="local col9 decl" id="99pte" title='pte' data-type='pte_t' data-ref="99pte" data-ref-filename="99pte">pte</dfn>;</td></tr>
<tr><th id="310">310</th><td>	<a class="typedef" href="../include/linux/mm_types.h.html#swp_entry_t" title='swp_entry_t' data-type='struct swp_entry_t' data-ref="swp_entry_t" data-ref-filename="swp_entry_t">swp_entry_t</a> <dfn class="local col0 decl" id="100entry" title='entry' data-type='swp_entry_t' data-ref="100entry" data-ref-filename="100entry">entry</dfn>;</td></tr>
<tr><th id="311">311</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col1 decl" id="101page" title='page' data-type='struct page *' data-ref="101page" data-ref-filename="101page">page</dfn>;</td></tr>
<tr><th id="312">312</th><td></td></tr>
<tr><th id="313">313</th><td>	<a class="ref fn" href="../include/linux/spinlock.h.html#spin_lock" title='spin_lock' data-ref="spin_lock" data-ref-filename="spin_lock">spin_lock</a>(<a class="local col8 ref" href="#98ptl" title='ptl' data-ref="98ptl" data-ref-filename="98ptl">ptl</a>);</td></tr>
<tr><th id="314">314</th><td>	<a class="local col9 ref" href="#99pte" title='pte' data-ref="99pte" data-ref-filename="99pte">pte</a> = *<a class="local col7 ref" href="#97ptep" title='ptep' data-ref="97ptep" data-ref-filename="97ptep">ptep</a>;</td></tr>
<tr><th id="315">315</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/swapops.h.html#is_swap_pte" title='is_swap_pte' data-ref="is_swap_pte" data-ref-filename="is_swap_pte">is_swap_pte</a>(<a class="local col9 ref" href="#99pte" title='pte' data-ref="99pte" data-ref-filename="99pte">pte</a>))</td></tr>
<tr><th id="316">316</th><td>		<b>goto</b> <a class="lbl" href="#102out" data-ref="102out" data-ref-filename="102out">out</a>;</td></tr>
<tr><th id="317">317</th><td></td></tr>
<tr><th id="318">318</th><td>	<a class="local col0 ref" href="#100entry" title='entry' data-ref="100entry" data-ref-filename="100entry">entry</a> = <a class="ref fn" href="../include/linux/swapops.h.html#pte_to_swp_entry" title='pte_to_swp_entry' data-ref="pte_to_swp_entry" data-ref-filename="pte_to_swp_entry">pte_to_swp_entry</a>(<a class="local col9 ref" href="#99pte" title='pte' data-ref="99pte" data-ref-filename="99pte">pte</a>);</td></tr>
<tr><th id="319">319</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/swapops.h.html#is_migration_entry" title='is_migration_entry' data-ref="is_migration_entry" data-ref-filename="is_migration_entry">is_migration_entry</a>(<a class="local col0 ref" href="#100entry" title='entry' data-ref="100entry" data-ref-filename="100entry">entry</a>))</td></tr>
<tr><th id="320">320</th><td>		<b>goto</b> <a class="lbl" href="#102out" data-ref="102out" data-ref-filename="102out">out</a>;</td></tr>
<tr><th id="321">321</th><td></td></tr>
<tr><th id="322">322</th><td>	<a class="local col1 ref" href="#101page" title='page' data-ref="101page" data-ref-filename="101page">page</a> = <a class="ref fn" href="../include/linux/swapops.h.html#migration_entry_to_page" title='migration_entry_to_page' data-ref="migration_entry_to_page" data-ref-filename="migration_entry_to_page">migration_entry_to_page</a>(<a class="local col0 ref" href="#100entry" title='entry' data-ref="100entry" data-ref-filename="100entry">entry</a>);</td></tr>
<tr><th id="323">323</th><td></td></tr>
<tr><th id="324">324</th><td>	<i>/*</i></td></tr>
<tr><th id="325">325</th><td><i>	 * Once page cache replacement of page migration started, page_count</i></td></tr>
<tr><th id="326">326</th><td><i>	 * is zero; but we must not call put_and_wait_on_page_locked() without</i></td></tr>
<tr><th id="327">327</th><td><i>	 * a ref. Use get_page_unless_zero(), and just fault again if it fails.</i></td></tr>
<tr><th id="328">328</th><td><i>	 */</i></td></tr>
<tr><th id="329">329</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/mm.h.html#get_page_unless_zero" title='get_page_unless_zero' data-ref="get_page_unless_zero" data-ref-filename="get_page_unless_zero">get_page_unless_zero</a>(<a class="local col1 ref" href="#101page" title='page' data-ref="101page" data-ref-filename="101page">page</a>))</td></tr>
<tr><th id="330">330</th><td>		<b>goto</b> <a class="lbl" href="#102out" data-ref="102out" data-ref-filename="102out">out</a>;</td></tr>
<tr><th id="331">331</th><td>	<a class="macro" href="../include/linux/mm.h.html#2000" title="do { spin_unlock(ptl); ((void)(ptep)); } while (0)" data-ref="_M/pte_unmap_unlock">pte_unmap_unlock</a>(<a class="local col7 ref" href="#97ptep" title='ptep' data-ref="97ptep" data-ref-filename="97ptep">ptep</a>, <a class="local col8 ref" href="#98ptl" title='ptl' data-ref="98ptl" data-ref-filename="98ptl">ptl</a>);</td></tr>
<tr><th id="332">332</th><td>	<a class="ref fn" href="../include/linux/pagemap.h.html#put_and_wait_on_page_locked" title='put_and_wait_on_page_locked' data-ref="put_and_wait_on_page_locked" data-ref-filename="put_and_wait_on_page_locked">put_and_wait_on_page_locked</a>(<a class="local col1 ref" href="#101page" title='page' data-ref="101page" data-ref-filename="101page">page</a>);</td></tr>
<tr><th id="333">333</th><td>	<b>return</b>;</td></tr>
<tr><th id="334">334</th><td><dfn class="lbl" id="102out" data-ref="102out" data-ref-filename="102out">out</dfn>:</td></tr>
<tr><th id="335">335</th><td>	<a class="macro" href="../include/linux/mm.h.html#2000" title="do { spin_unlock(ptl); ((void)(ptep)); } while (0)" data-ref="_M/pte_unmap_unlock">pte_unmap_unlock</a>(<a class="local col7 ref" href="#97ptep" title='ptep' data-ref="97ptep" data-ref-filename="97ptep">ptep</a>, <a class="local col8 ref" href="#98ptl" title='ptl' data-ref="98ptl" data-ref-filename="98ptl">ptl</a>);</td></tr>
<tr><th id="336">336</th><td>}</td></tr>
<tr><th id="337">337</th><td></td></tr>
<tr><th id="338">338</th><td><em>void</em> <dfn class="decl def fn" id="migration_entry_wait" title='migration_entry_wait' data-ref="migration_entry_wait" data-ref-filename="migration_entry_wait">migration_entry_wait</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col3 decl" id="103mm" title='mm' data-type='struct mm_struct *' data-ref="103mm" data-ref-filename="103mm">mm</dfn>, <a class="typedef" href="../arch/x86/include/asm/pgtable_types.h.html#pmd_t" title='pmd_t' data-type='struct pmd_t' data-ref="pmd_t" data-ref-filename="pmd_t">pmd_t</a> *<dfn class="local col4 decl" id="104pmd" title='pmd' data-type='pmd_t *' data-ref="104pmd" data-ref-filename="104pmd">pmd</dfn>,</td></tr>
<tr><th id="339">339</th><td>				<em>unsigned</em> <em>long</em> <dfn class="local col5 decl" id="105address" title='address' data-type='unsigned long' data-ref="105address" data-ref-filename="105address">address</dfn>)</td></tr>
<tr><th id="340">340</th><td>{</td></tr>
<tr><th id="341">341</th><td>	<a class="typedef" href="../include/linux/spinlock_types.h.html#spinlock_t" title='spinlock_t' data-type='struct spinlock' data-ref="spinlock_t" data-ref-filename="spinlock_t">spinlock_t</a> *<dfn class="local col6 decl" id="106ptl" title='ptl' data-type='spinlock_t *' data-ref="106ptl" data-ref-filename="106ptl">ptl</dfn> = <a class="ref fn" href="../include/linux/mm.h.html#pte_lockptr" title='pte_lockptr' data-ref="pte_lockptr" data-ref-filename="pte_lockptr">pte_lockptr</a>(<a class="local col3 ref" href="#103mm" title='mm' data-ref="103mm" data-ref-filename="103mm">mm</a>, <a class="local col4 ref" href="#104pmd" title='pmd' data-ref="104pmd" data-ref-filename="104pmd">pmd</a>);</td></tr>
<tr><th id="342">342</th><td>	<a class="typedef" href="../arch/x86/include/asm/pgtable_64_types.h.html#pte_t" title='pte_t' data-type='struct pte_t' data-ref="pte_t" data-ref-filename="pte_t">pte_t</a> *<dfn class="local col7 decl" id="107ptep" title='ptep' data-type='pte_t *' data-ref="107ptep" data-ref-filename="107ptep">ptep</dfn> = <a class="macro" href="../arch/x86/include/asm/pgtable_64.h.html#184" title="pte_offset_kernel((pmd), (address))" data-ref="_M/pte_offset_map">pte_offset_map</a>(<a class="local col4 ref" href="#104pmd" title='pmd' data-ref="104pmd" data-ref-filename="104pmd">pmd</a>, <a class="local col5 ref" href="#105address" title='address' data-ref="105address" data-ref-filename="105address">address</a>);</td></tr>
<tr><th id="343">343</th><td>	<a class="ref fn" href="#__migration_entry_wait" title='__migration_entry_wait' data-ref="__migration_entry_wait" data-ref-filename="__migration_entry_wait">__migration_entry_wait</a>(<a class="local col3 ref" href="#103mm" title='mm' data-ref="103mm" data-ref-filename="103mm">mm</a>, <a class="local col7 ref" href="#107ptep" title='ptep' data-ref="107ptep" data-ref-filename="107ptep">ptep</a>, <a class="local col6 ref" href="#106ptl" title='ptl' data-ref="106ptl" data-ref-filename="106ptl">ptl</a>);</td></tr>
<tr><th id="344">344</th><td>}</td></tr>
<tr><th id="345">345</th><td></td></tr>
<tr><th id="346">346</th><td><em>void</em> <dfn class="decl def fn" id="migration_entry_wait_huge" title='migration_entry_wait_huge' data-ref="migration_entry_wait_huge" data-ref-filename="migration_entry_wait_huge">migration_entry_wait_huge</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#vm_area_struct" title='vm_area_struct' data-ref="vm_area_struct" data-ref-filename="vm_area_struct">vm_area_struct</a> *<dfn class="local col8 decl" id="108vma" title='vma' data-type='struct vm_area_struct *' data-ref="108vma" data-ref-filename="108vma">vma</dfn>,</td></tr>
<tr><th id="347">347</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col9 decl" id="109mm" title='mm' data-type='struct mm_struct *' data-ref="109mm" data-ref-filename="109mm">mm</dfn>, <a class="typedef" href="../arch/x86/include/asm/pgtable_64_types.h.html#pte_t" title='pte_t' data-type='struct pte_t' data-ref="pte_t" data-ref-filename="pte_t">pte_t</a> *<dfn class="local col0 decl" id="110pte" title='pte' data-type='pte_t *' data-ref="110pte" data-ref-filename="110pte">pte</dfn>)</td></tr>
<tr><th id="348">348</th><td>{</td></tr>
<tr><th id="349">349</th><td>	<a class="typedef" href="../include/linux/spinlock_types.h.html#spinlock_t" title='spinlock_t' data-type='struct spinlock' data-ref="spinlock_t" data-ref-filename="spinlock_t">spinlock_t</a> *<dfn class="local col1 decl" id="111ptl" title='ptl' data-type='spinlock_t *' data-ref="111ptl" data-ref-filename="111ptl">ptl</dfn> = <a class="ref fn" href="../include/linux/hugetlb.h.html#huge_pte_lockptr" title='huge_pte_lockptr' data-ref="huge_pte_lockptr" data-ref-filename="huge_pte_lockptr">huge_pte_lockptr</a>(<a class="ref fn" href="../include/linux/hugetlb.h.html#hstate_vma" title='hstate_vma' data-ref="hstate_vma" data-ref-filename="hstate_vma">hstate_vma</a>(<a class="local col8 ref" href="#108vma" title='vma' data-ref="108vma" data-ref-filename="108vma">vma</a>), <a class="local col9 ref" href="#109mm" title='mm' data-ref="109mm" data-ref-filename="109mm">mm</a>, <a class="local col0 ref" href="#110pte" title='pte' data-ref="110pte" data-ref-filename="110pte">pte</a>);</td></tr>
<tr><th id="350">350</th><td>	<a class="ref fn" href="#__migration_entry_wait" title='__migration_entry_wait' data-ref="__migration_entry_wait" data-ref-filename="__migration_entry_wait">__migration_entry_wait</a>(<a class="local col9 ref" href="#109mm" title='mm' data-ref="109mm" data-ref-filename="109mm">mm</a>, <a class="local col0 ref" href="#110pte" title='pte' data-ref="110pte" data-ref-filename="110pte">pte</a>, <a class="local col1 ref" href="#111ptl" title='ptl' data-ref="111ptl" data-ref-filename="111ptl">ptl</a>);</td></tr>
<tr><th id="351">351</th><td>}</td></tr>
<tr><th id="352">352</th><td></td></tr>
<tr><th id="353">353</th><td><u>#<span data-ppcond="353">ifdef</span> <span class="macro" data-ref="_M/CONFIG_ARCH_ENABLE_THP_MIGRATION">CONFIG_ARCH_ENABLE_THP_MIGRATION</span></u></td></tr>
<tr><th id="354">354</th><td><em>void</em> pmd_migration_entry_wait(<b>struct</b> mm_struct *mm, pmd_t *pmd)</td></tr>
<tr><th id="355">355</th><td>{</td></tr>
<tr><th id="356">356</th><td>	spinlock_t *ptl;</td></tr>
<tr><th id="357">357</th><td>	<b>struct</b> page *page;</td></tr>
<tr><th id="358">358</th><td></td></tr>
<tr><th id="359">359</th><td>	ptl = pmd_lock(mm, pmd);</td></tr>
<tr><th id="360">360</th><td>	<b>if</b> (!is_pmd_migration_entry(*pmd))</td></tr>
<tr><th id="361">361</th><td>		<b>goto</b> unlock;</td></tr>
<tr><th id="362">362</th><td>	page = migration_entry_to_page(pmd_to_swp_entry(*pmd));</td></tr>
<tr><th id="363">363</th><td>	<b>if</b> (!get_page_unless_zero(page))</td></tr>
<tr><th id="364">364</th><td>		<b>goto</b> unlock;</td></tr>
<tr><th id="365">365</th><td>	spin_unlock(ptl);</td></tr>
<tr><th id="366">366</th><td>	put_and_wait_on_page_locked(page);</td></tr>
<tr><th id="367">367</th><td>	<b>return</b>;</td></tr>
<tr><th id="368">368</th><td>unlock:</td></tr>
<tr><th id="369">369</th><td>	spin_unlock(ptl);</td></tr>
<tr><th id="370">370</th><td>}</td></tr>
<tr><th id="371">371</th><td><u>#<span data-ppcond="353">endif</span></u></td></tr>
<tr><th id="372">372</th><td></td></tr>
<tr><th id="373">373</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="expected_page_refs" title='expected_page_refs' data-type='int expected_page_refs(struct address_space * mapping, struct page * page)' data-ref="expected_page_refs" data-ref-filename="expected_page_refs">expected_page_refs</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col2 decl" id="112mapping" title='mapping' data-type='struct address_space *' data-ref="112mapping" data-ref-filename="112mapping">mapping</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col3 decl" id="113page" title='page' data-type='struct page *' data-ref="113page" data-ref-filename="113page">page</dfn>)</td></tr>
<tr><th id="374">374</th><td>{</td></tr>
<tr><th id="375">375</th><td>	<em>int</em> <dfn class="local col4 decl" id="114expected_count" title='expected_count' data-type='int' data-ref="114expected_count" data-ref-filename="114expected_count">expected_count</dfn> = <var>1</var>;</td></tr>
<tr><th id="376">376</th><td></td></tr>
<tr><th id="377">377</th><td>	<i>/*</i></td></tr>
<tr><th id="378">378</th><td><i>	 * Device public or private pages have an extra refcount as they are</i></td></tr>
<tr><th id="379">379</th><td><i>	 * ZONE_DEVICE pages.</i></td></tr>
<tr><th id="380">380</th><td><i>	 */</i></td></tr>
<tr><th id="381">381</th><td>	<a class="local col4 ref" href="#114expected_count" title='expected_count' data-ref="114expected_count" data-ref-filename="114expected_count">expected_count</a> += <a class="ref fn" href="../include/linux/mm.h.html#is_device_private_page" title='is_device_private_page' data-ref="is_device_private_page" data-ref-filename="is_device_private_page">is_device_private_page</a>(<a class="local col3 ref" href="#113page" title='page' data-ref="113page" data-ref-filename="113page">page</a>);</td></tr>
<tr><th id="382">382</th><td>	<b>if</b> (<a class="local col2 ref" href="#112mapping" title='mapping' data-ref="112mapping" data-ref-filename="112mapping">mapping</a>)</td></tr>
<tr><th id="383">383</th><td>		<a class="local col4 ref" href="#114expected_count" title='expected_count' data-ref="114expected_count" data-ref-filename="114expected_count">expected_count</a> += <a class="macro" href="../include/linux/huge_mm.h.html#279" title="1" data-ref="_M/hpage_nr_pages">hpage_nr_pages</a>(page) + <a class="ref fn" href="../include/linux/page-flags.h.html#page_has_private" title='page_has_private' data-ref="page_has_private" data-ref-filename="page_has_private">page_has_private</a>(<a class="local col3 ref" href="#113page" title='page' data-ref="113page" data-ref-filename="113page">page</a>);</td></tr>
<tr><th id="384">384</th><td></td></tr>
<tr><th id="385">385</th><td>	<b>return</b> <a class="local col4 ref" href="#114expected_count" title='expected_count' data-ref="114expected_count" data-ref-filename="114expected_count">expected_count</a>;</td></tr>
<tr><th id="386">386</th><td>}</td></tr>
<tr><th id="387">387</th><td></td></tr>
<tr><th id="388">388</th><td><i>/*</i></td></tr>
<tr><th id="389">389</th><td><i> * Replace the page in the mapping.</i></td></tr>
<tr><th id="390">390</th><td><i> *</i></td></tr>
<tr><th id="391">391</th><td><i> * The number of remaining references must be:</i></td></tr>
<tr><th id="392">392</th><td><i> * 1 for anonymous pages without a mapping</i></td></tr>
<tr><th id="393">393</th><td><i> * 2 for pages with a mapping</i></td></tr>
<tr><th id="394">394</th><td><i> * 3 for pages with a mapping and PagePrivate/PagePrivate2 set.</i></td></tr>
<tr><th id="395">395</th><td><i> */</i></td></tr>
<tr><th id="396">396</th><td><em>int</em> <dfn class="decl def fn" id="migrate_page_move_mapping" title='migrate_page_move_mapping' data-ref="migrate_page_move_mapping" data-ref-filename="migrate_page_move_mapping">migrate_page_move_mapping</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col5 decl" id="115mapping" title='mapping' data-type='struct address_space *' data-ref="115mapping" data-ref-filename="115mapping">mapping</dfn>,</td></tr>
<tr><th id="397">397</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col6 decl" id="116newpage" title='newpage' data-type='struct page *' data-ref="116newpage" data-ref-filename="116newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="117page" title='page' data-type='struct page *' data-ref="117page" data-ref-filename="117page">page</dfn>, <em>int</em> <dfn class="local col8 decl" id="118extra_count" title='extra_count' data-type='int' data-ref="118extra_count" data-ref-filename="118extra_count">extra_count</dfn>)</td></tr>
<tr><th id="398">398</th><td>{</td></tr>
<tr><th id="399">399</th><td>	<a class="macro" href="../include/linux/xarray.h.html#1311" title="struct xa_state xas = { .xa = &amp;mapping-&gt;i_pages, .xa_index = page_index(page), .xa_shift = 0, .xa_sibs = 0, .xa_offset = 0, .xa_pad = 0, .xa_node = ((struct xa_node *)3UL), .xa_alloc = ((void *)0), .xa_update = ((void *)0) }" data-ref="_M/XA_STATE">XA_STATE</a>(<dfn class="local col9 decl" id="119xas" title='xas' data-type='struct xa_state' data-ref="119xas" data-ref-filename="119xas">xas</dfn>, &amp;<a class="local col5 ref" href="#115mapping" title='mapping' data-ref="115mapping" data-ref-filename="115mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::i_pages" title='address_space::i_pages' data-ref="address_space::i_pages" data-ref-filename="address_space..i_pages">i_pages</a>, <a class="ref fn" href="../include/linux/mm.h.html#page_index" title='page_index' data-ref="page_index" data-ref-filename="page_index">page_index</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>));</td></tr>
<tr><th id="400">400</th><td>	<b>struct</b> <a class="type" href="../include/linux/mmzone.h.html#zone" title='zone' data-ref="zone" data-ref-filename="zone">zone</a> *<dfn class="local col0 decl" id="120oldzone" title='oldzone' data-type='struct zone *' data-ref="120oldzone" data-ref-filename="120oldzone">oldzone</dfn>, *<dfn class="local col1 decl" id="121newzone" title='newzone' data-type='struct zone *' data-ref="121newzone" data-ref-filename="121newzone">newzone</dfn>;</td></tr>
<tr><th id="401">401</th><td>	<em>int</em> <dfn class="local col2 decl" id="122dirty" title='dirty' data-type='int' data-ref="122dirty" data-ref-filename="122dirty">dirty</dfn>;</td></tr>
<tr><th id="402">402</th><td>	<em>int</em> <dfn class="local col3 decl" id="123expected_count" title='expected_count' data-type='int' data-ref="123expected_count" data-ref-filename="123expected_count">expected_count</dfn> = <a class="tu ref fn" href="#expected_page_refs" title='expected_page_refs' data-use='c' data-ref="expected_page_refs" data-ref-filename="expected_page_refs">expected_page_refs</a>(<a class="local col5 ref" href="#115mapping" title='mapping' data-ref="115mapping" data-ref-filename="115mapping">mapping</a>, <a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>) + <a class="local col8 ref" href="#118extra_count" title='extra_count' data-ref="118extra_count" data-ref-filename="118extra_count">extra_count</a>;</td></tr>
<tr><th id="403">403</th><td></td></tr>
<tr><th id="404">404</th><td>	<b>if</b> (!<a class="local col5 ref" href="#115mapping" title='mapping' data-ref="115mapping" data-ref-filename="115mapping">mapping</a>) {</td></tr>
<tr><th id="405">405</th><td>		<i>/* Anonymous page without mapping */</i></td></tr>
<tr><th id="406">406</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page_ref.h.html#page_count" title='page_count' data-ref="page_count" data-ref-filename="page_count">page_count</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>) != <a class="local col3 ref" href="#123expected_count" title='expected_count' data-ref="123expected_count" data-ref-filename="123expected_count">expected_count</a>)</td></tr>
<tr><th id="407">407</th><td>			<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="408">408</th><td></td></tr>
<tr><th id="409">409</th><td>		<i>/* No turning back from here */</i></td></tr>
<tr><th id="410">410</th><td>		<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::index" title='page::(anonymous union)::(anonymous struct)::index' data-ref="page::(anonymousunion)::(anonymous)::index" data-ref-filename="page..(anonymousunion)..(anonymous)..index">index</a> = <a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::index" title='page::(anonymous union)::(anonymous struct)::index' data-ref="page::(anonymousunion)::(anonymous)::index" data-ref-filename="page..(anonymousunion)..(anonymous)..index">index</a>;</td></tr>
<tr><th id="411">411</th><td>		<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a> = <a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a>;</td></tr>
<tr><th id="412">412</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#340" title='PageSwapBacked' data-ref="PageSwapBacked" data-ref-filename="PageSwapBacked">PageSwapBacked</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>))</td></tr>
<tr><th id="413">413</th><td>			<a class="ref fn" href="../include/linux/page-flags.h.html#342" title='__SetPageSwapBacked' data-ref="__SetPageSwapBacked" data-ref-filename="__SetPageSwapBacked">__SetPageSwapBacked</a>(<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>);</td></tr>
<tr><th id="414">414</th><td></td></tr>
<tr><th id="415">415</th><td>		<b>return</b> <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>;</td></tr>
<tr><th id="416">416</th><td>	}</td></tr>
<tr><th id="417">417</th><td></td></tr>
<tr><th id="418">418</th><td>	<a class="local col0 ref" href="#120oldzone" title='oldzone' data-ref="120oldzone" data-ref-filename="120oldzone">oldzone</a> = <a class="ref fn" href="../include/linux/mm.h.html#page_zone" title='page_zone' data-ref="page_zone" data-ref-filename="page_zone">page_zone</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>);</td></tr>
<tr><th id="419">419</th><td>	<a class="local col1 ref" href="#121newzone" title='newzone' data-ref="121newzone" data-ref-filename="121newzone">newzone</a> = <a class="ref fn" href="../include/linux/mm.h.html#page_zone" title='page_zone' data-ref="page_zone" data-ref-filename="page_zone">page_zone</a>(<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>);</td></tr>
<tr><th id="420">420</th><td></td></tr>
<tr><th id="421">421</th><td>	<a class="macro" href="../include/linux/xarray.h.html#1337" title="spin_lock_irq(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_lock_irq">xas_lock_irq</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>);</td></tr>
<tr><th id="422">422</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page_ref.h.html#page_count" title='page_count' data-ref="page_count" data-ref-filename="page_count">page_count</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>) != <a class="local col3 ref" href="#123expected_count" title='expected_count' data-ref="123expected_count" data-ref-filename="123expected_count">expected_count</a> || <a class="ref fn" href="../include/linux/xarray.h.html#xas_load" title='xas_load' data-ref="xas_load" data-ref-filename="xas_load">xas_load</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>) != <a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>) {</td></tr>
<tr><th id="423">423</th><td>		<a class="macro" href="../include/linux/xarray.h.html#1338" title="spin_unlock_irq(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_unlock_irq">xas_unlock_irq</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>);</td></tr>
<tr><th id="424">424</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="425">425</th><td>	}</td></tr>
<tr><th id="426">426</th><td></td></tr>
<tr><th id="427">427</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/page_ref.h.html#page_ref_freeze" title='page_ref_freeze' data-ref="page_ref_freeze" data-ref-filename="page_ref_freeze">page_ref_freeze</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>, <a class="local col3 ref" href="#123expected_count" title='expected_count' data-ref="123expected_count" data-ref-filename="123expected_count">expected_count</a>)) {</td></tr>
<tr><th id="428">428</th><td>		<a class="macro" href="../include/linux/xarray.h.html#1338" title="spin_unlock_irq(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_unlock_irq">xas_unlock_irq</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>);</td></tr>
<tr><th id="429">429</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="430">430</th><td>	}</td></tr>
<tr><th id="431">431</th><td></td></tr>
<tr><th id="432">432</th><td>	<i>/*</i></td></tr>
<tr><th id="433">433</th><td><i>	 * Now we know that no one else is looking at the page:</i></td></tr>
<tr><th id="434">434</th><td><i>	 * no turning back from here.</i></td></tr>
<tr><th id="435">435</th><td><i>	 */</i></td></tr>
<tr><th id="436">436</th><td>	<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::index" title='page::(anonymous union)::(anonymous struct)::index' data-ref="page::(anonymousunion)::(anonymous)::index" data-ref-filename="page..(anonymousunion)..(anonymous)..index">index</a> = <a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::index" title='page::(anonymous union)::(anonymous struct)::index' data-ref="page::(anonymousunion)::(anonymous)::index" data-ref-filename="page..(anonymousunion)..(anonymous)..index">index</a>;</td></tr>
<tr><th id="437">437</th><td>	<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a> = <a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a>;</td></tr>
<tr><th id="438">438</th><td>	<a class="ref fn" href="../include/linux/page_ref.h.html#page_ref_add" title='page_ref_add' data-ref="page_ref_add" data-ref-filename="page_ref_add">page_ref_add</a>(<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>, <a class="macro" href="../include/linux/huge_mm.h.html#279" title="1" data-ref="_M/hpage_nr_pages">hpage_nr_pages</a>(page)); <i>/* add cache reference */</i></td></tr>
<tr><th id="439">439</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#340" title='PageSwapBacked' data-ref="PageSwapBacked" data-ref-filename="PageSwapBacked">PageSwapBacked</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>)) {</td></tr>
<tr><th id="440">440</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#342" title='__SetPageSwapBacked' data-ref="__SetPageSwapBacked" data-ref-filename="__SetPageSwapBacked">__SetPageSwapBacked</a>(<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>);</td></tr>
<tr><th id="441">441</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageSwapCache" title='PageSwapCache' data-ref="PageSwapCache" data-ref-filename="PageSwapCache">PageSwapCache</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>)) {</td></tr>
<tr><th id="442">442</th><td>			<a class="ref fn" href="../include/linux/page-flags.h.html#388" title='SetPageSwapCache' data-ref="SetPageSwapCache" data-ref-filename="SetPageSwapCache">SetPageSwapCache</a>(<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>);</td></tr>
<tr><th id="443">443</th><td>			<a class="macro" href="../include/linux/mm_types.h.html#233" title="((newpage)-&gt;private = (((page)-&gt;private)))" data-ref="_M/set_page_private">set_page_private</a>(<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>, <a class="macro" href="../include/linux/mm_types.h.html#232" title="((page)-&gt;private)" data-ref="_M/page_private">page_private</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>));</td></tr>
<tr><th id="444">444</th><td>		}</td></tr>
<tr><th id="445">445</th><td>	} <b>else</b> {</td></tr>
<tr><th id="446">446</th><td>		<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(PageSwapCache(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#PageSwapCache" title='PageSwapCache' data-ref="PageSwapCache" data-ref-filename="PageSwapCache">PageSwapCache</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>), page);</td></tr>
<tr><th id="447">447</th><td>	}</td></tr>
<tr><th id="448">448</th><td></td></tr>
<tr><th id="449">449</th><td>	<i>/* Move dirty while page refs frozen and newpage not yet exposed */</i></td></tr>
<tr><th id="450">450</th><td>	<a class="local col2 ref" href="#122dirty" title='dirty' data-ref="122dirty" data-ref-filename="122dirty">dirty</a> = <a class="ref fn" href="../include/linux/page-flags.h.html#318" title='PageDirty' data-ref="PageDirty" data-ref-filename="PageDirty">PageDirty</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>);</td></tr>
<tr><th id="451">451</th><td>	<b>if</b> (<a class="local col2 ref" href="#122dirty" title='dirty' data-ref="122dirty" data-ref-filename="122dirty">dirty</a>) {</td></tr>
<tr><th id="452">452</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#318" title='ClearPageDirty' data-ref="ClearPageDirty" data-ref-filename="ClearPageDirty">ClearPageDirty</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>);</td></tr>
<tr><th id="453">453</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#318" title='SetPageDirty' data-ref="SetPageDirty" data-ref-filename="SetPageDirty">SetPageDirty</a>(<a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>);</td></tr>
<tr><th id="454">454</th><td>	}</td></tr>
<tr><th id="455">455</th><td></td></tr>
<tr><th id="456">456</th><td>	<a class="ref fn" href="../include/linux/xarray.h.html#xas_store" title='xas_store' data-ref="xas_store" data-ref-filename="xas_store">xas_store</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>, <a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a>);</td></tr>
<tr><th id="457">457</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#685" title='PageTransHuge' data-ref="PageTransHuge" data-ref-filename="PageTransHuge">PageTransHuge</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>)) {</td></tr>
<tr><th id="458">458</th><td>		<em>int</em> <dfn class="local col4 decl" id="124i" title='i' data-type='int' data-ref="124i" data-ref-filename="124i">i</dfn>;</td></tr>
<tr><th id="459">459</th><td></td></tr>
<tr><th id="460">460</th><td>		<b>for</b> (<a class="local col4 ref" href="#124i" title='i' data-ref="124i" data-ref-filename="124i">i</a> = <var>1</var>; <a class="local col4 ref" href="#124i" title='i' data-ref="124i" data-ref-filename="124i">i</a> &lt; <a class="macro" href="../include/linux/huge_mm.h.html#79" title="(1&lt;&lt;(({ do { extern void __compiletime_assert_460(void) ; if (!(!(1))) __compiletime_assert_460(); } while (0); 0; })-12))" data-ref="_M/HPAGE_PMD_NR">HPAGE_PMD_NR</a>; <a class="local col4 ref" href="#124i" title='i' data-ref="124i" data-ref-filename="124i">i</a>++) {</td></tr>
<tr><th id="461">461</th><td>			<a class="ref fn" href="../include/linux/xarray.h.html#xas_next" title='xas_next' data-ref="xas_next" data-ref-filename="xas_next">xas_next</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>);</td></tr>
<tr><th id="462">462</th><td>			<a class="ref fn" href="../include/linux/xarray.h.html#xas_store" title='xas_store' data-ref="xas_store" data-ref-filename="xas_store">xas_store</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>, <a class="local col6 ref" href="#116newpage" title='newpage' data-ref="116newpage" data-ref-filename="116newpage">newpage</a> + <a class="local col4 ref" href="#124i" title='i' data-ref="124i" data-ref-filename="124i">i</a>);</td></tr>
<tr><th id="463">463</th><td>		}</td></tr>
<tr><th id="464">464</th><td>	}</td></tr>
<tr><th id="465">465</th><td></td></tr>
<tr><th id="466">466</th><td>	<i>/*</i></td></tr>
<tr><th id="467">467</th><td><i>	 * Drop cache reference from old page by unfreezing</i></td></tr>
<tr><th id="468">468</th><td><i>	 * to one less reference.</i></td></tr>
<tr><th id="469">469</th><td><i>	 * We know this isn't the last reference.</i></td></tr>
<tr><th id="470">470</th><td><i>	 */</i></td></tr>
<tr><th id="471">471</th><td>	<a class="ref fn" href="../include/linux/page_ref.h.html#page_ref_unfreeze" title='page_ref_unfreeze' data-ref="page_ref_unfreeze" data-ref-filename="page_ref_unfreeze">page_ref_unfreeze</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>, <a class="local col3 ref" href="#123expected_count" title='expected_count' data-ref="123expected_count" data-ref-filename="123expected_count">expected_count</a> - <a class="macro" href="../include/linux/huge_mm.h.html#279" title="1" data-ref="_M/hpage_nr_pages">hpage_nr_pages</a>(page));</td></tr>
<tr><th id="472">472</th><td></td></tr>
<tr><th id="473">473</th><td>	<a class="macro" href="../include/linux/xarray.h.html#1334" title="spin_unlock(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_unlock">xas_unlock</a>(&amp;<a class="local col9 ref" href="#399" title='xas' data-ref="119xas" data-ref-filename="119xas">xas</a>);</td></tr>
<tr><th id="474">474</th><td>	<i>/* Leave irq disabled to prevent preemption while updating stats */</i></td></tr>
<tr><th id="475">475</th><td></td></tr>
<tr><th id="476">476</th><td>	<i>/*</i></td></tr>
<tr><th id="477">477</th><td><i>	 * If moved to a different zone then also account</i></td></tr>
<tr><th id="478">478</th><td><i>	 * the page for that zone. Other VM counters will be</i></td></tr>
<tr><th id="479">479</th><td><i>	 * taken care of when we establish references to the</i></td></tr>
<tr><th id="480">480</th><td><i>	 * new page and drop references to the old page.</i></td></tr>
<tr><th id="481">481</th><td><i>	 *</i></td></tr>
<tr><th id="482">482</th><td><i>	 * Note that anonymous pages are accounted for</i></td></tr>
<tr><th id="483">483</th><td><i>	 * via NR_FILE_PAGES and NR_ANON_MAPPED if they</i></td></tr>
<tr><th id="484">484</th><td><i>	 * are mapped to swap space.</i></td></tr>
<tr><th id="485">485</th><td><i>	 */</i></td></tr>
<tr><th id="486">486</th><td>	<b>if</b> (<a class="local col1 ref" href="#121newzone" title='newzone' data-ref="121newzone" data-ref-filename="121newzone">newzone</a> != <a class="local col0 ref" href="#120oldzone" title='oldzone' data-ref="120oldzone" data-ref-filename="120oldzone">oldzone</a>) {</td></tr>
<tr><th id="487">487</th><td>		<a class="ref fn" href="../include/linux/vmstat.h.html#__dec_node_state" title='__dec_node_state' data-ref="__dec_node_state" data-ref-filename="__dec_node_state">__dec_node_state</a>(<a class="local col0 ref" href="#120oldzone" title='oldzone' data-ref="120oldzone" data-ref-filename="120oldzone">oldzone</a>-&gt;<a class="ref field" href="../include/linux/mmzone.h.html#zone::zone_pgdat" title='zone::zone_pgdat' data-ref="zone::zone_pgdat" data-ref-filename="zone..zone_pgdat">zone_pgdat</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_FILE_PAGES" title='NR_FILE_PAGES' data-ref="NR_FILE_PAGES" data-ref-filename="NR_FILE_PAGES">NR_FILE_PAGES</a>);</td></tr>
<tr><th id="488">488</th><td>		<a class="ref fn" href="../include/linux/vmstat.h.html#__inc_node_state" title='__inc_node_state' data-ref="__inc_node_state" data-ref-filename="__inc_node_state">__inc_node_state</a>(<a class="local col1 ref" href="#121newzone" title='newzone' data-ref="121newzone" data-ref-filename="121newzone">newzone</a>-&gt;<a class="ref field" href="../include/linux/mmzone.h.html#zone::zone_pgdat" title='zone::zone_pgdat' data-ref="zone::zone_pgdat" data-ref-filename="zone..zone_pgdat">zone_pgdat</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_FILE_PAGES" title='NR_FILE_PAGES' data-ref="NR_FILE_PAGES" data-ref-filename="NR_FILE_PAGES">NR_FILE_PAGES</a>);</td></tr>
<tr><th id="489">489</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#340" title='PageSwapBacked' data-ref="PageSwapBacked" data-ref-filename="PageSwapBacked">PageSwapBacked</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>) &amp;&amp; !<a class="ref fn" href="../include/linux/page-flags.h.html#PageSwapCache" title='PageSwapCache' data-ref="PageSwapCache" data-ref-filename="PageSwapCache">PageSwapCache</a>(<a class="local col7 ref" href="#117page" title='page' data-ref="117page" data-ref-filename="117page">page</a>)) {</td></tr>
<tr><th id="490">490</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#__dec_node_state" title='__dec_node_state' data-ref="__dec_node_state" data-ref-filename="__dec_node_state">__dec_node_state</a>(<a class="local col0 ref" href="#120oldzone" title='oldzone' data-ref="120oldzone" data-ref-filename="120oldzone">oldzone</a>-&gt;<a class="ref field" href="../include/linux/mmzone.h.html#zone::zone_pgdat" title='zone::zone_pgdat' data-ref="zone::zone_pgdat" data-ref-filename="zone..zone_pgdat">zone_pgdat</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_SHMEM" title='NR_SHMEM' data-ref="NR_SHMEM" data-ref-filename="NR_SHMEM">NR_SHMEM</a>);</td></tr>
<tr><th id="491">491</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#__inc_node_state" title='__inc_node_state' data-ref="__inc_node_state" data-ref-filename="__inc_node_state">__inc_node_state</a>(<a class="local col1 ref" href="#121newzone" title='newzone' data-ref="121newzone" data-ref-filename="121newzone">newzone</a>-&gt;<a class="ref field" href="../include/linux/mmzone.h.html#zone::zone_pgdat" title='zone::zone_pgdat' data-ref="zone::zone_pgdat" data-ref-filename="zone..zone_pgdat">zone_pgdat</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_SHMEM" title='NR_SHMEM' data-ref="NR_SHMEM" data-ref-filename="NR_SHMEM">NR_SHMEM</a>);</td></tr>
<tr><th id="492">492</th><td>		}</td></tr>
<tr><th id="493">493</th><td>		<b>if</b> (<a class="local col2 ref" href="#122dirty" title='dirty' data-ref="122dirty" data-ref-filename="122dirty">dirty</a> &amp;&amp; <a class="ref fn" href="../include/linux/backing-dev.h.html#mapping_cap_account_dirty" title='mapping_cap_account_dirty' data-ref="mapping_cap_account_dirty" data-ref-filename="mapping_cap_account_dirty">mapping_cap_account_dirty</a>(<a class="local col5 ref" href="#115mapping" title='mapping' data-ref="115mapping" data-ref-filename="115mapping">mapping</a>)) {</td></tr>
<tr><th id="494">494</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#__dec_node_state" title='__dec_node_state' data-ref="__dec_node_state" data-ref-filename="__dec_node_state">__dec_node_state</a>(<a class="local col0 ref" href="#120oldzone" title='oldzone' data-ref="120oldzone" data-ref-filename="120oldzone">oldzone</a>-&gt;<a class="ref field" href="../include/linux/mmzone.h.html#zone::zone_pgdat" title='zone::zone_pgdat' data-ref="zone::zone_pgdat" data-ref-filename="zone..zone_pgdat">zone_pgdat</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_FILE_DIRTY" title='NR_FILE_DIRTY' data-ref="NR_FILE_DIRTY" data-ref-filename="NR_FILE_DIRTY">NR_FILE_DIRTY</a>);</td></tr>
<tr><th id="495">495</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#__dec_zone_state" title='__dec_zone_state' data-ref="__dec_zone_state" data-ref-filename="__dec_zone_state">__dec_zone_state</a>(<a class="local col0 ref" href="#120oldzone" title='oldzone' data-ref="120oldzone" data-ref-filename="120oldzone">oldzone</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_ZONE_WRITE_PENDING" title='NR_ZONE_WRITE_PENDING' data-ref="NR_ZONE_WRITE_PENDING" data-ref-filename="NR_ZONE_WRITE_PENDING">NR_ZONE_WRITE_PENDING</a>);</td></tr>
<tr><th id="496">496</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#__inc_node_state" title='__inc_node_state' data-ref="__inc_node_state" data-ref-filename="__inc_node_state">__inc_node_state</a>(<a class="local col1 ref" href="#121newzone" title='newzone' data-ref="121newzone" data-ref-filename="121newzone">newzone</a>-&gt;<a class="ref field" href="../include/linux/mmzone.h.html#zone::zone_pgdat" title='zone::zone_pgdat' data-ref="zone::zone_pgdat" data-ref-filename="zone..zone_pgdat">zone_pgdat</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_FILE_DIRTY" title='NR_FILE_DIRTY' data-ref="NR_FILE_DIRTY" data-ref-filename="NR_FILE_DIRTY">NR_FILE_DIRTY</a>);</td></tr>
<tr><th id="497">497</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#__inc_zone_state" title='__inc_zone_state' data-ref="__inc_zone_state" data-ref-filename="__inc_zone_state">__inc_zone_state</a>(<a class="local col1 ref" href="#121newzone" title='newzone' data-ref="121newzone" data-ref-filename="121newzone">newzone</a>, <a class="enum" href="../include/linux/mmzone.h.html#NR_ZONE_WRITE_PENDING" title='NR_ZONE_WRITE_PENDING' data-ref="NR_ZONE_WRITE_PENDING" data-ref-filename="NR_ZONE_WRITE_PENDING">NR_ZONE_WRITE_PENDING</a>);</td></tr>
<tr><th id="498">498</th><td>		}</td></tr>
<tr><th id="499">499</th><td>	}</td></tr>
<tr><th id="500">500</th><td>	<a class="macro" href="../include/linux/irqflags.h.html#140" title="do { arch_local_irq_enable(); } while (0)" data-ref="_M/local_irq_enable">local_irq_enable</a>();</td></tr>
<tr><th id="501">501</th><td></td></tr>
<tr><th id="502">502</th><td>	<b>return</b> <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>;</td></tr>
<tr><th id="503">503</th><td>}</td></tr>
<tr><th id="504">504</th><td><a class="macro" href="../include/linux/export.h.html#123" title="extern typeof(migrate_page_move_mapping) migrate_page_move_mapping; static const char __kstrtab_migrate_page_move_mapping[] __attribute__((section(&quot;__ksymtab_strings&quot;), used, aligned(1))) = &quot;migrate_page_move_mapping&quot;; static void * __attribute__((__section__(&quot;.discard.addressable&quot;))) __attribute__((__used__)) __addressable_migrate_page_move_mapping504 = (void *)&amp;migrate_page_move_mapping; asm(&quot;	.section \&quot;___ksymtab&quot; &quot;&quot; &quot;+&quot; &quot;migrate_page_move_mapping&quot; &quot;\&quot;, \&quot;a\&quot;	\n&quot; &quot;	.balign	8					\n&quot; &quot;__ksymtab_&quot; &quot;migrate_page_move_mapping&quot; &quot;:				\n&quot; &quot;	.long	&quot; &quot;migrate_page_move_mapping&quot; &quot;- .				\n&quot; &quot;	.long	__kstrtab_&quot; &quot;migrate_page_move_mapping&quot; &quot;- .			\n&quot; &quot;	.previous					\n&quot;)" data-ref="_M/EXPORT_SYMBOL">EXPORT_SYMBOL</a>(<a class="decl fn" href="#migrate_page_move_mapping" title='migrate_page_move_mapping' data-ref="migrate_page_move_mapping" data-ref-filename="migrate_page_move_mapping"><a class="ref fn" href="#migrate_page_move_mapping" title='migrate_page_move_mapping' data-ref="migrate_page_move_mapping" data-ref-filename="migrate_page_move_mapping"><a class="ref fn" href="#migrate_page_move_mapping" title='migrate_page_move_mapping' data-ref="migrate_page_move_mapping" data-ref-filename="migrate_page_move_mapping">migrate_page_move_mapping</a></a></a>);</td></tr>
<tr><th id="505">505</th><td></td></tr>
<tr><th id="506">506</th><td><i>/*</i></td></tr>
<tr><th id="507">507</th><td><i> * The expected number of remaining references is the same as that</i></td></tr>
<tr><th id="508">508</th><td><i> * of migrate_page_move_mapping().</i></td></tr>
<tr><th id="509">509</th><td><i> */</i></td></tr>
<tr><th id="510">510</th><td><em>int</em> <dfn class="decl def fn" id="migrate_huge_page_move_mapping" title='migrate_huge_page_move_mapping' data-ref="migrate_huge_page_move_mapping" data-ref-filename="migrate_huge_page_move_mapping">migrate_huge_page_move_mapping</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col5 decl" id="125mapping" title='mapping' data-type='struct address_space *' data-ref="125mapping" data-ref-filename="125mapping">mapping</dfn>,</td></tr>
<tr><th id="511">511</th><td>				   <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col6 decl" id="126newpage" title='newpage' data-type='struct page *' data-ref="126newpage" data-ref-filename="126newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="127page" title='page' data-type='struct page *' data-ref="127page" data-ref-filename="127page">page</dfn>)</td></tr>
<tr><th id="512">512</th><td>{</td></tr>
<tr><th id="513">513</th><td>	<a class="macro" href="../include/linux/xarray.h.html#1311" title="struct xa_state xas = { .xa = &amp;mapping-&gt;i_pages, .xa_index = page_index(page), .xa_shift = 0, .xa_sibs = 0, .xa_offset = 0, .xa_pad = 0, .xa_node = ((struct xa_node *)3UL), .xa_alloc = ((void *)0), .xa_update = ((void *)0) }" data-ref="_M/XA_STATE">XA_STATE</a>(<dfn class="local col8 decl" id="128xas" title='xas' data-type='struct xa_state' data-ref="128xas" data-ref-filename="128xas">xas</dfn>, &amp;<a class="local col5 ref" href="#125mapping" title='mapping' data-ref="125mapping" data-ref-filename="125mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::i_pages" title='address_space::i_pages' data-ref="address_space::i_pages" data-ref-filename="address_space..i_pages">i_pages</a>, <a class="ref fn" href="../include/linux/mm.h.html#page_index" title='page_index' data-ref="page_index" data-ref-filename="page_index">page_index</a>(<a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>));</td></tr>
<tr><th id="514">514</th><td>	<em>int</em> <dfn class="local col9 decl" id="129expected_count" title='expected_count' data-type='int' data-ref="129expected_count" data-ref-filename="129expected_count">expected_count</dfn>;</td></tr>
<tr><th id="515">515</th><td></td></tr>
<tr><th id="516">516</th><td>	<a class="macro" href="../include/linux/xarray.h.html#1337" title="spin_lock_irq(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_lock_irq">xas_lock_irq</a>(&amp;<a class="local col8 ref" href="#513" title='xas' data-ref="128xas" data-ref-filename="128xas">xas</a>);</td></tr>
<tr><th id="517">517</th><td>	<a class="local col9 ref" href="#129expected_count" title='expected_count' data-ref="129expected_count" data-ref-filename="129expected_count">expected_count</a> = <var>2</var> + <a class="ref fn" href="../include/linux/page-flags.h.html#page_has_private" title='page_has_private' data-ref="page_has_private" data-ref-filename="page_has_private">page_has_private</a>(<a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>);</td></tr>
<tr><th id="518">518</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page_ref.h.html#page_count" title='page_count' data-ref="page_count" data-ref-filename="page_count">page_count</a>(<a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>) != <a class="local col9 ref" href="#129expected_count" title='expected_count' data-ref="129expected_count" data-ref-filename="129expected_count">expected_count</a> || <a class="ref fn" href="../include/linux/xarray.h.html#xas_load" title='xas_load' data-ref="xas_load" data-ref-filename="xas_load">xas_load</a>(&amp;<a class="local col8 ref" href="#513" title='xas' data-ref="128xas" data-ref-filename="128xas">xas</a>) != <a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>) {</td></tr>
<tr><th id="519">519</th><td>		<a class="macro" href="../include/linux/xarray.h.html#1338" title="spin_unlock_irq(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_unlock_irq">xas_unlock_irq</a>(&amp;<a class="local col8 ref" href="#513" title='xas' data-ref="128xas" data-ref-filename="128xas">xas</a>);</td></tr>
<tr><th id="520">520</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="521">521</th><td>	}</td></tr>
<tr><th id="522">522</th><td></td></tr>
<tr><th id="523">523</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/page_ref.h.html#page_ref_freeze" title='page_ref_freeze' data-ref="page_ref_freeze" data-ref-filename="page_ref_freeze">page_ref_freeze</a>(<a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>, <a class="local col9 ref" href="#129expected_count" title='expected_count' data-ref="129expected_count" data-ref-filename="129expected_count">expected_count</a>)) {</td></tr>
<tr><th id="524">524</th><td>		<a class="macro" href="../include/linux/xarray.h.html#1338" title="spin_unlock_irq(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_unlock_irq">xas_unlock_irq</a>(&amp;<a class="local col8 ref" href="#513" title='xas' data-ref="128xas" data-ref-filename="128xas">xas</a>);</td></tr>
<tr><th id="525">525</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="526">526</th><td>	}</td></tr>
<tr><th id="527">527</th><td></td></tr>
<tr><th id="528">528</th><td>	<a class="local col6 ref" href="#126newpage" title='newpage' data-ref="126newpage" data-ref-filename="126newpage">newpage</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::index" title='page::(anonymous union)::(anonymous struct)::index' data-ref="page::(anonymousunion)::(anonymous)::index" data-ref-filename="page..(anonymousunion)..(anonymous)..index">index</a> = <a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::index" title='page::(anonymous union)::(anonymous struct)::index' data-ref="page::(anonymousunion)::(anonymous)::index" data-ref-filename="page..(anonymousunion)..(anonymous)..index">index</a>;</td></tr>
<tr><th id="529">529</th><td>	<a class="local col6 ref" href="#126newpage" title='newpage' data-ref="126newpage" data-ref-filename="126newpage">newpage</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a> = <a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a>;</td></tr>
<tr><th id="530">530</th><td></td></tr>
<tr><th id="531">531</th><td>	<a class="ref fn" href="../include/linux/mm.h.html#get_page" title='get_page' data-ref="get_page" data-ref-filename="get_page">get_page</a>(<a class="local col6 ref" href="#126newpage" title='newpage' data-ref="126newpage" data-ref-filename="126newpage">newpage</a>);</td></tr>
<tr><th id="532">532</th><td></td></tr>
<tr><th id="533">533</th><td>	<a class="ref fn" href="../include/linux/xarray.h.html#xas_store" title='xas_store' data-ref="xas_store" data-ref-filename="xas_store">xas_store</a>(&amp;<a class="local col8 ref" href="#513" title='xas' data-ref="128xas" data-ref-filename="128xas">xas</a>, <a class="local col6 ref" href="#126newpage" title='newpage' data-ref="126newpage" data-ref-filename="126newpage">newpage</a>);</td></tr>
<tr><th id="534">534</th><td></td></tr>
<tr><th id="535">535</th><td>	<a class="ref fn" href="../include/linux/page_ref.h.html#page_ref_unfreeze" title='page_ref_unfreeze' data-ref="page_ref_unfreeze" data-ref-filename="page_ref_unfreeze">page_ref_unfreeze</a>(<a class="local col7 ref" href="#127page" title='page' data-ref="127page" data-ref-filename="127page">page</a>, <a class="local col9 ref" href="#129expected_count" title='expected_count' data-ref="129expected_count" data-ref-filename="129expected_count">expected_count</a> - <var>1</var>);</td></tr>
<tr><th id="536">536</th><td></td></tr>
<tr><th id="537">537</th><td>	<a class="macro" href="../include/linux/xarray.h.html#1338" title="spin_unlock_irq(&amp;((&amp;xas)-&gt;xa)-&gt;xa_lock)" data-ref="_M/xas_unlock_irq">xas_unlock_irq</a>(&amp;<a class="local col8 ref" href="#513" title='xas' data-ref="128xas" data-ref-filename="128xas">xas</a>);</td></tr>
<tr><th id="538">538</th><td></td></tr>
<tr><th id="539">539</th><td>	<b>return</b> <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>;</td></tr>
<tr><th id="540">540</th><td>}</td></tr>
<tr><th id="541">541</th><td></td></tr>
<tr><th id="542">542</th><td><i  data-doc="__copy_gigantic_page">/*</i></td></tr>
<tr><th id="543">543</th><td><i  data-doc="__copy_gigantic_page"> * Gigantic pages are so large that we do not guarantee that page++ pointer</i></td></tr>
<tr><th id="544">544</th><td><i  data-doc="__copy_gigantic_page"> * arithmetic will work across the entire page.  We need something more</i></td></tr>
<tr><th id="545">545</th><td><i  data-doc="__copy_gigantic_page"> * specialized.</i></td></tr>
<tr><th id="546">546</th><td><i  data-doc="__copy_gigantic_page"> */</i></td></tr>
<tr><th id="547">547</th><td><em>static</em> <em>void</em> <dfn class="tu decl def fn" id="__copy_gigantic_page" title='__copy_gigantic_page' data-type='void __copy_gigantic_page(struct page * dst, struct page * src, int nr_pages)' data-ref="__copy_gigantic_page" data-ref-filename="__copy_gigantic_page">__copy_gigantic_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col0 decl" id="130dst" title='dst' data-type='struct page *' data-ref="130dst" data-ref-filename="130dst">dst</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col1 decl" id="131src" title='src' data-type='struct page *' data-ref="131src" data-ref-filename="131src">src</dfn>,</td></tr>
<tr><th id="548">548</th><td>				<em>int</em> <dfn class="local col2 decl" id="132nr_pages" title='nr_pages' data-type='int' data-ref="132nr_pages" data-ref-filename="132nr_pages">nr_pages</dfn>)</td></tr>
<tr><th id="549">549</th><td>{</td></tr>
<tr><th id="550">550</th><td>	<em>int</em> <dfn class="local col3 decl" id="133i" title='i' data-type='int' data-ref="133i" data-ref-filename="133i">i</dfn>;</td></tr>
<tr><th id="551">551</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col4 decl" id="134dst_base" title='dst_base' data-type='struct page *' data-ref="134dst_base" data-ref-filename="134dst_base">dst_base</dfn> = <a class="local col0 ref" href="#130dst" title='dst' data-ref="130dst" data-ref-filename="130dst">dst</a>;</td></tr>
<tr><th id="552">552</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col5 decl" id="135src_base" title='src_base' data-type='struct page *' data-ref="135src_base" data-ref-filename="135src_base">src_base</dfn> = <a class="local col1 ref" href="#131src" title='src' data-ref="131src" data-ref-filename="131src">src</a>;</td></tr>
<tr><th id="553">553</th><td></td></tr>
<tr><th id="554">554</th><td>	<b>for</b> (<a class="local col3 ref" href="#133i" title='i' data-ref="133i" data-ref-filename="133i">i</a> = <var>0</var>; <a class="local col3 ref" href="#133i" title='i' data-ref="133i" data-ref-filename="133i">i</a> &lt; <a class="local col2 ref" href="#132nr_pages" title='nr_pages' data-ref="132nr_pages" data-ref-filename="132nr_pages">nr_pages</a>; ) {</td></tr>
<tr><th id="555">555</th><td>		<a class="macro" href="../include/linux/sched.h.html#1776" title="({ ___might_sleep(&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;, 555, 0); _cond_resched(); })" data-ref="_M/cond_resched">cond_resched</a>();</td></tr>
<tr><th id="556">556</th><td>		<a class="ref fn" href="../include/linux/highmem.h.html#copy_highpage" title='copy_highpage' data-ref="copy_highpage" data-ref-filename="copy_highpage">copy_highpage</a>(<a class="local col0 ref" href="#130dst" title='dst' data-ref="130dst" data-ref-filename="130dst">dst</a>, <a class="local col1 ref" href="#131src" title='src' data-ref="131src" data-ref-filename="131src">src</a>);</td></tr>
<tr><th id="557">557</th><td></td></tr>
<tr><th id="558">558</th><td>		<a class="local col3 ref" href="#133i" title='i' data-ref="133i" data-ref-filename="133i">i</a>++;</td></tr>
<tr><th id="559">559</th><td>		<a class="local col0 ref" href="#130dst" title='dst' data-ref="130dst" data-ref-filename="130dst">dst</a> = <a class="ref fn" href="internal.h.html#mem_map_next" title='mem_map_next' data-ref="mem_map_next" data-ref-filename="mem_map_next">mem_map_next</a>(<a class="local col0 ref" href="#130dst" title='dst' data-ref="130dst" data-ref-filename="130dst">dst</a>, <a class="local col4 ref" href="#134dst_base" title='dst_base' data-ref="134dst_base" data-ref-filename="134dst_base">dst_base</a>, <a class="local col3 ref" href="#133i" title='i' data-ref="133i" data-ref-filename="133i">i</a>);</td></tr>
<tr><th id="560">560</th><td>		<a class="local col1 ref" href="#131src" title='src' data-ref="131src" data-ref-filename="131src">src</a> = <a class="ref fn" href="internal.h.html#mem_map_next" title='mem_map_next' data-ref="mem_map_next" data-ref-filename="mem_map_next">mem_map_next</a>(<a class="local col1 ref" href="#131src" title='src' data-ref="131src" data-ref-filename="131src">src</a>, <a class="local col5 ref" href="#135src_base" title='src_base' data-ref="135src_base" data-ref-filename="135src_base">src_base</a>, <a class="local col3 ref" href="#133i" title='i' data-ref="133i" data-ref-filename="133i">i</a>);</td></tr>
<tr><th id="561">561</th><td>	}</td></tr>
<tr><th id="562">562</th><td>}</td></tr>
<tr><th id="563">563</th><td></td></tr>
<tr><th id="564">564</th><td><em>static</em> <em>void</em> <dfn class="tu decl def fn" id="copy_huge_page" title='copy_huge_page' data-type='void copy_huge_page(struct page * dst, struct page * src)' data-ref="copy_huge_page" data-ref-filename="copy_huge_page">copy_huge_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col6 decl" id="136dst" title='dst' data-type='struct page *' data-ref="136dst" data-ref-filename="136dst">dst</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="137src" title='src' data-type='struct page *' data-ref="137src" data-ref-filename="137src">src</dfn>)</td></tr>
<tr><th id="565">565</th><td>{</td></tr>
<tr><th id="566">566</th><td>	<em>int</em> <dfn class="local col8 decl" id="138i" title='i' data-type='int' data-ref="138i" data-ref-filename="138i">i</dfn>;</td></tr>
<tr><th id="567">567</th><td>	<em>int</em> <dfn class="local col9 decl" id="139nr_pages" title='nr_pages' data-type='int' data-ref="139nr_pages" data-ref-filename="139nr_pages">nr_pages</dfn>;</td></tr>
<tr><th id="568">568</th><td></td></tr>
<tr><th id="569">569</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageHuge" title='PageHuge' data-ref="PageHuge" data-ref-filename="PageHuge">PageHuge</a>(<a class="local col7 ref" href="#137src" title='src' data-ref="137src" data-ref-filename="137src">src</a>)) {</td></tr>
<tr><th id="570">570</th><td>		<i>/* hugetlbfs page */</i></td></tr>
<tr><th id="571">571</th><td>		<b>struct</b> <a class="type" href="../include/linux/hugetlb.h.html#hstate" title='hstate' data-ref="hstate" data-ref-filename="hstate">hstate</a> *<dfn class="local col0 decl" id="140h" title='h' data-type='struct hstate *' data-ref="140h" data-ref-filename="140h">h</dfn> = <a class="ref fn" href="../include/linux/hugetlb.h.html#page_hstate" title='page_hstate' data-ref="page_hstate" data-ref-filename="page_hstate">page_hstate</a>(<a class="local col7 ref" href="#137src" title='src' data-ref="137src" data-ref-filename="137src">src</a>);</td></tr>
<tr><th id="572">572</th><td>		<a class="local col9 ref" href="#139nr_pages" title='nr_pages' data-ref="139nr_pages" data-ref-filename="139nr_pages">nr_pages</a> = <a class="ref fn" href="../include/linux/hugetlb.h.html#pages_per_huge_page" title='pages_per_huge_page' data-ref="pages_per_huge_page" data-ref-filename="pages_per_huge_page">pages_per_huge_page</a>(<a class="local col0 ref" href="#140h" title='h' data-ref="140h" data-ref-filename="140h">h</a>);</td></tr>
<tr><th id="573">573</th><td></td></tr>
<tr><th id="574">574</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(nr_pages &gt; (1 &lt;&lt; (11 - 1))), 0)" data-ref="_M/unlikely">unlikely</a>(<a class="local col9 ref" href="#139nr_pages" title='nr_pages' data-ref="139nr_pages" data-ref-filename="139nr_pages">nr_pages</a> &gt; <a class="macro" href="../include/linux/mmzone.h.html#31" title="(1 &lt;&lt; (11 - 1))" data-ref="_M/MAX_ORDER_NR_PAGES">MAX_ORDER_NR_PAGES</a>)) {</td></tr>
<tr><th id="575">575</th><td>			<a class="tu ref fn" href="#__copy_gigantic_page" title='__copy_gigantic_page' data-use='c' data-ref="__copy_gigantic_page" data-ref-filename="__copy_gigantic_page">__copy_gigantic_page</a>(<a class="local col6 ref" href="#136dst" title='dst' data-ref="136dst" data-ref-filename="136dst">dst</a>, <a class="local col7 ref" href="#137src" title='src' data-ref="137src" data-ref-filename="137src">src</a>, <a class="local col9 ref" href="#139nr_pages" title='nr_pages' data-ref="139nr_pages" data-ref-filename="139nr_pages">nr_pages</a>);</td></tr>
<tr><th id="576">576</th><td>			<b>return</b>;</td></tr>
<tr><th id="577">577</th><td>		}</td></tr>
<tr><th id="578">578</th><td>	} <b>else</b> {</td></tr>
<tr><th id="579">579</th><td>		<i>/* thp page */</i></td></tr>
<tr><th id="580">580</th><td>		<a class="macro" href="../include/asm-generic/bug.h.html#61" title="do { if (__builtin_expect(!!(!PageTransHuge(src)), 0)) do { do { asm volatile(&quot;1:\t&quot; &quot;.byte 0x0f, 0x0b&quot; &quot;\n&quot; &quot;.pushsection __bug_table,\&quot;aw\&quot;\n&quot; &quot;2:\t&quot; &quot;.long &quot; &quot;1b&quot; &quot; - 2b&quot; &quot;\t# bug_entry::bug_addr\n&quot; &quot;\t&quot; &quot;.long &quot; &quot;%c0&quot; &quot; - 2b&quot; &quot;\t# bug_entry::file\n&quot; &quot;\t.word %c1&quot; &quot;\t# bug_entry::line\n&quot; &quot;\t.word %c2&quot; &quot;\t# bug_entry::flags\n&quot; &quot;\t.org 2b+%c3\n&quot; &quot;.popsection&quot; : : &quot;i&quot; (&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;), &quot;i&quot; (580), &quot;i&quot; (0), &quot;i&quot; (sizeof(struct bug_entry))); } while (0); do { ({ asm volatile(&quot;%c0:\n\t&quot; &quot;.pushsection .discard.unreachable\n\t&quot; &quot;.long %c0b - .\n\t&quot; &quot;.popsection\n\t&quot; : : &quot;i&quot; (108)); }); __builtin_unreachable(); } while (0); } while (0); } while (0)" data-ref="_M/BUG_ON">BUG_ON</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#685" title='PageTransHuge' data-ref="PageTransHuge" data-ref-filename="PageTransHuge">PageTransHuge</a>(<a class="local col7 ref" href="#137src" title='src' data-ref="137src" data-ref-filename="137src">src</a>));</td></tr>
<tr><th id="581">581</th><td>		<a class="local col9 ref" href="#139nr_pages" title='nr_pages' data-ref="139nr_pages" data-ref-filename="139nr_pages">nr_pages</a> = <a class="macro" href="../include/linux/huge_mm.h.html#279" title="1" data-ref="_M/hpage_nr_pages">hpage_nr_pages</a>(src);</td></tr>
<tr><th id="582">582</th><td>	}</td></tr>
<tr><th id="583">583</th><td></td></tr>
<tr><th id="584">584</th><td>	<b>for</b> (<a class="local col8 ref" href="#138i" title='i' data-ref="138i" data-ref-filename="138i">i</a> = <var>0</var>; <a class="local col8 ref" href="#138i" title='i' data-ref="138i" data-ref-filename="138i">i</a> &lt; <a class="local col9 ref" href="#139nr_pages" title='nr_pages' data-ref="139nr_pages" data-ref-filename="139nr_pages">nr_pages</a>; <a class="local col8 ref" href="#138i" title='i' data-ref="138i" data-ref-filename="138i">i</a>++) {</td></tr>
<tr><th id="585">585</th><td>		<a class="macro" href="../include/linux/sched.h.html#1776" title="({ ___might_sleep(&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;, 585, 0); _cond_resched(); })" data-ref="_M/cond_resched">cond_resched</a>();</td></tr>
<tr><th id="586">586</th><td>		<a class="ref fn" href="../include/linux/highmem.h.html#copy_highpage" title='copy_highpage' data-ref="copy_highpage" data-ref-filename="copy_highpage">copy_highpage</a>(<a class="local col6 ref" href="#136dst" title='dst' data-ref="136dst" data-ref-filename="136dst">dst</a> + <a class="local col8 ref" href="#138i" title='i' data-ref="138i" data-ref-filename="138i">i</a>, <a class="local col7 ref" href="#137src" title='src' data-ref="137src" data-ref-filename="137src">src</a> + <a class="local col8 ref" href="#138i" title='i' data-ref="138i" data-ref-filename="138i">i</a>);</td></tr>
<tr><th id="587">587</th><td>	}</td></tr>
<tr><th id="588">588</th><td>}</td></tr>
<tr><th id="589">589</th><td></td></tr>
<tr><th id="590">590</th><td><i>/*</i></td></tr>
<tr><th id="591">591</th><td><i> * Copy the page to its new location</i></td></tr>
<tr><th id="592">592</th><td><i> */</i></td></tr>
<tr><th id="593">593</th><td><em>void</em> <dfn class="decl def fn" id="migrate_page_states" title='migrate_page_states' data-ref="migrate_page_states" data-ref-filename="migrate_page_states">migrate_page_states</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col1 decl" id="141newpage" title='newpage' data-type='struct page *' data-ref="141newpage" data-ref-filename="141newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col2 decl" id="142page" title='page' data-type='struct page *' data-ref="142page" data-ref-filename="142page">page</dfn>)</td></tr>
<tr><th id="594">594</th><td>{</td></tr>
<tr><th id="595">595</th><td>	<em>int</em> <dfn class="local col3 decl" id="143cpupid" title='cpupid' data-type='int' data-ref="143cpupid" data-ref-filename="143cpupid">cpupid</dfn>;</td></tr>
<tr><th id="596">596</th><td></td></tr>
<tr><th id="597">597</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#314" title='PageError' data-ref="PageError" data-ref-filename="PageError">PageError</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="598">598</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#314" title='SetPageError' data-ref="SetPageError" data-ref-filename="SetPageError">SetPageError</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="599">599</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#315" title='PageReferenced' data-ref="PageReferenced" data-ref-filename="PageReferenced">PageReferenced</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="600">600</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#315" title='SetPageReferenced' data-ref="SetPageReferenced" data-ref-filename="SetPageReferenced">SetPageReferenced</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="601">601</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageUptodate" title='PageUptodate' data-ref="PageUptodate" data-ref-filename="PageUptodate">PageUptodate</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="602">602</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#SetPageUptodate" title='SetPageUptodate' data-ref="SetPageUptodate" data-ref-filename="SetPageUptodate">SetPageUptodate</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="603">603</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#322" title='TestClearPageActive' data-ref="TestClearPageActive" data-ref-filename="TestClearPageActive">TestClearPageActive</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>)) {</td></tr>
<tr><th id="604">604</th><td>		<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(PageUnevictable(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#394" title='PageUnevictable' data-ref="PageUnevictable" data-ref-filename="PageUnevictable">PageUnevictable</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>), page);</td></tr>
<tr><th id="605">605</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#321" title='SetPageActive' data-ref="SetPageActive" data-ref-filename="SetPageActive">SetPageActive</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="606">606</th><td>	} <b>else</b> <b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#396" title='TestClearPageUnevictable' data-ref="TestClearPageUnevictable" data-ref-filename="TestClearPageUnevictable">TestClearPageUnevictable</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="607">607</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#394" title='SetPageUnevictable' data-ref="SetPageUnevictable" data-ref-filename="SetPageUnevictable">SetPageUnevictable</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="608">608</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#323" title='PageWorkingset' data-ref="PageWorkingset" data-ref-filename="PageWorkingset">PageWorkingset</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="609">609</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#323" title='SetPageWorkingset' data-ref="SetPageWorkingset" data-ref-filename="SetPageWorkingset">SetPageWorkingset</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="610">610</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#327" title='PageChecked' data-ref="PageChecked" data-ref-filename="PageChecked">PageChecked</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="611">611</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#327" title='SetPageChecked' data-ref="SetPageChecked" data-ref-filename="SetPageChecked">SetPageChecked</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="612">612</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#361" title='PageMappedToDisk' data-ref="PageMappedToDisk" data-ref-filename="PageMappedToDisk">PageMappedToDisk</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="613">613</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#361" title='SetPageMappedToDisk' data-ref="SetPageMappedToDisk" data-ref-filename="SetPageMappedToDisk">SetPageMappedToDisk</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="614">614</th><td></td></tr>
<tr><th id="615">615</th><td>	<i>/* Move dirty on pages not done by migrate_page_move_mapping() */</i></td></tr>
<tr><th id="616">616</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#318" title='PageDirty' data-ref="PageDirty" data-ref-filename="PageDirty">PageDirty</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="617">617</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#318" title='SetPageDirty' data-ref="SetPageDirty" data-ref-filename="SetPageDirty">SetPageDirty</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="618">618</th><td></td></tr>
<tr><th id="619">619</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page_idle.h.html#page_is_young" title='page_is_young' data-ref="page_is_young" data-ref-filename="page_is_young">page_is_young</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="620">620</th><td>		<a class="ref fn" href="../include/linux/page_idle.h.html#set_page_young" title='set_page_young' data-ref="set_page_young" data-ref-filename="set_page_young">set_page_young</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="621">621</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page_idle.h.html#page_is_idle" title='page_is_idle' data-ref="page_is_idle" data-ref-filename="page_is_idle">page_is_idle</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="622">622</th><td>		<a class="ref fn" href="../include/linux/page_idle.h.html#set_page_idle" title='set_page_idle' data-ref="set_page_idle" data-ref-filename="set_page_idle">set_page_idle</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="623">623</th><td></td></tr>
<tr><th id="624">624</th><td>	<i>/*</i></td></tr>
<tr><th id="625">625</th><td><i>	 * Copy NUMA information to the new page, to prevent over-eager</i></td></tr>
<tr><th id="626">626</th><td><i>	 * future migrations of this same page.</i></td></tr>
<tr><th id="627">627</th><td><i>	 */</i></td></tr>
<tr><th id="628">628</th><td>	<a class="local col3 ref" href="#143cpupid" title='cpupid' data-ref="143cpupid" data-ref-filename="143cpupid">cpupid</a> = <a class="ref fn" href="../include/linux/mm.h.html#page_cpupid_xchg_last" title='page_cpupid_xchg_last' data-ref="page_cpupid_xchg_last" data-ref-filename="page_cpupid_xchg_last">page_cpupid_xchg_last</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>, -<var>1</var>);</td></tr>
<tr><th id="629">629</th><td>	<a class="ref fn" href="../include/linux/mm.h.html#page_cpupid_xchg_last" title='page_cpupid_xchg_last' data-ref="page_cpupid_xchg_last" data-ref-filename="page_cpupid_xchg_last">page_cpupid_xchg_last</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>, <a class="local col3 ref" href="#143cpupid" title='cpupid' data-ref="143cpupid" data-ref-filename="143cpupid">cpupid</a>);</td></tr>
<tr><th id="630">630</th><td></td></tr>
<tr><th id="631">631</th><td>	<a class="ref fn" href="../include/linux/ksm.h.html#ksm_migrate_page" title='ksm_migrate_page' data-ref="ksm_migrate_page" data-ref-filename="ksm_migrate_page">ksm_migrate_page</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>, <a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>);</td></tr>
<tr><th id="632">632</th><td>	<i>/*</i></td></tr>
<tr><th id="633">633</th><td><i>	 * Please do not reorder this without considering how mm/ksm.c's</i></td></tr>
<tr><th id="634">634</th><td><i>	 * get_ksm_page() depends upon ksm_migrate_page() and PageSwapCache().</i></td></tr>
<tr><th id="635">635</th><td><i>	 */</i></td></tr>
<tr><th id="636">636</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageSwapCache" title='PageSwapCache' data-ref="PageSwapCache" data-ref-filename="PageSwapCache">PageSwapCache</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>))</td></tr>
<tr><th id="637">637</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#389" title='ClearPageSwapCache' data-ref="ClearPageSwapCache" data-ref-filename="ClearPageSwapCache">ClearPageSwapCache</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>);</td></tr>
<tr><th id="638">638</th><td>	<a class="ref fn" href="../include/linux/page-flags.h.html#349" title='ClearPagePrivate' data-ref="ClearPagePrivate" data-ref-filename="ClearPagePrivate">ClearPagePrivate</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>);</td></tr>
<tr><th id="639">639</th><td>	<a class="macro" href="../include/linux/mm_types.h.html#233" title="((page)-&gt;private = (0))" data-ref="_M/set_page_private">set_page_private</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>, <var>0</var>);</td></tr>
<tr><th id="640">640</th><td></td></tr>
<tr><th id="641">641</th><td>	<i>/*</i></td></tr>
<tr><th id="642">642</th><td><i>	 * If any waiters have accumulated on the new page then</i></td></tr>
<tr><th id="643">643</th><td><i>	 * wake them up.</i></td></tr>
<tr><th id="644">644</th><td><i>	 */</i></td></tr>
<tr><th id="645">645</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#359" title='PageWriteback' data-ref="PageWriteback" data-ref-filename="PageWriteback">PageWriteback</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>))</td></tr>
<tr><th id="646">646</th><td>		<a class="ref fn" href="../include/linux/pagemap.h.html#end_page_writeback" title='end_page_writeback' data-ref="end_page_writeback" data-ref-filename="end_page_writeback">end_page_writeback</a>(<a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="647">647</th><td></td></tr>
<tr><th id="648">648</th><td>	<a class="ref fn" href="../include/linux/page_owner.h.html#copy_page_owner" title='copy_page_owner' data-ref="copy_page_owner" data-ref-filename="copy_page_owner">copy_page_owner</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>, <a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="649">649</th><td></td></tr>
<tr><th id="650">650</th><td>	<a class="ref fn" href="../include/linux/memcontrol.h.html#mem_cgroup_migrate" title='mem_cgroup_migrate' data-ref="mem_cgroup_migrate" data-ref-filename="mem_cgroup_migrate">mem_cgroup_migrate</a>(<a class="local col2 ref" href="#142page" title='page' data-ref="142page" data-ref-filename="142page">page</a>, <a class="local col1 ref" href="#141newpage" title='newpage' data-ref="141newpage" data-ref-filename="141newpage">newpage</a>);</td></tr>
<tr><th id="651">651</th><td>}</td></tr>
<tr><th id="652">652</th><td><a class="macro" href="../include/linux/export.h.html#123" title="extern typeof(migrate_page_states) migrate_page_states; static const char __kstrtab_migrate_page_states[] __attribute__((section(&quot;__ksymtab_strings&quot;), used, aligned(1))) = &quot;migrate_page_states&quot;; static void * __attribute__((__section__(&quot;.discard.addressable&quot;))) __attribute__((__used__)) __addressable_migrate_page_states652 = (void *)&amp;migrate_page_states; asm(&quot;	.section \&quot;___ksymtab&quot; &quot;&quot; &quot;+&quot; &quot;migrate_page_states&quot; &quot;\&quot;, \&quot;a\&quot;	\n&quot; &quot;	.balign	8					\n&quot; &quot;__ksymtab_&quot; &quot;migrate_page_states&quot; &quot;:				\n&quot; &quot;	.long	&quot; &quot;migrate_page_states&quot; &quot;- .				\n&quot; &quot;	.long	__kstrtab_&quot; &quot;migrate_page_states&quot; &quot;- .			\n&quot; &quot;	.previous					\n&quot;)" data-ref="_M/EXPORT_SYMBOL">EXPORT_SYMBOL</a>(<a class="decl fn" href="#migrate_page_states" title='migrate_page_states' data-ref="migrate_page_states" data-ref-filename="migrate_page_states"><a class="ref fn" href="#migrate_page_states" title='migrate_page_states' data-ref="migrate_page_states" data-ref-filename="migrate_page_states"><a class="ref fn" href="#migrate_page_states" title='migrate_page_states' data-ref="migrate_page_states" data-ref-filename="migrate_page_states">migrate_page_states</a></a></a>);</td></tr>
<tr><th id="653">653</th><td></td></tr>
<tr><th id="654">654</th><td><em>void</em> <dfn class="decl def fn" id="migrate_page_copy" title='migrate_page_copy' data-ref="migrate_page_copy" data-ref-filename="migrate_page_copy">migrate_page_copy</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col4 decl" id="144newpage" title='newpage' data-type='struct page *' data-ref="144newpage" data-ref-filename="144newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col5 decl" id="145page" title='page' data-type='struct page *' data-ref="145page" data-ref-filename="145page">page</dfn>)</td></tr>
<tr><th id="655">655</th><td>{</td></tr>
<tr><th id="656">656</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageHuge" title='PageHuge' data-ref="PageHuge" data-ref-filename="PageHuge">PageHuge</a>(<a class="local col5 ref" href="#145page" title='page' data-ref="145page" data-ref-filename="145page">page</a>) || <a class="ref fn" href="../include/linux/page-flags.h.html#685" title='PageTransHuge' data-ref="PageTransHuge" data-ref-filename="PageTransHuge">PageTransHuge</a>(<a class="local col5 ref" href="#145page" title='page' data-ref="145page" data-ref-filename="145page">page</a>))</td></tr>
<tr><th id="657">657</th><td>		<a class="tu ref fn" href="#copy_huge_page" title='copy_huge_page' data-use='c' data-ref="copy_huge_page" data-ref-filename="copy_huge_page">copy_huge_page</a>(<a class="local col4 ref" href="#144newpage" title='newpage' data-ref="144newpage" data-ref-filename="144newpage">newpage</a>, <a class="local col5 ref" href="#145page" title='page' data-ref="145page" data-ref-filename="145page">page</a>);</td></tr>
<tr><th id="658">658</th><td>	<b>else</b></td></tr>
<tr><th id="659">659</th><td>		<a class="ref fn" href="../include/linux/highmem.h.html#copy_highpage" title='copy_highpage' data-ref="copy_highpage" data-ref-filename="copy_highpage">copy_highpage</a>(<a class="local col4 ref" href="#144newpage" title='newpage' data-ref="144newpage" data-ref-filename="144newpage">newpage</a>, <a class="local col5 ref" href="#145page" title='page' data-ref="145page" data-ref-filename="145page">page</a>);</td></tr>
<tr><th id="660">660</th><td></td></tr>
<tr><th id="661">661</th><td>	<a class="ref fn" href="#migrate_page_states" title='migrate_page_states' data-ref="migrate_page_states" data-ref-filename="migrate_page_states">migrate_page_states</a>(<a class="local col4 ref" href="#144newpage" title='newpage' data-ref="144newpage" data-ref-filename="144newpage">newpage</a>, <a class="local col5 ref" href="#145page" title='page' data-ref="145page" data-ref-filename="145page">page</a>);</td></tr>
<tr><th id="662">662</th><td>}</td></tr>
<tr><th id="663">663</th><td><a class="macro" href="../include/linux/export.h.html#123" title="extern typeof(migrate_page_copy) migrate_page_copy; static const char __kstrtab_migrate_page_copy[] __attribute__((section(&quot;__ksymtab_strings&quot;), used, aligned(1))) = &quot;migrate_page_copy&quot;; static void * __attribute__((__section__(&quot;.discard.addressable&quot;))) __attribute__((__used__)) __addressable_migrate_page_copy663 = (void *)&amp;migrate_page_copy; asm(&quot;	.section \&quot;___ksymtab&quot; &quot;&quot; &quot;+&quot; &quot;migrate_page_copy&quot; &quot;\&quot;, \&quot;a\&quot;	\n&quot; &quot;	.balign	8					\n&quot; &quot;__ksymtab_&quot; &quot;migrate_page_copy&quot; &quot;:				\n&quot; &quot;	.long	&quot; &quot;migrate_page_copy&quot; &quot;- .				\n&quot; &quot;	.long	__kstrtab_&quot; &quot;migrate_page_copy&quot; &quot;- .			\n&quot; &quot;	.previous					\n&quot;)" data-ref="_M/EXPORT_SYMBOL">EXPORT_SYMBOL</a>(<a class="decl fn" href="#migrate_page_copy" title='migrate_page_copy' data-ref="migrate_page_copy" data-ref-filename="migrate_page_copy"><a class="ref fn" href="#migrate_page_copy" title='migrate_page_copy' data-ref="migrate_page_copy" data-ref-filename="migrate_page_copy"><a class="ref fn" href="#migrate_page_copy" title='migrate_page_copy' data-ref="migrate_page_copy" data-ref-filename="migrate_page_copy">migrate_page_copy</a></a></a>);</td></tr>
<tr><th id="664">664</th><td></td></tr>
<tr><th id="665">665</th><td><i>/************************************************************</i></td></tr>
<tr><th id="666">666</th><td><i> *                    Migration functions</i></td></tr>
<tr><th id="667">667</th><td><i> ***********************************************************/</i></td></tr>
<tr><th id="668">668</th><td></td></tr>
<tr><th id="669">669</th><td><i>/*</i></td></tr>
<tr><th id="670">670</th><td><i> * Common logic to directly migrate a single LRU page suitable for</i></td></tr>
<tr><th id="671">671</th><td><i> * pages that do not use PagePrivate/PagePrivate2.</i></td></tr>
<tr><th id="672">672</th><td><i> *</i></td></tr>
<tr><th id="673">673</th><td><i> * Pages are locked upon entry and exit.</i></td></tr>
<tr><th id="674">674</th><td><i> */</i></td></tr>
<tr><th id="675">675</th><td><em>int</em> <dfn class="decl def fn" id="migrate_page" title='migrate_page' data-ref="migrate_page" data-ref-filename="migrate_page">migrate_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col6 decl" id="146mapping" title='mapping' data-type='struct address_space *' data-ref="146mapping" data-ref-filename="146mapping">mapping</dfn>,</td></tr>
<tr><th id="676">676</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="147newpage" title='newpage' data-type='struct page *' data-ref="147newpage" data-ref-filename="147newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col8 decl" id="148page" title='page' data-type='struct page *' data-ref="148page" data-ref-filename="148page">page</dfn>,</td></tr>
<tr><th id="677">677</th><td>		<b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col9 decl" id="149mode" title='mode' data-type='enum migrate_mode' data-ref="149mode" data-ref-filename="149mode">mode</dfn>)</td></tr>
<tr><th id="678">678</th><td>{</td></tr>
<tr><th id="679">679</th><td>	<em>int</em> <dfn class="local col0 decl" id="150rc" title='rc' data-type='int' data-ref="150rc" data-ref-filename="150rc">rc</dfn>;</td></tr>
<tr><th id="680">680</th><td></td></tr>
<tr><th id="681">681</th><td>	<a class="macro" href="../include/asm-generic/bug.h.html#61" title="do { if (__builtin_expect(!!(PageWriteback(page)), 0)) do { do { asm volatile(&quot;1:\t&quot; &quot;.byte 0x0f, 0x0b&quot; &quot;\n&quot; &quot;.pushsection __bug_table,\&quot;aw\&quot;\n&quot; &quot;2:\t&quot; &quot;.long &quot; &quot;1b&quot; &quot; - 2b&quot; &quot;\t# bug_entry::bug_addr\n&quot; &quot;\t&quot; &quot;.long &quot; &quot;%c0&quot; &quot; - 2b&quot; &quot;\t# bug_entry::file\n&quot; &quot;\t.word %c1&quot; &quot;\t# bug_entry::line\n&quot; &quot;\t.word %c2&quot; &quot;\t# bug_entry::flags\n&quot; &quot;\t.org 2b+%c3\n&quot; &quot;.popsection&quot; : : &quot;i&quot; (&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;), &quot;i&quot; (681), &quot;i&quot; (0), &quot;i&quot; (sizeof(struct bug_entry))); } while (0); do { ({ asm volatile(&quot;%c0:\n\t&quot; &quot;.pushsection .discard.unreachable\n\t&quot; &quot;.long %c0b - .\n\t&quot; &quot;.popsection\n\t&quot; : : &quot;i&quot; (110)); }); __builtin_unreachable(); } while (0); } while (0); } while (0)" data-ref="_M/BUG_ON">BUG_ON</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#359" title='PageWriteback' data-ref="PageWriteback" data-ref-filename="PageWriteback">PageWriteback</a>(<a class="local col8 ref" href="#148page" title='page' data-ref="148page" data-ref-filename="148page">page</a>));	<i>/* Writeback must be complete */</i></td></tr>
<tr><th id="682">682</th><td></td></tr>
<tr><th id="683">683</th><td>	<a class="local col0 ref" href="#150rc" title='rc' data-ref="150rc" data-ref-filename="150rc">rc</a> = <a class="ref fn" href="#migrate_page_move_mapping" title='migrate_page_move_mapping' data-ref="migrate_page_move_mapping" data-ref-filename="migrate_page_move_mapping">migrate_page_move_mapping</a>(<a class="local col6 ref" href="#146mapping" title='mapping' data-ref="146mapping" data-ref-filename="146mapping">mapping</a>, <a class="local col7 ref" href="#147newpage" title='newpage' data-ref="147newpage" data-ref-filename="147newpage">newpage</a>, <a class="local col8 ref" href="#148page" title='page' data-ref="148page" data-ref-filename="148page">page</a>, <var>0</var>);</td></tr>
<tr><th id="684">684</th><td></td></tr>
<tr><th id="685">685</th><td>	<b>if</b> (<a class="local col0 ref" href="#150rc" title='rc' data-ref="150rc" data-ref-filename="150rc">rc</a> != <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>)</td></tr>
<tr><th id="686">686</th><td>		<b>return</b> <a class="local col0 ref" href="#150rc" title='rc' data-ref="150rc" data-ref-filename="150rc">rc</a>;</td></tr>
<tr><th id="687">687</th><td></td></tr>
<tr><th id="688">688</th><td>	<b>if</b> (<a class="local col9 ref" href="#149mode" title='mode' data-ref="149mode" data-ref-filename="149mode">mode</a> != <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC_NO_COPY" title='MIGRATE_SYNC_NO_COPY' data-ref="MIGRATE_SYNC_NO_COPY" data-ref-filename="MIGRATE_SYNC_NO_COPY">MIGRATE_SYNC_NO_COPY</a>)</td></tr>
<tr><th id="689">689</th><td>		<a class="ref fn" href="#migrate_page_copy" title='migrate_page_copy' data-ref="migrate_page_copy" data-ref-filename="migrate_page_copy">migrate_page_copy</a>(<a class="local col7 ref" href="#147newpage" title='newpage' data-ref="147newpage" data-ref-filename="147newpage">newpage</a>, <a class="local col8 ref" href="#148page" title='page' data-ref="148page" data-ref-filename="148page">page</a>);</td></tr>
<tr><th id="690">690</th><td>	<b>else</b></td></tr>
<tr><th id="691">691</th><td>		<a class="ref fn" href="#migrate_page_states" title='migrate_page_states' data-ref="migrate_page_states" data-ref-filename="migrate_page_states">migrate_page_states</a>(<a class="local col7 ref" href="#147newpage" title='newpage' data-ref="147newpage" data-ref-filename="147newpage">newpage</a>, <a class="local col8 ref" href="#148page" title='page' data-ref="148page" data-ref-filename="148page">page</a>);</td></tr>
<tr><th id="692">692</th><td>	<b>return</b> <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>;</td></tr>
<tr><th id="693">693</th><td>}</td></tr>
<tr><th id="694">694</th><td><a class="macro" href="../include/linux/export.h.html#123" title="extern typeof(migrate_page) migrate_page; static const char __kstrtab_migrate_page[] __attribute__((section(&quot;__ksymtab_strings&quot;), used, aligned(1))) = &quot;migrate_page&quot;; static void * __attribute__((__section__(&quot;.discard.addressable&quot;))) __attribute__((__used__)) __addressable_migrate_page694 = (void *)&amp;migrate_page; asm(&quot;	.section \&quot;___ksymtab&quot; &quot;&quot; &quot;+&quot; &quot;migrate_page&quot; &quot;\&quot;, \&quot;a\&quot;	\n&quot; &quot;	.balign	8					\n&quot; &quot;__ksymtab_&quot; &quot;migrate_page&quot; &quot;:				\n&quot; &quot;	.long	&quot; &quot;migrate_page&quot; &quot;- .				\n&quot; &quot;	.long	__kstrtab_&quot; &quot;migrate_page&quot; &quot;- .			\n&quot; &quot;	.previous					\n&quot;)" data-ref="_M/EXPORT_SYMBOL">EXPORT_SYMBOL</a>(<a class="decl fn" href="#migrate_page" title='migrate_page' data-ref="migrate_page" data-ref-filename="migrate_page"><a class="ref fn" href="#migrate_page" title='migrate_page' data-ref="migrate_page" data-ref-filename="migrate_page"><a class="ref fn" href="#migrate_page" title='migrate_page' data-ref="migrate_page" data-ref-filename="migrate_page">migrate_page</a></a></a>);</td></tr>
<tr><th id="695">695</th><td></td></tr>
<tr><th id="696">696</th><td><u>#<span data-ppcond="696">ifdef</span> <a class="macro" href="../include/generated/autoconf.h.html#259" data-ref="_M/CONFIG_BLOCK">CONFIG_BLOCK</a></u></td></tr>
<tr><th id="697">697</th><td><i  data-doc="buffer_migrate_lock_buffers">/* Returns true if all buffers are successfully locked */</i></td></tr>
<tr><th id="698">698</th><td><em>static</em> <a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="tu decl def fn" id="buffer_migrate_lock_buffers" title='buffer_migrate_lock_buffers' data-type='bool buffer_migrate_lock_buffers(struct buffer_head * head, enum migrate_mode mode)' data-ref="buffer_migrate_lock_buffers" data-ref-filename="buffer_migrate_lock_buffers">buffer_migrate_lock_buffers</dfn>(<b>struct</b> <a class="type" href="../include/linux/buffer_head.h.html#buffer_head" title='buffer_head' data-ref="buffer_head" data-ref-filename="buffer_head">buffer_head</a> *<dfn class="local col1 decl" id="151head" title='head' data-type='struct buffer_head *' data-ref="151head" data-ref-filename="151head">head</dfn>,</td></tr>
<tr><th id="699">699</th><td>							<b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col2 decl" id="152mode" title='mode' data-type='enum migrate_mode' data-ref="152mode" data-ref-filename="152mode">mode</dfn>)</td></tr>
<tr><th id="700">700</th><td>{</td></tr>
<tr><th id="701">701</th><td>	<b>struct</b> <a class="type" href="../include/linux/buffer_head.h.html#buffer_head" title='buffer_head' data-ref="buffer_head" data-ref-filename="buffer_head">buffer_head</a> *<dfn class="local col3 decl" id="153bh" title='bh' data-type='struct buffer_head *' data-ref="153bh" data-ref-filename="153bh">bh</dfn> = <a class="local col1 ref" href="#151head" title='head' data-ref="151head" data-ref-filename="151head">head</a>;</td></tr>
<tr><th id="702">702</th><td></td></tr>
<tr><th id="703">703</th><td>	<i>/* Simple case, sync compaction */</i></td></tr>
<tr><th id="704">704</th><td>	<b>if</b> (<a class="local col2 ref" href="#152mode" title='mode' data-ref="152mode" data-ref-filename="152mode">mode</a> != <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_ASYNC" title='MIGRATE_ASYNC' data-ref="MIGRATE_ASYNC" data-ref-filename="MIGRATE_ASYNC">MIGRATE_ASYNC</a>) {</td></tr>
<tr><th id="705">705</th><td>		<b>do</b> {</td></tr>
<tr><th id="706">706</th><td>			<a class="ref fn" href="../include/linux/buffer_head.h.html#lock_buffer" title='lock_buffer' data-ref="lock_buffer" data-ref-filename="lock_buffer">lock_buffer</a>(<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a>);</td></tr>
<tr><th id="707">707</th><td>			<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a> = <a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a>-&gt;<a class="ref field" href="../include/linux/buffer_head.h.html#buffer_head::b_this_page" title='buffer_head::b_this_page' data-ref="buffer_head::b_this_page" data-ref-filename="buffer_head..b_this_page">b_this_page</a>;</td></tr>
<tr><th id="708">708</th><td></td></tr>
<tr><th id="709">709</th><td>		} <b>while</b> (<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a> != <a class="local col1 ref" href="#151head" title='head' data-ref="151head" data-ref-filename="151head">head</a>);</td></tr>
<tr><th id="710">710</th><td></td></tr>
<tr><th id="711">711</th><td>		<b>return</b> <a class="enum" href="../include/linux/stddef.h.html#true" title='true' data-ref="true" data-ref-filename="true">true</a>;</td></tr>
<tr><th id="712">712</th><td>	}</td></tr>
<tr><th id="713">713</th><td></td></tr>
<tr><th id="714">714</th><td>	<i>/* async case, we cannot block on lock_buffer so use trylock_buffer */</i></td></tr>
<tr><th id="715">715</th><td>	<b>do</b> {</td></tr>
<tr><th id="716">716</th><td>		<b>if</b> (!<a class="ref fn" href="../include/linux/buffer_head.h.html#trylock_buffer" title='trylock_buffer' data-ref="trylock_buffer" data-ref-filename="trylock_buffer">trylock_buffer</a>(<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a>)) {</td></tr>
<tr><th id="717">717</th><td>			<i>/*</i></td></tr>
<tr><th id="718">718</th><td><i>			 * We failed to lock the buffer and cannot stall in</i></td></tr>
<tr><th id="719">719</th><td><i>			 * async migration. Release the taken locks</i></td></tr>
<tr><th id="720">720</th><td><i>			 */</i></td></tr>
<tr><th id="721">721</th><td>			<b>struct</b> <a class="type" href="../include/linux/buffer_head.h.html#buffer_head" title='buffer_head' data-ref="buffer_head" data-ref-filename="buffer_head">buffer_head</a> *<dfn class="local col4 decl" id="154failed_bh" title='failed_bh' data-type='struct buffer_head *' data-ref="154failed_bh" data-ref-filename="154failed_bh">failed_bh</dfn> = <a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a>;</td></tr>
<tr><th id="722">722</th><td>			<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a> = <a class="local col1 ref" href="#151head" title='head' data-ref="151head" data-ref-filename="151head">head</a>;</td></tr>
<tr><th id="723">723</th><td>			<b>while</b> (<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a> != <a class="local col4 ref" href="#154failed_bh" title='failed_bh' data-ref="154failed_bh" data-ref-filename="154failed_bh">failed_bh</a>) {</td></tr>
<tr><th id="724">724</th><td>				<a class="ref fn" href="../include/linux/buffer_head.h.html#unlock_buffer" title='unlock_buffer' data-ref="unlock_buffer" data-ref-filename="unlock_buffer">unlock_buffer</a>(<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a>);</td></tr>
<tr><th id="725">725</th><td>				<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a> = <a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a>-&gt;<a class="ref field" href="../include/linux/buffer_head.h.html#buffer_head::b_this_page" title='buffer_head::b_this_page' data-ref="buffer_head::b_this_page" data-ref-filename="buffer_head..b_this_page">b_this_page</a>;</td></tr>
<tr><th id="726">726</th><td>			}</td></tr>
<tr><th id="727">727</th><td>			<b>return</b> <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>;</td></tr>
<tr><th id="728">728</th><td>		}</td></tr>
<tr><th id="729">729</th><td></td></tr>
<tr><th id="730">730</th><td>		<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a> = <a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a>-&gt;<a class="ref field" href="../include/linux/buffer_head.h.html#buffer_head::b_this_page" title='buffer_head::b_this_page' data-ref="buffer_head::b_this_page" data-ref-filename="buffer_head..b_this_page">b_this_page</a>;</td></tr>
<tr><th id="731">731</th><td>	} <b>while</b> (<a class="local col3 ref" href="#153bh" title='bh' data-ref="153bh" data-ref-filename="153bh">bh</a> != <a class="local col1 ref" href="#151head" title='head' data-ref="151head" data-ref-filename="151head">head</a>);</td></tr>
<tr><th id="732">732</th><td>	<b>return</b> <a class="enum" href="../include/linux/stddef.h.html#true" title='true' data-ref="true" data-ref-filename="true">true</a>;</td></tr>
<tr><th id="733">733</th><td>}</td></tr>
<tr><th id="734">734</th><td></td></tr>
<tr><th id="735">735</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="__buffer_migrate_page" title='__buffer_migrate_page' data-type='int __buffer_migrate_page(struct address_space * mapping, struct page * newpage, struct page * page, enum migrate_mode mode, bool check_refs)' data-ref="__buffer_migrate_page" data-ref-filename="__buffer_migrate_page">__buffer_migrate_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col5 decl" id="155mapping" title='mapping' data-type='struct address_space *' data-ref="155mapping" data-ref-filename="155mapping">mapping</dfn>,</td></tr>
<tr><th id="736">736</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col6 decl" id="156newpage" title='newpage' data-type='struct page *' data-ref="156newpage" data-ref-filename="156newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="157page" title='page' data-type='struct page *' data-ref="157page" data-ref-filename="157page">page</dfn>, <b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col8 decl" id="158mode" title='mode' data-type='enum migrate_mode' data-ref="158mode" data-ref-filename="158mode">mode</dfn>,</td></tr>
<tr><th id="737">737</th><td>		<a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="local col9 decl" id="159check_refs" title='check_refs' data-type='bool' data-ref="159check_refs" data-ref-filename="159check_refs">check_refs</dfn>)</td></tr>
<tr><th id="738">738</th><td>{</td></tr>
<tr><th id="739">739</th><td>	<b>struct</b> <a class="type" href="../include/linux/buffer_head.h.html#buffer_head" title='buffer_head' data-ref="buffer_head" data-ref-filename="buffer_head">buffer_head</a> *<dfn class="local col0 decl" id="160bh" title='bh' data-type='struct buffer_head *' data-ref="160bh" data-ref-filename="160bh">bh</dfn>, *<dfn class="local col1 decl" id="161head" title='head' data-type='struct buffer_head *' data-ref="161head" data-ref-filename="161head">head</dfn>;</td></tr>
<tr><th id="740">740</th><td>	<em>int</em> <dfn class="local col2 decl" id="162rc" title='rc' data-type='int' data-ref="162rc" data-ref-filename="162rc">rc</dfn>;</td></tr>
<tr><th id="741">741</th><td>	<em>int</em> <dfn class="local col3 decl" id="163expected_count" title='expected_count' data-type='int' data-ref="163expected_count" data-ref-filename="163expected_count">expected_count</dfn>;</td></tr>
<tr><th id="742">742</th><td></td></tr>
<tr><th id="743">743</th><td>	<b>if</b> (!<a class="macro" href="../include/linux/buffer_head.h.html#146" title="PagePrivate(page)" data-ref="_M/page_has_buffers">page_has_buffers</a>(<a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>))</td></tr>
<tr><th id="744">744</th><td>		<b>return</b> <a class="ref fn" href="#migrate_page" title='migrate_page' data-ref="migrate_page" data-ref-filename="migrate_page">migrate_page</a>(<a class="local col5 ref" href="#155mapping" title='mapping' data-ref="155mapping" data-ref-filename="155mapping">mapping</a>, <a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>, <a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>, <a class="local col8 ref" href="#158mode" title='mode' data-ref="158mode" data-ref-filename="158mode">mode</a>);</td></tr>
<tr><th id="745">745</th><td></td></tr>
<tr><th id="746">746</th><td>	<i>/* Check whether page does not have extra refs before we do more work */</i></td></tr>
<tr><th id="747">747</th><td>	<a class="local col3 ref" href="#163expected_count" title='expected_count' data-ref="163expected_count" data-ref-filename="163expected_count">expected_count</a> = <a class="tu ref fn" href="#expected_page_refs" title='expected_page_refs' data-use='c' data-ref="expected_page_refs" data-ref-filename="expected_page_refs">expected_page_refs</a>(<a class="local col5 ref" href="#155mapping" title='mapping' data-ref="155mapping" data-ref-filename="155mapping">mapping</a>, <a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>);</td></tr>
<tr><th id="748">748</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page_ref.h.html#page_count" title='page_count' data-ref="page_count" data-ref-filename="page_count">page_count</a>(<a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>) != <a class="local col3 ref" href="#163expected_count" title='expected_count' data-ref="163expected_count" data-ref-filename="163expected_count">expected_count</a>)</td></tr>
<tr><th id="749">749</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="750">750</th><td></td></tr>
<tr><th id="751">751</th><td>	<a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a> = <a class="macro" href="../include/linux/buffer_head.h.html#141" title="({ do { if (__builtin_expect(!!(!PagePrivate(page)), 0)) do { do { asm volatile(&quot;1:\t&quot; &quot;.byte 0x0f, 0x0b&quot; &quot;\n&quot; &quot;.pushsection __bug_table,\&quot;aw\&quot;\n&quot; &quot;2:\t&quot; &quot;.long &quot; &quot;1b&quot; &quot; - 2b&quot; &quot;\t# bug_entry::bug_addr\n&quot; &quot;\t&quot; &quot;.long &quot; &quot;%c0&quot; &quot; - 2b&quot; &quot;\t# bug_entry::file\n&quot; &quot;\t.word %c1&quot; &quot;\t# bug_entry::line\n&quot; &quot;\t.word %c2&quot; &quot;\t# bug_entry::flags\n&quot; &quot;\t.org 2b+%c3\n&quot; &quot;.popsection&quot; : : &quot;i&quot; (&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;), &quot;i&quot; (751), &quot;i&quot; (0), &quot;i&quot; (sizeof(struct bug_entry))); } while (0); do { ({ asm volatile(&quot;%c0:\n\t&quot; &quot;.pushsection .discard.unreachable\n\t&quot; &quot;.long %c0b - .\n\t&quot; &quot;.popsection\n\t&quot; : : &quot;i&quot; (112)); }); __builtin_unreachable(); } while (0); } while (0); } while (0); ((struct buffer_head *)((page)-&gt;private)); })" data-ref="_M/page_buffers">page_buffers</a>(<a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>);</td></tr>
<tr><th id="752">752</th><td>	<b>if</b> (!<a class="tu ref fn" href="#buffer_migrate_lock_buffers" title='buffer_migrate_lock_buffers' data-use='c' data-ref="buffer_migrate_lock_buffers" data-ref-filename="buffer_migrate_lock_buffers">buffer_migrate_lock_buffers</a>(<a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a>, <a class="local col8 ref" href="#158mode" title='mode' data-ref="158mode" data-ref-filename="158mode">mode</a>))</td></tr>
<tr><th id="753">753</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="754">754</th><td></td></tr>
<tr><th id="755">755</th><td>	<b>if</b> (<a class="local col9 ref" href="#159check_refs" title='check_refs' data-ref="159check_refs" data-ref-filename="159check_refs">check_refs</a>) {</td></tr>
<tr><th id="756">756</th><td>		<a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="local col4 decl" id="164busy" title='busy' data-type='bool' data-ref="164busy" data-ref-filename="164busy">busy</dfn>;</td></tr>
<tr><th id="757">757</th><td>		<a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="local col5 decl" id="165invalidated" title='invalidated' data-type='bool' data-ref="165invalidated" data-ref-filename="165invalidated">invalidated</dfn> = <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>;</td></tr>
<tr><th id="758">758</th><td></td></tr>
<tr><th id="759">759</th><td><dfn class="lbl" id="166recheck_buffers" data-ref="166recheck_buffers" data-ref-filename="166recheck_buffers">recheck_buffers</dfn>:</td></tr>
<tr><th id="760">760</th><td>		<a class="local col4 ref" href="#164busy" title='busy' data-ref="164busy" data-ref-filename="164busy">busy</a> = <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>;</td></tr>
<tr><th id="761">761</th><td>		<a class="ref fn" href="../include/linux/spinlock.h.html#spin_lock" title='spin_lock' data-ref="spin_lock" data-ref-filename="spin_lock">spin_lock</a>(&amp;<a class="local col5 ref" href="#155mapping" title='mapping' data-ref="155mapping" data-ref-filename="155mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::private_lock" title='address_space::private_lock' data-ref="address_space::private_lock" data-ref-filename="address_space..private_lock">private_lock</a>);</td></tr>
<tr><th id="762">762</th><td>		<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> = <a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a>;</td></tr>
<tr><th id="763">763</th><td>		<b>do</b> {</td></tr>
<tr><th id="764">764</th><td>			<b>if</b> (<a class="macro" href="../include/asm-generic/atomic-instrumented.h.html#29" title="atomic_read" data-ref="_M/atomic_read">atomic_read</a>(&amp;<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a>-&gt;<a class="ref field" href="../include/linux/buffer_head.h.html#buffer_head::b_count" title='buffer_head::b_count' data-ref="buffer_head::b_count" data-ref-filename="buffer_head..b_count">b_count</a>)) {</td></tr>
<tr><th id="765">765</th><td>				<a class="local col4 ref" href="#164busy" title='busy' data-ref="164busy" data-ref-filename="164busy">busy</a> = <a class="enum" href="../include/linux/stddef.h.html#true" title='true' data-ref="true" data-ref-filename="true">true</a>;</td></tr>
<tr><th id="766">766</th><td>				<b>break</b>;</td></tr>
<tr><th id="767">767</th><td>			}</td></tr>
<tr><th id="768">768</th><td>			<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> = <a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a>-&gt;<a class="ref field" href="../include/linux/buffer_head.h.html#buffer_head::b_this_page" title='buffer_head::b_this_page' data-ref="buffer_head::b_this_page" data-ref-filename="buffer_head..b_this_page">b_this_page</a>;</td></tr>
<tr><th id="769">769</th><td>		} <b>while</b> (<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> != <a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a>);</td></tr>
<tr><th id="770">770</th><td>		<b>if</b> (<a class="local col4 ref" href="#164busy" title='busy' data-ref="164busy" data-ref-filename="164busy">busy</a>) {</td></tr>
<tr><th id="771">771</th><td>			<b>if</b> (<a class="local col5 ref" href="#165invalidated" title='invalidated' data-ref="165invalidated" data-ref-filename="165invalidated">invalidated</a>) {</td></tr>
<tr><th id="772">772</th><td>				<a class="local col2 ref" href="#162rc" title='rc' data-ref="162rc" data-ref-filename="162rc">rc</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="773">773</th><td>				<b>goto</b> <a class="lbl" href="#167unlock_buffers" data-ref="167unlock_buffers" data-ref-filename="167unlock_buffers">unlock_buffers</a>;</td></tr>
<tr><th id="774">774</th><td>			}</td></tr>
<tr><th id="775">775</th><td>			<a class="ref fn" href="../include/linux/spinlock.h.html#spin_unlock" title='spin_unlock' data-ref="spin_unlock" data-ref-filename="spin_unlock">spin_unlock</a>(&amp;<a class="local col5 ref" href="#155mapping" title='mapping' data-ref="155mapping" data-ref-filename="155mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::private_lock" title='address_space::private_lock' data-ref="address_space::private_lock" data-ref-filename="address_space..private_lock">private_lock</a>);</td></tr>
<tr><th id="776">776</th><td>			<a class="ref fn" href="../include/linux/buffer_head.h.html#invalidate_bh_lrus" title='invalidate_bh_lrus' data-ref="invalidate_bh_lrus" data-ref-filename="invalidate_bh_lrus">invalidate_bh_lrus</a>();</td></tr>
<tr><th id="777">777</th><td>			<a class="local col5 ref" href="#165invalidated" title='invalidated' data-ref="165invalidated" data-ref-filename="165invalidated">invalidated</a> = <a class="enum" href="../include/linux/stddef.h.html#true" title='true' data-ref="true" data-ref-filename="true">true</a>;</td></tr>
<tr><th id="778">778</th><td>			<b>goto</b> <a class="lbl" href="#166recheck_buffers" data-ref="166recheck_buffers" data-ref-filename="166recheck_buffers">recheck_buffers</a>;</td></tr>
<tr><th id="779">779</th><td>		}</td></tr>
<tr><th id="780">780</th><td>	}</td></tr>
<tr><th id="781">781</th><td></td></tr>
<tr><th id="782">782</th><td>	<a class="local col2 ref" href="#162rc" title='rc' data-ref="162rc" data-ref-filename="162rc">rc</a> = <a class="ref fn" href="#migrate_page_move_mapping" title='migrate_page_move_mapping' data-ref="migrate_page_move_mapping" data-ref-filename="migrate_page_move_mapping">migrate_page_move_mapping</a>(<a class="local col5 ref" href="#155mapping" title='mapping' data-ref="155mapping" data-ref-filename="155mapping">mapping</a>, <a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>, <a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>, <var>0</var>);</td></tr>
<tr><th id="783">783</th><td>	<b>if</b> (<a class="local col2 ref" href="#162rc" title='rc' data-ref="162rc" data-ref-filename="162rc">rc</a> != <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>)</td></tr>
<tr><th id="784">784</th><td>		<b>goto</b> <a class="lbl" href="#167unlock_buffers" data-ref="167unlock_buffers" data-ref-filename="167unlock_buffers">unlock_buffers</a>;</td></tr>
<tr><th id="785">785</th><td></td></tr>
<tr><th id="786">786</th><td>	<a class="ref fn" href="../include/linux/page-flags.h.html#349" title='ClearPagePrivate' data-ref="ClearPagePrivate" data-ref-filename="ClearPagePrivate">ClearPagePrivate</a>(<a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>);</td></tr>
<tr><th id="787">787</th><td>	<a class="macro" href="../include/linux/mm_types.h.html#233" title="((newpage)-&gt;private = (((page)-&gt;private)))" data-ref="_M/set_page_private">set_page_private</a>(<a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>, <a class="macro" href="../include/linux/mm_types.h.html#232" title="((page)-&gt;private)" data-ref="_M/page_private">page_private</a>(<a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>));</td></tr>
<tr><th id="788">788</th><td>	<a class="macro" href="../include/linux/mm_types.h.html#233" title="((page)-&gt;private = (0))" data-ref="_M/set_page_private">set_page_private</a>(<a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>, <var>0</var>);</td></tr>
<tr><th id="789">789</th><td>	<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>);</td></tr>
<tr><th id="790">790</th><td>	<a class="ref fn" href="../include/linux/mm.h.html#get_page" title='get_page' data-ref="get_page" data-ref-filename="get_page">get_page</a>(<a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>);</td></tr>
<tr><th id="791">791</th><td></td></tr>
<tr><th id="792">792</th><td>	<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> = <a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a>;</td></tr>
<tr><th id="793">793</th><td>	<b>do</b> {</td></tr>
<tr><th id="794">794</th><td>		<a class="ref fn" href="../include/linux/buffer_head.h.html#set_bh_page" title='set_bh_page' data-ref="set_bh_page" data-ref-filename="set_bh_page">set_bh_page</a>(<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a>, <a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>, <a class="macro" href="../include/linux/buffer_head.h.html#138" title="((unsigned long)(bh)-&gt;b_data &amp; ~(~(((1UL) &lt;&lt; 12)-1)))" data-ref="_M/bh_offset">bh_offset</a>(<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a>));</td></tr>
<tr><th id="795">795</th><td>		<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> = <a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a>-&gt;<a class="ref field" href="../include/linux/buffer_head.h.html#buffer_head::b_this_page" title='buffer_head::b_this_page' data-ref="buffer_head::b_this_page" data-ref-filename="buffer_head..b_this_page">b_this_page</a>;</td></tr>
<tr><th id="796">796</th><td></td></tr>
<tr><th id="797">797</th><td>	} <b>while</b> (<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> != <a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a>);</td></tr>
<tr><th id="798">798</th><td></td></tr>
<tr><th id="799">799</th><td>	<a class="ref fn" href="../include/linux/page-flags.h.html#349" title='SetPagePrivate' data-ref="SetPagePrivate" data-ref-filename="SetPagePrivate">SetPagePrivate</a>(<a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>);</td></tr>
<tr><th id="800">800</th><td></td></tr>
<tr><th id="801">801</th><td>	<b>if</b> (<a class="local col8 ref" href="#158mode" title='mode' data-ref="158mode" data-ref-filename="158mode">mode</a> != <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC_NO_COPY" title='MIGRATE_SYNC_NO_COPY' data-ref="MIGRATE_SYNC_NO_COPY" data-ref-filename="MIGRATE_SYNC_NO_COPY">MIGRATE_SYNC_NO_COPY</a>)</td></tr>
<tr><th id="802">802</th><td>		<a class="ref fn" href="#migrate_page_copy" title='migrate_page_copy' data-ref="migrate_page_copy" data-ref-filename="migrate_page_copy">migrate_page_copy</a>(<a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>, <a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>);</td></tr>
<tr><th id="803">803</th><td>	<b>else</b></td></tr>
<tr><th id="804">804</th><td>		<a class="ref fn" href="#migrate_page_states" title='migrate_page_states' data-ref="migrate_page_states" data-ref-filename="migrate_page_states">migrate_page_states</a>(<a class="local col6 ref" href="#156newpage" title='newpage' data-ref="156newpage" data-ref-filename="156newpage">newpage</a>, <a class="local col7 ref" href="#157page" title='page' data-ref="157page" data-ref-filename="157page">page</a>);</td></tr>
<tr><th id="805">805</th><td></td></tr>
<tr><th id="806">806</th><td>	<a class="local col2 ref" href="#162rc" title='rc' data-ref="162rc" data-ref-filename="162rc">rc</a> = <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>;</td></tr>
<tr><th id="807">807</th><td><dfn class="lbl" id="167unlock_buffers" data-ref="167unlock_buffers" data-ref-filename="167unlock_buffers">unlock_buffers</dfn>:</td></tr>
<tr><th id="808">808</th><td>	<b>if</b> (<a class="local col9 ref" href="#159check_refs" title='check_refs' data-ref="159check_refs" data-ref-filename="159check_refs">check_refs</a>)</td></tr>
<tr><th id="809">809</th><td>		<a class="ref fn" href="../include/linux/spinlock.h.html#spin_unlock" title='spin_unlock' data-ref="spin_unlock" data-ref-filename="spin_unlock">spin_unlock</a>(&amp;<a class="local col5 ref" href="#155mapping" title='mapping' data-ref="155mapping" data-ref-filename="155mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::private_lock" title='address_space::private_lock' data-ref="address_space::private_lock" data-ref-filename="address_space..private_lock">private_lock</a>);</td></tr>
<tr><th id="810">810</th><td>	<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> = <a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a>;</td></tr>
<tr><th id="811">811</th><td>	<b>do</b> {</td></tr>
<tr><th id="812">812</th><td>		<a class="ref fn" href="../include/linux/buffer_head.h.html#unlock_buffer" title='unlock_buffer' data-ref="unlock_buffer" data-ref-filename="unlock_buffer">unlock_buffer</a>(<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a>);</td></tr>
<tr><th id="813">813</th><td>		<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> = <a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a>-&gt;<a class="ref field" href="../include/linux/buffer_head.h.html#buffer_head::b_this_page" title='buffer_head::b_this_page' data-ref="buffer_head::b_this_page" data-ref-filename="buffer_head..b_this_page">b_this_page</a>;</td></tr>
<tr><th id="814">814</th><td></td></tr>
<tr><th id="815">815</th><td>	} <b>while</b> (<a class="local col0 ref" href="#160bh" title='bh' data-ref="160bh" data-ref-filename="160bh">bh</a> != <a class="local col1 ref" href="#161head" title='head' data-ref="161head" data-ref-filename="161head">head</a>);</td></tr>
<tr><th id="816">816</th><td></td></tr>
<tr><th id="817">817</th><td>	<b>return</b> <a class="local col2 ref" href="#162rc" title='rc' data-ref="162rc" data-ref-filename="162rc">rc</a>;</td></tr>
<tr><th id="818">818</th><td>}</td></tr>
<tr><th id="819">819</th><td></td></tr>
<tr><th id="820">820</th><td><i>/*</i></td></tr>
<tr><th id="821">821</th><td><i> * Migration function for pages with buffers. This function can only be used</i></td></tr>
<tr><th id="822">822</th><td><i> * if the underlying filesystem guarantees that no other references to "page"</i></td></tr>
<tr><th id="823">823</th><td><i> * exist. For example attached buffer heads are accessed only under page lock.</i></td></tr>
<tr><th id="824">824</th><td><i> */</i></td></tr>
<tr><th id="825">825</th><td><em>int</em> <dfn class="decl def fn" id="buffer_migrate_page" title='buffer_migrate_page' data-ref="buffer_migrate_page" data-ref-filename="buffer_migrate_page">buffer_migrate_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col8 decl" id="168mapping" title='mapping' data-type='struct address_space *' data-ref="168mapping" data-ref-filename="168mapping">mapping</dfn>,</td></tr>
<tr><th id="826">826</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col9 decl" id="169newpage" title='newpage' data-type='struct page *' data-ref="169newpage" data-ref-filename="169newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col0 decl" id="170page" title='page' data-type='struct page *' data-ref="170page" data-ref-filename="170page">page</dfn>, <b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col1 decl" id="171mode" title='mode' data-type='enum migrate_mode' data-ref="171mode" data-ref-filename="171mode">mode</dfn>)</td></tr>
<tr><th id="827">827</th><td>{</td></tr>
<tr><th id="828">828</th><td>	<b>return</b> <a class="tu ref fn" href="#__buffer_migrate_page" title='__buffer_migrate_page' data-use='c' data-ref="__buffer_migrate_page" data-ref-filename="__buffer_migrate_page">__buffer_migrate_page</a>(<a class="local col8 ref" href="#168mapping" title='mapping' data-ref="168mapping" data-ref-filename="168mapping">mapping</a>, <a class="local col9 ref" href="#169newpage" title='newpage' data-ref="169newpage" data-ref-filename="169newpage">newpage</a>, <a class="local col0 ref" href="#170page" title='page' data-ref="170page" data-ref-filename="170page">page</a>, <a class="local col1 ref" href="#171mode" title='mode' data-ref="171mode" data-ref-filename="171mode">mode</a>, <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>);</td></tr>
<tr><th id="829">829</th><td>}</td></tr>
<tr><th id="830">830</th><td><a class="macro" href="../include/linux/export.h.html#123" title="extern typeof(buffer_migrate_page) buffer_migrate_page; static const char __kstrtab_buffer_migrate_page[] __attribute__((section(&quot;__ksymtab_strings&quot;), used, aligned(1))) = &quot;buffer_migrate_page&quot;; static void * __attribute__((__section__(&quot;.discard.addressable&quot;))) __attribute__((__used__)) __addressable_buffer_migrate_page830 = (void *)&amp;buffer_migrate_page; asm(&quot;	.section \&quot;___ksymtab&quot; &quot;&quot; &quot;+&quot; &quot;buffer_migrate_page&quot; &quot;\&quot;, \&quot;a\&quot;	\n&quot; &quot;	.balign	8					\n&quot; &quot;__ksymtab_&quot; &quot;buffer_migrate_page&quot; &quot;:				\n&quot; &quot;	.long	&quot; &quot;buffer_migrate_page&quot; &quot;- .				\n&quot; &quot;	.long	__kstrtab_&quot; &quot;buffer_migrate_page&quot; &quot;- .			\n&quot; &quot;	.previous					\n&quot;)" data-ref="_M/EXPORT_SYMBOL">EXPORT_SYMBOL</a>(<a class="decl fn" href="#buffer_migrate_page" title='buffer_migrate_page' data-ref="buffer_migrate_page" data-ref-filename="buffer_migrate_page"><a class="ref fn" href="#buffer_migrate_page" title='buffer_migrate_page' data-ref="buffer_migrate_page" data-ref-filename="buffer_migrate_page"><a class="ref fn" href="#buffer_migrate_page" title='buffer_migrate_page' data-ref="buffer_migrate_page" data-ref-filename="buffer_migrate_page">buffer_migrate_page</a></a></a>);</td></tr>
<tr><th id="831">831</th><td></td></tr>
<tr><th id="832">832</th><td><i>/*</i></td></tr>
<tr><th id="833">833</th><td><i> * Same as above except that this variant is more careful and checks that there</i></td></tr>
<tr><th id="834">834</th><td><i> * are also no buffer head references. This function is the right one for</i></td></tr>
<tr><th id="835">835</th><td><i> * mappings where buffer heads are directly looked up and referenced (such as</i></td></tr>
<tr><th id="836">836</th><td><i> * block device mappings).</i></td></tr>
<tr><th id="837">837</th><td><i> */</i></td></tr>
<tr><th id="838">838</th><td><em>int</em> <dfn class="decl def fn" id="buffer_migrate_page_norefs" title='buffer_migrate_page_norefs' data-ref="buffer_migrate_page_norefs" data-ref-filename="buffer_migrate_page_norefs">buffer_migrate_page_norefs</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col2 decl" id="172mapping" title='mapping' data-type='struct address_space *' data-ref="172mapping" data-ref-filename="172mapping">mapping</dfn>,</td></tr>
<tr><th id="839">839</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col3 decl" id="173newpage" title='newpage' data-type='struct page *' data-ref="173newpage" data-ref-filename="173newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col4 decl" id="174page" title='page' data-type='struct page *' data-ref="174page" data-ref-filename="174page">page</dfn>, <b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col5 decl" id="175mode" title='mode' data-type='enum migrate_mode' data-ref="175mode" data-ref-filename="175mode">mode</dfn>)</td></tr>
<tr><th id="840">840</th><td>{</td></tr>
<tr><th id="841">841</th><td>	<b>return</b> <a class="tu ref fn" href="#__buffer_migrate_page" title='__buffer_migrate_page' data-use='c' data-ref="__buffer_migrate_page" data-ref-filename="__buffer_migrate_page">__buffer_migrate_page</a>(<a class="local col2 ref" href="#172mapping" title='mapping' data-ref="172mapping" data-ref-filename="172mapping">mapping</a>, <a class="local col3 ref" href="#173newpage" title='newpage' data-ref="173newpage" data-ref-filename="173newpage">newpage</a>, <a class="local col4 ref" href="#174page" title='page' data-ref="174page" data-ref-filename="174page">page</a>, <a class="local col5 ref" href="#175mode" title='mode' data-ref="175mode" data-ref-filename="175mode">mode</a>, <a class="enum" href="../include/linux/stddef.h.html#true" title='true' data-ref="true" data-ref-filename="true">true</a>);</td></tr>
<tr><th id="842">842</th><td>}</td></tr>
<tr><th id="843">843</th><td><u>#<span data-ppcond="696">endif</span></u></td></tr>
<tr><th id="844">844</th><td></td></tr>
<tr><th id="845">845</th><td><i  data-doc="writeout">/*</i></td></tr>
<tr><th id="846">846</th><td><i  data-doc="writeout"> * Writeback a page to clean the dirty state</i></td></tr>
<tr><th id="847">847</th><td><i  data-doc="writeout"> */</i></td></tr>
<tr><th id="848">848</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="writeout" title='writeout' data-type='int writeout(struct address_space * mapping, struct page * page)' data-ref="writeout" data-ref-filename="writeout">writeout</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col6 decl" id="176mapping" title='mapping' data-type='struct address_space *' data-ref="176mapping" data-ref-filename="176mapping">mapping</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="177page" title='page' data-type='struct page *' data-ref="177page" data-ref-filename="177page">page</dfn>)</td></tr>
<tr><th id="849">849</th><td>{</td></tr>
<tr><th id="850">850</th><td>	<b>struct</b> <a class="type" href="../include/linux/writeback.h.html#writeback_control" title='writeback_control' data-ref="writeback_control" data-ref-filename="writeback_control">writeback_control</a> <dfn class="local col8 decl" id="178wbc" title='wbc' data-type='struct writeback_control' data-ref="178wbc" data-ref-filename="178wbc">wbc</dfn> = {</td></tr>
<tr><th id="851">851</th><td>		.<a class="ref field" href="../include/linux/writeback.h.html#writeback_control::sync_mode" title='writeback_control::sync_mode' data-ref="writeback_control::sync_mode" data-ref-filename="writeback_control..sync_mode">sync_mode</a> = <a class="enum" href="../include/linux/writeback.h.html#WB_SYNC_NONE" title='WB_SYNC_NONE' data-ref="WB_SYNC_NONE" data-ref-filename="WB_SYNC_NONE">WB_SYNC_NONE</a>,</td></tr>
<tr><th id="852">852</th><td>		.<a class="ref field" href="../include/linux/writeback.h.html#writeback_control::nr_to_write" title='writeback_control::nr_to_write' data-ref="writeback_control::nr_to_write" data-ref-filename="writeback_control..nr_to_write">nr_to_write</a> = <var>1</var>,</td></tr>
<tr><th id="853">853</th><td>		.<a class="ref field" href="../include/linux/writeback.h.html#writeback_control::range_start" title='writeback_control::range_start' data-ref="writeback_control::range_start" data-ref-filename="writeback_control..range_start">range_start</a> = <var>0</var>,</td></tr>
<tr><th id="854">854</th><td>		.<a class="ref field" href="../include/linux/writeback.h.html#writeback_control::range_end" title='writeback_control::range_end' data-ref="writeback_control::range_end" data-ref-filename="writeback_control..range_end">range_end</a> = <a class="macro" href="../include/linux/limits.h.html#17" title="((long long)(~0ULL &gt;&gt; 1))" data-ref="_M/LLONG_MAX">LLONG_MAX</a>,</td></tr>
<tr><th id="855">855</th><td>		.<a class="ref field" href="../include/linux/writeback.h.html#writeback_control::for_reclaim" title='writeback_control::for_reclaim' data-ref="writeback_control::for_reclaim" data-ref-filename="writeback_control..for_reclaim">for_reclaim</a> = <var>1</var></td></tr>
<tr><th id="856">856</th><td>	};</td></tr>
<tr><th id="857">857</th><td>	<em>int</em> <dfn class="local col9 decl" id="179rc" title='rc' data-type='int' data-ref="179rc" data-ref-filename="179rc">rc</dfn>;</td></tr>
<tr><th id="858">858</th><td></td></tr>
<tr><th id="859">859</th><td>	<b>if</b> (!<a class="local col6 ref" href="#176mapping" title='mapping' data-ref="176mapping" data-ref-filename="176mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::a_ops" title='address_space::a_ops' data-ref="address_space::a_ops" data-ref-filename="address_space..a_ops">a_ops</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space_operations::writepage" title='address_space_operations::writepage' data-ref="address_space_operations::writepage" data-ref-filename="address_space_operations..writepage">writepage</a>)</td></tr>
<tr><th id="860">860</th><td>		<i>/* No write method for the address space */</i></td></tr>
<tr><th id="861">861</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#26" title="22" data-ref="_M/EINVAL">EINVAL</a>;</td></tr>
<tr><th id="862">862</th><td></td></tr>
<tr><th id="863">863</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/mm.h.html#clear_page_dirty_for_io" title='clear_page_dirty_for_io' data-ref="clear_page_dirty_for_io" data-ref-filename="clear_page_dirty_for_io">clear_page_dirty_for_io</a>(<a class="local col7 ref" href="#177page" title='page' data-ref="177page" data-ref-filename="177page">page</a>))</td></tr>
<tr><th id="864">864</th><td>		<i>/* Someone else already triggered a write */</i></td></tr>
<tr><th id="865">865</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="866">866</th><td></td></tr>
<tr><th id="867">867</th><td>	<i>/*</i></td></tr>
<tr><th id="868">868</th><td><i>	 * A dirty page may imply that the underlying filesystem has</i></td></tr>
<tr><th id="869">869</th><td><i>	 * the page on some queue. So the page must be clean for</i></td></tr>
<tr><th id="870">870</th><td><i>	 * migration. Writeout may mean we loose the lock and the</i></td></tr>
<tr><th id="871">871</th><td><i>	 * page state is no longer what we checked for earlier.</i></td></tr>
<tr><th id="872">872</th><td><i>	 * At this point we know that the migration attempt cannot</i></td></tr>
<tr><th id="873">873</th><td><i>	 * be successful.</i></td></tr>
<tr><th id="874">874</th><td><i>	 */</i></td></tr>
<tr><th id="875">875</th><td>	<a class="ref fn" href="#remove_migration_ptes" title='remove_migration_ptes' data-ref="remove_migration_ptes" data-ref-filename="remove_migration_ptes">remove_migration_ptes</a>(<a class="local col7 ref" href="#177page" title='page' data-ref="177page" data-ref-filename="177page">page</a>, <a class="local col7 ref" href="#177page" title='page' data-ref="177page" data-ref-filename="177page">page</a>, <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>);</td></tr>
<tr><th id="876">876</th><td></td></tr>
<tr><th id="877">877</th><td>	<a class="local col9 ref" href="#179rc" title='rc' data-ref="179rc" data-ref-filename="179rc">rc</a> = <a class="local col6 ref" href="#176mapping" title='mapping' data-ref="176mapping" data-ref-filename="176mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::a_ops" title='address_space::a_ops' data-ref="address_space::a_ops" data-ref-filename="address_space..a_ops">a_ops</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space_operations::writepage" title='address_space_operations::writepage' data-ref="address_space_operations::writepage" data-ref-filename="address_space_operations..writepage">writepage</a>(<a class="local col7 ref" href="#177page" title='page' data-ref="177page" data-ref-filename="177page">page</a>, &amp;<a class="local col8 ref" href="#178wbc" title='wbc' data-ref="178wbc" data-ref-filename="178wbc">wbc</a>);</td></tr>
<tr><th id="878">878</th><td></td></tr>
<tr><th id="879">879</th><td>	<b>if</b> (<a class="local col9 ref" href="#179rc" title='rc' data-ref="179rc" data-ref-filename="179rc">rc</a> != <a class="enum" href="../include/linux/fs.h.html#AOP_WRITEPAGE_ACTIVATE" title='AOP_WRITEPAGE_ACTIVATE' data-ref="AOP_WRITEPAGE_ACTIVATE" data-ref-filename="AOP_WRITEPAGE_ACTIVATE">AOP_WRITEPAGE_ACTIVATE</a>)</td></tr>
<tr><th id="880">880</th><td>		<i>/* unlocked. Relock */</i></td></tr>
<tr><th id="881">881</th><td>		<a class="ref fn" href="../include/linux/pagemap.h.html#lock_page" title='lock_page' data-ref="lock_page" data-ref-filename="lock_page">lock_page</a>(<a class="local col7 ref" href="#177page" title='page' data-ref="177page" data-ref-filename="177page">page</a>);</td></tr>
<tr><th id="882">882</th><td></td></tr>
<tr><th id="883">883</th><td>	<b>return</b> (<a class="local col9 ref" href="#179rc" title='rc' data-ref="179rc" data-ref-filename="179rc">rc</a> &lt; <var>0</var>) ? -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#9" title="5" data-ref="_M/EIO">EIO</a> : -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="884">884</th><td>}</td></tr>
<tr><th id="885">885</th><td></td></tr>
<tr><th id="886">886</th><td><i  data-doc="fallback_migrate_page">/*</i></td></tr>
<tr><th id="887">887</th><td><i  data-doc="fallback_migrate_page"> * Default handling if a filesystem does not provide a migration function.</i></td></tr>
<tr><th id="888">888</th><td><i  data-doc="fallback_migrate_page"> */</i></td></tr>
<tr><th id="889">889</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="fallback_migrate_page" title='fallback_migrate_page' data-type='int fallback_migrate_page(struct address_space * mapping, struct page * newpage, struct page * page, enum migrate_mode mode)' data-ref="fallback_migrate_page" data-ref-filename="fallback_migrate_page">fallback_migrate_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col0 decl" id="180mapping" title='mapping' data-type='struct address_space *' data-ref="180mapping" data-ref-filename="180mapping">mapping</dfn>,</td></tr>
<tr><th id="890">890</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col1 decl" id="181newpage" title='newpage' data-type='struct page *' data-ref="181newpage" data-ref-filename="181newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col2 decl" id="182page" title='page' data-type='struct page *' data-ref="182page" data-ref-filename="182page">page</dfn>, <b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col3 decl" id="183mode" title='mode' data-type='enum migrate_mode' data-ref="183mode" data-ref-filename="183mode">mode</dfn>)</td></tr>
<tr><th id="891">891</th><td>{</td></tr>
<tr><th id="892">892</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#318" title='PageDirty' data-ref="PageDirty" data-ref-filename="PageDirty">PageDirty</a>(<a class="local col2 ref" href="#182page" title='page' data-ref="182page" data-ref-filename="182page">page</a>)) {</td></tr>
<tr><th id="893">893</th><td>		<i>/* Only writeback pages in full synchronous migration */</i></td></tr>
<tr><th id="894">894</th><td>		<b>switch</b> (<a class="local col3 ref" href="#183mode" title='mode' data-ref="183mode" data-ref-filename="183mode">mode</a>) {</td></tr>
<tr><th id="895">895</th><td>		<b>case</b> <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC" title='MIGRATE_SYNC' data-ref="MIGRATE_SYNC" data-ref-filename="MIGRATE_SYNC">MIGRATE_SYNC</a>:</td></tr>
<tr><th id="896">896</th><td>		<b>case</b> <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC_NO_COPY" title='MIGRATE_SYNC_NO_COPY' data-ref="MIGRATE_SYNC_NO_COPY" data-ref-filename="MIGRATE_SYNC_NO_COPY">MIGRATE_SYNC_NO_COPY</a>:</td></tr>
<tr><th id="897">897</th><td>			<b>break</b>;</td></tr>
<tr><th id="898">898</th><td>		<b>default</b>:</td></tr>
<tr><th id="899">899</th><td>			<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#20" title="16" data-ref="_M/EBUSY">EBUSY</a>;</td></tr>
<tr><th id="900">900</th><td>		}</td></tr>
<tr><th id="901">901</th><td>		<b>return</b> <a class="tu ref fn" href="#writeout" title='writeout' data-use='c' data-ref="writeout" data-ref-filename="writeout">writeout</a>(<a class="local col0 ref" href="#180mapping" title='mapping' data-ref="180mapping" data-ref-filename="180mapping">mapping</a>, <a class="local col2 ref" href="#182page" title='page' data-ref="182page" data-ref-filename="182page">page</a>);</td></tr>
<tr><th id="902">902</th><td>	}</td></tr>
<tr><th id="903">903</th><td></td></tr>
<tr><th id="904">904</th><td>	<i>/*</i></td></tr>
<tr><th id="905">905</th><td><i>	 * Buffers may be managed in a filesystem specific way.</i></td></tr>
<tr><th id="906">906</th><td><i>	 * We must have no buffers or drop them.</i></td></tr>
<tr><th id="907">907</th><td><i>	 */</i></td></tr>
<tr><th id="908">908</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#page_has_private" title='page_has_private' data-ref="page_has_private" data-ref-filename="page_has_private">page_has_private</a>(<a class="local col2 ref" href="#182page" title='page' data-ref="182page" data-ref-filename="182page">page</a>) &amp;&amp;</td></tr>
<tr><th id="909">909</th><td>	    !<a class="ref fn" href="../include/linux/mm.h.html#try_to_release_page" title='try_to_release_page' data-ref="try_to_release_page" data-ref-filename="try_to_release_page">try_to_release_page</a>(<a class="local col2 ref" href="#182page" title='page' data-ref="182page" data-ref-filename="182page">page</a>, <a class="macro" href="../include/linux/gfp.h.html#290" title="((( gfp_t)(0x400u|0x800u)) | (( gfp_t)0x40u) | (( gfp_t)0x80u))" data-ref="_M/GFP_KERNEL">GFP_KERNEL</a>))</td></tr>
<tr><th id="910">910</th><td>		<b>return</b> <a class="local col3 ref" href="#183mode" title='mode' data-ref="183mode" data-ref-filename="183mode">mode</a> == <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC" title='MIGRATE_SYNC' data-ref="MIGRATE_SYNC" data-ref-filename="MIGRATE_SYNC">MIGRATE_SYNC</a> ? -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a> : -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#20" title="16" data-ref="_M/EBUSY">EBUSY</a>;</td></tr>
<tr><th id="911">911</th><td></td></tr>
<tr><th id="912">912</th><td>	<b>return</b> <a class="ref fn" href="#migrate_page" title='migrate_page' data-ref="migrate_page" data-ref-filename="migrate_page">migrate_page</a>(<a class="local col0 ref" href="#180mapping" title='mapping' data-ref="180mapping" data-ref-filename="180mapping">mapping</a>, <a class="local col1 ref" href="#181newpage" title='newpage' data-ref="181newpage" data-ref-filename="181newpage">newpage</a>, <a class="local col2 ref" href="#182page" title='page' data-ref="182page" data-ref-filename="182page">page</a>, <a class="local col3 ref" href="#183mode" title='mode' data-ref="183mode" data-ref-filename="183mode">mode</a>);</td></tr>
<tr><th id="913">913</th><td>}</td></tr>
<tr><th id="914">914</th><td></td></tr>
<tr><th id="915">915</th><td><i  data-doc="move_to_new_page">/*</i></td></tr>
<tr><th id="916">916</th><td><i  data-doc="move_to_new_page"> * Move a page to a newly allocated page</i></td></tr>
<tr><th id="917">917</th><td><i  data-doc="move_to_new_page"> * The page is locked and all ptes have been successfully removed.</i></td></tr>
<tr><th id="918">918</th><td><i  data-doc="move_to_new_page"> *</i></td></tr>
<tr><th id="919">919</th><td><i  data-doc="move_to_new_page"> * The new page will have replaced the old page if this function</i></td></tr>
<tr><th id="920">920</th><td><i  data-doc="move_to_new_page"> * is successful.</i></td></tr>
<tr><th id="921">921</th><td><i  data-doc="move_to_new_page"> *</i></td></tr>
<tr><th id="922">922</th><td><i  data-doc="move_to_new_page"> * Return value:</i></td></tr>
<tr><th id="923">923</th><td><i  data-doc="move_to_new_page"> *   &lt; 0 - error code</i></td></tr>
<tr><th id="924">924</th><td><i  data-doc="move_to_new_page"> *  MIGRATEPAGE_SUCCESS - success</i></td></tr>
<tr><th id="925">925</th><td><i  data-doc="move_to_new_page"> */</i></td></tr>
<tr><th id="926">926</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="move_to_new_page" title='move_to_new_page' data-type='int move_to_new_page(struct page * newpage, struct page * page, enum migrate_mode mode)' data-ref="move_to_new_page" data-ref-filename="move_to_new_page">move_to_new_page</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col4 decl" id="184newpage" title='newpage' data-type='struct page *' data-ref="184newpage" data-ref-filename="184newpage">newpage</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col5 decl" id="185page" title='page' data-type='struct page *' data-ref="185page" data-ref-filename="185page">page</dfn>,</td></tr>
<tr><th id="927">927</th><td>				<b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col6 decl" id="186mode" title='mode' data-type='enum migrate_mode' data-ref="186mode" data-ref-filename="186mode">mode</dfn>)</td></tr>
<tr><th id="928">928</th><td>{</td></tr>
<tr><th id="929">929</th><td>	<b>struct</b> <a class="type" href="../include/linux/fs.h.html#address_space" title='address_space' data-ref="address_space" data-ref-filename="address_space">address_space</a> *<dfn class="local col7 decl" id="187mapping" title='mapping' data-type='struct address_space *' data-ref="187mapping" data-ref-filename="187mapping">mapping</dfn>;</td></tr>
<tr><th id="930">930</th><td>	<em>int</em> <dfn class="local col8 decl" id="188rc" title='rc' data-type='int' data-ref="188rc" data-ref-filename="188rc">rc</dfn> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="931">931</th><td>	<a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="local col9 decl" id="189is_lru" title='is_lru' data-type='bool' data-ref="189is_lru" data-ref-filename="189is_lru">is_lru</dfn> = !<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>);</td></tr>
<tr><th id="932">932</th><td></td></tr>
<tr><th id="933">933</th><td>	<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageLocked(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#312" title='PageLocked' data-ref="PageLocked" data-ref-filename="PageLocked">PageLocked</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>), page);</td></tr>
<tr><th id="934">934</th><td>	<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageLocked(newpage)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#312" title='PageLocked' data-ref="PageLocked" data-ref-filename="PageLocked">PageLocked</a>(<a class="local col4 ref" href="#184newpage" title='newpage' data-ref="184newpage" data-ref-filename="184newpage">newpage</a>), newpage);</td></tr>
<tr><th id="935">935</th><td></td></tr>
<tr><th id="936">936</th><td>	<a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a> = <a class="ref fn" href="../include/linux/mm.h.html#page_mapping" title='page_mapping' data-ref="page_mapping" data-ref-filename="page_mapping">page_mapping</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>);</td></tr>
<tr><th id="937">937</th><td></td></tr>
<tr><th id="938">938</th><td>	<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#77" title="__builtin_expect(!!(is_lru), 1)" data-ref="_M/likely">likely</a>(<a class="local col9 ref" href="#189is_lru" title='is_lru' data-ref="189is_lru" data-ref-filename="189is_lru">is_lru</a>)) {</td></tr>
<tr><th id="939">939</th><td>		<b>if</b> (!<a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>)</td></tr>
<tr><th id="940">940</th><td>			<a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a> = <a class="ref fn" href="#migrate_page" title='migrate_page' data-ref="migrate_page" data-ref-filename="migrate_page">migrate_page</a>(<a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>, <a class="local col4 ref" href="#184newpage" title='newpage' data-ref="184newpage" data-ref-filename="184newpage">newpage</a>, <a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>, <a class="local col6 ref" href="#186mode" title='mode' data-ref="186mode" data-ref-filename="186mode">mode</a>);</td></tr>
<tr><th id="941">941</th><td>		<b>else</b> <b>if</b> (<a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::a_ops" title='address_space::a_ops' data-ref="address_space::a_ops" data-ref-filename="address_space..a_ops">a_ops</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space_operations::migratepage" title='address_space_operations::migratepage' data-ref="address_space_operations::migratepage" data-ref-filename="address_space_operations..migratepage">migratepage</a>)</td></tr>
<tr><th id="942">942</th><td>			<i>/*</i></td></tr>
<tr><th id="943">943</th><td><i>			 * Most pages have a mapping and most filesystems</i></td></tr>
<tr><th id="944">944</th><td><i>			 * provide a migratepage callback. Anonymous pages</i></td></tr>
<tr><th id="945">945</th><td><i>			 * are part of swap space which also has its own</i></td></tr>
<tr><th id="946">946</th><td><i>			 * migratepage callback. This is the most common path</i></td></tr>
<tr><th id="947">947</th><td><i>			 * for page migration.</i></td></tr>
<tr><th id="948">948</th><td><i>			 */</i></td></tr>
<tr><th id="949">949</th><td>			<a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a> = <a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::a_ops" title='address_space::a_ops' data-ref="address_space::a_ops" data-ref-filename="address_space..a_ops">a_ops</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space_operations::migratepage" title='address_space_operations::migratepage' data-ref="address_space_operations::migratepage" data-ref-filename="address_space_operations..migratepage">migratepage</a>(<a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>, <a class="local col4 ref" href="#184newpage" title='newpage' data-ref="184newpage" data-ref-filename="184newpage">newpage</a>,</td></tr>
<tr><th id="950">950</th><td>							<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>, <a class="local col6 ref" href="#186mode" title='mode' data-ref="186mode" data-ref-filename="186mode">mode</a>);</td></tr>
<tr><th id="951">951</th><td>		<b>else</b></td></tr>
<tr><th id="952">952</th><td>			<a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a> = <a class="tu ref fn" href="#fallback_migrate_page" title='fallback_migrate_page' data-use='c' data-ref="fallback_migrate_page" data-ref-filename="fallback_migrate_page">fallback_migrate_page</a>(<a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>, <a class="local col4 ref" href="#184newpage" title='newpage' data-ref="184newpage" data-ref-filename="184newpage">newpage</a>,</td></tr>
<tr><th id="953">953</th><td>							<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>, <a class="local col6 ref" href="#186mode" title='mode' data-ref="186mode" data-ref-filename="186mode">mode</a>);</td></tr>
<tr><th id="954">954</th><td>	} <b>else</b> {</td></tr>
<tr><th id="955">955</th><td>		<i>/*</i></td></tr>
<tr><th id="956">956</th><td><i>		 * In case of non-lru page, it could be released after</i></td></tr>
<tr><th id="957">957</th><td><i>		 * isolation step. In that case, we shouldn't try migration.</i></td></tr>
<tr><th id="958">958</th><td><i>		 */</i></td></tr>
<tr><th id="959">959</th><td>		<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageIsolated(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='PageIsolated' data-ref="PageIsolated" data-ref-filename="PageIsolated">PageIsolated</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>), page);</td></tr>
<tr><th id="960">960</th><td>		<b>if</b> (!<a class="ref fn" href="../include/linux/migrate.h.html#PageMovable" title='PageMovable' data-ref="PageMovable" data-ref-filename="PageMovable">PageMovable</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>)) {</td></tr>
<tr><th id="961">961</th><td>			<a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a> = <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>;</td></tr>
<tr><th id="962">962</th><td>			<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='__ClearPageIsolated' data-ref="__ClearPageIsolated" data-ref-filename="__ClearPageIsolated">__ClearPageIsolated</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>);</td></tr>
<tr><th id="963">963</th><td>			<b>goto</b> <a class="lbl" href="#190out" data-ref="190out" data-ref-filename="190out">out</a>;</td></tr>
<tr><th id="964">964</th><td>		}</td></tr>
<tr><th id="965">965</th><td></td></tr>
<tr><th id="966">966</th><td>		<a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a> = <a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space::a_ops" title='address_space::a_ops' data-ref="address_space::a_ops" data-ref-filename="address_space..a_ops">a_ops</a>-&gt;<a class="ref field" href="../include/linux/fs.h.html#address_space_operations::migratepage" title='address_space_operations::migratepage' data-ref="address_space_operations::migratepage" data-ref-filename="address_space_operations..migratepage">migratepage</a>(<a class="local col7 ref" href="#187mapping" title='mapping' data-ref="187mapping" data-ref-filename="187mapping">mapping</a>, <a class="local col4 ref" href="#184newpage" title='newpage' data-ref="184newpage" data-ref-filename="184newpage">newpage</a>,</td></tr>
<tr><th id="967">967</th><td>						<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>, <a class="local col6 ref" href="#186mode" title='mode' data-ref="186mode" data-ref-filename="186mode">mode</a>);</td></tr>
<tr><th id="968">968</th><td>		<a class="macro" href="../include/asm-generic/bug.h.html#68" title="({ int __ret_warn_on = !!(rc == 0 &amp;&amp; !PageIsolated(page)); if (__builtin_expect(!!(__ret_warn_on), 0)) do { do { asm volatile(&quot;1:\t&quot; &quot;.byte 0x0f, 0x0b&quot; &quot;\n&quot; &quot;.pushsection __bug_table,\&quot;aw\&quot;\n&quot; &quot;2:\t&quot; &quot;.long &quot; &quot;1b&quot; &quot; - 2b&quot; &quot;\t# bug_entry::bug_addr\n&quot; &quot;\t&quot; &quot;.long &quot; &quot;%c0&quot; &quot; - 2b&quot; &quot;\t# bug_entry::file\n&quot; &quot;\t.word %c1&quot; &quot;\t# bug_entry::line\n&quot; &quot;\t.word %c2&quot; &quot;\t# bug_entry::flags\n&quot; &quot;\t.org 2b+%c3\n&quot; &quot;.popsection&quot; : : &quot;i&quot; (&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;), &quot;i&quot; (969), &quot;i&quot; ((1 &lt;&lt; 0)|((1 &lt;&lt; 1)|((9) &lt;&lt; 8))), &quot;i&quot; (sizeof(struct bug_entry))); } while (0); ({ asm volatile(&quot;%c0:\n\t&quot; &quot;.pushsection .discard.reachable\n\t&quot; &quot;.long %c0b - .\n\t&quot; &quot;.popsection\n\t&quot; : : &quot;i&quot; (114)); }); } while (0); __builtin_expect(!!(__ret_warn_on), 0); })" data-ref="_M/WARN_ON_ONCE">WARN_ON_ONCE</a>(<a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a> &amp;&amp;</td></tr>
<tr><th id="969">969</th><td>			!<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='PageIsolated' data-ref="PageIsolated" data-ref-filename="PageIsolated">PageIsolated</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>));</td></tr>
<tr><th id="970">970</th><td>	}</td></tr>
<tr><th id="971">971</th><td></td></tr>
<tr><th id="972">972</th><td>	<i>/*</i></td></tr>
<tr><th id="973">973</th><td><i>	 * When successful, old pagecache page-&gt;mapping must be cleared before</i></td></tr>
<tr><th id="974">974</th><td><i>	 * page is freed; but stats require that PageAnon be left as PageAnon.</i></td></tr>
<tr><th id="975">975</th><td><i>	 */</i></td></tr>
<tr><th id="976">976</th><td>	<b>if</b> (<a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>) {</td></tr>
<tr><th id="977">977</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>)) {</td></tr>
<tr><th id="978">978</th><td>			<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(!PageIsolated(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='PageIsolated' data-ref="PageIsolated" data-ref-filename="PageIsolated">PageIsolated</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>), page);</td></tr>
<tr><th id="979">979</th><td></td></tr>
<tr><th id="980">980</th><td>			<i>/*</i></td></tr>
<tr><th id="981">981</th><td><i>			 * We clear PG_movable under page_lock so any compactor</i></td></tr>
<tr><th id="982">982</th><td><i>			 * cannot try to migrate this page.</i></td></tr>
<tr><th id="983">983</th><td><i>			 */</i></td></tr>
<tr><th id="984">984</th><td>			<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='__ClearPageIsolated' data-ref="__ClearPageIsolated" data-ref-filename="__ClearPageIsolated">__ClearPageIsolated</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>);</td></tr>
<tr><th id="985">985</th><td>		}</td></tr>
<tr><th id="986">986</th><td></td></tr>
<tr><th id="987">987</th><td>		<i>/*</i></td></tr>
<tr><th id="988">988</th><td><i>		 * Anonymous and movable page-&gt;mapping will be cleard by</i></td></tr>
<tr><th id="989">989</th><td><i>		 * free_pages_prepare so don't reset it here for keeping</i></td></tr>
<tr><th id="990">990</th><td><i>		 * the type to work PageAnon, for example.</i></td></tr>
<tr><th id="991">991</th><td><i>		 */</i></td></tr>
<tr><th id="992">992</th><td>		<b>if</b> (!<a class="ref fn" href="../include/linux/page-flags.h.html#PageMappingFlags" title='PageMappingFlags' data-ref="PageMappingFlags" data-ref-filename="PageMappingFlags">PageMappingFlags</a>(<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>))</td></tr>
<tr><th id="993">993</th><td>			<a class="local col5 ref" href="#185page" title='page' data-ref="185page" data-ref-filename="185page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a> = <a class="macro" href="../include/linux/stddef.h.html#8" title="((void *)0)" data-ref="_M/NULL">NULL</a>;</td></tr>
<tr><th id="994">994</th><td></td></tr>
<tr><th id="995">995</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#77" title="__builtin_expect(!!(!is_zone_device_page(newpage)), 1)" data-ref="_M/likely">likely</a>(!<a class="ref fn" href="../include/linux/mm.h.html#is_zone_device_page" title='is_zone_device_page' data-ref="is_zone_device_page" data-ref-filename="is_zone_device_page">is_zone_device_page</a>(<a class="local col4 ref" href="#184newpage" title='newpage' data-ref="184newpage" data-ref-filename="184newpage">newpage</a>)))</td></tr>
<tr><th id="996">996</th><td>			<a class="ref fn" href="../include/asm-generic/cacheflush.h.html#flush_dcache_page" title='flush_dcache_page' data-ref="flush_dcache_page" data-ref-filename="flush_dcache_page">flush_dcache_page</a>(<a class="local col4 ref" href="#184newpage" title='newpage' data-ref="184newpage" data-ref-filename="184newpage">newpage</a>);</td></tr>
<tr><th id="997">997</th><td></td></tr>
<tr><th id="998">998</th><td>	}</td></tr>
<tr><th id="999">999</th><td><dfn class="lbl" id="190out" data-ref="190out" data-ref-filename="190out">out</dfn>:</td></tr>
<tr><th id="1000">1000</th><td>	<b>return</b> <a class="local col8 ref" href="#188rc" title='rc' data-ref="188rc" data-ref-filename="188rc">rc</a>;</td></tr>
<tr><th id="1001">1001</th><td>}</td></tr>
<tr><th id="1002">1002</th><td></td></tr>
<tr><th id="1003">1003</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="__unmap_and_move" title='__unmap_and_move' data-type='int __unmap_and_move(struct page * page, struct page * newpage, int force, enum migrate_mode mode)' data-ref="__unmap_and_move" data-ref-filename="__unmap_and_move">__unmap_and_move</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col1 decl" id="191page" title='page' data-type='struct page *' data-ref="191page" data-ref-filename="191page">page</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col2 decl" id="192newpage" title='newpage' data-type='struct page *' data-ref="192newpage" data-ref-filename="192newpage">newpage</dfn>,</td></tr>
<tr><th id="1004">1004</th><td>				<em>int</em> <dfn class="local col3 decl" id="193force" title='force' data-type='int' data-ref="193force" data-ref-filename="193force">force</dfn>, <b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col4 decl" id="194mode" title='mode' data-type='enum migrate_mode' data-ref="194mode" data-ref-filename="194mode">mode</dfn>)</td></tr>
<tr><th id="1005">1005</th><td>{</td></tr>
<tr><th id="1006">1006</th><td>	<em>int</em> <dfn class="local col5 decl" id="195rc" title='rc' data-type='int' data-ref="195rc" data-ref-filename="195rc">rc</dfn> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="1007">1007</th><td>	<em>int</em> <dfn class="local col6 decl" id="196page_was_mapped" title='page_was_mapped' data-type='int' data-ref="196page_was_mapped" data-ref-filename="196page_was_mapped">page_was_mapped</dfn> = <var>0</var>;</td></tr>
<tr><th id="1008">1008</th><td>	<b>struct</b> <a class="type" href="../include/linux/rmap.h.html#anon_vma" title='anon_vma' data-ref="anon_vma" data-ref-filename="anon_vma">anon_vma</a> *<dfn class="local col7 decl" id="197anon_vma" title='anon_vma' data-type='struct anon_vma *' data-ref="197anon_vma" data-ref-filename="197anon_vma">anon_vma</dfn> = <a class="macro" href="../include/linux/stddef.h.html#8" title="((void *)0)" data-ref="_M/NULL">NULL</a>;</td></tr>
<tr><th id="1009">1009</th><td>	<a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="local col8 decl" id="198is_lru" title='is_lru' data-type='bool' data-ref="198is_lru" data-ref-filename="198is_lru">is_lru</dfn> = !<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>);</td></tr>
<tr><th id="1010">1010</th><td></td></tr>
<tr><th id="1011">1011</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/pagemap.h.html#trylock_page" title='trylock_page' data-ref="trylock_page" data-ref-filename="trylock_page">trylock_page</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>)) {</td></tr>
<tr><th id="1012">1012</th><td>		<b>if</b> (!<a class="local col3 ref" href="#193force" title='force' data-ref="193force" data-ref-filename="193force">force</a> || <a class="local col4 ref" href="#194mode" title='mode' data-ref="194mode" data-ref-filename="194mode">mode</a> == <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_ASYNC" title='MIGRATE_ASYNC' data-ref="MIGRATE_ASYNC" data-ref-filename="MIGRATE_ASYNC">MIGRATE_ASYNC</a>)</td></tr>
<tr><th id="1013">1013</th><td>			<b>goto</b> <a class="lbl" href="#199out" data-ref="199out" data-ref-filename="199out">out</a>;</td></tr>
<tr><th id="1014">1014</th><td></td></tr>
<tr><th id="1015">1015</th><td>		<i>/*</i></td></tr>
<tr><th id="1016">1016</th><td><i>		 * It's not safe for direct compaction to call lock_page.</i></td></tr>
<tr><th id="1017">1017</th><td><i>		 * For example, during page readahead pages are added locked</i></td></tr>
<tr><th id="1018">1018</th><td><i>		 * to the LRU. Later, when the IO completes the pages are</i></td></tr>
<tr><th id="1019">1019</th><td><i>		 * marked uptodate and unlocked. However, the queueing</i></td></tr>
<tr><th id="1020">1020</th><td><i>		 * could be merging multiple pages for one bio (e.g.</i></td></tr>
<tr><th id="1021">1021</th><td><i>		 * mpage_readpages). If an allocation happens for the</i></td></tr>
<tr><th id="1022">1022</th><td><i>		 * second or third page, the process can end up locking</i></td></tr>
<tr><th id="1023">1023</th><td><i>		 * the same page twice and deadlocking. Rather than</i></td></tr>
<tr><th id="1024">1024</th><td><i>		 * trying to be clever about what pages can be locked,</i></td></tr>
<tr><th id="1025">1025</th><td><i>		 * avoid the use of lock_page for direct compaction</i></td></tr>
<tr><th id="1026">1026</th><td><i>		 * altogether.</i></td></tr>
<tr><th id="1027">1027</th><td><i>		 */</i></td></tr>
<tr><th id="1028">1028</th><td>		<b>if</b> (<a class="macro" href="../arch/x86/include/asm/current.h.html#18" title="get_current()" data-ref="_M/current">current</a>-&gt;<a class="ref field" href="../include/linux/sched.h.html#task_struct::flags" title='task_struct::flags' data-ref="task_struct::flags" data-ref-filename="task_struct..flags">flags</a> &amp; <a class="macro" href="../include/linux/sched.h.html#1461" title="0x00000800" data-ref="_M/PF_MEMALLOC">PF_MEMALLOC</a>)</td></tr>
<tr><th id="1029">1029</th><td>			<b>goto</b> <a class="lbl" href="#199out" data-ref="199out" data-ref-filename="199out">out</a>;</td></tr>
<tr><th id="1030">1030</th><td></td></tr>
<tr><th id="1031">1031</th><td>		<a class="ref fn" href="../include/linux/pagemap.h.html#lock_page" title='lock_page' data-ref="lock_page" data-ref-filename="lock_page">lock_page</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>);</td></tr>
<tr><th id="1032">1032</th><td>	}</td></tr>
<tr><th id="1033">1033</th><td></td></tr>
<tr><th id="1034">1034</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#359" title='PageWriteback' data-ref="PageWriteback" data-ref-filename="PageWriteback">PageWriteback</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>)) {</td></tr>
<tr><th id="1035">1035</th><td>		<i>/*</i></td></tr>
<tr><th id="1036">1036</th><td><i>		 * Only in the case of a full synchronous migration is it</i></td></tr>
<tr><th id="1037">1037</th><td><i>		 * necessary to wait for PageWriteback. In the async case,</i></td></tr>
<tr><th id="1038">1038</th><td><i>		 * the retry loop is too short and in the sync-light case,</i></td></tr>
<tr><th id="1039">1039</th><td><i>		 * the overhead of stalling is too much</i></td></tr>
<tr><th id="1040">1040</th><td><i>		 */</i></td></tr>
<tr><th id="1041">1041</th><td>		<b>switch</b> (<a class="local col4 ref" href="#194mode" title='mode' data-ref="194mode" data-ref-filename="194mode">mode</a>) {</td></tr>
<tr><th id="1042">1042</th><td>		<b>case</b> <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC" title='MIGRATE_SYNC' data-ref="MIGRATE_SYNC" data-ref-filename="MIGRATE_SYNC">MIGRATE_SYNC</a>:</td></tr>
<tr><th id="1043">1043</th><td>		<b>case</b> <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC_NO_COPY" title='MIGRATE_SYNC_NO_COPY' data-ref="MIGRATE_SYNC_NO_COPY" data-ref-filename="MIGRATE_SYNC_NO_COPY">MIGRATE_SYNC_NO_COPY</a>:</td></tr>
<tr><th id="1044">1044</th><td>			<b>break</b>;</td></tr>
<tr><th id="1045">1045</th><td>		<b>default</b>:</td></tr>
<tr><th id="1046">1046</th><td>			<a class="local col5 ref" href="#195rc" title='rc' data-ref="195rc" data-ref-filename="195rc">rc</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#20" title="16" data-ref="_M/EBUSY">EBUSY</a>;</td></tr>
<tr><th id="1047">1047</th><td>			<b>goto</b> <a class="lbl" href="#200out_unlock" data-ref="200out_unlock" data-ref-filename="200out_unlock">out_unlock</a>;</td></tr>
<tr><th id="1048">1048</th><td>		}</td></tr>
<tr><th id="1049">1049</th><td>		<b>if</b> (!<a class="local col3 ref" href="#193force" title='force' data-ref="193force" data-ref-filename="193force">force</a>)</td></tr>
<tr><th id="1050">1050</th><td>			<b>goto</b> <a class="lbl" href="#200out_unlock" data-ref="200out_unlock" data-ref-filename="200out_unlock">out_unlock</a>;</td></tr>
<tr><th id="1051">1051</th><td>		<a class="ref fn" href="../include/linux/pagemap.h.html#wait_on_page_writeback" title='wait_on_page_writeback' data-ref="wait_on_page_writeback" data-ref-filename="wait_on_page_writeback">wait_on_page_writeback</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>);</td></tr>
<tr><th id="1052">1052</th><td>	}</td></tr>
<tr><th id="1053">1053</th><td></td></tr>
<tr><th id="1054">1054</th><td>	<i>/*</i></td></tr>
<tr><th id="1055">1055</th><td><i>	 * By try_to_unmap(), page-&gt;mapcount goes down to 0 here. In this case,</i></td></tr>
<tr><th id="1056">1056</th><td><i>	 * we cannot notice that anon_vma is freed while we migrates a page.</i></td></tr>
<tr><th id="1057">1057</th><td><i>	 * This get_anon_vma() delays freeing anon_vma pointer until the end</i></td></tr>
<tr><th id="1058">1058</th><td><i>	 * of migration. File cache pages are no problem because of page_lock()</i></td></tr>
<tr><th id="1059">1059</th><td><i>	 * File Caches may use write_page() or lock_page() in migration, then,</i></td></tr>
<tr><th id="1060">1060</th><td><i>	 * just care Anon page here.</i></td></tr>
<tr><th id="1061">1061</th><td><i>	 *</i></td></tr>
<tr><th id="1062">1062</th><td><i>	 * Only page_get_anon_vma() understands the subtleties of</i></td></tr>
<tr><th id="1063">1063</th><td><i>	 * getting a hold on an anon_vma from outside one of its mms.</i></td></tr>
<tr><th id="1064">1064</th><td><i>	 * But if we cannot get anon_vma, then we won't need it anyway,</i></td></tr>
<tr><th id="1065">1065</th><td><i>	 * because that implies that the anon page is no longer mapped</i></td></tr>
<tr><th id="1066">1066</th><td><i>	 * (and cannot be remapped so long as we hold the page lock).</i></td></tr>
<tr><th id="1067">1067</th><td><i>	 */</i></td></tr>
<tr><th id="1068">1068</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageAnon" title='PageAnon' data-ref="PageAnon" data-ref-filename="PageAnon">PageAnon</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>) &amp;&amp; !<a class="ref fn" href="../include/linux/page-flags.h.html#487" title='PageKsm' data-ref="PageKsm" data-ref-filename="PageKsm">PageKsm</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>))</td></tr>
<tr><th id="1069">1069</th><td>		<a class="local col7 ref" href="#197anon_vma" title='anon_vma' data-ref="197anon_vma" data-ref-filename="197anon_vma">anon_vma</a> = <a class="ref fn" href="../include/linux/rmap.h.html#page_get_anon_vma" title='page_get_anon_vma' data-ref="page_get_anon_vma" data-ref-filename="page_get_anon_vma">page_get_anon_vma</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>);</td></tr>
<tr><th id="1070">1070</th><td></td></tr>
<tr><th id="1071">1071</th><td>	<i>/*</i></td></tr>
<tr><th id="1072">1072</th><td><i>	 * Block others from accessing the new page when we get around to</i></td></tr>
<tr><th id="1073">1073</th><td><i>	 * establishing additional references. We are usually the only one</i></td></tr>
<tr><th id="1074">1074</th><td><i>	 * holding a reference to newpage at this point. We used to have a BUG</i></td></tr>
<tr><th id="1075">1075</th><td><i>	 * here if trylock_page(newpage) fails, but would like to allow for</i></td></tr>
<tr><th id="1076">1076</th><td><i>	 * cases where there might be a race with the previous use of newpage.</i></td></tr>
<tr><th id="1077">1077</th><td><i>	 * This is much like races on refcount of oldpage: just don't BUG().</i></td></tr>
<tr><th id="1078">1078</th><td><i>	 */</i></td></tr>
<tr><th id="1079">1079</th><td>	<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(!trylock_page(newpage)), 0)" data-ref="_M/unlikely">unlikely</a>(!<a class="ref fn" href="../include/linux/pagemap.h.html#trylock_page" title='trylock_page' data-ref="trylock_page" data-ref-filename="trylock_page">trylock_page</a>(<a class="local col2 ref" href="#192newpage" title='newpage' data-ref="192newpage" data-ref-filename="192newpage">newpage</a>)))</td></tr>
<tr><th id="1080">1080</th><td>		<b>goto</b> <a class="lbl" href="#200out_unlock" data-ref="200out_unlock" data-ref-filename="200out_unlock">out_unlock</a>;</td></tr>
<tr><th id="1081">1081</th><td></td></tr>
<tr><th id="1082">1082</th><td>	<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(!is_lru), 0)" data-ref="_M/unlikely">unlikely</a>(!<a class="local col8 ref" href="#198is_lru" title='is_lru' data-ref="198is_lru" data-ref-filename="198is_lru">is_lru</a>)) {</td></tr>
<tr><th id="1083">1083</th><td>		<a class="local col5 ref" href="#195rc" title='rc' data-ref="195rc" data-ref-filename="195rc">rc</a> = <a class="tu ref fn" href="#move_to_new_page" title='move_to_new_page' data-use='c' data-ref="move_to_new_page" data-ref-filename="move_to_new_page">move_to_new_page</a>(<a class="local col2 ref" href="#192newpage" title='newpage' data-ref="192newpage" data-ref-filename="192newpage">newpage</a>, <a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>, <a class="local col4 ref" href="#194mode" title='mode' data-ref="194mode" data-ref-filename="194mode">mode</a>);</td></tr>
<tr><th id="1084">1084</th><td>		<b>goto</b> <a class="lbl" href="#201out_unlock_both" data-ref="201out_unlock_both" data-ref-filename="201out_unlock_both">out_unlock_both</a>;</td></tr>
<tr><th id="1085">1085</th><td>	}</td></tr>
<tr><th id="1086">1086</th><td></td></tr>
<tr><th id="1087">1087</th><td>	<i>/*</i></td></tr>
<tr><th id="1088">1088</th><td><i>	 * Corner case handling:</i></td></tr>
<tr><th id="1089">1089</th><td><i>	 * 1. When a new swap-cache page is read into, it is added to the LRU</i></td></tr>
<tr><th id="1090">1090</th><td><i>	 * and treated as swapcache but it has no rmap yet.</i></td></tr>
<tr><th id="1091">1091</th><td><i>	 * Calling try_to_unmap() against a page-&gt;mapping==NULL page will</i></td></tr>
<tr><th id="1092">1092</th><td><i>	 * trigger a BUG.  So handle it here.</i></td></tr>
<tr><th id="1093">1093</th><td><i>	 * 2. An orphaned page (see truncate_complete_page) might have</i></td></tr>
<tr><th id="1094">1094</th><td><i>	 * fs-private metadata. The page can be picked up due to memory</i></td></tr>
<tr><th id="1095">1095</th><td><i>	 * offlining.  Everywhere else except page reclaim, the page is</i></td></tr>
<tr><th id="1096">1096</th><td><i>	 * invisible to the vm, so the page can not be migrated.  So try to</i></td></tr>
<tr><th id="1097">1097</th><td><i>	 * free the metadata, so the page can be freed.</i></td></tr>
<tr><th id="1098">1098</th><td><i>	 */</i></td></tr>
<tr><th id="1099">1099</th><td>	<b>if</b> (!<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::mapping" title='page::(anonymous union)::(anonymous struct)::mapping' data-ref="page::(anonymousunion)::(anonymous)::mapping" data-ref-filename="page..(anonymousunion)..(anonymous)..mapping">mapping</a>) {</td></tr>
<tr><th id="1100">1100</th><td>		<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(PageAnon(page)))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#PageAnon" title='PageAnon' data-ref="PageAnon" data-ref-filename="PageAnon">PageAnon</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>), page);</td></tr>
<tr><th id="1101">1101</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#page_has_private" title='page_has_private' data-ref="page_has_private" data-ref-filename="page_has_private">page_has_private</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>)) {</td></tr>
<tr><th id="1102">1102</th><td>			<a class="ref fn" href="../include/linux/buffer_head.h.html#try_to_free_buffers" title='try_to_free_buffers' data-ref="try_to_free_buffers" data-ref-filename="try_to_free_buffers">try_to_free_buffers</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>);</td></tr>
<tr><th id="1103">1103</th><td>			<b>goto</b> <a class="lbl" href="#201out_unlock_both" data-ref="201out_unlock_both" data-ref-filename="201out_unlock_both">out_unlock_both</a>;</td></tr>
<tr><th id="1104">1104</th><td>		}</td></tr>
<tr><th id="1105">1105</th><td>	} <b>else</b> <b>if</b> (<a class="ref fn" href="../include/linux/mm.h.html#page_mapped" title='page_mapped' data-ref="page_mapped" data-ref-filename="page_mapped">page_mapped</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>)) {</td></tr>
<tr><th id="1106">1106</th><td>		<i>/* Establish migration ptes */</i></td></tr>
<tr><th id="1107">1107</th><td>		<a class="macro" href="../include/linux/mmdebug.h.html#46" title="((void)(sizeof(( long)(PageAnon(page) &amp;&amp; !PageKsm(page) &amp;&amp; !anon_vma))))" data-ref="_M/VM_BUG_ON_PAGE">VM_BUG_ON_PAGE</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#PageAnon" title='PageAnon' data-ref="PageAnon" data-ref-filename="PageAnon">PageAnon</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>) &amp;&amp; !<a class="ref fn" href="../include/linux/page-flags.h.html#487" title='PageKsm' data-ref="PageKsm" data-ref-filename="PageKsm">PageKsm</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>) &amp;&amp; !<a class="local col7 ref" href="#197anon_vma" title='anon_vma' data-ref="197anon_vma" data-ref-filename="197anon_vma">anon_vma</a>,</td></tr>
<tr><th id="1108">1108</th><td>				page);</td></tr>
<tr><th id="1109">1109</th><td>		<a class="ref fn" href="../include/linux/rmap.h.html#try_to_unmap" title='try_to_unmap' data-ref="try_to_unmap" data-ref-filename="try_to_unmap">try_to_unmap</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>,</td></tr>
<tr><th id="1110">1110</th><td>			<a class="enum" href="../include/linux/rmap.h.html#TTU_MIGRATION" title='TTU_MIGRATION' data-ref="TTU_MIGRATION" data-ref-filename="TTU_MIGRATION">TTU_MIGRATION</a>|<a class="enum" href="../include/linux/rmap.h.html#TTU_IGNORE_MLOCK" title='TTU_IGNORE_MLOCK' data-ref="TTU_IGNORE_MLOCK" data-ref-filename="TTU_IGNORE_MLOCK">TTU_IGNORE_MLOCK</a>|<a class="enum" href="../include/linux/rmap.h.html#TTU_IGNORE_ACCESS" title='TTU_IGNORE_ACCESS' data-ref="TTU_IGNORE_ACCESS" data-ref-filename="TTU_IGNORE_ACCESS">TTU_IGNORE_ACCESS</a>);</td></tr>
<tr><th id="1111">1111</th><td>		<a class="local col6 ref" href="#196page_was_mapped" title='page_was_mapped' data-ref="196page_was_mapped" data-ref-filename="196page_was_mapped">page_was_mapped</a> = <var>1</var>;</td></tr>
<tr><th id="1112">1112</th><td>	}</td></tr>
<tr><th id="1113">1113</th><td></td></tr>
<tr><th id="1114">1114</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/mm.h.html#page_mapped" title='page_mapped' data-ref="page_mapped" data-ref-filename="page_mapped">page_mapped</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>))</td></tr>
<tr><th id="1115">1115</th><td>		<a class="local col5 ref" href="#195rc" title='rc' data-ref="195rc" data-ref-filename="195rc">rc</a> = <a class="tu ref fn" href="#move_to_new_page" title='move_to_new_page' data-use='c' data-ref="move_to_new_page" data-ref-filename="move_to_new_page">move_to_new_page</a>(<a class="local col2 ref" href="#192newpage" title='newpage' data-ref="192newpage" data-ref-filename="192newpage">newpage</a>, <a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>, <a class="local col4 ref" href="#194mode" title='mode' data-ref="194mode" data-ref-filename="194mode">mode</a>);</td></tr>
<tr><th id="1116">1116</th><td></td></tr>
<tr><th id="1117">1117</th><td>	<b>if</b> (<a class="local col6 ref" href="#196page_was_mapped" title='page_was_mapped' data-ref="196page_was_mapped" data-ref-filename="196page_was_mapped">page_was_mapped</a>)</td></tr>
<tr><th id="1118">1118</th><td>		<a class="ref fn" href="#remove_migration_ptes" title='remove_migration_ptes' data-ref="remove_migration_ptes" data-ref-filename="remove_migration_ptes">remove_migration_ptes</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>,</td></tr>
<tr><th id="1119">1119</th><td>			<a class="local col5 ref" href="#195rc" title='rc' data-ref="195rc" data-ref-filename="195rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a> ? <a class="local col2 ref" href="#192newpage" title='newpage' data-ref="192newpage" data-ref-filename="192newpage">newpage</a> : <a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>, <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>);</td></tr>
<tr><th id="1120">1120</th><td></td></tr>
<tr><th id="1121">1121</th><td><dfn class="lbl" id="201out_unlock_both" data-ref="201out_unlock_both" data-ref-filename="201out_unlock_both">out_unlock_both</dfn>:</td></tr>
<tr><th id="1122">1122</th><td>	<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col2 ref" href="#192newpage" title='newpage' data-ref="192newpage" data-ref-filename="192newpage">newpage</a>);</td></tr>
<tr><th id="1123">1123</th><td><dfn class="lbl" id="200out_unlock" data-ref="200out_unlock" data-ref-filename="200out_unlock">out_unlock</dfn>:</td></tr>
<tr><th id="1124">1124</th><td>	<i>/* Drop an anon_vma reference if we took one */</i></td></tr>
<tr><th id="1125">1125</th><td>	<b>if</b> (<a class="local col7 ref" href="#197anon_vma" title='anon_vma' data-ref="197anon_vma" data-ref-filename="197anon_vma">anon_vma</a>)</td></tr>
<tr><th id="1126">1126</th><td>		<a class="ref fn" href="../include/linux/rmap.h.html#put_anon_vma" title='put_anon_vma' data-ref="put_anon_vma" data-ref-filename="put_anon_vma">put_anon_vma</a>(<a class="local col7 ref" href="#197anon_vma" title='anon_vma' data-ref="197anon_vma" data-ref-filename="197anon_vma">anon_vma</a>);</td></tr>
<tr><th id="1127">1127</th><td>	<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col1 ref" href="#191page" title='page' data-ref="191page" data-ref-filename="191page">page</a>);</td></tr>
<tr><th id="1128">1128</th><td><dfn class="lbl" id="199out" data-ref="199out" data-ref-filename="199out">out</dfn>:</td></tr>
<tr><th id="1129">1129</th><td>	<i>/*</i></td></tr>
<tr><th id="1130">1130</th><td><i>	 * If migration is successful, decrease refcount of the newpage</i></td></tr>
<tr><th id="1131">1131</th><td><i>	 * which will not free the page because new page owner increased</i></td></tr>
<tr><th id="1132">1132</th><td><i>	 * refcounter. As well, if it is LRU page, add the page to LRU</i></td></tr>
<tr><th id="1133">1133</th><td><i>	 * list in here. Use the old state of the isolated source page to</i></td></tr>
<tr><th id="1134">1134</th><td><i>	 * determine if we migrated a LRU page. newpage was already unlocked</i></td></tr>
<tr><th id="1135">1135</th><td><i>	 * and possibly modified by its owner - don't rely on the page</i></td></tr>
<tr><th id="1136">1136</th><td><i>	 * state.</i></td></tr>
<tr><th id="1137">1137</th><td><i>	 */</i></td></tr>
<tr><th id="1138">1138</th><td>	<b>if</b> (<a class="local col5 ref" href="#195rc" title='rc' data-ref="195rc" data-ref-filename="195rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>) {</td></tr>
<tr><th id="1139">1139</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(!is_lru), 0)" data-ref="_M/unlikely">unlikely</a>(!<a class="local col8 ref" href="#198is_lru" title='is_lru' data-ref="198is_lru" data-ref-filename="198is_lru">is_lru</a>))</td></tr>
<tr><th id="1140">1140</th><td>			<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col2 ref" href="#192newpage" title='newpage' data-ref="192newpage" data-ref-filename="192newpage">newpage</a>);</td></tr>
<tr><th id="1141">1141</th><td>		<b>else</b></td></tr>
<tr><th id="1142">1142</th><td>			<a class="ref fn" href="internal.h.html#putback_lru_page" title='putback_lru_page' data-ref="putback_lru_page" data-ref-filename="putback_lru_page">putback_lru_page</a>(<a class="local col2 ref" href="#192newpage" title='newpage' data-ref="192newpage" data-ref-filename="192newpage">newpage</a>);</td></tr>
<tr><th id="1143">1143</th><td>	}</td></tr>
<tr><th id="1144">1144</th><td></td></tr>
<tr><th id="1145">1145</th><td>	<b>return</b> <a class="local col5 ref" href="#195rc" title='rc' data-ref="195rc" data-ref-filename="195rc">rc</a>;</td></tr>
<tr><th id="1146">1146</th><td>}</td></tr>
<tr><th id="1147">1147</th><td></td></tr>
<tr><th id="1148">1148</th><td><i>/*</i></td></tr>
<tr><th id="1149">1149</th><td><i> * gcc 4.7 and 4.8 on arm get an ICEs when inlining unmap_and_move().  Work</i></td></tr>
<tr><th id="1150">1150</th><td><i> * around it.</i></td></tr>
<tr><th id="1151">1151</th><td><i> */</i></td></tr>
<tr><th id="1152">1152</th><td><u>#<span data-ppcond="1152">if</span> defined(<span class="macro" data-ref="_M/CONFIG_ARM">CONFIG_ARM</span>) &amp;&amp; \</u></td></tr>
<tr><th id="1153">1153</th><td><u>	defined(<span class="macro" data-ref="_M/GCC_VERSION">GCC_VERSION</span>) &amp;&amp; GCC_VERSION &lt; 40900 &amp;&amp; GCC_VERSION &gt;= 40700</u></td></tr>
<tr><th id="1154">1154</th><td><u>#define ICE_noinline noinline</u></td></tr>
<tr><th id="1155">1155</th><td><u>#<span data-ppcond="1152">else</span></u></td></tr>
<tr><th id="1156">1156</th><td><u>#define <dfn class="macro" id="_M/ICE_noinline" data-ref="_M/ICE_noinline">ICE_noinline</dfn></u></td></tr>
<tr><th id="1157">1157</th><td><u>#<span data-ppcond="1152">endif</span></u></td></tr>
<tr><th id="1158">1158</th><td></td></tr>
<tr><th id="1159">1159</th><td><i  data-doc="unmap_and_move">/*</i></td></tr>
<tr><th id="1160">1160</th><td><i  data-doc="unmap_and_move"> * Obtain the lock on page, remove all ptes and migrate the page</i></td></tr>
<tr><th id="1161">1161</th><td><i  data-doc="unmap_and_move"> * to the newly allocated page in newpage.</i></td></tr>
<tr><th id="1162">1162</th><td><i  data-doc="unmap_and_move"> */</i></td></tr>
<tr><th id="1163">1163</th><td><em>static</em> <a class="macro" href="#1156" title="" data-ref="_M/ICE_noinline">ICE_noinline</a> <em>int</em> <dfn class="tu decl def fn" id="unmap_and_move" title='unmap_and_move' data-type='int unmap_and_move(new_page_t * get_new_page, free_page_t * put_new_page, unsigned long private, struct page * page, int force, enum migrate_mode mode, enum migrate_reason reason)' data-ref="unmap_and_move" data-ref-filename="unmap_and_move">unmap_and_move</dfn>(<a class="typedef" href="../include/linux/migrate.h.html#new_page_t" title='new_page_t' data-type='struct page *(struct page *, unsigned long)' data-ref="new_page_t" data-ref-filename="new_page_t">new_page_t</a> <dfn class="local col2 decl" id="202get_new_page" title='get_new_page' data-type='new_page_t *' data-ref="202get_new_page" data-ref-filename="202get_new_page">get_new_page</dfn>,</td></tr>
<tr><th id="1164">1164</th><td>				   <a class="typedef" href="../include/linux/migrate.h.html#free_page_t" title='free_page_t' data-type='void (struct page *, unsigned long)' data-ref="free_page_t" data-ref-filename="free_page_t">free_page_t</a> <dfn class="local col3 decl" id="203put_new_page" title='put_new_page' data-type='free_page_t *' data-ref="203put_new_page" data-ref-filename="203put_new_page">put_new_page</dfn>,</td></tr>
<tr><th id="1165">1165</th><td>				   <em>unsigned</em> <em>long</em> <dfn class="local col4 decl" id="204private" title='private' data-type='unsigned long' data-ref="204private" data-ref-filename="204private">private</dfn>, <b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col5 decl" id="205page" title='page' data-type='struct page *' data-ref="205page" data-ref-filename="205page">page</dfn>,</td></tr>
<tr><th id="1166">1166</th><td>				   <em>int</em> <dfn class="local col6 decl" id="206force" title='force' data-type='int' data-ref="206force" data-ref-filename="206force">force</dfn>, <b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col7 decl" id="207mode" title='mode' data-type='enum migrate_mode' data-ref="207mode" data-ref-filename="207mode">mode</dfn>,</td></tr>
<tr><th id="1167">1167</th><td>				   <b>enum</b> <a class="type" href="../include/linux/migrate.h.html#migrate_reason" title='migrate_reason' data-ref="migrate_reason" data-ref-filename="migrate_reason">migrate_reason</a> <dfn class="local col8 decl" id="208reason" title='reason' data-type='enum migrate_reason' data-ref="208reason" data-ref-filename="208reason">reason</dfn>)</td></tr>
<tr><th id="1168">1168</th><td>{</td></tr>
<tr><th id="1169">1169</th><td>	<em>int</em> <dfn class="local col9 decl" id="209rc" title='rc' data-type='int' data-ref="209rc" data-ref-filename="209rc">rc</dfn> = <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>;</td></tr>
<tr><th id="1170">1170</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col0 decl" id="210newpage" title='newpage' data-type='struct page *' data-ref="210newpage" data-ref-filename="210newpage">newpage</dfn>;</td></tr>
<tr><th id="1171">1171</th><td></td></tr>
<tr><th id="1172">1172</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/huge_mm.h.html#thp_migration_supported" title='thp_migration_supported' data-ref="thp_migration_supported" data-ref-filename="thp_migration_supported">thp_migration_supported</a>() &amp;&amp; <a class="ref fn" href="../include/linux/page-flags.h.html#685" title='PageTransHuge' data-ref="PageTransHuge" data-ref-filename="PageTransHuge">PageTransHuge</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>))</td></tr>
<tr><th id="1173">1173</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#16" title="12" data-ref="_M/ENOMEM">ENOMEM</a>;</td></tr>
<tr><th id="1174">1174</th><td></td></tr>
<tr><th id="1175">1175</th><td>	<a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a> = <a class="local col2 ref" href="#202get_new_page" title='get_new_page' data-ref="202get_new_page" data-ref-filename="202get_new_page">get_new_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>, <a class="local col4 ref" href="#204private" title='private' data-ref="204private" data-ref-filename="204private">private</a>);</td></tr>
<tr><th id="1176">1176</th><td>	<b>if</b> (!<a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a>)</td></tr>
<tr><th id="1177">1177</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#16" title="12" data-ref="_M/ENOMEM">ENOMEM</a>;</td></tr>
<tr><th id="1178">1178</th><td></td></tr>
<tr><th id="1179">1179</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page_ref.h.html#page_count" title='page_count' data-ref="page_count" data-ref-filename="page_count">page_count</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>) == <var>1</var>) {</td></tr>
<tr><th id="1180">1180</th><td>		<i>/* page was freed from under us. So we are done. */</i></td></tr>
<tr><th id="1181">1181</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#321" title='ClearPageActive' data-ref="ClearPageActive" data-ref-filename="ClearPageActive">ClearPageActive</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1182">1182</th><td>		<a class="ref fn" href="../include/linux/page-flags.h.html#394" title='ClearPageUnevictable' data-ref="ClearPageUnevictable" data-ref-filename="ClearPageUnevictable">ClearPageUnevictable</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1183">1183</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(__PageMovable(page)), 0)" data-ref="_M/unlikely">unlikely</a>(<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>))) {</td></tr>
<tr><th id="1184">1184</th><td>			<a class="ref fn" href="../include/linux/pagemap.h.html#lock_page" title='lock_page' data-ref="lock_page" data-ref-filename="lock_page">lock_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1185">1185</th><td>			<b>if</b> (!<a class="ref fn" href="../include/linux/migrate.h.html#PageMovable" title='PageMovable' data-ref="PageMovable" data-ref-filename="PageMovable">PageMovable</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>))</td></tr>
<tr><th id="1186">1186</th><td>				<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='__ClearPageIsolated' data-ref="__ClearPageIsolated" data-ref-filename="__ClearPageIsolated">__ClearPageIsolated</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1187">1187</th><td>			<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1188">1188</th><td>		}</td></tr>
<tr><th id="1189">1189</th><td>		<b>if</b> (<a class="local col3 ref" href="#203put_new_page" title='put_new_page' data-ref="203put_new_page" data-ref-filename="203put_new_page">put_new_page</a>)</td></tr>
<tr><th id="1190">1190</th><td>			<a class="local col3 ref" href="#203put_new_page" title='put_new_page' data-ref="203put_new_page" data-ref-filename="203put_new_page">put_new_page</a>(<a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a>, <a class="local col4 ref" href="#204private" title='private' data-ref="204private" data-ref-filename="204private">private</a>);</td></tr>
<tr><th id="1191">1191</th><td>		<b>else</b></td></tr>
<tr><th id="1192">1192</th><td>			<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a>);</td></tr>
<tr><th id="1193">1193</th><td>		<b>goto</b> <a class="lbl" href="#211out" data-ref="211out" data-ref-filename="211out">out</a>;</td></tr>
<tr><th id="1194">1194</th><td>	}</td></tr>
<tr><th id="1195">1195</th><td></td></tr>
<tr><th id="1196">1196</th><td>	<a class="local col9 ref" href="#209rc" title='rc' data-ref="209rc" data-ref-filename="209rc">rc</a> = <a class="tu ref fn" href="#__unmap_and_move" title='__unmap_and_move' data-use='c' data-ref="__unmap_and_move" data-ref-filename="__unmap_and_move">__unmap_and_move</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>, <a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a>, <a class="local col6 ref" href="#206force" title='force' data-ref="206force" data-ref-filename="206force">force</a>, <a class="local col7 ref" href="#207mode" title='mode' data-ref="207mode" data-ref-filename="207mode">mode</a>);</td></tr>
<tr><th id="1197">1197</th><td>	<b>if</b> (<a class="local col9 ref" href="#209rc" title='rc' data-ref="209rc" data-ref-filename="209rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>)</td></tr>
<tr><th id="1198">1198</th><td>		<a class="ref fn" href="../include/linux/page_owner.h.html#set_page_owner_migrate_reason" title='set_page_owner_migrate_reason' data-ref="set_page_owner_migrate_reason" data-ref-filename="set_page_owner_migrate_reason">set_page_owner_migrate_reason</a>(<a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a>, <a class="local col8 ref" href="#208reason" title='reason' data-ref="208reason" data-ref-filename="208reason">reason</a>);</td></tr>
<tr><th id="1199">1199</th><td></td></tr>
<tr><th id="1200">1200</th><td><dfn class="lbl" id="211out" data-ref="211out" data-ref-filename="211out">out</dfn>:</td></tr>
<tr><th id="1201">1201</th><td>	<b>if</b> (<a class="local col9 ref" href="#209rc" title='rc' data-ref="209rc" data-ref-filename="209rc">rc</a> != -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>) {</td></tr>
<tr><th id="1202">1202</th><td>		<i>/*</i></td></tr>
<tr><th id="1203">1203</th><td><i>		 * A page that has been migrated has all references</i></td></tr>
<tr><th id="1204">1204</th><td><i>		 * removed and will be freed. A page that has not been</i></td></tr>
<tr><th id="1205">1205</th><td><i>		 * migrated will have kepts its references and be</i></td></tr>
<tr><th id="1206">1206</th><td><i>		 * restored.</i></td></tr>
<tr><th id="1207">1207</th><td><i>		 */</i></td></tr>
<tr><th id="1208">1208</th><td>		<a class="ref fn" href="../include/linux/list.h.html#list_del" title='list_del' data-ref="list_del" data-ref-filename="list_del">list_del</a>(&amp;<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::lru" title='page::(anonymous union)::(anonymous struct)::lru' data-ref="page::(anonymousunion)::(anonymous)::lru" data-ref-filename="page..(anonymousunion)..(anonymous)..lru">lru</a>);</td></tr>
<tr><th id="1209">1209</th><td></td></tr>
<tr><th id="1210">1210</th><td>		<i>/*</i></td></tr>
<tr><th id="1211">1211</th><td><i>		 * Compaction can migrate also non-LRU pages which are</i></td></tr>
<tr><th id="1212">1212</th><td><i>		 * not accounted to NR_ISOLATED_*. They can be recognized</i></td></tr>
<tr><th id="1213">1213</th><td><i>		 * as __PageMovable</i></td></tr>
<tr><th id="1214">1214</th><td><i>		 */</i></td></tr>
<tr><th id="1215">1215</th><td>		<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#77" title="__builtin_expect(!!(!__PageMovable(page)), 1)" data-ref="_M/likely">likely</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>)))</td></tr>
<tr><th id="1216">1216</th><td>			<a class="ref fn" href="../include/linux/vmstat.h.html#mod_node_page_state" title='mod_node_page_state' data-ref="mod_node_page_state" data-ref-filename="mod_node_page_state">mod_node_page_state</a>(<a class="ref fn" href="../include/linux/mm.h.html#page_pgdat" title='page_pgdat' data-ref="page_pgdat" data-ref-filename="page_pgdat">page_pgdat</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>), <a class="enum" href="../include/linux/mmzone.h.html#NR_ISOLATED_ANON" title='NR_ISOLATED_ANON' data-ref="NR_ISOLATED_ANON" data-ref-filename="NR_ISOLATED_ANON">NR_ISOLATED_ANON</a> +</td></tr>
<tr><th id="1217">1217</th><td>					<a class="ref fn" href="../include/linux/mm_inline.h.html#page_is_file_cache" title='page_is_file_cache' data-ref="page_is_file_cache" data-ref-filename="page_is_file_cache">page_is_file_cache</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>), -<a class="macro" href="../include/linux/huge_mm.h.html#279" title="1" data-ref="_M/hpage_nr_pages">hpage_nr_pages</a>(page));</td></tr>
<tr><th id="1218">1218</th><td>	}</td></tr>
<tr><th id="1219">1219</th><td></td></tr>
<tr><th id="1220">1220</th><td>	<i>/*</i></td></tr>
<tr><th id="1221">1221</th><td><i>	 * If migration is successful, releases reference grabbed during</i></td></tr>
<tr><th id="1222">1222</th><td><i>	 * isolation. Otherwise, restore the page to right list unless</i></td></tr>
<tr><th id="1223">1223</th><td><i>	 * we want to retry.</i></td></tr>
<tr><th id="1224">1224</th><td><i>	 */</i></td></tr>
<tr><th id="1225">1225</th><td>	<b>if</b> (<a class="local col9 ref" href="#209rc" title='rc' data-ref="209rc" data-ref-filename="209rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>) {</td></tr>
<tr><th id="1226">1226</th><td>		<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1227">1227</th><td>		<b>if</b> (<a class="local col8 ref" href="#208reason" title='reason' data-ref="208reason" data-ref-filename="208reason">reason</a> == <a class="enum" href="../include/linux/migrate.h.html#MR_MEMORY_FAILURE" title='MR_MEMORY_FAILURE' data-ref="MR_MEMORY_FAILURE" data-ref-filename="MR_MEMORY_FAILURE">MR_MEMORY_FAILURE</a>) {</td></tr>
<tr><th id="1228">1228</th><td>			<i>/*</i></td></tr>
<tr><th id="1229">1229</th><td><i>			 * Set PG_HWPoison on just freed page</i></td></tr>
<tr><th id="1230">1230</th><td><i>			 * intentionally. Although it's rather weird,</i></td></tr>
<tr><th id="1231">1231</th><td><i>			 * it's how HWPoison flag works at the moment.</i></td></tr>
<tr><th id="1232">1232</th><td><i>			 */</i></td></tr>
<tr><th id="1233">1233</th><td>			<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#set_hwpoison_free_buddy_page" title='set_hwpoison_free_buddy_page' data-ref="set_hwpoison_free_buddy_page" data-ref-filename="set_hwpoison_free_buddy_page">set_hwpoison_free_buddy_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>))</td></tr>
<tr><th id="1234">1234</th><td>				<a class="ref fn" href="../include/linux/swapops.h.html#num_poisoned_pages_inc" title='num_poisoned_pages_inc' data-ref="num_poisoned_pages_inc" data-ref-filename="num_poisoned_pages_inc">num_poisoned_pages_inc</a>();</td></tr>
<tr><th id="1235">1235</th><td>		}</td></tr>
<tr><th id="1236">1236</th><td>	} <b>else</b> {</td></tr>
<tr><th id="1237">1237</th><td>		<b>if</b> (<a class="local col9 ref" href="#209rc" title='rc' data-ref="209rc" data-ref-filename="209rc">rc</a> != -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>) {</td></tr>
<tr><th id="1238">1238</th><td>			<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#77" title="__builtin_expect(!!(!__PageMovable(page)), 1)" data-ref="_M/likely">likely</a>(!<a class="ref fn" href="../include/linux/page-flags.h.html#__PageMovable" title='__PageMovable' data-ref="__PageMovable" data-ref-filename="__PageMovable">__PageMovable</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>))) {</td></tr>
<tr><th id="1239">1239</th><td>				<a class="ref fn" href="internal.h.html#putback_lru_page" title='putback_lru_page' data-ref="putback_lru_page" data-ref-filename="putback_lru_page">putback_lru_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1240">1240</th><td>				<b>goto</b> <a class="lbl" href="#212put_new" data-ref="212put_new" data-ref-filename="212put_new">put_new</a>;</td></tr>
<tr><th id="1241">1241</th><td>			}</td></tr>
<tr><th id="1242">1242</th><td></td></tr>
<tr><th id="1243">1243</th><td>			<a class="ref fn" href="../include/linux/pagemap.h.html#lock_page" title='lock_page' data-ref="lock_page" data-ref-filename="lock_page">lock_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1244">1244</th><td>			<b>if</b> (<a class="ref fn" href="../include/linux/migrate.h.html#PageMovable" title='PageMovable' data-ref="PageMovable" data-ref-filename="PageMovable">PageMovable</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>))</td></tr>
<tr><th id="1245">1245</th><td>				<a class="ref fn" href="#putback_movable_page" title='putback_movable_page' data-ref="putback_movable_page" data-ref-filename="putback_movable_page">putback_movable_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1246">1246</th><td>			<b>else</b></td></tr>
<tr><th id="1247">1247</th><td>				<a class="ref fn" href="../include/linux/page-flags.h.html#769" title='__ClearPageIsolated' data-ref="__ClearPageIsolated" data-ref-filename="__ClearPageIsolated">__ClearPageIsolated</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1248">1248</th><td>			<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1249">1249</th><td>			<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col5 ref" href="#205page" title='page' data-ref="205page" data-ref-filename="205page">page</a>);</td></tr>
<tr><th id="1250">1250</th><td>		}</td></tr>
<tr><th id="1251">1251</th><td><dfn class="lbl" id="212put_new" data-ref="212put_new" data-ref-filename="212put_new">put_new</dfn>:</td></tr>
<tr><th id="1252">1252</th><td>		<b>if</b> (<a class="local col3 ref" href="#203put_new_page" title='put_new_page' data-ref="203put_new_page" data-ref-filename="203put_new_page">put_new_page</a>)</td></tr>
<tr><th id="1253">1253</th><td>			<a class="local col3 ref" href="#203put_new_page" title='put_new_page' data-ref="203put_new_page" data-ref-filename="203put_new_page">put_new_page</a>(<a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a>, <a class="local col4 ref" href="#204private" title='private' data-ref="204private" data-ref-filename="204private">private</a>);</td></tr>
<tr><th id="1254">1254</th><td>		<b>else</b></td></tr>
<tr><th id="1255">1255</th><td>			<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col0 ref" href="#210newpage" title='newpage' data-ref="210newpage" data-ref-filename="210newpage">newpage</a>);</td></tr>
<tr><th id="1256">1256</th><td>	}</td></tr>
<tr><th id="1257">1257</th><td></td></tr>
<tr><th id="1258">1258</th><td>	<b>return</b> <a class="local col9 ref" href="#209rc" title='rc' data-ref="209rc" data-ref-filename="209rc">rc</a>;</td></tr>
<tr><th id="1259">1259</th><td>}</td></tr>
<tr><th id="1260">1260</th><td></td></tr>
<tr><th id="1261">1261</th><td><i  data-doc="unmap_and_move_huge_page">/*</i></td></tr>
<tr><th id="1262">1262</th><td><i  data-doc="unmap_and_move_huge_page"> * Counterpart of unmap_and_move_page() for hugepage migration.</i></td></tr>
<tr><th id="1263">1263</th><td><i  data-doc="unmap_and_move_huge_page"> *</i></td></tr>
<tr><th id="1264">1264</th><td><i  data-doc="unmap_and_move_huge_page"> * This function doesn't wait the completion of hugepage I/O</i></td></tr>
<tr><th id="1265">1265</th><td><i  data-doc="unmap_and_move_huge_page"> * because there is no race between I/O and migration for hugepage.</i></td></tr>
<tr><th id="1266">1266</th><td><i  data-doc="unmap_and_move_huge_page"> * Note that currently hugepage I/O occurs only in direct I/O</i></td></tr>
<tr><th id="1267">1267</th><td><i  data-doc="unmap_and_move_huge_page"> * where no lock is held and PG_writeback is irrelevant,</i></td></tr>
<tr><th id="1268">1268</th><td><i  data-doc="unmap_and_move_huge_page"> * and writeback status of all subpages are counted in the reference</i></td></tr>
<tr><th id="1269">1269</th><td><i  data-doc="unmap_and_move_huge_page"> * count of the head page (i.e. if all subpages of a 2MB hugepage are</i></td></tr>
<tr><th id="1270">1270</th><td><i  data-doc="unmap_and_move_huge_page"> * under direct I/O, the reference of the head page is 512 and a bit more.)</i></td></tr>
<tr><th id="1271">1271</th><td><i  data-doc="unmap_and_move_huge_page"> * This means that when we try to migrate hugepage whose subpages are</i></td></tr>
<tr><th id="1272">1272</th><td><i  data-doc="unmap_and_move_huge_page"> * doing direct I/O, some references remain after try_to_unmap() and</i></td></tr>
<tr><th id="1273">1273</th><td><i  data-doc="unmap_and_move_huge_page"> * hugepage migration fails without data corruption.</i></td></tr>
<tr><th id="1274">1274</th><td><i  data-doc="unmap_and_move_huge_page"> *</i></td></tr>
<tr><th id="1275">1275</th><td><i  data-doc="unmap_and_move_huge_page"> * There is also no race when direct I/O is issued on the page under migration,</i></td></tr>
<tr><th id="1276">1276</th><td><i  data-doc="unmap_and_move_huge_page"> * because then pte is replaced with migration swap entry and direct I/O code</i></td></tr>
<tr><th id="1277">1277</th><td><i  data-doc="unmap_and_move_huge_page"> * will wait in the page fault for migration to complete.</i></td></tr>
<tr><th id="1278">1278</th><td><i  data-doc="unmap_and_move_huge_page"> */</i></td></tr>
<tr><th id="1279">1279</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="unmap_and_move_huge_page" title='unmap_and_move_huge_page' data-type='int unmap_and_move_huge_page(new_page_t * get_new_page, free_page_t * put_new_page, unsigned long private, struct page * hpage, int force, enum migrate_mode mode, int reason)' data-ref="unmap_and_move_huge_page" data-ref-filename="unmap_and_move_huge_page">unmap_and_move_huge_page</dfn>(<a class="typedef" href="../include/linux/migrate.h.html#new_page_t" title='new_page_t' data-type='struct page *(struct page *, unsigned long)' data-ref="new_page_t" data-ref-filename="new_page_t">new_page_t</a> <dfn class="local col3 decl" id="213get_new_page" title='get_new_page' data-type='new_page_t *' data-ref="213get_new_page" data-ref-filename="213get_new_page">get_new_page</dfn>,</td></tr>
<tr><th id="1280">1280</th><td>				<a class="typedef" href="../include/linux/migrate.h.html#free_page_t" title='free_page_t' data-type='void (struct page *, unsigned long)' data-ref="free_page_t" data-ref-filename="free_page_t">free_page_t</a> <dfn class="local col4 decl" id="214put_new_page" title='put_new_page' data-type='free_page_t *' data-ref="214put_new_page" data-ref-filename="214put_new_page">put_new_page</dfn>, <em>unsigned</em> <em>long</em> <dfn class="local col5 decl" id="215private" title='private' data-type='unsigned long' data-ref="215private" data-ref-filename="215private">private</dfn>,</td></tr>
<tr><th id="1281">1281</th><td>				<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col6 decl" id="216hpage" title='hpage' data-type='struct page *' data-ref="216hpage" data-ref-filename="216hpage">hpage</dfn>, <em>int</em> <dfn class="local col7 decl" id="217force" title='force' data-type='int' data-ref="217force" data-ref-filename="217force">force</dfn>,</td></tr>
<tr><th id="1282">1282</th><td>				<b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col8 decl" id="218mode" title='mode' data-type='enum migrate_mode' data-ref="218mode" data-ref-filename="218mode">mode</dfn>, <em>int</em> <dfn class="local col9 decl" id="219reason" title='reason' data-type='int' data-ref="219reason" data-ref-filename="219reason">reason</dfn>)</td></tr>
<tr><th id="1283">1283</th><td>{</td></tr>
<tr><th id="1284">1284</th><td>	<em>int</em> <dfn class="local col0 decl" id="220rc" title='rc' data-type='int' data-ref="220rc" data-ref-filename="220rc">rc</dfn> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>;</td></tr>
<tr><th id="1285">1285</th><td>	<em>int</em> <dfn class="local col1 decl" id="221page_was_mapped" title='page_was_mapped' data-type='int' data-ref="221page_was_mapped" data-ref-filename="221page_was_mapped">page_was_mapped</dfn> = <var>0</var>;</td></tr>
<tr><th id="1286">1286</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col2 decl" id="222new_hpage" title='new_hpage' data-type='struct page *' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</dfn>;</td></tr>
<tr><th id="1287">1287</th><td>	<b>struct</b> <a class="type" href="../include/linux/rmap.h.html#anon_vma" title='anon_vma' data-ref="anon_vma" data-ref-filename="anon_vma">anon_vma</a> *<dfn class="local col3 decl" id="223anon_vma" title='anon_vma' data-type='struct anon_vma *' data-ref="223anon_vma" data-ref-filename="223anon_vma">anon_vma</dfn> = <a class="macro" href="../include/linux/stddef.h.html#8" title="((void *)0)" data-ref="_M/NULL">NULL</a>;</td></tr>
<tr><th id="1288">1288</th><td></td></tr>
<tr><th id="1289">1289</th><td>	<i>/*</i></td></tr>
<tr><th id="1290">1290</th><td><i>	 * Migratability of hugepages depends on architectures and their size.</i></td></tr>
<tr><th id="1291">1291</th><td><i>	 * This check is necessary because some callers of hugepage migration</i></td></tr>
<tr><th id="1292">1292</th><td><i>	 * like soft offline and memory hotremove don't walk through page</i></td></tr>
<tr><th id="1293">1293</th><td><i>	 * tables or check whether the hugepage is pmd-based or not before</i></td></tr>
<tr><th id="1294">1294</th><td><i>	 * kicking migration.</i></td></tr>
<tr><th id="1295">1295</th><td><i>	 */</i></td></tr>
<tr><th id="1296">1296</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/hugetlb.h.html#hugepage_migration_supported" title='hugepage_migration_supported' data-ref="hugepage_migration_supported" data-ref-filename="hugepage_migration_supported">hugepage_migration_supported</a>(<a class="ref fn" href="../include/linux/hugetlb.h.html#page_hstate" title='page_hstate' data-ref="page_hstate" data-ref-filename="page_hstate">page_hstate</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>))) {</td></tr>
<tr><th id="1297">1297</th><td>		<a class="ref fn" href="../include/linux/hugetlb.h.html#putback_active_hugepage" title='putback_active_hugepage' data-ref="putback_active_hugepage" data-ref-filename="putback_active_hugepage">putback_active_hugepage</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>);</td></tr>
<tr><th id="1298">1298</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno.h.html#18" title="38" data-ref="_M/ENOSYS">ENOSYS</a>;</td></tr>
<tr><th id="1299">1299</th><td>	}</td></tr>
<tr><th id="1300">1300</th><td></td></tr>
<tr><th id="1301">1301</th><td>	<a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a> = <a class="local col3 ref" href="#213get_new_page" title='get_new_page' data-ref="213get_new_page" data-ref-filename="213get_new_page">get_new_page</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>, <a class="local col5 ref" href="#215private" title='private' data-ref="215private" data-ref-filename="215private">private</a>);</td></tr>
<tr><th id="1302">1302</th><td>	<b>if</b> (!<a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a>)</td></tr>
<tr><th id="1303">1303</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#16" title="12" data-ref="_M/ENOMEM">ENOMEM</a>;</td></tr>
<tr><th id="1304">1304</th><td></td></tr>
<tr><th id="1305">1305</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/pagemap.h.html#trylock_page" title='trylock_page' data-ref="trylock_page" data-ref-filename="trylock_page">trylock_page</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>)) {</td></tr>
<tr><th id="1306">1306</th><td>		<b>if</b> (!<a class="local col7 ref" href="#217force" title='force' data-ref="217force" data-ref-filename="217force">force</a>)</td></tr>
<tr><th id="1307">1307</th><td>			<b>goto</b> <a class="lbl" href="#224out" data-ref="224out" data-ref-filename="224out">out</a>;</td></tr>
<tr><th id="1308">1308</th><td>		<b>switch</b> (<a class="local col8 ref" href="#218mode" title='mode' data-ref="218mode" data-ref-filename="218mode">mode</a>) {</td></tr>
<tr><th id="1309">1309</th><td>		<b>case</b> <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC" title='MIGRATE_SYNC' data-ref="MIGRATE_SYNC" data-ref-filename="MIGRATE_SYNC">MIGRATE_SYNC</a>:</td></tr>
<tr><th id="1310">1310</th><td>		<b>case</b> <a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC_NO_COPY" title='MIGRATE_SYNC_NO_COPY' data-ref="MIGRATE_SYNC_NO_COPY" data-ref-filename="MIGRATE_SYNC_NO_COPY">MIGRATE_SYNC_NO_COPY</a>:</td></tr>
<tr><th id="1311">1311</th><td>			<b>break</b>;</td></tr>
<tr><th id="1312">1312</th><td>		<b>default</b>:</td></tr>
<tr><th id="1313">1313</th><td>			<b>goto</b> <a class="lbl" href="#224out" data-ref="224out" data-ref-filename="224out">out</a>;</td></tr>
<tr><th id="1314">1314</th><td>		}</td></tr>
<tr><th id="1315">1315</th><td>		<a class="ref fn" href="../include/linux/pagemap.h.html#lock_page" title='lock_page' data-ref="lock_page" data-ref-filename="lock_page">lock_page</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>);</td></tr>
<tr><th id="1316">1316</th><td>	}</td></tr>
<tr><th id="1317">1317</th><td></td></tr>
<tr><th id="1318">1318</th><td>	<i>/*</i></td></tr>
<tr><th id="1319">1319</th><td><i>	 * Check for pages which are in the process of being freed.  Without</i></td></tr>
<tr><th id="1320">1320</th><td><i>	 * page_mapping() set, hugetlbfs specific move page routine will not</i></td></tr>
<tr><th id="1321">1321</th><td><i>	 * be called and we could leak usage counts for subpools.</i></td></tr>
<tr><th id="1322">1322</th><td><i>	 */</i></td></tr>
<tr><th id="1323">1323</th><td>	<b>if</b> (<a class="macro" href="../include/linux/mm_types.h.html#232" title="((hpage)-&gt;private)" data-ref="_M/page_private">page_private</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>) &amp;&amp; !<a class="ref fn" href="../include/linux/mm.h.html#page_mapping" title='page_mapping' data-ref="page_mapping" data-ref-filename="page_mapping">page_mapping</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>)) {</td></tr>
<tr><th id="1324">1324</th><td>		<a class="local col0 ref" href="#220rc" title='rc' data-ref="220rc" data-ref-filename="220rc">rc</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#20" title="16" data-ref="_M/EBUSY">EBUSY</a>;</td></tr>
<tr><th id="1325">1325</th><td>		<b>goto</b> <a class="lbl" href="#225out_unlock" data-ref="225out_unlock" data-ref-filename="225out_unlock">out_unlock</a>;</td></tr>
<tr><th id="1326">1326</th><td>	}</td></tr>
<tr><th id="1327">1327</th><td></td></tr>
<tr><th id="1328">1328</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageAnon" title='PageAnon' data-ref="PageAnon" data-ref-filename="PageAnon">PageAnon</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>))</td></tr>
<tr><th id="1329">1329</th><td>		<a class="local col3 ref" href="#223anon_vma" title='anon_vma' data-ref="223anon_vma" data-ref-filename="223anon_vma">anon_vma</a> = <a class="ref fn" href="../include/linux/rmap.h.html#page_get_anon_vma" title='page_get_anon_vma' data-ref="page_get_anon_vma" data-ref-filename="page_get_anon_vma">page_get_anon_vma</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>);</td></tr>
<tr><th id="1330">1330</th><td></td></tr>
<tr><th id="1331">1331</th><td>	<b>if</b> (<a class="macro" href="../include/linux/compiler.h.html#78" title="__builtin_expect(!!(!trylock_page(new_hpage)), 0)" data-ref="_M/unlikely">unlikely</a>(!<a class="ref fn" href="../include/linux/pagemap.h.html#trylock_page" title='trylock_page' data-ref="trylock_page" data-ref-filename="trylock_page">trylock_page</a>(<a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a>)))</td></tr>
<tr><th id="1332">1332</th><td>		<b>goto</b> <a class="lbl" href="#226put_anon" data-ref="226put_anon" data-ref-filename="226put_anon">put_anon</a>;</td></tr>
<tr><th id="1333">1333</th><td></td></tr>
<tr><th id="1334">1334</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/mm.h.html#page_mapped" title='page_mapped' data-ref="page_mapped" data-ref-filename="page_mapped">page_mapped</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>)) {</td></tr>
<tr><th id="1335">1335</th><td>		<a class="ref fn" href="../include/linux/rmap.h.html#try_to_unmap" title='try_to_unmap' data-ref="try_to_unmap" data-ref-filename="try_to_unmap">try_to_unmap</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>,</td></tr>
<tr><th id="1336">1336</th><td>			<a class="enum" href="../include/linux/rmap.h.html#TTU_MIGRATION" title='TTU_MIGRATION' data-ref="TTU_MIGRATION" data-ref-filename="TTU_MIGRATION">TTU_MIGRATION</a>|<a class="enum" href="../include/linux/rmap.h.html#TTU_IGNORE_MLOCK" title='TTU_IGNORE_MLOCK' data-ref="TTU_IGNORE_MLOCK" data-ref-filename="TTU_IGNORE_MLOCK">TTU_IGNORE_MLOCK</a>|<a class="enum" href="../include/linux/rmap.h.html#TTU_IGNORE_ACCESS" title='TTU_IGNORE_ACCESS' data-ref="TTU_IGNORE_ACCESS" data-ref-filename="TTU_IGNORE_ACCESS">TTU_IGNORE_ACCESS</a>);</td></tr>
<tr><th id="1337">1337</th><td>		<a class="local col1 ref" href="#221page_was_mapped" title='page_was_mapped' data-ref="221page_was_mapped" data-ref-filename="221page_was_mapped">page_was_mapped</a> = <var>1</var>;</td></tr>
<tr><th id="1338">1338</th><td>	}</td></tr>
<tr><th id="1339">1339</th><td></td></tr>
<tr><th id="1340">1340</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/mm.h.html#page_mapped" title='page_mapped' data-ref="page_mapped" data-ref-filename="page_mapped">page_mapped</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>))</td></tr>
<tr><th id="1341">1341</th><td>		<a class="local col0 ref" href="#220rc" title='rc' data-ref="220rc" data-ref-filename="220rc">rc</a> = <a class="tu ref fn" href="#move_to_new_page" title='move_to_new_page' data-use='c' data-ref="move_to_new_page" data-ref-filename="move_to_new_page">move_to_new_page</a>(<a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a>, <a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>, <a class="local col8 ref" href="#218mode" title='mode' data-ref="218mode" data-ref-filename="218mode">mode</a>);</td></tr>
<tr><th id="1342">1342</th><td></td></tr>
<tr><th id="1343">1343</th><td>	<b>if</b> (<a class="local col1 ref" href="#221page_was_mapped" title='page_was_mapped' data-ref="221page_was_mapped" data-ref-filename="221page_was_mapped">page_was_mapped</a>)</td></tr>
<tr><th id="1344">1344</th><td>		<a class="ref fn" href="#remove_migration_ptes" title='remove_migration_ptes' data-ref="remove_migration_ptes" data-ref-filename="remove_migration_ptes">remove_migration_ptes</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>,</td></tr>
<tr><th id="1345">1345</th><td>			<a class="local col0 ref" href="#220rc" title='rc' data-ref="220rc" data-ref-filename="220rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a> ? <a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a> : <a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>, <a class="enum" href="../include/linux/stddef.h.html#false" title='false' data-ref="false" data-ref-filename="false">false</a>);</td></tr>
<tr><th id="1346">1346</th><td></td></tr>
<tr><th id="1347">1347</th><td>	<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a>);</td></tr>
<tr><th id="1348">1348</th><td></td></tr>
<tr><th id="1349">1349</th><td><dfn class="lbl" id="226put_anon" data-ref="226put_anon" data-ref-filename="226put_anon">put_anon</dfn>:</td></tr>
<tr><th id="1350">1350</th><td>	<b>if</b> (<a class="local col3 ref" href="#223anon_vma" title='anon_vma' data-ref="223anon_vma" data-ref-filename="223anon_vma">anon_vma</a>)</td></tr>
<tr><th id="1351">1351</th><td>		<a class="ref fn" href="../include/linux/rmap.h.html#put_anon_vma" title='put_anon_vma' data-ref="put_anon_vma" data-ref-filename="put_anon_vma">put_anon_vma</a>(<a class="local col3 ref" href="#223anon_vma" title='anon_vma' data-ref="223anon_vma" data-ref-filename="223anon_vma">anon_vma</a>);</td></tr>
<tr><th id="1352">1352</th><td></td></tr>
<tr><th id="1353">1353</th><td>	<b>if</b> (<a class="local col0 ref" href="#220rc" title='rc' data-ref="220rc" data-ref-filename="220rc">rc</a> == <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>) {</td></tr>
<tr><th id="1354">1354</th><td>		<a class="ref fn" href="../include/linux/hugetlb.h.html#move_hugetlb_state" title='move_hugetlb_state' data-ref="move_hugetlb_state" data-ref-filename="move_hugetlb_state">move_hugetlb_state</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>, <a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a>, <a class="local col9 ref" href="#219reason" title='reason' data-ref="219reason" data-ref-filename="219reason">reason</a>);</td></tr>
<tr><th id="1355">1355</th><td>		<a class="local col4 ref" href="#214put_new_page" title='put_new_page' data-ref="214put_new_page" data-ref-filename="214put_new_page">put_new_page</a> = <a class="macro" href="../include/linux/stddef.h.html#8" title="((void *)0)" data-ref="_M/NULL">NULL</a>;</td></tr>
<tr><th id="1356">1356</th><td>	}</td></tr>
<tr><th id="1357">1357</th><td></td></tr>
<tr><th id="1358">1358</th><td><dfn class="lbl" id="225out_unlock" data-ref="225out_unlock" data-ref-filename="225out_unlock">out_unlock</dfn>:</td></tr>
<tr><th id="1359">1359</th><td>	<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>);</td></tr>
<tr><th id="1360">1360</th><td><dfn class="lbl" id="224out" data-ref="224out" data-ref-filename="224out">out</dfn>:</td></tr>
<tr><th id="1361">1361</th><td>	<b>if</b> (<a class="local col0 ref" href="#220rc" title='rc' data-ref="220rc" data-ref-filename="220rc">rc</a> != -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>)</td></tr>
<tr><th id="1362">1362</th><td>		<a class="ref fn" href="../include/linux/hugetlb.h.html#putback_active_hugepage" title='putback_active_hugepage' data-ref="putback_active_hugepage" data-ref-filename="putback_active_hugepage">putback_active_hugepage</a>(<a class="local col6 ref" href="#216hpage" title='hpage' data-ref="216hpage" data-ref-filename="216hpage">hpage</a>);</td></tr>
<tr><th id="1363">1363</th><td></td></tr>
<tr><th id="1364">1364</th><td>	<i>/*</i></td></tr>
<tr><th id="1365">1365</th><td><i>	 * If migration was not successful and there's a freeing callback, use</i></td></tr>
<tr><th id="1366">1366</th><td><i>	 * it.  Otherwise, put_page() will drop the reference grabbed during</i></td></tr>
<tr><th id="1367">1367</th><td><i>	 * isolation.</i></td></tr>
<tr><th id="1368">1368</th><td><i>	 */</i></td></tr>
<tr><th id="1369">1369</th><td>	<b>if</b> (<a class="local col4 ref" href="#214put_new_page" title='put_new_page' data-ref="214put_new_page" data-ref-filename="214put_new_page">put_new_page</a>)</td></tr>
<tr><th id="1370">1370</th><td>		<a class="local col4 ref" href="#214put_new_page" title='put_new_page' data-ref="214put_new_page" data-ref-filename="214put_new_page">put_new_page</a>(<a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a>, <a class="local col5 ref" href="#215private" title='private' data-ref="215private" data-ref-filename="215private">private</a>);</td></tr>
<tr><th id="1371">1371</th><td>	<b>else</b></td></tr>
<tr><th id="1372">1372</th><td>		<a class="ref fn" href="../include/linux/hugetlb.h.html#putback_active_hugepage" title='putback_active_hugepage' data-ref="putback_active_hugepage" data-ref-filename="putback_active_hugepage">putback_active_hugepage</a>(<a class="local col2 ref" href="#222new_hpage" title='new_hpage' data-ref="222new_hpage" data-ref-filename="222new_hpage">new_hpage</a>);</td></tr>
<tr><th id="1373">1373</th><td></td></tr>
<tr><th id="1374">1374</th><td>	<b>return</b> <a class="local col0 ref" href="#220rc" title='rc' data-ref="220rc" data-ref-filename="220rc">rc</a>;</td></tr>
<tr><th id="1375">1375</th><td>}</td></tr>
<tr><th id="1376">1376</th><td></td></tr>
<tr><th id="1377">1377</th><td><i>/*</i></td></tr>
<tr><th id="1378">1378</th><td><i> * migrate_pages - migrate the pages specified in a list, to the free pages</i></td></tr>
<tr><th id="1379">1379</th><td><i> *		   supplied as the target for the page migration</i></td></tr>
<tr><th id="1380">1380</th><td><i> *</i></td></tr>
<tr><th id="1381">1381</th><td><i> * @from:		The list of pages to be migrated.</i></td></tr>
<tr><th id="1382">1382</th><td><i> * @get_new_page:	The function used to allocate free pages to be used</i></td></tr>
<tr><th id="1383">1383</th><td><i> *			as the target of the page migration.</i></td></tr>
<tr><th id="1384">1384</th><td><i> * @put_new_page:	The function used to free target pages if migration</i></td></tr>
<tr><th id="1385">1385</th><td><i> *			fails, or NULL if no special handling is necessary.</i></td></tr>
<tr><th id="1386">1386</th><td><i> * @private:		Private data to be passed on to get_new_page()</i></td></tr>
<tr><th id="1387">1387</th><td><i> * @mode:		The migration mode that specifies the constraints for</i></td></tr>
<tr><th id="1388">1388</th><td><i> *			page migration, if any.</i></td></tr>
<tr><th id="1389">1389</th><td><i> * @reason:		The reason for page migration.</i></td></tr>
<tr><th id="1390">1390</th><td><i> *</i></td></tr>
<tr><th id="1391">1391</th><td><i> * The function returns after 10 attempts or if no pages are movable any more</i></td></tr>
<tr><th id="1392">1392</th><td><i> * because the list has become empty or no retryable pages exist any more.</i></td></tr>
<tr><th id="1393">1393</th><td><i> * The caller should call putback_movable_pages() to return pages to the LRU</i></td></tr>
<tr><th id="1394">1394</th><td><i> * or free list only if ret != 0.</i></td></tr>
<tr><th id="1395">1395</th><td><i> *</i></td></tr>
<tr><th id="1396">1396</th><td><i> * Returns the number of pages that were not migrated, or an error code.</i></td></tr>
<tr><th id="1397">1397</th><td><i> */</i></td></tr>
<tr><th id="1398">1398</th><td><em>int</em> <dfn class="decl def fn" id="migrate_pages" title='migrate_pages' data-ref="migrate_pages" data-ref-filename="migrate_pages">migrate_pages</dfn>(<b>struct</b> <a class="type" href="../include/linux/types.h.html#list_head" title='list_head' data-ref="list_head" data-ref-filename="list_head">list_head</a> *<dfn class="local col7 decl" id="227from" title='from' data-type='struct list_head *' data-ref="227from" data-ref-filename="227from">from</dfn>, <a class="typedef" href="../include/linux/migrate.h.html#new_page_t" title='new_page_t' data-type='struct page *(struct page *, unsigned long)' data-ref="new_page_t" data-ref-filename="new_page_t">new_page_t</a> <dfn class="local col8 decl" id="228get_new_page" title='get_new_page' data-type='new_page_t *' data-ref="228get_new_page" data-ref-filename="228get_new_page">get_new_page</dfn>,</td></tr>
<tr><th id="1399">1399</th><td>		<a class="typedef" href="../include/linux/migrate.h.html#free_page_t" title='free_page_t' data-type='void (struct page *, unsigned long)' data-ref="free_page_t" data-ref-filename="free_page_t">free_page_t</a> <dfn class="local col9 decl" id="229put_new_page" title='put_new_page' data-type='free_page_t *' data-ref="229put_new_page" data-ref-filename="229put_new_page">put_new_page</dfn>, <em>unsigned</em> <em>long</em> <dfn class="local col0 decl" id="230private" title='private' data-type='unsigned long' data-ref="230private" data-ref-filename="230private">private</dfn>,</td></tr>
<tr><th id="1400">1400</th><td>		<b>enum</b> <a class="type" href="../include/linux/migrate_mode.h.html#migrate_mode" title='migrate_mode' data-ref="migrate_mode" data-ref-filename="migrate_mode">migrate_mode</a> <dfn class="local col1 decl" id="231mode" title='mode' data-type='enum migrate_mode' data-ref="231mode" data-ref-filename="231mode">mode</dfn>, <em>int</em> <dfn class="local col2 decl" id="232reason" title='reason' data-type='int' data-ref="232reason" data-ref-filename="232reason">reason</dfn>)</td></tr>
<tr><th id="1401">1401</th><td>{</td></tr>
<tr><th id="1402">1402</th><td>	<em>int</em> <dfn class="local col3 decl" id="233retry" title='retry' data-type='int' data-ref="233retry" data-ref-filename="233retry">retry</dfn> = <var>1</var>;</td></tr>
<tr><th id="1403">1403</th><td>	<em>int</em> <dfn class="local col4 decl" id="234nr_failed" title='nr_failed' data-type='int' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</dfn> = <var>0</var>;</td></tr>
<tr><th id="1404">1404</th><td>	<em>int</em> <dfn class="local col5 decl" id="235nr_succeeded" title='nr_succeeded' data-type='int' data-ref="235nr_succeeded" data-ref-filename="235nr_succeeded">nr_succeeded</dfn> = <var>0</var>;</td></tr>
<tr><th id="1405">1405</th><td>	<em>int</em> <dfn class="local col6 decl" id="236pass" title='pass' data-type='int' data-ref="236pass" data-ref-filename="236pass">pass</dfn> = <var>0</var>;</td></tr>
<tr><th id="1406">1406</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="237page" title='page' data-type='struct page *' data-ref="237page" data-ref-filename="237page">page</dfn>;</td></tr>
<tr><th id="1407">1407</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col8 decl" id="238page2" title='page2' data-type='struct page *' data-ref="238page2" data-ref-filename="238page2">page2</dfn>;</td></tr>
<tr><th id="1408">1408</th><td>	<em>int</em> <dfn class="local col9 decl" id="239swapwrite" title='swapwrite' data-type='int' data-ref="239swapwrite" data-ref-filename="239swapwrite">swapwrite</dfn> = <a class="macro" href="../arch/x86/include/asm/current.h.html#18" title="get_current()" data-ref="_M/current">current</a>-&gt;<a class="ref field" href="../include/linux/sched.h.html#task_struct::flags" title='task_struct::flags' data-ref="task_struct::flags" data-ref-filename="task_struct..flags">flags</a> &amp; <a class="macro" href="../include/linux/sched.h.html#1473" title="0x00800000" data-ref="_M/PF_SWAPWRITE">PF_SWAPWRITE</a>;</td></tr>
<tr><th id="1409">1409</th><td>	<em>int</em> <dfn class="local col0 decl" id="240rc" title='rc' data-type='int' data-ref="240rc" data-ref-filename="240rc">rc</dfn>;</td></tr>
<tr><th id="1410">1410</th><td></td></tr>
<tr><th id="1411">1411</th><td>	<b>if</b> (!<a class="local col9 ref" href="#239swapwrite" title='swapwrite' data-ref="239swapwrite" data-ref-filename="239swapwrite">swapwrite</a>)</td></tr>
<tr><th id="1412">1412</th><td>		<a class="macro" href="../arch/x86/include/asm/current.h.html#18" title="get_current()" data-ref="_M/current">current</a>-&gt;<a class="ref field" href="../include/linux/sched.h.html#task_struct::flags" title='task_struct::flags' data-ref="task_struct::flags" data-ref-filename="task_struct..flags">flags</a> |= <a class="macro" href="../include/linux/sched.h.html#1473" title="0x00800000" data-ref="_M/PF_SWAPWRITE">PF_SWAPWRITE</a>;</td></tr>
<tr><th id="1413">1413</th><td></td></tr>
<tr><th id="1414">1414</th><td>	<b>for</b>(<a class="local col6 ref" href="#236pass" title='pass' data-ref="236pass" data-ref-filename="236pass">pass</a> = <var>0</var>; <a class="local col6 ref" href="#236pass" title='pass' data-ref="236pass" data-ref-filename="236pass">pass</a> &lt; <var>10</var> &amp;&amp; <a class="local col3 ref" href="#233retry" title='retry' data-ref="233retry" data-ref-filename="233retry">retry</a>; <a class="local col6 ref" href="#236pass" title='pass' data-ref="236pass" data-ref-filename="236pass">pass</a>++) {</td></tr>
<tr><th id="1415">1415</th><td>		<a class="local col3 ref" href="#233retry" title='retry' data-ref="233retry" data-ref-filename="233retry">retry</a> = <var>0</var>;</td></tr>
<tr><th id="1416">1416</th><td></td></tr>
<tr><th id="1417">1417</th><td>		<a class="macro" href="../include/linux/list.h.html#663" title="for (page = ({ void *__mptr = (void *)((from)-&gt;next); do { extern void __compiletime_assert_1417(void) ; if (!(!(!__builtin_types_compatible_p(typeof(*((from)-&gt;next)), typeof(((typeof(*page) *)0)-&gt;lru)) &amp;&amp; !__builtin_types_compatible_p(typeof(*((from)-&gt;next)), typeof(void))))) __compiletime_assert_1417(); } while (0); ((typeof(*page) *)(__mptr - __builtin_offsetof(typeof(*page), lru))); }), page2 = ({ void *__mptr = (void *)((page)-&gt;lru.next); do { extern void __compiletime_assert_1417(void) ; if (!(!(!__builtin_types_compatible_p(typeof(*((page)-&gt;lru.next)), typeof(((typeof(*(page)) *)0)-&gt;lru)) &amp;&amp; !__builtin_types_compatible_p(typeof(*((page)-&gt;lru.next)), typeof(void))))) __compiletime_assert_1417(); } while (0); ((typeof(*(page)) *)(__mptr - __builtin_offsetof(typeof(*(page)), lru))); }); &amp;page-&gt;lru != (from); page = page2, page2 = ({ void *__mptr = (void *)((page2)-&gt;lru.next); do { extern void __compiletime_assert_1417(void) ; if (!(!(!__builtin_types_compatible_p(typeof(*((page2)-&gt;lru.next)), typeof(((typeof(*(page2)) *)0)-&gt;lru)) &amp;&amp; !__builtin_types_compatible_p(typeof(*((page2)-&gt;lru.next)), typeof(void))))) __compiletime_assert_1417(); } while (0); ((typeof(*(page2)) *)(__mptr - __builtin_offsetof(typeof(*(page2)), lru))); }))" data-ref="_M/list_for_each_entry_safe">list_for_each_entry_safe</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>, <a class="local col8 ref" href="#238page2" title='page2' data-ref="238page2" data-ref-filename="238page2">page2</a>, <a class="local col7 ref" href="#227from" title='from' data-ref="227from" data-ref-filename="227from">from</a>, <a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::lru" title='page::(anonymous union)::(anonymous struct)::lru' data-ref="page::(anonymousunion)::(anonymous)::lru" data-ref-filename="page..(anonymousunion)..(anonymous)..lru">lru</a>) {</td></tr>
<tr><th id="1418">1418</th><td><dfn class="lbl" id="241retry" data-ref="241retry" data-ref-filename="241retry">retry</dfn>:</td></tr>
<tr><th id="1419">1419</th><td>			<a class="macro" href="../include/linux/sched.h.html#1776" title="({ ___might_sleep(&quot;/home/woboq/linux-5.3.1/mm/migrate.c&quot;, 1419, 0); _cond_resched(); })" data-ref="_M/cond_resched">cond_resched</a>();</td></tr>
<tr><th id="1420">1420</th><td></td></tr>
<tr><th id="1421">1421</th><td>			<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageHuge" title='PageHuge' data-ref="PageHuge" data-ref-filename="PageHuge">PageHuge</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>))</td></tr>
<tr><th id="1422">1422</th><td>				<a class="local col0 ref" href="#240rc" title='rc' data-ref="240rc" data-ref-filename="240rc">rc</a> = <a class="tu ref fn" href="#unmap_and_move_huge_page" title='unmap_and_move_huge_page' data-use='c' data-ref="unmap_and_move_huge_page" data-ref-filename="unmap_and_move_huge_page">unmap_and_move_huge_page</a>(<a class="local col8 ref" href="#228get_new_page" title='get_new_page' data-ref="228get_new_page" data-ref-filename="228get_new_page">get_new_page</a>,</td></tr>
<tr><th id="1423">1423</th><td>						<a class="local col9 ref" href="#229put_new_page" title='put_new_page' data-ref="229put_new_page" data-ref-filename="229put_new_page">put_new_page</a>, <a class="local col0 ref" href="#230private" title='private' data-ref="230private" data-ref-filename="230private">private</a>, <a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>,</td></tr>
<tr><th id="1424">1424</th><td>						<a class="local col6 ref" href="#236pass" title='pass' data-ref="236pass" data-ref-filename="236pass">pass</a> &gt; <var>2</var>, <a class="local col1 ref" href="#231mode" title='mode' data-ref="231mode" data-ref-filename="231mode">mode</a>, <a class="local col2 ref" href="#232reason" title='reason' data-ref="232reason" data-ref-filename="232reason">reason</a>);</td></tr>
<tr><th id="1425">1425</th><td>			<b>else</b></td></tr>
<tr><th id="1426">1426</th><td>				<a class="local col0 ref" href="#240rc" title='rc' data-ref="240rc" data-ref-filename="240rc">rc</a> = <a class="tu ref fn" href="#unmap_and_move" title='unmap_and_move' data-use='c' data-ref="unmap_and_move" data-ref-filename="unmap_and_move">unmap_and_move</a>(<a class="local col8 ref" href="#228get_new_page" title='get_new_page' data-ref="228get_new_page" data-ref-filename="228get_new_page">get_new_page</a>, <a class="local col9 ref" href="#229put_new_page" title='put_new_page' data-ref="229put_new_page" data-ref-filename="229put_new_page">put_new_page</a>,</td></tr>
<tr><th id="1427">1427</th><td>						<a class="local col0 ref" href="#230private" title='private' data-ref="230private" data-ref-filename="230private">private</a>, <a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>, <a class="local col6 ref" href="#236pass" title='pass' data-ref="236pass" data-ref-filename="236pass">pass</a> &gt; <var>2</var>, <a class="local col1 ref" href="#231mode" title='mode' data-ref="231mode" data-ref-filename="231mode">mode</a>,</td></tr>
<tr><th id="1428">1428</th><td>						<a class="local col2 ref" href="#232reason" title='reason' data-ref="232reason" data-ref-filename="232reason">reason</a>);</td></tr>
<tr><th id="1429">1429</th><td></td></tr>
<tr><th id="1430">1430</th><td>			<b>switch</b>(<a class="local col0 ref" href="#240rc" title='rc' data-ref="240rc" data-ref-filename="240rc">rc</a>) {</td></tr>
<tr><th id="1431">1431</th><td>			<b>case</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#16" title="12" data-ref="_M/ENOMEM">ENOMEM</a>:</td></tr>
<tr><th id="1432">1432</th><td>				<i>/*</i></td></tr>
<tr><th id="1433">1433</th><td><i>				 * THP migration might be unsupported or the</i></td></tr>
<tr><th id="1434">1434</th><td><i>				 * allocation could've failed so we should</i></td></tr>
<tr><th id="1435">1435</th><td><i>				 * retry on the same page with the THP split</i></td></tr>
<tr><th id="1436">1436</th><td><i>				 * to base pages.</i></td></tr>
<tr><th id="1437">1437</th><td><i>				 *</i></td></tr>
<tr><th id="1438">1438</th><td><i>				 * Head page is retried immediately and tail</i></td></tr>
<tr><th id="1439">1439</th><td><i>				 * pages are added to the tail of the list so</i></td></tr>
<tr><th id="1440">1440</th><td><i>				 * we encounter them after the rest of the list</i></td></tr>
<tr><th id="1441">1441</th><td><i>				 * is processed.</i></td></tr>
<tr><th id="1442">1442</th><td><i>				 */</i></td></tr>
<tr><th id="1443">1443</th><td>				<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#685" title='PageTransHuge' data-ref="PageTransHuge" data-ref-filename="PageTransHuge">PageTransHuge</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>) &amp;&amp; !<a class="ref fn" href="../include/linux/page-flags.h.html#PageHuge" title='PageHuge' data-ref="PageHuge" data-ref-filename="PageHuge">PageHuge</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>)) {</td></tr>
<tr><th id="1444">1444</th><td>					<a class="ref fn" href="../include/linux/pagemap.h.html#lock_page" title='lock_page' data-ref="lock_page" data-ref-filename="lock_page">lock_page</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>);</td></tr>
<tr><th id="1445">1445</th><td>					<a class="local col0 ref" href="#240rc" title='rc' data-ref="240rc" data-ref-filename="240rc">rc</a> = <a class="ref fn" href="../include/linux/huge_mm.h.html#split_huge_page_to_list" title='split_huge_page_to_list' data-ref="split_huge_page_to_list" data-ref-filename="split_huge_page_to_list">split_huge_page_to_list</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>, <a class="local col7 ref" href="#227from" title='from' data-ref="227from" data-ref-filename="227from">from</a>);</td></tr>
<tr><th id="1446">1446</th><td>					<a class="ref fn" href="../include/linux/pagemap.h.html#unlock_page" title='unlock_page' data-ref="unlock_page" data-ref-filename="unlock_page">unlock_page</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>);</td></tr>
<tr><th id="1447">1447</th><td>					<b>if</b> (!<a class="local col0 ref" href="#240rc" title='rc' data-ref="240rc" data-ref-filename="240rc">rc</a>) {</td></tr>
<tr><th id="1448">1448</th><td>						<a class="macro" href="../include/linux/list.h.html#728" title="page2 = ({ void *__mptr = (void *)((page)-&gt;lru.next); do { extern void __compiletime_assert_1448(void) ; if (!(!(!__builtin_types_compatible_p(typeof(*((page)-&gt;lru.next)), typeof(((typeof(*(page)) *)0)-&gt;lru)) &amp;&amp; !__builtin_types_compatible_p(typeof(*((page)-&gt;lru.next)), typeof(void))))) __compiletime_assert_1448(); } while (0); ((typeof(*(page)) *)(__mptr - __builtin_offsetof(typeof(*(page)), lru))); })" data-ref="_M/list_safe_reset_next">list_safe_reset_next</a>(<a class="local col7 ref" href="#237page" title='page' data-ref="237page" data-ref-filename="237page">page</a>, <a class="local col8 ref" href="#238page2" title='page2' data-ref="238page2" data-ref-filename="238page2">page2</a>, <a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::lru" title='page::(anonymous union)::(anonymous struct)::lru' data-ref="page::(anonymousunion)::(anonymous)::lru" data-ref-filename="page..(anonymousunion)..(anonymous)..lru">lru</a>);</td></tr>
<tr><th id="1449">1449</th><td>						<b>goto</b> <a class="lbl" href="#241retry" data-ref="241retry" data-ref-filename="241retry">retry</a>;</td></tr>
<tr><th id="1450">1450</th><td>					}</td></tr>
<tr><th id="1451">1451</th><td>				}</td></tr>
<tr><th id="1452">1452</th><td>				<a class="local col4 ref" href="#234nr_failed" title='nr_failed' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</a>++;</td></tr>
<tr><th id="1453">1453</th><td>				<b>goto</b> <a class="lbl" href="#242out" data-ref="242out" data-ref-filename="242out">out</a>;</td></tr>
<tr><th id="1454">1454</th><td>			<b>case</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#15" title="11" data-ref="_M/EAGAIN">EAGAIN</a>:</td></tr>
<tr><th id="1455">1455</th><td>				<a class="local col3 ref" href="#233retry" title='retry' data-ref="233retry" data-ref-filename="233retry">retry</a>++;</td></tr>
<tr><th id="1456">1456</th><td>				<b>break</b>;</td></tr>
<tr><th id="1457">1457</th><td>			<b>case</b> <a class="macro" href="../include/linux/migrate.h.html#18" title="0" data-ref="_M/MIGRATEPAGE_SUCCESS">MIGRATEPAGE_SUCCESS</a>:</td></tr>
<tr><th id="1458">1458</th><td>				<a class="local col5 ref" href="#235nr_succeeded" title='nr_succeeded' data-ref="235nr_succeeded" data-ref-filename="235nr_succeeded">nr_succeeded</a>++;</td></tr>
<tr><th id="1459">1459</th><td>				<b>break</b>;</td></tr>
<tr><th id="1460">1460</th><td>			<b>default</b>:</td></tr>
<tr><th id="1461">1461</th><td>				<i>/*</i></td></tr>
<tr><th id="1462">1462</th><td><i>				 * Permanent failure (-EBUSY, -ENOSYS, etc.):</i></td></tr>
<tr><th id="1463">1463</th><td><i>				 * unlike -EAGAIN case, the failed page is</i></td></tr>
<tr><th id="1464">1464</th><td><i>				 * removed from migration page list and not</i></td></tr>
<tr><th id="1465">1465</th><td><i>				 * retried in the next outer loop.</i></td></tr>
<tr><th id="1466">1466</th><td><i>				 */</i></td></tr>
<tr><th id="1467">1467</th><td>				<a class="local col4 ref" href="#234nr_failed" title='nr_failed' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</a>++;</td></tr>
<tr><th id="1468">1468</th><td>				<b>break</b>;</td></tr>
<tr><th id="1469">1469</th><td>			}</td></tr>
<tr><th id="1470">1470</th><td>		}</td></tr>
<tr><th id="1471">1471</th><td>	}</td></tr>
<tr><th id="1472">1472</th><td>	<a class="local col4 ref" href="#234nr_failed" title='nr_failed' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</a> += <a class="local col3 ref" href="#233retry" title='retry' data-ref="233retry" data-ref-filename="233retry">retry</a>;</td></tr>
<tr><th id="1473">1473</th><td>	<a class="local col0 ref" href="#240rc" title='rc' data-ref="240rc" data-ref-filename="240rc">rc</a> = <a class="local col4 ref" href="#234nr_failed" title='nr_failed' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</a>;</td></tr>
<tr><th id="1474">1474</th><td><dfn class="lbl" id="242out" data-ref="242out" data-ref-filename="242out">out</dfn>:</td></tr>
<tr><th id="1475">1475</th><td>	<b>if</b> (<a class="local col5 ref" href="#235nr_succeeded" title='nr_succeeded' data-ref="235nr_succeeded" data-ref-filename="235nr_succeeded">nr_succeeded</a>)</td></tr>
<tr><th id="1476">1476</th><td>		<a class="ref fn" href="../include/linux/vmstat.h.html#count_vm_events" title='count_vm_events' data-ref="count_vm_events" data-ref-filename="count_vm_events">count_vm_events</a>(<a class="enum" href="../include/linux/vm_event_item.h.html#PGMIGRATE_SUCCESS" title='PGMIGRATE_SUCCESS' data-ref="PGMIGRATE_SUCCESS" data-ref-filename="PGMIGRATE_SUCCESS">PGMIGRATE_SUCCESS</a>, <a class="local col5 ref" href="#235nr_succeeded" title='nr_succeeded' data-ref="235nr_succeeded" data-ref-filename="235nr_succeeded">nr_succeeded</a>);</td></tr>
<tr><th id="1477">1477</th><td>	<b>if</b> (<a class="local col4 ref" href="#234nr_failed" title='nr_failed' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</a>)</td></tr>
<tr><th id="1478">1478</th><td>		<a class="ref fn" href="../include/linux/vmstat.h.html#count_vm_events" title='count_vm_events' data-ref="count_vm_events" data-ref-filename="count_vm_events">count_vm_events</a>(<a class="enum" href="../include/linux/vm_event_item.h.html#PGMIGRATE_FAIL" title='PGMIGRATE_FAIL' data-ref="PGMIGRATE_FAIL" data-ref-filename="PGMIGRATE_FAIL">PGMIGRATE_FAIL</a>, <a class="local col4 ref" href="#234nr_failed" title='nr_failed' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</a>);</td></tr>
<tr><th id="1479">1479</th><td>	<a class="ref fn" href="../include/trace/events/migrate.h.html#46" title='trace_mm_migrate_pages' data-ref="trace_mm_migrate_pages" data-ref-filename="trace_mm_migrate_pages">trace_mm_migrate_pages</a>(<a class="local col5 ref" href="#235nr_succeeded" title='nr_succeeded' data-ref="235nr_succeeded" data-ref-filename="235nr_succeeded">nr_succeeded</a>, <a class="local col4 ref" href="#234nr_failed" title='nr_failed' data-ref="234nr_failed" data-ref-filename="234nr_failed">nr_failed</a>, <a class="local col1 ref" href="#231mode" title='mode' data-ref="231mode" data-ref-filename="231mode">mode</a>, <a class="local col2 ref" href="#232reason" title='reason' data-ref="232reason" data-ref-filename="232reason">reason</a>);</td></tr>
<tr><th id="1480">1480</th><td></td></tr>
<tr><th id="1481">1481</th><td>	<b>if</b> (!<a class="local col9 ref" href="#239swapwrite" title='swapwrite' data-ref="239swapwrite" data-ref-filename="239swapwrite">swapwrite</a>)</td></tr>
<tr><th id="1482">1482</th><td>		<a class="macro" href="../arch/x86/include/asm/current.h.html#18" title="get_current()" data-ref="_M/current">current</a>-&gt;<a class="ref field" href="../include/linux/sched.h.html#task_struct::flags" title='task_struct::flags' data-ref="task_struct::flags" data-ref-filename="task_struct..flags">flags</a> &amp;= ~<a class="macro" href="../include/linux/sched.h.html#1473" title="0x00800000" data-ref="_M/PF_SWAPWRITE">PF_SWAPWRITE</a>;</td></tr>
<tr><th id="1483">1483</th><td></td></tr>
<tr><th id="1484">1484</th><td>	<b>return</b> <a class="local col0 ref" href="#240rc" title='rc' data-ref="240rc" data-ref-filename="240rc">rc</a>;</td></tr>
<tr><th id="1485">1485</th><td>}</td></tr>
<tr><th id="1486">1486</th><td></td></tr>
<tr><th id="1487">1487</th><td><u>#<span data-ppcond="1487">ifdef</span> <a class="macro" href="../include/generated/autoconf.h.html#729" data-ref="_M/CONFIG_NUMA">CONFIG_NUMA</a></u></td></tr>
<tr><th id="1488">1488</th><td></td></tr>
<tr><th id="1489">1489</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="store_status" title='store_status' data-type='int store_status(int * status, int start, int value, int nr)' data-ref="store_status" data-ref-filename="store_status">store_status</dfn>(<em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col3 decl" id="243status" title='status' data-type='int *' data-ref="243status" data-ref-filename="243status">status</dfn>, <em>int</em> <dfn class="local col4 decl" id="244start" title='start' data-type='int' data-ref="244start" data-ref-filename="244start">start</dfn>, <em>int</em> <dfn class="local col5 decl" id="245value" title='value' data-type='int' data-ref="245value" data-ref-filename="245value">value</dfn>, <em>int</em> <dfn class="local col6 decl" id="246nr" title='nr' data-type='int' data-ref="246nr" data-ref-filename="246nr">nr</dfn>)</td></tr>
<tr><th id="1490">1490</th><td>{</td></tr>
<tr><th id="1491">1491</th><td>	<b>while</b> (<a class="local col6 ref" href="#246nr" title='nr' data-ref="246nr" data-ref-filename="246nr">nr</a>-- &gt; <var>0</var>) {</td></tr>
<tr><th id="1492">1492</th><td>		<b>if</b> (<a class="macro" href="../arch/x86/include/asm/uaccess.h.html#244" title="({ int __ret_pu; __typeof__(*(status + start)) __pu_val; (void)0; might_fault(); __pu_val = value; switch (sizeof(*(status + start))) { case 1: asm volatile(&quot;call __put_user_&quot; &quot;1&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(status + start)))(__pu_val)), &quot;c&quot; (status + start) : &quot;ebx&quot;); break; case 2: asm volatile(&quot;call __put_user_&quot; &quot;2&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(status + start)))(__pu_val)), &quot;c&quot; (status + start) : &quot;ebx&quot;); break; case 4: asm volatile(&quot;call __put_user_&quot; &quot;4&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(status + start)))(__pu_val)), &quot;c&quot; (status + start) : &quot;ebx&quot;); break; case 8: asm volatile(&quot;call __put_user_&quot; &quot;8&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(status + start)))(__pu_val)), &quot;c&quot; (status + start) : &quot;ebx&quot;); break; default: asm volatile(&quot;call __put_user_&quot; &quot;X&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(status + start)))(__pu_val)), &quot;c&quot; (status + start) : &quot;ebx&quot;); break; } __builtin_expect(__ret_pu, 0); })" data-ref="_M/put_user">put_user</a>(<a class="local col5 ref" href="#245value" title='value' data-ref="245value" data-ref-filename="245value">value</a>, <a class="local col3 ref" href="#243status" title='status' data-ref="243status" data-ref-filename="243status">status</a> + <a class="local col4 ref" href="#244start" title='start' data-ref="244start" data-ref-filename="244start">start</a>))</td></tr>
<tr><th id="1493">1493</th><td>			<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#18" title="14" data-ref="_M/EFAULT">EFAULT</a>;</td></tr>
<tr><th id="1494">1494</th><td>		<a class="local col4 ref" href="#244start" title='start' data-ref="244start" data-ref-filename="244start">start</a>++;</td></tr>
<tr><th id="1495">1495</th><td>	}</td></tr>
<tr><th id="1496">1496</th><td></td></tr>
<tr><th id="1497">1497</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="1498">1498</th><td>}</td></tr>
<tr><th id="1499">1499</th><td></td></tr>
<tr><th id="1500">1500</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="do_move_pages_to_node" title='do_move_pages_to_node' data-type='int do_move_pages_to_node(struct mm_struct * mm, struct list_head * pagelist, int node)' data-ref="do_move_pages_to_node" data-ref-filename="do_move_pages_to_node">do_move_pages_to_node</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col7 decl" id="247mm" title='mm' data-type='struct mm_struct *' data-ref="247mm" data-ref-filename="247mm">mm</dfn>,</td></tr>
<tr><th id="1501">1501</th><td>		<b>struct</b> <a class="type" href="../include/linux/types.h.html#list_head" title='list_head' data-ref="list_head" data-ref-filename="list_head">list_head</a> *<dfn class="local col8 decl" id="248pagelist" title='pagelist' data-type='struct list_head *' data-ref="248pagelist" data-ref-filename="248pagelist">pagelist</dfn>, <em>int</em> <dfn class="local col9 decl" id="249node" title='node' data-type='int' data-ref="249node" data-ref-filename="249node">node</dfn>)</td></tr>
<tr><th id="1502">1502</th><td>{</td></tr>
<tr><th id="1503">1503</th><td>	<em>int</em> <dfn class="local col0 decl" id="250err" title='err' data-type='int' data-ref="250err" data-ref-filename="250err">err</dfn>;</td></tr>
<tr><th id="1504">1504</th><td></td></tr>
<tr><th id="1505">1505</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/list.h.html#list_empty" title='list_empty' data-ref="list_empty" data-ref-filename="list_empty">list_empty</a>(<a class="local col8 ref" href="#248pagelist" title='pagelist' data-ref="248pagelist" data-ref-filename="248pagelist">pagelist</a>))</td></tr>
<tr><th id="1506">1506</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="1507">1507</th><td></td></tr>
<tr><th id="1508">1508</th><td>	<a class="local col0 ref" href="#250err" title='err' data-ref="250err" data-ref-filename="250err">err</a> = <a class="ref fn" href="#migrate_pages" title='migrate_pages' data-ref="migrate_pages" data-ref-filename="migrate_pages">migrate_pages</a>(<a class="local col8 ref" href="#248pagelist" title='pagelist' data-ref="248pagelist" data-ref-filename="248pagelist">pagelist</a>, <a class="ref fn" href="internal.h.html#alloc_new_node_page" title='alloc_new_node_page' data-ref="alloc_new_node_page" data-ref-filename="alloc_new_node_page">alloc_new_node_page</a>, <a class="macro" href="../include/linux/stddef.h.html#8" title="((void *)0)" data-ref="_M/NULL">NULL</a>, <a class="local col9 ref" href="#249node" title='node' data-ref="249node" data-ref-filename="249node">node</a>,</td></tr>
<tr><th id="1509">1509</th><td>			<a class="enum" href="../include/linux/migrate_mode.h.html#MIGRATE_SYNC" title='MIGRATE_SYNC' data-ref="MIGRATE_SYNC" data-ref-filename="MIGRATE_SYNC">MIGRATE_SYNC</a>, <a class="enum" href="../include/linux/migrate.h.html#MR_SYSCALL" title='MR_SYSCALL' data-ref="MR_SYSCALL" data-ref-filename="MR_SYSCALL">MR_SYSCALL</a>);</td></tr>
<tr><th id="1510">1510</th><td>	<b>if</b> (<a class="local col0 ref" href="#250err" title='err' data-ref="250err" data-ref-filename="250err">err</a>)</td></tr>
<tr><th id="1511">1511</th><td>		<a class="ref fn" href="#putback_movable_pages" title='putback_movable_pages' data-ref="putback_movable_pages" data-ref-filename="putback_movable_pages">putback_movable_pages</a>(<a class="local col8 ref" href="#248pagelist" title='pagelist' data-ref="248pagelist" data-ref-filename="248pagelist">pagelist</a>);</td></tr>
<tr><th id="1512">1512</th><td>	<b>return</b> <a class="local col0 ref" href="#250err" title='err' data-ref="250err" data-ref-filename="250err">err</a>;</td></tr>
<tr><th id="1513">1513</th><td>}</td></tr>
<tr><th id="1514">1514</th><td></td></tr>
<tr><th id="1515">1515</th><td><i  data-doc="add_page_for_migration">/*</i></td></tr>
<tr><th id="1516">1516</th><td><i  data-doc="add_page_for_migration"> * Resolves the given address to a struct page, isolates it from the LRU and</i></td></tr>
<tr><th id="1517">1517</th><td><i  data-doc="add_page_for_migration"> * puts it to the given pagelist.</i></td></tr>
<tr><th id="1518">1518</th><td><i  data-doc="add_page_for_migration"> * Returns -errno if the page cannot be found/isolated or 0 when it has been</i></td></tr>
<tr><th id="1519">1519</th><td><i  data-doc="add_page_for_migration"> * queued or the page doesn't need to be migrated because it is already on</i></td></tr>
<tr><th id="1520">1520</th><td><i  data-doc="add_page_for_migration"> * the target node</i></td></tr>
<tr><th id="1521">1521</th><td><i  data-doc="add_page_for_migration"> */</i></td></tr>
<tr><th id="1522">1522</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="add_page_for_migration" title='add_page_for_migration' data-type='int add_page_for_migration(struct mm_struct * mm, unsigned long addr, int node, struct list_head * pagelist, bool migrate_all)' data-ref="add_page_for_migration" data-ref-filename="add_page_for_migration">add_page_for_migration</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col1 decl" id="251mm" title='mm' data-type='struct mm_struct *' data-ref="251mm" data-ref-filename="251mm">mm</dfn>, <em>unsigned</em> <em>long</em> <dfn class="local col2 decl" id="252addr" title='addr' data-type='unsigned long' data-ref="252addr" data-ref-filename="252addr">addr</dfn>,</td></tr>
<tr><th id="1523">1523</th><td>		<em>int</em> <dfn class="local col3 decl" id="253node" title='node' data-type='int' data-ref="253node" data-ref-filename="253node">node</dfn>, <b>struct</b> <a class="type" href="../include/linux/types.h.html#list_head" title='list_head' data-ref="list_head" data-ref-filename="list_head">list_head</a> *<dfn class="local col4 decl" id="254pagelist" title='pagelist' data-type='struct list_head *' data-ref="254pagelist" data-ref-filename="254pagelist">pagelist</dfn>, <a class="typedef" href="../include/linux/types.h.html#bool" title='bool' data-type='_Bool' data-ref="bool" data-ref-filename="bool">bool</a> <dfn class="local col5 decl" id="255migrate_all" title='migrate_all' data-type='bool' data-ref="255migrate_all" data-ref-filename="255migrate_all">migrate_all</dfn>)</td></tr>
<tr><th id="1524">1524</th><td>{</td></tr>
<tr><th id="1525">1525</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#vm_area_struct" title='vm_area_struct' data-ref="vm_area_struct" data-ref-filename="vm_area_struct">vm_area_struct</a> *<dfn class="local col6 decl" id="256vma" title='vma' data-type='struct vm_area_struct *' data-ref="256vma" data-ref-filename="256vma">vma</dfn>;</td></tr>
<tr><th id="1526">1526</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col7 decl" id="257page" title='page' data-type='struct page *' data-ref="257page" data-ref-filename="257page">page</dfn>;</td></tr>
<tr><th id="1527">1527</th><td>	<em>unsigned</em> <em>int</em> <dfn class="local col8 decl" id="258follflags" title='follflags' data-type='unsigned int' data-ref="258follflags" data-ref-filename="258follflags">follflags</dfn>;</td></tr>
<tr><th id="1528">1528</th><td>	<em>int</em> <dfn class="local col9 decl" id="259err" title='err' data-type='int' data-ref="259err" data-ref-filename="259err">err</dfn>;</td></tr>
<tr><th id="1529">1529</th><td></td></tr>
<tr><th id="1530">1530</th><td>	<a class="ref fn" href="../include/linux/rwsem.h.html#down_read" title='down_read' data-ref="down_read" data-ref-filename="down_read">down_read</a>(&amp;<a class="local col1 ref" href="#251mm" title='mm' data-ref="251mm" data-ref-filename="251mm">mm</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#mm_struct::(anonymous)::mmap_sem" title='mm_struct::(anonymous struct)::mmap_sem' data-ref="mm_struct::(anonymous)::mmap_sem" data-ref-filename="mm_struct..(anonymous)..mmap_sem">mmap_sem</a>);</td></tr>
<tr><th id="1531">1531</th><td>	<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#18" title="14" data-ref="_M/EFAULT">EFAULT</a>;</td></tr>
<tr><th id="1532">1532</th><td>	<a class="local col6 ref" href="#256vma" title='vma' data-ref="256vma" data-ref-filename="256vma">vma</a> = <a class="ref fn" href="../include/linux/mm.h.html#find_vma" title='find_vma' data-ref="find_vma" data-ref-filename="find_vma">find_vma</a>(<a class="local col1 ref" href="#251mm" title='mm' data-ref="251mm" data-ref-filename="251mm">mm</a>, <a class="local col2 ref" href="#252addr" title='addr' data-ref="252addr" data-ref-filename="252addr">addr</a>);</td></tr>
<tr><th id="1533">1533</th><td>	<b>if</b> (!<a class="local col6 ref" href="#256vma" title='vma' data-ref="256vma" data-ref-filename="256vma">vma</a> || <a class="local col2 ref" href="#252addr" title='addr' data-ref="252addr" data-ref-filename="252addr">addr</a> &lt; <a class="local col6 ref" href="#256vma" title='vma' data-ref="256vma" data-ref-filename="256vma">vma</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#vm_area_struct::vm_start" title='vm_area_struct::vm_start' data-ref="vm_area_struct::vm_start" data-ref-filename="vm_area_struct..vm_start">vm_start</a> || !<a class="ref fn" href="../include/linux/mempolicy.h.html#vma_migratable" title='vma_migratable' data-ref="vma_migratable" data-ref-filename="vma_migratable">vma_migratable</a>(<a class="local col6 ref" href="#256vma" title='vma' data-ref="256vma" data-ref-filename="256vma">vma</a>))</td></tr>
<tr><th id="1534">1534</th><td>		<b>goto</b> <a class="lbl" href="#260out" data-ref="260out" data-ref-filename="260out">out</a>;</td></tr>
<tr><th id="1535">1535</th><td></td></tr>
<tr><th id="1536">1536</th><td>	<i>/* FOLL_DUMP to ignore special (like zero) pages */</i></td></tr>
<tr><th id="1537">1537</th><td>	<a class="local col8 ref" href="#258follflags" title='follflags' data-ref="258follflags" data-ref-filename="258follflags">follflags</a> = <a class="macro" href="../include/linux/mm.h.html#2601" title="0x04" data-ref="_M/FOLL_GET">FOLL_GET</a> | <a class="macro" href="../include/linux/mm.h.html#2602" title="0x08" data-ref="_M/FOLL_DUMP">FOLL_DUMP</a>;</td></tr>
<tr><th id="1538">1538</th><td>	<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a> = <a class="ref fn" href="../include/linux/mm.h.html#follow_page" title='follow_page' data-ref="follow_page" data-ref-filename="follow_page">follow_page</a>(<a class="local col6 ref" href="#256vma" title='vma' data-ref="256vma" data-ref-filename="256vma">vma</a>, <a class="local col2 ref" href="#252addr" title='addr' data-ref="252addr" data-ref-filename="252addr">addr</a>, <a class="local col8 ref" href="#258follflags" title='follflags' data-ref="258follflags" data-ref-filename="258follflags">follflags</a>);</td></tr>
<tr><th id="1539">1539</th><td></td></tr>
<tr><th id="1540">1540</th><td>	<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = <a class="ref fn" href="../include/linux/err.h.html#PTR_ERR" title='PTR_ERR' data-ref="PTR_ERR" data-ref-filename="PTR_ERR">PTR_ERR</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>);</td></tr>
<tr><th id="1541">1541</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/err.h.html#IS_ERR" title='IS_ERR' data-ref="IS_ERR" data-ref-filename="IS_ERR">IS_ERR</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>))</td></tr>
<tr><th id="1542">1542</th><td>		<b>goto</b> <a class="lbl" href="#260out" data-ref="260out" data-ref-filename="260out">out</a>;</td></tr>
<tr><th id="1543">1543</th><td></td></tr>
<tr><th id="1544">1544</th><td>	<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#6" title="2" data-ref="_M/ENOENT">ENOENT</a>;</td></tr>
<tr><th id="1545">1545</th><td>	<b>if</b> (!<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>)</td></tr>
<tr><th id="1546">1546</th><td>		<b>goto</b> <a class="lbl" href="#260out" data-ref="260out" data-ref-filename="260out">out</a>;</td></tr>
<tr><th id="1547">1547</th><td></td></tr>
<tr><th id="1548">1548</th><td>	<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = <var>0</var>;</td></tr>
<tr><th id="1549">1549</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/mm.h.html#page_to_nid" title='page_to_nid' data-ref="page_to_nid" data-ref-filename="page_to_nid">page_to_nid</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>) == <a class="local col3 ref" href="#253node" title='node' data-ref="253node" data-ref-filename="253node">node</a>)</td></tr>
<tr><th id="1550">1550</th><td>		<b>goto</b> <a class="lbl" href="#261out_putpage" data-ref="261out_putpage" data-ref-filename="261out_putpage">out_putpage</a>;</td></tr>
<tr><th id="1551">1551</th><td></td></tr>
<tr><th id="1552">1552</th><td>	<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#17" title="13" data-ref="_M/EACCES">EACCES</a>;</td></tr>
<tr><th id="1553">1553</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/mm.h.html#page_mapcount" title='page_mapcount' data-ref="page_mapcount" data-ref-filename="page_mapcount">page_mapcount</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>) &gt; <var>1</var> &amp;&amp; !<a class="local col5 ref" href="#255migrate_all" title='migrate_all' data-ref="255migrate_all" data-ref-filename="255migrate_all">migrate_all</a>)</td></tr>
<tr><th id="1554">1554</th><td>		<b>goto</b> <a class="lbl" href="#261out_putpage" data-ref="261out_putpage" data-ref-filename="261out_putpage">out_putpage</a>;</td></tr>
<tr><th id="1555">1555</th><td></td></tr>
<tr><th id="1556">1556</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#PageHuge" title='PageHuge' data-ref="PageHuge" data-ref-filename="PageHuge">PageHuge</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>)) {</td></tr>
<tr><th id="1557">1557</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/page-flags.h.html#550" title='PageHead' data-ref="PageHead" data-ref-filename="PageHead">PageHead</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>)) {</td></tr>
<tr><th id="1558">1558</th><td>			<a class="ref fn" href="../include/linux/hugetlb.h.html#isolate_huge_page" title='isolate_huge_page' data-ref="isolate_huge_page" data-ref-filename="isolate_huge_page">isolate_huge_page</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>, <a class="local col4 ref" href="#254pagelist" title='pagelist' data-ref="254pagelist" data-ref-filename="254pagelist">pagelist</a>);</td></tr>
<tr><th id="1559">1559</th><td>			<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = <var>0</var>;</td></tr>
<tr><th id="1560">1560</th><td>		}</td></tr>
<tr><th id="1561">1561</th><td>	} <b>else</b> {</td></tr>
<tr><th id="1562">1562</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col2 decl" id="262head" title='head' data-type='struct page *' data-ref="262head" data-ref-filename="262head">head</dfn>;</td></tr>
<tr><th id="1563">1563</th><td></td></tr>
<tr><th id="1564">1564</th><td>		<a class="local col2 ref" href="#262head" title='head' data-ref="262head" data-ref-filename="262head">head</a> = <a class="ref fn" href="../include/linux/page-flags.h.html#compound_head" title='compound_head' data-ref="compound_head" data-ref-filename="compound_head">compound_head</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>);</td></tr>
<tr><th id="1565">1565</th><td>		<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = <a class="ref fn" href="internal.h.html#isolate_lru_page" title='isolate_lru_page' data-ref="isolate_lru_page" data-ref-filename="isolate_lru_page">isolate_lru_page</a>(<a class="local col2 ref" href="#262head" title='head' data-ref="262head" data-ref-filename="262head">head</a>);</td></tr>
<tr><th id="1566">1566</th><td>		<b>if</b> (<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a>)</td></tr>
<tr><th id="1567">1567</th><td>			<b>goto</b> <a class="lbl" href="#261out_putpage" data-ref="261out_putpage" data-ref-filename="261out_putpage">out_putpage</a>;</td></tr>
<tr><th id="1568">1568</th><td></td></tr>
<tr><th id="1569">1569</th><td>		<a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a> = <var>0</var>;</td></tr>
<tr><th id="1570">1570</th><td>		<a class="ref fn" href="../include/linux/list.h.html#list_add_tail" title='list_add_tail' data-ref="list_add_tail" data-ref-filename="list_add_tail">list_add_tail</a>(&amp;<a class="local col2 ref" href="#262head" title='head' data-ref="262head" data-ref-filename="262head">head</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#page::(anonymousunion)::(anonymous)::lru" title='page::(anonymous union)::(anonymous struct)::lru' data-ref="page::(anonymousunion)::(anonymous)::lru" data-ref-filename="page..(anonymousunion)..(anonymous)..lru">lru</a>, <a class="local col4 ref" href="#254pagelist" title='pagelist' data-ref="254pagelist" data-ref-filename="254pagelist">pagelist</a>);</td></tr>
<tr><th id="1571">1571</th><td>		<a class="ref fn" href="../include/linux/vmstat.h.html#mod_node_page_state" title='mod_node_page_state' data-ref="mod_node_page_state" data-ref-filename="mod_node_page_state">mod_node_page_state</a>(<a class="ref fn" href="../include/linux/mm.h.html#page_pgdat" title='page_pgdat' data-ref="page_pgdat" data-ref-filename="page_pgdat">page_pgdat</a>(<a class="local col2 ref" href="#262head" title='head' data-ref="262head" data-ref-filename="262head">head</a>),</td></tr>
<tr><th id="1572">1572</th><td>			<a class="enum" href="../include/linux/mmzone.h.html#NR_ISOLATED_ANON" title='NR_ISOLATED_ANON' data-ref="NR_ISOLATED_ANON" data-ref-filename="NR_ISOLATED_ANON">NR_ISOLATED_ANON</a> + <a class="ref fn" href="../include/linux/mm_inline.h.html#page_is_file_cache" title='page_is_file_cache' data-ref="page_is_file_cache" data-ref-filename="page_is_file_cache">page_is_file_cache</a>(<a class="local col2 ref" href="#262head" title='head' data-ref="262head" data-ref-filename="262head">head</a>),</td></tr>
<tr><th id="1573">1573</th><td>			<a class="macro" href="../include/linux/huge_mm.h.html#279" title="1" data-ref="_M/hpage_nr_pages">hpage_nr_pages</a>(head));</td></tr>
<tr><th id="1574">1574</th><td>	}</td></tr>
<tr><th id="1575">1575</th><td><dfn class="lbl" id="261out_putpage" data-ref="261out_putpage" data-ref-filename="261out_putpage">out_putpage</dfn>:</td></tr>
<tr><th id="1576">1576</th><td>	<i>/*</i></td></tr>
<tr><th id="1577">1577</th><td><i>	 * Either remove the duplicate refcount from</i></td></tr>
<tr><th id="1578">1578</th><td><i>	 * isolate_lru_page() or drop the page ref if it was</i></td></tr>
<tr><th id="1579">1579</th><td><i>	 * not isolated.</i></td></tr>
<tr><th id="1580">1580</th><td><i>	 */</i></td></tr>
<tr><th id="1581">1581</th><td>	<a class="ref fn" href="../include/linux/mm.h.html#put_page" title='put_page' data-ref="put_page" data-ref-filename="put_page">put_page</a>(<a class="local col7 ref" href="#257page" title='page' data-ref="257page" data-ref-filename="257page">page</a>);</td></tr>
<tr><th id="1582">1582</th><td><dfn class="lbl" id="260out" data-ref="260out" data-ref-filename="260out">out</dfn>:</td></tr>
<tr><th id="1583">1583</th><td>	<a class="ref fn" href="../include/linux/rwsem.h.html#up_read" title='up_read' data-ref="up_read" data-ref-filename="up_read">up_read</a>(&amp;<a class="local col1 ref" href="#251mm" title='mm' data-ref="251mm" data-ref-filename="251mm">mm</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#mm_struct::(anonymous)::mmap_sem" title='mm_struct::(anonymous struct)::mmap_sem' data-ref="mm_struct::(anonymous)::mmap_sem" data-ref-filename="mm_struct..(anonymous)..mmap_sem">mmap_sem</a>);</td></tr>
<tr><th id="1584">1584</th><td>	<b>return</b> <a class="local col9 ref" href="#259err" title='err' data-ref="259err" data-ref-filename="259err">err</a>;</td></tr>
<tr><th id="1585">1585</th><td>}</td></tr>
<tr><th id="1586">1586</th><td></td></tr>
<tr><th id="1587">1587</th><td><i  data-doc="do_pages_move">/*</i></td></tr>
<tr><th id="1588">1588</th><td><i  data-doc="do_pages_move"> * Migrate an array of page address onto an array of nodes and fill</i></td></tr>
<tr><th id="1589">1589</th><td><i  data-doc="do_pages_move"> * the corresponding array of status.</i></td></tr>
<tr><th id="1590">1590</th><td><i  data-doc="do_pages_move"> */</i></td></tr>
<tr><th id="1591">1591</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="do_pages_move" title='do_pages_move' data-type='int do_pages_move(struct mm_struct * mm, nodemask_t task_nodes, unsigned long nr_pages, const void ** pages, const int * nodes, int * status, int flags)' data-ref="do_pages_move" data-ref-filename="do_pages_move">do_pages_move</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col3 decl" id="263mm" title='mm' data-type='struct mm_struct *' data-ref="263mm" data-ref-filename="263mm">mm</dfn>, <a class="typedef" href="../include/linux/nodemask.h.html#nodemask_t" title='nodemask_t' data-type='struct nodemask_t' data-ref="nodemask_t" data-ref-filename="nodemask_t">nodemask_t</a> <dfn class="local col4 decl" id="264task_nodes" title='task_nodes' data-type='nodemask_t' data-ref="264task_nodes" data-ref-filename="264task_nodes">task_nodes</dfn>,</td></tr>
<tr><th id="1592">1592</th><td>			 <em>unsigned</em> <em>long</em> <dfn class="local col5 decl" id="265nr_pages" title='nr_pages' data-type='unsigned long' data-ref="265nr_pages" data-ref-filename="265nr_pages">nr_pages</dfn>,</td></tr>
<tr><th id="1593">1593</th><td>			 <em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> * <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col6 decl" id="266pages" title='pages' data-type='const void **' data-ref="266pages" data-ref-filename="266pages">pages</dfn>,</td></tr>
<tr><th id="1594">1594</th><td>			 <em>const</em> <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col7 decl" id="267nodes" title='nodes' data-type='const int *' data-ref="267nodes" data-ref-filename="267nodes">nodes</dfn>,</td></tr>
<tr><th id="1595">1595</th><td>			 <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col8 decl" id="268status" title='status' data-type='int *' data-ref="268status" data-ref-filename="268status">status</dfn>, <em>int</em> <dfn class="local col9 decl" id="269flags" title='flags' data-type='int' data-ref="269flags" data-ref-filename="269flags">flags</dfn>)</td></tr>
<tr><th id="1596">1596</th><td>{</td></tr>
<tr><th id="1597">1597</th><td>	<em>int</em> <dfn class="local col0 decl" id="270current_node" title='current_node' data-type='int' data-ref="270current_node" data-ref-filename="270current_node">current_node</dfn> = <a class="macro" href="../include/linux/numa.h.html#14" title="(-1)" data-ref="_M/NUMA_NO_NODE">NUMA_NO_NODE</a>;</td></tr>
<tr><th id="1598">1598</th><td>	<a class="macro" href="../include/linux/list.h.html#23" title="struct list_head pagelist = { &amp;(pagelist), &amp;(pagelist) }" data-ref="_M/LIST_HEAD">LIST_HEAD</a>(<dfn class="local col1 decl" id="271pagelist" title='pagelist' data-type='struct list_head' data-ref="271pagelist" data-ref-filename="271pagelist"><a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist"><a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist"><a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist"><a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist">pagelist</a></a></a></a></dfn>);</td></tr>
<tr><th id="1599">1599</th><td>	<em>int</em> <dfn class="local col2 decl" id="272start" title='start' data-type='int' data-ref="272start" data-ref-filename="272start">start</dfn>, <dfn class="local col3 decl" id="273i" title='i' data-type='int' data-ref="273i" data-ref-filename="273i">i</dfn>;</td></tr>
<tr><th id="1600">1600</th><td>	<em>int</em> <dfn class="local col4 decl" id="274err" title='err' data-type='int' data-ref="274err" data-ref-filename="274err">err</dfn> = <var>0</var>, <dfn class="local col5 decl" id="275err1" title='err1' data-type='int' data-ref="275err1" data-ref-filename="275err1">err1</dfn>;</td></tr>
<tr><th id="1601">1601</th><td></td></tr>
<tr><th id="1602">1602</th><td>	<a class="ref fn" href="#migrate_prep" title='migrate_prep' data-ref="migrate_prep" data-ref-filename="migrate_prep">migrate_prep</a>();</td></tr>
<tr><th id="1603">1603</th><td></td></tr>
<tr><th id="1604">1604</th><td>	<b>for</b> (<a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a> = <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a> = <var>0</var>; <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a> &lt; <a class="local col5 ref" href="#265nr_pages" title='nr_pages' data-ref="265nr_pages" data-ref-filename="265nr_pages">nr_pages</a>; <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a>++) {</td></tr>
<tr><th id="1605">1605</th><td>		<em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col6 decl" id="276p" title='p' data-type='const void *' data-ref="276p" data-ref-filename="276p">p</dfn>;</td></tr>
<tr><th id="1606">1606</th><td>		<em>unsigned</em> <em>long</em> <dfn class="local col7 decl" id="277addr" title='addr' data-type='unsigned long' data-ref="277addr" data-ref-filename="277addr">addr</dfn>;</td></tr>
<tr><th id="1607">1607</th><td>		<em>int</em> <dfn class="local col8 decl" id="278node" title='node' data-type='int' data-ref="278node" data-ref-filename="278node">node</dfn>;</td></tr>
<tr><th id="1608">1608</th><td></td></tr>
<tr><th id="1609">1609</th><td>		<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#18" title="14" data-ref="_M/EFAULT">EFAULT</a>;</td></tr>
<tr><th id="1610">1610</th><td>		<b>if</b> (<a class="macro" href="../arch/x86/include/asm/uaccess.h.html#166" title="({ int __ret_gu; register __typeof__(__builtin_choose_expr(sizeof(*(pages + i)) &gt; sizeof(0UL), 0ULL, 0UL)) __val_gu asm(&quot;%&quot;&quot;rdx&quot;); (void)0; might_fault(); asm volatile(&quot;call __get_user_%P4&quot; : &quot;=a&quot; (__ret_gu), &quot;=r&quot; (__val_gu), &quot;+r&quot; (current_stack_pointer) : &quot;0&quot; (pages + i), &quot;i&quot; (sizeof(*(pages + i)))); (p) = ( __typeof__(*(pages + i))) __val_gu; __builtin_expect(__ret_gu, 0); })" data-ref="_M/get_user">get_user</a>(<a class="local col6 ref" href="#276p" title='p' data-ref="276p" data-ref-filename="276p">p</a>, <a class="local col6 ref" href="#266pages" title='pages' data-ref="266pages" data-ref-filename="266pages">pages</a> + <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a>))</td></tr>
<tr><th id="1611">1611</th><td>			<b>goto</b> <a class="lbl" href="#279out_flush" data-ref="279out_flush" data-ref-filename="279out_flush">out_flush</a>;</td></tr>
<tr><th id="1612">1612</th><td>		<b>if</b> (<a class="macro" href="../arch/x86/include/asm/uaccess.h.html#166" title="({ int __ret_gu; register __typeof__(__builtin_choose_expr(sizeof(*(nodes + i)) &gt; sizeof(0UL), 0ULL, 0UL)) __val_gu asm(&quot;%&quot;&quot;rdx&quot;); (void)0; might_fault(); asm volatile(&quot;call __get_user_%P4&quot; : &quot;=a&quot; (__ret_gu), &quot;=r&quot; (__val_gu), &quot;+r&quot; (current_stack_pointer) : &quot;0&quot; (nodes + i), &quot;i&quot; (sizeof(*(nodes + i)))); (node) = ( __typeof__(*(nodes + i))) __val_gu; __builtin_expect(__ret_gu, 0); })" data-ref="_M/get_user">get_user</a>(<a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a>, <a class="local col7 ref" href="#267nodes" title='nodes' data-ref="267nodes" data-ref-filename="267nodes">nodes</a> + <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a>))</td></tr>
<tr><th id="1613">1613</th><td>			<b>goto</b> <a class="lbl" href="#279out_flush" data-ref="279out_flush" data-ref-filename="279out_flush">out_flush</a>;</td></tr>
<tr><th id="1614">1614</th><td>		<a class="local col7 ref" href="#277addr" title='addr' data-ref="277addr" data-ref-filename="277addr">addr</a> = (<em>unsigned</em> <em>long</em>)<a class="local col6 ref" href="#276p" title='p' data-ref="276p" data-ref-filename="276p">p</a>;</td></tr>
<tr><th id="1615">1615</th><td></td></tr>
<tr><th id="1616">1616</th><td>		<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#23" title="19" data-ref="_M/ENODEV">ENODEV</a>;</td></tr>
<tr><th id="1617">1617</th><td>		<b>if</b> (<a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a> &lt; <var>0</var> || <a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a> &gt;= <a class="macro" href="../include/linux/numa.h.html#12" title="(1 &lt;&lt; 6)" data-ref="_M/MAX_NUMNODES">MAX_NUMNODES</a>)</td></tr>
<tr><th id="1618">1618</th><td>			<b>goto</b> <a class="lbl" href="#279out_flush" data-ref="279out_flush" data-ref-filename="279out_flush">out_flush</a>;</td></tr>
<tr><th id="1619">1619</th><td>		<b>if</b> (!<a class="ref fn" href="../include/linux/nodemask.h.html#node_state" title='node_state' data-ref="node_state" data-ref-filename="node_state">node_state</a>(<a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a>, <a class="enum" href="../include/linux/nodemask.h.html#N_MEMORY" title='N_MEMORY' data-ref="N_MEMORY" data-ref-filename="N_MEMORY">N_MEMORY</a>))</td></tr>
<tr><th id="1620">1620</th><td>			<b>goto</b> <a class="lbl" href="#279out_flush" data-ref="279out_flush" data-ref-filename="279out_flush">out_flush</a>;</td></tr>
<tr><th id="1621">1621</th><td></td></tr>
<tr><th id="1622">1622</th><td>		<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#17" title="13" data-ref="_M/EACCES">EACCES</a>;</td></tr>
<tr><th id="1623">1623</th><td>		<b>if</b> (!<a class="macro" href="../include/linux/nodemask.h.html#152" title="test_bit((node), (task_nodes).bits)" data-ref="_M/node_isset">node_isset</a>(<a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a>, <a class="local col4 ref" href="#264task_nodes" title='task_nodes' data-ref="264task_nodes" data-ref-filename="264task_nodes">task_nodes</a>))</td></tr>
<tr><th id="1624">1624</th><td>			<b>goto</b> <a class="lbl" href="#279out_flush" data-ref="279out_flush" data-ref-filename="279out_flush">out_flush</a>;</td></tr>
<tr><th id="1625">1625</th><td></td></tr>
<tr><th id="1626">1626</th><td>		<b>if</b> (<a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a> == <a class="macro" href="../include/linux/numa.h.html#14" title="(-1)" data-ref="_M/NUMA_NO_NODE">NUMA_NO_NODE</a>) {</td></tr>
<tr><th id="1627">1627</th><td>			<a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a> = <a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a>;</td></tr>
<tr><th id="1628">1628</th><td>			<a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a> = <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a>;</td></tr>
<tr><th id="1629">1629</th><td>		} <b>else</b> <b>if</b> (<a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a> != <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>) {</td></tr>
<tr><th id="1630">1630</th><td>			<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = <a class="tu ref fn" href="#do_move_pages_to_node" title='do_move_pages_to_node' data-use='c' data-ref="do_move_pages_to_node" data-ref-filename="do_move_pages_to_node">do_move_pages_to_node</a>(<a class="local col3 ref" href="#263mm" title='mm' data-ref="263mm" data-ref-filename="263mm">mm</a>, &amp;<a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist">pagelist</a>, <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>);</td></tr>
<tr><th id="1631">1631</th><td>			<b>if</b> (<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>)</td></tr>
<tr><th id="1632">1632</th><td>				<b>goto</b> <a class="lbl" href="#280out" data-ref="280out" data-ref-filename="280out">out</a>;</td></tr>
<tr><th id="1633">1633</th><td>			<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = <a class="tu ref fn" href="#store_status" title='store_status' data-use='c' data-ref="store_status" data-ref-filename="store_status">store_status</a>(<a class="local col8 ref" href="#268status" title='status' data-ref="268status" data-ref-filename="268status">status</a>, <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a>, <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>, <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a> - <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a>);</td></tr>
<tr><th id="1634">1634</th><td>			<b>if</b> (<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>)</td></tr>
<tr><th id="1635">1635</th><td>				<b>goto</b> <a class="lbl" href="#280out" data-ref="280out" data-ref-filename="280out">out</a>;</td></tr>
<tr><th id="1636">1636</th><td>			<a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a> = <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a>;</td></tr>
<tr><th id="1637">1637</th><td>			<a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a> = <a class="local col8 ref" href="#278node" title='node' data-ref="278node" data-ref-filename="278node">node</a>;</td></tr>
<tr><th id="1638">1638</th><td>		}</td></tr>
<tr><th id="1639">1639</th><td></td></tr>
<tr><th id="1640">1640</th><td>		<i>/*</i></td></tr>
<tr><th id="1641">1641</th><td><i>		 * Errors in the page lookup or isolation are not fatal and we simply</i></td></tr>
<tr><th id="1642">1642</th><td><i>		 * report them via status</i></td></tr>
<tr><th id="1643">1643</th><td><i>		 */</i></td></tr>
<tr><th id="1644">1644</th><td>		<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = <a class="tu ref fn" href="#add_page_for_migration" title='add_page_for_migration' data-use='c' data-ref="add_page_for_migration" data-ref-filename="add_page_for_migration">add_page_for_migration</a>(<a class="local col3 ref" href="#263mm" title='mm' data-ref="263mm" data-ref-filename="263mm">mm</a>, <a class="local col7 ref" href="#277addr" title='addr' data-ref="277addr" data-ref-filename="277addr">addr</a>, <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>,</td></tr>
<tr><th id="1645">1645</th><td>				&amp;<a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist">pagelist</a>, <a class="local col9 ref" href="#269flags" title='flags' data-ref="269flags" data-ref-filename="269flags">flags</a> &amp; <a class="macro" href="../include/uapi/linux/mempolicy.h.html#47" title="(1&lt;&lt;2)" data-ref="_M/MPOL_MF_MOVE_ALL">MPOL_MF_MOVE_ALL</a>);</td></tr>
<tr><th id="1646">1646</th><td>		<b>if</b> (!<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>)</td></tr>
<tr><th id="1647">1647</th><td>			<b>continue</b>;</td></tr>
<tr><th id="1648">1648</th><td></td></tr>
<tr><th id="1649">1649</th><td>		<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = <a class="tu ref fn" href="#store_status" title='store_status' data-use='c' data-ref="store_status" data-ref-filename="store_status">store_status</a>(<a class="local col8 ref" href="#268status" title='status' data-ref="268status" data-ref-filename="268status">status</a>, <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a>, <a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>, <var>1</var>);</td></tr>
<tr><th id="1650">1650</th><td>		<b>if</b> (<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>)</td></tr>
<tr><th id="1651">1651</th><td>			<b>goto</b> <a class="lbl" href="#279out_flush" data-ref="279out_flush" data-ref-filename="279out_flush">out_flush</a>;</td></tr>
<tr><th id="1652">1652</th><td></td></tr>
<tr><th id="1653">1653</th><td>		<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = <a class="tu ref fn" href="#do_move_pages_to_node" title='do_move_pages_to_node' data-use='c' data-ref="do_move_pages_to_node" data-ref-filename="do_move_pages_to_node">do_move_pages_to_node</a>(<a class="local col3 ref" href="#263mm" title='mm' data-ref="263mm" data-ref-filename="263mm">mm</a>, &amp;<a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist">pagelist</a>, <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>);</td></tr>
<tr><th id="1654">1654</th><td>		<b>if</b> (<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>)</td></tr>
<tr><th id="1655">1655</th><td>			<b>goto</b> <a class="lbl" href="#280out" data-ref="280out" data-ref-filename="280out">out</a>;</td></tr>
<tr><th id="1656">1656</th><td>		<b>if</b> (<a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a> &gt; <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a>) {</td></tr>
<tr><th id="1657">1657</th><td>			<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = <a class="tu ref fn" href="#store_status" title='store_status' data-use='c' data-ref="store_status" data-ref-filename="store_status">store_status</a>(<a class="local col8 ref" href="#268status" title='status' data-ref="268status" data-ref-filename="268status">status</a>, <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a>, <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>, <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a> - <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a>);</td></tr>
<tr><th id="1658">1658</th><td>			<b>if</b> (<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>)</td></tr>
<tr><th id="1659">1659</th><td>				<b>goto</b> <a class="lbl" href="#280out" data-ref="280out" data-ref-filename="280out">out</a>;</td></tr>
<tr><th id="1660">1660</th><td>		}</td></tr>
<tr><th id="1661">1661</th><td>		<a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a> = <a class="macro" href="../include/linux/numa.h.html#14" title="(-1)" data-ref="_M/NUMA_NO_NODE">NUMA_NO_NODE</a>;</td></tr>
<tr><th id="1662">1662</th><td>	}</td></tr>
<tr><th id="1663">1663</th><td><dfn class="lbl" id="279out_flush" data-ref="279out_flush" data-ref-filename="279out_flush">out_flush</dfn>:</td></tr>
<tr><th id="1664">1664</th><td>	<b>if</b> (<a class="ref fn" href="../include/linux/list.h.html#list_empty" title='list_empty' data-ref="list_empty" data-ref-filename="list_empty">list_empty</a>(&amp;<a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist">pagelist</a>))</td></tr>
<tr><th id="1665">1665</th><td>		<b>return</b> <a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>;</td></tr>
<tr><th id="1666">1666</th><td></td></tr>
<tr><th id="1667">1667</th><td>	<i>/* Make sure we do not overwrite the existing error */</i></td></tr>
<tr><th id="1668">1668</th><td>	<a class="local col5 ref" href="#275err1" title='err1' data-ref="275err1" data-ref-filename="275err1">err1</a> = <a class="tu ref fn" href="#do_move_pages_to_node" title='do_move_pages_to_node' data-use='c' data-ref="do_move_pages_to_node" data-ref-filename="do_move_pages_to_node">do_move_pages_to_node</a>(<a class="local col3 ref" href="#263mm" title='mm' data-ref="263mm" data-ref-filename="263mm">mm</a>, &amp;<a class="local col1 ref" href="#1598" title='pagelist' data-ref="271pagelist" data-ref-filename="271pagelist">pagelist</a>, <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>);</td></tr>
<tr><th id="1669">1669</th><td>	<b>if</b> (!<a class="local col5 ref" href="#275err1" title='err1' data-ref="275err1" data-ref-filename="275err1">err1</a>)</td></tr>
<tr><th id="1670">1670</th><td>		<a class="local col5 ref" href="#275err1" title='err1' data-ref="275err1" data-ref-filename="275err1">err1</a> = <a class="tu ref fn" href="#store_status" title='store_status' data-use='c' data-ref="store_status" data-ref-filename="store_status">store_status</a>(<a class="local col8 ref" href="#268status" title='status' data-ref="268status" data-ref-filename="268status">status</a>, <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a>, <a class="local col0 ref" href="#270current_node" title='current_node' data-ref="270current_node" data-ref-filename="270current_node">current_node</a>, <a class="local col3 ref" href="#273i" title='i' data-ref="273i" data-ref-filename="273i">i</a> - <a class="local col2 ref" href="#272start" title='start' data-ref="272start" data-ref-filename="272start">start</a>);</td></tr>
<tr><th id="1671">1671</th><td>	<b>if</b> (!<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>)</td></tr>
<tr><th id="1672">1672</th><td>		<a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a> = <a class="local col5 ref" href="#275err1" title='err1' data-ref="275err1" data-ref-filename="275err1">err1</a>;</td></tr>
<tr><th id="1673">1673</th><td><dfn class="lbl" id="280out" data-ref="280out" data-ref-filename="280out">out</dfn>:</td></tr>
<tr><th id="1674">1674</th><td>	<b>return</b> <a class="local col4 ref" href="#274err" title='err' data-ref="274err" data-ref-filename="274err">err</a>;</td></tr>
<tr><th id="1675">1675</th><td>}</td></tr>
<tr><th id="1676">1676</th><td></td></tr>
<tr><th id="1677">1677</th><td><i  data-doc="do_pages_stat_array">/*</i></td></tr>
<tr><th id="1678">1678</th><td><i  data-doc="do_pages_stat_array"> * Determine the nodes of an array of pages and store it in an array of status.</i></td></tr>
<tr><th id="1679">1679</th><td><i  data-doc="do_pages_stat_array"> */</i></td></tr>
<tr><th id="1680">1680</th><td><em>static</em> <em>void</em> <dfn class="tu decl def fn" id="do_pages_stat_array" title='do_pages_stat_array' data-type='void do_pages_stat_array(struct mm_struct * mm, unsigned long nr_pages, const void ** pages, int * status)' data-ref="do_pages_stat_array" data-ref-filename="do_pages_stat_array">do_pages_stat_array</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col1 decl" id="281mm" title='mm' data-type='struct mm_struct *' data-ref="281mm" data-ref-filename="281mm">mm</dfn>, <em>unsigned</em> <em>long</em> <dfn class="local col2 decl" id="282nr_pages" title='nr_pages' data-type='unsigned long' data-ref="282nr_pages" data-ref-filename="282nr_pages">nr_pages</dfn>,</td></tr>
<tr><th id="1681">1681</th><td>				<em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> **<dfn class="local col3 decl" id="283pages" title='pages' data-type='const void **' data-ref="283pages" data-ref-filename="283pages">pages</dfn>, <em>int</em> *<dfn class="local col4 decl" id="284status" title='status' data-type='int *' data-ref="284status" data-ref-filename="284status">status</dfn>)</td></tr>
<tr><th id="1682">1682</th><td>{</td></tr>
<tr><th id="1683">1683</th><td>	<em>unsigned</em> <em>long</em> <dfn class="local col5 decl" id="285i" title='i' data-type='unsigned long' data-ref="285i" data-ref-filename="285i">i</dfn>;</td></tr>
<tr><th id="1684">1684</th><td></td></tr>
<tr><th id="1685">1685</th><td>	<a class="ref fn" href="../include/linux/rwsem.h.html#down_read" title='down_read' data-ref="down_read" data-ref-filename="down_read">down_read</a>(&amp;<a class="local col1 ref" href="#281mm" title='mm' data-ref="281mm" data-ref-filename="281mm">mm</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#mm_struct::(anonymous)::mmap_sem" title='mm_struct::(anonymous struct)::mmap_sem' data-ref="mm_struct::(anonymous)::mmap_sem" data-ref-filename="mm_struct..(anonymous)..mmap_sem">mmap_sem</a>);</td></tr>
<tr><th id="1686">1686</th><td></td></tr>
<tr><th id="1687">1687</th><td>	<b>for</b> (<a class="local col5 ref" href="#285i" title='i' data-ref="285i" data-ref-filename="285i">i</a> = <var>0</var>; <a class="local col5 ref" href="#285i" title='i' data-ref="285i" data-ref-filename="285i">i</a> &lt; <a class="local col2 ref" href="#282nr_pages" title='nr_pages' data-ref="282nr_pages" data-ref-filename="282nr_pages">nr_pages</a>; <a class="local col5 ref" href="#285i" title='i' data-ref="285i" data-ref-filename="285i">i</a>++) {</td></tr>
<tr><th id="1688">1688</th><td>		<em>unsigned</em> <em>long</em> <dfn class="local col6 decl" id="286addr" title='addr' data-type='unsigned long' data-ref="286addr" data-ref-filename="286addr">addr</dfn> = (<em>unsigned</em> <em>long</em>)(*<a class="local col3 ref" href="#283pages" title='pages' data-ref="283pages" data-ref-filename="283pages">pages</a>);</td></tr>
<tr><th id="1689">1689</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#vm_area_struct" title='vm_area_struct' data-ref="vm_area_struct" data-ref-filename="vm_area_struct">vm_area_struct</a> *<dfn class="local col7 decl" id="287vma" title='vma' data-type='struct vm_area_struct *' data-ref="287vma" data-ref-filename="287vma">vma</dfn>;</td></tr>
<tr><th id="1690">1690</th><td>		<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#page" title='page' data-ref="page" data-ref-filename="page">page</a> *<dfn class="local col8 decl" id="288page" title='page' data-type='struct page *' data-ref="288page" data-ref-filename="288page">page</dfn>;</td></tr>
<tr><th id="1691">1691</th><td>		<em>int</em> <dfn class="local col9 decl" id="289err" title='err' data-type='int' data-ref="289err" data-ref-filename="289err">err</dfn> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#18" title="14" data-ref="_M/EFAULT">EFAULT</a>;</td></tr>
<tr><th id="1692">1692</th><td></td></tr>
<tr><th id="1693">1693</th><td>		<a class="local col7 ref" href="#287vma" title='vma' data-ref="287vma" data-ref-filename="287vma">vma</a> = <a class="ref fn" href="../include/linux/mm.h.html#find_vma" title='find_vma' data-ref="find_vma" data-ref-filename="find_vma">find_vma</a>(<a class="local col1 ref" href="#281mm" title='mm' data-ref="281mm" data-ref-filename="281mm">mm</a>, <a class="local col6 ref" href="#286addr" title='addr' data-ref="286addr" data-ref-filename="286addr">addr</a>);</td></tr>
<tr><th id="1694">1694</th><td>		<b>if</b> (!<a class="local col7 ref" href="#287vma" title='vma' data-ref="287vma" data-ref-filename="287vma">vma</a> || <a class="local col6 ref" href="#286addr" title='addr' data-ref="286addr" data-ref-filename="286addr">addr</a> &lt; <a class="local col7 ref" href="#287vma" title='vma' data-ref="287vma" data-ref-filename="287vma">vma</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#vm_area_struct::vm_start" title='vm_area_struct::vm_start' data-ref="vm_area_struct::vm_start" data-ref-filename="vm_area_struct..vm_start">vm_start</a>)</td></tr>
<tr><th id="1695">1695</th><td>			<b>goto</b> <a class="lbl" href="#290set_status" data-ref="290set_status" data-ref-filename="290set_status">set_status</a>;</td></tr>
<tr><th id="1696">1696</th><td></td></tr>
<tr><th id="1697">1697</th><td>		<i>/* FOLL_DUMP to ignore special (like zero) pages */</i></td></tr>
<tr><th id="1698">1698</th><td>		<a class="local col8 ref" href="#288page" title='page' data-ref="288page" data-ref-filename="288page">page</a> = <a class="ref fn" href="../include/linux/mm.h.html#follow_page" title='follow_page' data-ref="follow_page" data-ref-filename="follow_page">follow_page</a>(<a class="local col7 ref" href="#287vma" title='vma' data-ref="287vma" data-ref-filename="287vma">vma</a>, <a class="local col6 ref" href="#286addr" title='addr' data-ref="286addr" data-ref-filename="286addr">addr</a>, <a class="macro" href="../include/linux/mm.h.html#2602" title="0x08" data-ref="_M/FOLL_DUMP">FOLL_DUMP</a>);</td></tr>
<tr><th id="1699">1699</th><td></td></tr>
<tr><th id="1700">1700</th><td>		<a class="local col9 ref" href="#289err" title='err' data-ref="289err" data-ref-filename="289err">err</a> = <a class="ref fn" href="../include/linux/err.h.html#PTR_ERR" title='PTR_ERR' data-ref="PTR_ERR" data-ref-filename="PTR_ERR">PTR_ERR</a>(<a class="local col8 ref" href="#288page" title='page' data-ref="288page" data-ref-filename="288page">page</a>);</td></tr>
<tr><th id="1701">1701</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/err.h.html#IS_ERR" title='IS_ERR' data-ref="IS_ERR" data-ref-filename="IS_ERR">IS_ERR</a>(<a class="local col8 ref" href="#288page" title='page' data-ref="288page" data-ref-filename="288page">page</a>))</td></tr>
<tr><th id="1702">1702</th><td>			<b>goto</b> <a class="lbl" href="#290set_status" data-ref="290set_status" data-ref-filename="290set_status">set_status</a>;</td></tr>
<tr><th id="1703">1703</th><td></td></tr>
<tr><th id="1704">1704</th><td>		<a class="local col9 ref" href="#289err" title='err' data-ref="289err" data-ref-filename="289err">err</a> = <a class="local col8 ref" href="#288page" title='page' data-ref="288page" data-ref-filename="288page">page</a> ? <a class="ref fn" href="../include/linux/mm.h.html#page_to_nid" title='page_to_nid' data-ref="page_to_nid" data-ref-filename="page_to_nid">page_to_nid</a>(<a class="local col8 ref" href="#288page" title='page' data-ref="288page" data-ref-filename="288page">page</a>) : -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#6" title="2" data-ref="_M/ENOENT">ENOENT</a>;</td></tr>
<tr><th id="1705">1705</th><td><dfn class="lbl" id="290set_status" data-ref="290set_status" data-ref-filename="290set_status">set_status</dfn>:</td></tr>
<tr><th id="1706">1706</th><td>		*<a class="local col4 ref" href="#284status" title='status' data-ref="284status" data-ref-filename="284status">status</a> = <a class="local col9 ref" href="#289err" title='err' data-ref="289err" data-ref-filename="289err">err</a>;</td></tr>
<tr><th id="1707">1707</th><td></td></tr>
<tr><th id="1708">1708</th><td>		<a class="local col3 ref" href="#283pages" title='pages' data-ref="283pages" data-ref-filename="283pages">pages</a>++;</td></tr>
<tr><th id="1709">1709</th><td>		<a class="local col4 ref" href="#284status" title='status' data-ref="284status" data-ref-filename="284status">status</a>++;</td></tr>
<tr><th id="1710">1710</th><td>	}</td></tr>
<tr><th id="1711">1711</th><td></td></tr>
<tr><th id="1712">1712</th><td>	<a class="ref fn" href="../include/linux/rwsem.h.html#up_read" title='up_read' data-ref="up_read" data-ref-filename="up_read">up_read</a>(&amp;<a class="local col1 ref" href="#281mm" title='mm' data-ref="281mm" data-ref-filename="281mm">mm</a>-&gt;<a class="ref field" href="../include/linux/mm_types.h.html#mm_struct::(anonymous)::mmap_sem" title='mm_struct::(anonymous struct)::mmap_sem' data-ref="mm_struct::(anonymous)::mmap_sem" data-ref-filename="mm_struct..(anonymous)..mmap_sem">mmap_sem</a>);</td></tr>
<tr><th id="1713">1713</th><td>}</td></tr>
<tr><th id="1714">1714</th><td></td></tr>
<tr><th id="1715">1715</th><td><i  data-doc="do_pages_stat">/*</i></td></tr>
<tr><th id="1716">1716</th><td><i  data-doc="do_pages_stat"> * Determine the nodes of a user array of pages and store it in</i></td></tr>
<tr><th id="1717">1717</th><td><i  data-doc="do_pages_stat"> * a user array of status.</i></td></tr>
<tr><th id="1718">1718</th><td><i  data-doc="do_pages_stat"> */</i></td></tr>
<tr><th id="1719">1719</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="do_pages_stat" title='do_pages_stat' data-type='int do_pages_stat(struct mm_struct * mm, unsigned long nr_pages, const void ** pages, int * status)' data-ref="do_pages_stat" data-ref-filename="do_pages_stat">do_pages_stat</dfn>(<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col1 decl" id="291mm" title='mm' data-type='struct mm_struct *' data-ref="291mm" data-ref-filename="291mm">mm</dfn>, <em>unsigned</em> <em>long</em> <dfn class="local col2 decl" id="292nr_pages" title='nr_pages' data-type='unsigned long' data-ref="292nr_pages" data-ref-filename="292nr_pages">nr_pages</dfn>,</td></tr>
<tr><th id="1720">1720</th><td>			 <em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> * <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col3 decl" id="293pages" title='pages' data-type='const void **' data-ref="293pages" data-ref-filename="293pages">pages</dfn>,</td></tr>
<tr><th id="1721">1721</th><td>			 <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col4 decl" id="294status" title='status' data-type='int *' data-ref="294status" data-ref-filename="294status">status</dfn>)</td></tr>
<tr><th id="1722">1722</th><td>{</td></tr>
<tr><th id="1723">1723</th><td><u>#define <dfn class="macro" id="_M/DO_PAGES_STAT_CHUNK_NR" data-ref="_M/DO_PAGES_STAT_CHUNK_NR">DO_PAGES_STAT_CHUNK_NR</dfn> 16</u></td></tr>
<tr><th id="1724">1724</th><td>	<em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col5 decl" id="295chunk_pages" title='chunk_pages' data-type='const void *[16]' data-ref="295chunk_pages" data-ref-filename="295chunk_pages">chunk_pages</dfn>[<a class="macro" href="#1723" title="16" data-ref="_M/DO_PAGES_STAT_CHUNK_NR">DO_PAGES_STAT_CHUNK_NR</a>];</td></tr>
<tr><th id="1725">1725</th><td>	<em>int</em> <dfn class="local col6 decl" id="296chunk_status" title='chunk_status' data-type='int [16]' data-ref="296chunk_status" data-ref-filename="296chunk_status">chunk_status</dfn>[<a class="macro" href="#1723" title="16" data-ref="_M/DO_PAGES_STAT_CHUNK_NR">DO_PAGES_STAT_CHUNK_NR</a>];</td></tr>
<tr><th id="1726">1726</th><td></td></tr>
<tr><th id="1727">1727</th><td>	<b>while</b> (<a class="local col2 ref" href="#292nr_pages" title='nr_pages' data-ref="292nr_pages" data-ref-filename="292nr_pages">nr_pages</a>) {</td></tr>
<tr><th id="1728">1728</th><td>		<em>unsigned</em> <em>long</em> <dfn class="local col7 decl" id="297chunk_nr" title='chunk_nr' data-type='unsigned long' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</dfn>;</td></tr>
<tr><th id="1729">1729</th><td></td></tr>
<tr><th id="1730">1730</th><td>		<a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a> = <a class="local col2 ref" href="#292nr_pages" title='nr_pages' data-ref="292nr_pages" data-ref-filename="292nr_pages">nr_pages</a>;</td></tr>
<tr><th id="1731">1731</th><td>		<b>if</b> (<a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a> &gt; <a class="macro" href="#1723" title="16" data-ref="_M/DO_PAGES_STAT_CHUNK_NR">DO_PAGES_STAT_CHUNK_NR</a>)</td></tr>
<tr><th id="1732">1732</th><td>			<a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a> = <a class="macro" href="#1723" title="16" data-ref="_M/DO_PAGES_STAT_CHUNK_NR">DO_PAGES_STAT_CHUNK_NR</a>;</td></tr>
<tr><th id="1733">1733</th><td></td></tr>
<tr><th id="1734">1734</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/uaccess.h.html#copy_from_user" title='copy_from_user' data-ref="copy_from_user" data-ref-filename="copy_from_user">copy_from_user</a>(<a class="local col5 ref" href="#295chunk_pages" title='chunk_pages' data-ref="295chunk_pages" data-ref-filename="295chunk_pages">chunk_pages</a>, <a class="local col3 ref" href="#293pages" title='pages' data-ref="293pages" data-ref-filename="293pages">pages</a>, <a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a> * <b>sizeof</b>(*<a class="local col5 ref" href="#295chunk_pages" title='chunk_pages' data-ref="295chunk_pages" data-ref-filename="295chunk_pages">chunk_pages</a>)))</td></tr>
<tr><th id="1735">1735</th><td>			<b>break</b>;</td></tr>
<tr><th id="1736">1736</th><td></td></tr>
<tr><th id="1737">1737</th><td>		<a class="tu ref fn" href="#do_pages_stat_array" title='do_pages_stat_array' data-use='c' data-ref="do_pages_stat_array" data-ref-filename="do_pages_stat_array">do_pages_stat_array</a>(<a class="local col1 ref" href="#291mm" title='mm' data-ref="291mm" data-ref-filename="291mm">mm</a>, <a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a>, <a class="local col5 ref" href="#295chunk_pages" title='chunk_pages' data-ref="295chunk_pages" data-ref-filename="295chunk_pages">chunk_pages</a>, <a class="local col6 ref" href="#296chunk_status" title='chunk_status' data-ref="296chunk_status" data-ref-filename="296chunk_status">chunk_status</a>);</td></tr>
<tr><th id="1738">1738</th><td></td></tr>
<tr><th id="1739">1739</th><td>		<b>if</b> (<a class="ref fn" href="../include/linux/uaccess.h.html#copy_to_user" title='copy_to_user' data-ref="copy_to_user" data-ref-filename="copy_to_user">copy_to_user</a>(<a class="local col4 ref" href="#294status" title='status' data-ref="294status" data-ref-filename="294status">status</a>, <a class="local col6 ref" href="#296chunk_status" title='chunk_status' data-ref="296chunk_status" data-ref-filename="296chunk_status">chunk_status</a>, <a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a> * <b>sizeof</b>(*<a class="local col4 ref" href="#294status" title='status' data-ref="294status" data-ref-filename="294status">status</a>)))</td></tr>
<tr><th id="1740">1740</th><td>			<b>break</b>;</td></tr>
<tr><th id="1741">1741</th><td></td></tr>
<tr><th id="1742">1742</th><td>		<a class="local col3 ref" href="#293pages" title='pages' data-ref="293pages" data-ref-filename="293pages">pages</a> += <a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a>;</td></tr>
<tr><th id="1743">1743</th><td>		<a class="local col4 ref" href="#294status" title='status' data-ref="294status" data-ref-filename="294status">status</a> += <a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a>;</td></tr>
<tr><th id="1744">1744</th><td>		<a class="local col2 ref" href="#292nr_pages" title='nr_pages' data-ref="292nr_pages" data-ref-filename="292nr_pages">nr_pages</a> -= <a class="local col7 ref" href="#297chunk_nr" title='chunk_nr' data-ref="297chunk_nr" data-ref-filename="297chunk_nr">chunk_nr</a>;</td></tr>
<tr><th id="1745">1745</th><td>	}</td></tr>
<tr><th id="1746">1746</th><td>	<b>return</b> <a class="local col2 ref" href="#292nr_pages" title='nr_pages' data-ref="292nr_pages" data-ref-filename="292nr_pages">nr_pages</a> ? -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#18" title="14" data-ref="_M/EFAULT">EFAULT</a> : <var>0</var>;</td></tr>
<tr><th id="1747">1747</th><td>}</td></tr>
<tr><th id="1748">1748</th><td></td></tr>
<tr><th id="1749">1749</th><td><i  data-doc="kernel_move_pages">/*</i></td></tr>
<tr><th id="1750">1750</th><td><i  data-doc="kernel_move_pages"> * Move a list of pages in the address space of the currently executing</i></td></tr>
<tr><th id="1751">1751</th><td><i  data-doc="kernel_move_pages"> * process.</i></td></tr>
<tr><th id="1752">1752</th><td><i  data-doc="kernel_move_pages"> */</i></td></tr>
<tr><th id="1753">1753</th><td><em>static</em> <em>int</em> <dfn class="tu decl def fn" id="kernel_move_pages" title='kernel_move_pages' data-type='int kernel_move_pages(pid_t pid, unsigned long nr_pages, const void ** pages, const int * nodes, int * status, int flags)' data-ref="kernel_move_pages" data-ref-filename="kernel_move_pages">kernel_move_pages</dfn>(<a class="typedef" href="../include/linux/types.h.html#pid_t" title='pid_t' data-type='__kernel_pid_t' data-ref="pid_t" data-ref-filename="pid_t">pid_t</a> <dfn class="local col8 decl" id="298pid" title='pid' data-type='pid_t' data-ref="298pid" data-ref-filename="298pid">pid</dfn>, <em>unsigned</em> <em>long</em> <dfn class="local col9 decl" id="299nr_pages" title='nr_pages' data-type='unsigned long' data-ref="299nr_pages" data-ref-filename="299nr_pages">nr_pages</dfn>,</td></tr>
<tr><th id="1754">1754</th><td>			     <em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> * <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col0 decl" id="300pages" title='pages' data-type='const void **' data-ref="300pages" data-ref-filename="300pages">pages</dfn>,</td></tr>
<tr><th id="1755">1755</th><td>			     <em>const</em> <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col1 decl" id="301nodes" title='nodes' data-type='const int *' data-ref="301nodes" data-ref-filename="301nodes">nodes</dfn>,</td></tr>
<tr><th id="1756">1756</th><td>			     <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col2 decl" id="302status" title='status' data-type='int *' data-ref="302status" data-ref-filename="302status">status</dfn>, <em>int</em> <dfn class="local col3 decl" id="303flags" title='flags' data-type='int' data-ref="303flags" data-ref-filename="303flags">flags</dfn>)</td></tr>
<tr><th id="1757">1757</th><td>{</td></tr>
<tr><th id="1758">1758</th><td>	<b>struct</b> <a class="type" href="../include/linux/sched.h.html#task_struct" title='task_struct' data-ref="task_struct" data-ref-filename="task_struct">task_struct</a> *<dfn class="local col4 decl" id="304task" title='task' data-type='struct task_struct *' data-ref="304task" data-ref-filename="304task">task</dfn>;</td></tr>
<tr><th id="1759">1759</th><td>	<b>struct</b> <a class="type" href="../include/linux/mm_types.h.html#mm_struct" title='mm_struct' data-ref="mm_struct" data-ref-filename="mm_struct">mm_struct</a> *<dfn class="local col5 decl" id="305mm" title='mm' data-type='struct mm_struct *' data-ref="305mm" data-ref-filename="305mm">mm</dfn>;</td></tr>
<tr><th id="1760">1760</th><td>	<em>int</em> <dfn class="local col6 decl" id="306err" title='err' data-type='int' data-ref="306err" data-ref-filename="306err">err</dfn>;</td></tr>
<tr><th id="1761">1761</th><td>	<a class="typedef" href="../include/linux/nodemask.h.html#nodemask_t" title='nodemask_t' data-type='struct nodemask_t' data-ref="nodemask_t" data-ref-filename="nodemask_t">nodemask_t</a> <dfn class="local col7 decl" id="307task_nodes" title='task_nodes' data-type='nodemask_t' data-ref="307task_nodes" data-ref-filename="307task_nodes">task_nodes</dfn>;</td></tr>
<tr><th id="1762">1762</th><td></td></tr>
<tr><th id="1763">1763</th><td>	<i>/* Check flags */</i></td></tr>
<tr><th id="1764">1764</th><td>	<b>if</b> (<a class="local col3 ref" href="#303flags" title='flags' data-ref="303flags" data-ref-filename="303flags">flags</a> &amp; ~(<a class="macro" href="../include/uapi/linux/mempolicy.h.html#45" title="(1&lt;&lt;1)" data-ref="_M/MPOL_MF_MOVE">MPOL_MF_MOVE</a>|<a class="macro" href="../include/uapi/linux/mempolicy.h.html#47" title="(1&lt;&lt;2)" data-ref="_M/MPOL_MF_MOVE_ALL">MPOL_MF_MOVE_ALL</a>))</td></tr>
<tr><th id="1765">1765</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#26" title="22" data-ref="_M/EINVAL">EINVAL</a>;</td></tr>
<tr><th id="1766">1766</th><td></td></tr>
<tr><th id="1767">1767</th><td>	<b>if</b> ((<a class="local col3 ref" href="#303flags" title='flags' data-ref="303flags" data-ref-filename="303flags">flags</a> &amp; <a class="macro" href="../include/uapi/linux/mempolicy.h.html#47" title="(1&lt;&lt;2)" data-ref="_M/MPOL_MF_MOVE_ALL">MPOL_MF_MOVE_ALL</a>) &amp;&amp; !<a class="ref fn" href="../include/linux/capability.h.html#capable" title='capable' data-ref="capable" data-ref-filename="capable">capable</a>(<a class="macro" href="../include/uapi/linux/capability.h.html#291" title="23" data-ref="_M/CAP_SYS_NICE">CAP_SYS_NICE</a>))</td></tr>
<tr><th id="1768">1768</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#5" title="1" data-ref="_M/EPERM">EPERM</a>;</td></tr>
<tr><th id="1769">1769</th><td></td></tr>
<tr><th id="1770">1770</th><td>	<i>/* Find the mm_struct */</i></td></tr>
<tr><th id="1771">1771</th><td>	<a class="ref fn" href="../include/linux/rcupdate.h.html#rcu_read_lock" title='rcu_read_lock' data-ref="rcu_read_lock" data-ref-filename="rcu_read_lock">rcu_read_lock</a>();</td></tr>
<tr><th id="1772">1772</th><td>	<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a> = <a class="local col8 ref" href="#298pid" title='pid' data-ref="298pid" data-ref-filename="298pid">pid</a> ? <a class="ref fn" href="../include/linux/sched.h.html#find_task_by_vpid" title='find_task_by_vpid' data-ref="find_task_by_vpid" data-ref-filename="find_task_by_vpid">find_task_by_vpid</a>(<a class="local col8 ref" href="#298pid" title='pid' data-ref="298pid" data-ref-filename="298pid">pid</a>) : <a class="macro" href="../arch/x86/include/asm/current.h.html#18" title="get_current()" data-ref="_M/current">current</a>;</td></tr>
<tr><th id="1773">1773</th><td>	<b>if</b> (!<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>) {</td></tr>
<tr><th id="1774">1774</th><td>		<a class="ref fn" href="../include/linux/rcupdate.h.html#rcu_read_unlock" title='rcu_read_unlock' data-ref="rcu_read_unlock" data-ref-filename="rcu_read_unlock">rcu_read_unlock</a>();</td></tr>
<tr><th id="1775">1775</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#7" title="3" data-ref="_M/ESRCH">ESRCH</a>;</td></tr>
<tr><th id="1776">1776</th><td>	}</td></tr>
<tr><th id="1777">1777</th><td>	<a class="macro" href="../include/linux/sched/task.h.html#108" title="do { refcount_inc(&amp;(task)-&gt;usage); } while(0)" data-ref="_M/get_task_struct">get_task_struct</a>(<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>);</td></tr>
<tr><th id="1778">1778</th><td></td></tr>
<tr><th id="1779">1779</th><td>	<i>/*</i></td></tr>
<tr><th id="1780">1780</th><td><i>	 * Check if this process has the right to modify the specified</i></td></tr>
<tr><th id="1781">1781</th><td><i>	 * process. Use the regular "ptrace_may_access()" checks.</i></td></tr>
<tr><th id="1782">1782</th><td><i>	 */</i></td></tr>
<tr><th id="1783">1783</th><td>	<b>if</b> (!<a class="ref fn" href="../include/linux/ptrace.h.html#ptrace_may_access" title='ptrace_may_access' data-ref="ptrace_may_access" data-ref-filename="ptrace_may_access">ptrace_may_access</a>(<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>, <a class="macro" href="../include/linux/ptrace.h.html#77" title="(0x01 | 0x10)" data-ref="_M/PTRACE_MODE_READ_REALCREDS">PTRACE_MODE_READ_REALCREDS</a>)) {</td></tr>
<tr><th id="1784">1784</th><td>		<a class="ref fn" href="../include/linux/rcupdate.h.html#rcu_read_unlock" title='rcu_read_unlock' data-ref="rcu_read_unlock" data-ref-filename="rcu_read_unlock">rcu_read_unlock</a>();</td></tr>
<tr><th id="1785">1785</th><td>		<a class="local col6 ref" href="#306err" title='err' data-ref="306err" data-ref-filename="306err">err</a> = -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#5" title="1" data-ref="_M/EPERM">EPERM</a>;</td></tr>
<tr><th id="1786">1786</th><td>		<b>goto</b> <a class="lbl" href="#308out" data-ref="308out" data-ref-filename="308out">out</a>;</td></tr>
<tr><th id="1787">1787</th><td>	}</td></tr>
<tr><th id="1788">1788</th><td>	<a class="ref fn" href="../include/linux/rcupdate.h.html#rcu_read_unlock" title='rcu_read_unlock' data-ref="rcu_read_unlock" data-ref-filename="rcu_read_unlock">rcu_read_unlock</a>();</td></tr>
<tr><th id="1789">1789</th><td></td></tr>
<tr><th id="1790">1790</th><td> 	<a class="local col6 ref" href="#306err" title='err' data-ref="306err" data-ref-filename="306err">err</a> = <a class="ref fn" href="../include/linux/security.h.html#security_task_movememory" title='security_task_movememory' data-ref="security_task_movememory" data-ref-filename="security_task_movememory">security_task_movememory</a>(<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>);</td></tr>
<tr><th id="1791">1791</th><td> 	<b>if</b> (<a class="local col6 ref" href="#306err" title='err' data-ref="306err" data-ref-filename="306err">err</a>)</td></tr>
<tr><th id="1792">1792</th><td>		<b>goto</b> <a class="lbl" href="#308out" data-ref="308out" data-ref-filename="308out">out</a>;</td></tr>
<tr><th id="1793">1793</th><td></td></tr>
<tr><th id="1794">1794</th><td>	<a class="local col7 ref" href="#307task_nodes" title='task_nodes' data-ref="307task_nodes" data-ref-filename="307task_nodes">task_nodes</a> = <a class="ref fn" href="../include/linux/cpuset.h.html#cpuset_mems_allowed" title='cpuset_mems_allowed' data-ref="cpuset_mems_allowed" data-ref-filename="cpuset_mems_allowed">cpuset_mems_allowed</a>(<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>);</td></tr>
<tr><th id="1795">1795</th><td>	<a class="local col5 ref" href="#305mm" title='mm' data-ref="305mm" data-ref-filename="305mm">mm</a> = <a class="ref fn" href="../include/linux/sched/mm.h.html#get_task_mm" title='get_task_mm' data-ref="get_task_mm" data-ref-filename="get_task_mm">get_task_mm</a>(<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>);</td></tr>
<tr><th id="1796">1796</th><td>	<a class="ref fn" href="../include/linux/sched/task.h.html#put_task_struct" title='put_task_struct' data-ref="put_task_struct" data-ref-filename="put_task_struct">put_task_struct</a>(<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>);</td></tr>
<tr><th id="1797">1797</th><td></td></tr>
<tr><th id="1798">1798</th><td>	<b>if</b> (!<a class="local col5 ref" href="#305mm" title='mm' data-ref="305mm" data-ref-filename="305mm">mm</a>)</td></tr>
<tr><th id="1799">1799</th><td>		<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#26" title="22" data-ref="_M/EINVAL">EINVAL</a>;</td></tr>
<tr><th id="1800">1800</th><td></td></tr>
<tr><th id="1801">1801</th><td>	<b>if</b> (<a class="local col1 ref" href="#301nodes" title='nodes' data-ref="301nodes" data-ref-filename="301nodes">nodes</a>)</td></tr>
<tr><th id="1802">1802</th><td>		<a class="local col6 ref" href="#306err" title='err' data-ref="306err" data-ref-filename="306err">err</a> = <a class="tu ref fn" href="#do_pages_move" title='do_pages_move' data-use='c' data-ref="do_pages_move" data-ref-filename="do_pages_move">do_pages_move</a>(<a class="local col5 ref" href="#305mm" title='mm' data-ref="305mm" data-ref-filename="305mm">mm</a>, <a class="local col7 ref" href="#307task_nodes" title='task_nodes' data-ref="307task_nodes" data-ref-filename="307task_nodes">task_nodes</a>, <a class="local col9 ref" href="#299nr_pages" title='nr_pages' data-ref="299nr_pages" data-ref-filename="299nr_pages">nr_pages</a>, <a class="local col0 ref" href="#300pages" title='pages' data-ref="300pages" data-ref-filename="300pages">pages</a>,</td></tr>
<tr><th id="1803">1803</th><td>				    <a class="local col1 ref" href="#301nodes" title='nodes' data-ref="301nodes" data-ref-filename="301nodes">nodes</a>, <a class="local col2 ref" href="#302status" title='status' data-ref="302status" data-ref-filename="302status">status</a>, <a class="local col3 ref" href="#303flags" title='flags' data-ref="303flags" data-ref-filename="303flags">flags</a>);</td></tr>
<tr><th id="1804">1804</th><td>	<b>else</b></td></tr>
<tr><th id="1805">1805</th><td>		<a class="local col6 ref" href="#306err" title='err' data-ref="306err" data-ref-filename="306err">err</a> = <a class="tu ref fn" href="#do_pages_stat" title='do_pages_stat' data-use='c' data-ref="do_pages_stat" data-ref-filename="do_pages_stat">do_pages_stat</a>(<a class="local col5 ref" href="#305mm" title='mm' data-ref="305mm" data-ref-filename="305mm">mm</a>, <a class="local col9 ref" href="#299nr_pages" title='nr_pages' data-ref="299nr_pages" data-ref-filename="299nr_pages">nr_pages</a>, <a class="local col0 ref" href="#300pages" title='pages' data-ref="300pages" data-ref-filename="300pages">pages</a>, <a class="local col2 ref" href="#302status" title='status' data-ref="302status" data-ref-filename="302status">status</a>);</td></tr>
<tr><th id="1806">1806</th><td></td></tr>
<tr><th id="1807">1807</th><td>	<a class="ref fn" href="../include/linux/sched/mm.h.html#mmput" title='mmput' data-ref="mmput" data-ref-filename="mmput">mmput</a>(<a class="local col5 ref" href="#305mm" title='mm' data-ref="305mm" data-ref-filename="305mm">mm</a>);</td></tr>
<tr><th id="1808">1808</th><td>	<b>return</b> <a class="local col6 ref" href="#306err" title='err' data-ref="306err" data-ref-filename="306err">err</a>;</td></tr>
<tr><th id="1809">1809</th><td></td></tr>
<tr><th id="1810">1810</th><td><dfn class="lbl" id="308out" data-ref="308out" data-ref-filename="308out">out</dfn>:</td></tr>
<tr><th id="1811">1811</th><td>	<a class="ref fn" href="../include/linux/sched/task.h.html#put_task_struct" title='put_task_struct' data-ref="put_task_struct" data-ref-filename="put_task_struct">put_task_struct</a>(<a class="local col4 ref" href="#304task" title='task' data-ref="304task" data-ref-filename="304task">task</a>);</td></tr>
<tr><th id="1812">1812</th><td>	<b>return</b> <a class="local col6 ref" href="#306err" title='err' data-ref="306err" data-ref-filename="306err">err</a>;</td></tr>
<tr><th id="1813">1813</th><td>}</td></tr>
<tr><th id="1814">1814</th><td></td></tr>
<tr><th id="1815">1815</th><td><a class="macro" href="../include/linux/syscalls.h.html#219" title=" long __x64_sys_move_pages(const struct pt_regs *regs); static struct error_injection_entry __attribute__((__used__)) __attribute__((__section__(&quot;_error_injection_whitelist&quot;))) _eil_addr___x64_sys_move_pages = { .addr = (unsigned long)__x64_sys_move_pages, .etype = EI_ETYPE_ERRNO, };; static long __se_sys_move_pages(__typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( pid_t)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( pid_t)0), typeof(0ULL))), 0LL, 0L)) pid, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( unsigned long)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( unsigned long)0), typeof(0ULL))), 0LL, 0L)) nr_pages, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( const void * *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const void * *)0), typeof(0ULL))), 0LL, 0L)) pages, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( const int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const int *)0), typeof(0ULL))), 0LL, 0L)) nodes, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int *)0), typeof(0ULL))), 0LL, 0L)) status, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int)0), typeof(0ULL))), 0LL, 0L)) flags); static inline __attribute__((__gnu_inline__)) __attribute__((__unused__)) __attribute__((no_instrument_function)) long __do_sys_move_pages(pid_t pid, unsigned long nr_pages, const void * * pages, const int * nodes, int * status, int flags); long __x64_sys_move_pages(const struct pt_regs *regs) { return __se_sys_move_pages(regs-&gt;di, regs-&gt;si, regs-&gt;dx, regs-&gt;r10, regs-&gt;r8, regs-&gt;r9); } long __ia32_sys_move_pages(const struct pt_regs *regs); static struct error_injection_entry __attribute__((__used__)) __attribute__((__section__(&quot;_error_injection_whitelist&quot;))) _eil_addr___ia32_sys_move_pages = { .addr = (unsigned long)__ia32_sys_move_pages, .etype = EI_ETYPE_ERRNO, };; long __ia32_sys_move_pages(const struct pt_regs *regs) { return __se_sys_move_pages((unsigned int)regs-&gt;bx, (unsigned int)regs-&gt;cx, (unsigned int)regs-&gt;dx, (unsigned int)regs-&gt;si, (unsigned int)regs-&gt;di, (unsigned int)regs-&gt;bp); } static long __se_sys_move_pages(__typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( pid_t)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( pid_t)0), typeof(0ULL))), 0LL, 0L)) pid, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( unsigned long)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( unsigned long)0), typeof(0ULL))), 0LL, 0L)) nr_pages, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( const void * *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const void * *)0), typeof(0ULL))), 0LL, 0L)) pages, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( const int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const int *)0), typeof(0ULL))), 0LL, 0L)) nodes, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int *)0), typeof(0ULL))), 0LL, 0L)) status, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int)0), typeof(0ULL))), 0LL, 0L)) flags) { long ret = __do_sys_move_pages(( pid_t) pid, ( unsigned long) nr_pages, ( const void * *) pages, ( const int *) nodes, ( int *) status, ( int) flags); (void)(sizeof(struct { int:(-!!(!(__builtin_types_compatible_p(typeof(( pid_t)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( pid_t)0), typeof(0ULL))) &amp;&amp; sizeof(pid_t) &gt; sizeof(long))); })), (void)(sizeof(struct { int:(-!!(!(__builtin_types_compatible_p(typeof(( unsigned long)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( unsigned long)0), typeof(0ULL))) &amp;&amp; sizeof(unsigned long) &gt; sizeof(long))); })), (void)(sizeof(struct { int:(-!!(!(__builtin_types_compatible_p(typeof(( const void * *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const void * *)0), typeof(0ULL))) &amp;&amp; sizeof(const void * *) &gt; sizeof(long))); })), (void)(sizeof(struct { int:(-!!(!(__builtin_types_compatible_p(typeof(( const int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const int *)0), typeof(0ULL))) &amp;&amp; sizeof(const int *) &gt; sizeof(long))); })), (void)(sizeof(struct { int:(-!!(!(__builtin_types_compatible_p(typeof(( int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int *)0), typeof(0ULL))) &amp;&amp; sizeof(int *) &gt; sizeof(long))); })), (void)(sizeof(struct { int:(-!!(!(__builtin_types_compatible_p(typeof(( int)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int)0), typeof(0ULL))) &amp;&amp; sizeof(int) &gt; sizeof(long))); })); do { } while (0); return ret; } static inline __attribute__((__gnu_inline__)) __attribute__((__unused__)) __attribute__((no_instrument_function)) long __do_sys_move_pages(pid_t pid, unsigned long nr_pages, const void * * pages, const int * nodes, int * status, int flags)" data-ref="_M/SYSCALL_DEFINE6">SYSCALL_DEFINE6</a>(move_pages, <a class="typedef" href="../include/linux/types.h.html#pid_t" title='pid_t' data-type='__kernel_pid_t' data-ref="pid_t" data-ref-filename="pid_t">pid_t</a>, <dfn class="local col9 decl" id="309pid" title='pid' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((pid_t)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((pid_t)0), typeof (0ULL))), 0LL, 0L))' data-ref="309pid" data-ref-filename="309pid"><dfn class="local col5 decl" id="315pid" title='pid' data-type='pid_t' data-ref="315pid" data-ref-filename="315pid"><dfn class="local col1 decl" id="321pid" title='pid' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((pid_t)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((pid_t)0), typeof (0ULL))), 0LL, 0L))' data-ref="321pid" data-ref-filename="321pid"><a class="local col1 ref" href="#1815" title='pid' data-ref="321pid" data-ref-filename="321pid"><dfn class="local col7 decl" id="327pid" title='pid' data-type='pid_t' data-ref="327pid" data-ref-filename="327pid">pid</dfn></a></dfn></dfn></dfn>, <em>unsigned</em> <em>long</em>, <dfn class="local col0 decl" id="310nr_pages" title='nr_pages' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((unsigned long)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((unsigned long)0), typeof (0ULL))), 0LL, 0L))' data-ref="310nr_pages" data-ref-filename="310nr_pages"><dfn class="local col6 decl" id="316nr_pages" title='nr_pages' data-type='unsigned long' data-ref="316nr_pages" data-ref-filename="316nr_pages"><dfn class="local col2 decl" id="322nr_pages" title='nr_pages' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((unsigned long)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((unsigned long)0), typeof (0ULL))), 0LL, 0L))' data-ref="322nr_pages" data-ref-filename="322nr_pages"><a class="local col2 ref" href="#1815" title='nr_pages' data-ref="322nr_pages" data-ref-filename="322nr_pages"><dfn class="local col8 decl" id="328nr_pages" title='nr_pages' data-type='unsigned long' data-ref="328nr_pages" data-ref-filename="328nr_pages">nr_pages</dfn></a></dfn></dfn></dfn>,</td></tr>
<tr><th id="1816">1816</th><td>		<em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> * <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *, <dfn class="local col1 decl" id="311pages" title='pages' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((const void **)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((const void **)0), typeof (0ULL))), 0LL, 0L))' data-ref="311pages" data-ref-filename="311pages"><dfn class="local col7 decl" id="317pages" title='pages' data-type='const void **' data-ref="317pages" data-ref-filename="317pages"><dfn class="local col3 decl" id="323pages" title='pages' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((const void **)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((const void **)0), typeof (0ULL))), 0LL, 0L))' data-ref="323pages" data-ref-filename="323pages"><a class="local col3 ref" href="#1815" title='pages' data-ref="323pages" data-ref-filename="323pages"><dfn class="local col9 decl" id="329pages" title='pages' data-type='const void **' data-ref="329pages" data-ref-filename="329pages">pages</dfn></a></dfn></dfn></dfn>,</td></tr>
<tr><th id="1817">1817</th><td>		<em>const</em> <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *, <dfn class="local col2 decl" id="312nodes" title='nodes' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((const int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((const int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="312nodes" data-ref-filename="312nodes"><dfn class="local col8 decl" id="318nodes" title='nodes' data-type='const int *' data-ref="318nodes" data-ref-filename="318nodes"><dfn class="local col4 decl" id="324nodes" title='nodes' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((const int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((const int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="324nodes" data-ref-filename="324nodes"><a class="local col4 ref" href="#1815" title='nodes' data-ref="324nodes" data-ref-filename="324nodes"><dfn class="local col0 decl" id="330nodes" title='nodes' data-type='const int *' data-ref="330nodes" data-ref-filename="330nodes">nodes</dfn></a></dfn></dfn></dfn>,</td></tr>
<tr><th id="1818">1818</th><td>		<em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *, <dfn class="local col3 decl" id="313status" title='status' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="313status" data-ref-filename="313status"><dfn class="local col9 decl" id="319status" title='status' data-type='int *' data-ref="319status" data-ref-filename="319status"><dfn class="local col5 decl" id="325status" title='status' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="325status" data-ref-filename="325status"><a class="local col5 ref" href="#1815" title='status' data-ref="325status" data-ref-filename="325status"><dfn class="local col1 decl" id="331status" title='status' data-type='int *' data-ref="331status" data-ref-filename="331status">status</dfn></a></dfn></dfn></dfn>, <em>int</em>, <dfn class="local col4 decl" id="314flags" title='flags' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int)0), typeof (0ULL))), 0LL, 0L))' data-ref="314flags" data-ref-filename="314flags"><dfn class="local col0 decl" id="320flags" title='flags' data-type='int' data-ref="320flags" data-ref-filename="320flags"><dfn class="local col6 decl" id="326flags" title='flags' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int)0), typeof (0ULL))), 0LL, 0L))' data-ref="326flags" data-ref-filename="326flags"><a class="local col6 ref" href="#1815" title='flags' data-ref="326flags" data-ref-filename="326flags"><dfn class="local col2 decl" id="332flags" title='flags' data-type='int' data-ref="332flags" data-ref-filename="332flags">flags</dfn></a></dfn></dfn></dfn>)</td></tr>
<tr><th id="1819">1819</th><td>{</td></tr>
<tr><th id="1820">1820</th><td>	<b>return</b> <a class="tu ref fn" href="#kernel_move_pages" title='kernel_move_pages' data-use='c' data-ref="kernel_move_pages" data-ref-filename="kernel_move_pages">kernel_move_pages</a>(<a class="local col7 ref" href="#1815" title='pid' data-ref="327pid" data-ref-filename="327pid">pid</a>, <a class="local col8 ref" href="#1815" title='nr_pages' data-ref="328nr_pages" data-ref-filename="328nr_pages">nr_pages</a>, <a class="local col9 ref" href="#1815" title='pages' data-ref="329pages" data-ref-filename="329pages">pages</a>, <a class="local col0 ref" href="#1815" title='nodes' data-ref="330nodes" data-ref-filename="330nodes">nodes</a>, <a class="local col1 ref" href="#1815" title='status' data-ref="331status" data-ref-filename="331status">status</a>, <a class="local col2 ref" href="#1815" title='flags' data-ref="332flags" data-ref-filename="332flags">flags</a>);</td></tr>
<tr><th id="1821">1821</th><td>}</td></tr>
<tr><th id="1822">1822</th><td></td></tr>
<tr><th id="1823">1823</th><td><u>#<span data-ppcond="1823">ifdef</span> <a class="macro" href="../include/generated/autoconf.h.html#86" data-ref="_M/CONFIG_COMPAT">CONFIG_COMPAT</a></u></td></tr>
<tr><th id="1824">1824</th><td><a class="macro" href="../include/linux/compat.h.html#65" title="static long __se_compat_sys_move_pages(__typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( pid_t)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( pid_t)0), typeof(0ULL))), 0LL, 0L)) pid, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( compat_ulong_t)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( compat_ulong_t)0), typeof(0ULL))), 0LL, 0L)) nr_pages, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( compat_uptr_t *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( compat_uptr_t *)0), typeof(0ULL))), 0LL, 0L)) pages32, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( const int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const int *)0), typeof(0ULL))), 0LL, 0L)) nodes, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int *)0), typeof(0ULL))), 0LL, 0L)) status, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int)0), typeof(0ULL))), 0LL, 0L)) flags); static inline __attribute__((__gnu_inline__)) __attribute__((__unused__)) __attribute__((no_instrument_function)) long __do_compat_sys_move_pages(pid_t pid, compat_ulong_t nr_pages, compat_uptr_t * pages32, const int * nodes, int * status, int flags); long __ia32_compat_sys_move_pages(const struct pt_regs *regs); static struct error_injection_entry __attribute__((__used__)) __attribute__((__section__(&quot;_error_injection_whitelist&quot;))) _eil_addr___ia32_compat_sys_move_pages = { .addr = (unsigned long)__ia32_compat_sys_move_pages, .etype = EI_ETYPE_ERRNO, };; long __ia32_compat_sys_move_pages(const struct pt_regs *regs) { return __se_compat_sys_move_pages((unsigned int)regs-&gt;bx, (unsigned int)regs-&gt;cx, (unsigned int)regs-&gt;dx, (unsigned int)regs-&gt;si, (unsigned int)regs-&gt;di, (unsigned int)regs-&gt;bp); } static long __se_compat_sys_move_pages(__typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( pid_t)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( pid_t)0), typeof(0ULL))), 0LL, 0L)) pid, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( compat_ulong_t)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( compat_ulong_t)0), typeof(0ULL))), 0LL, 0L)) nr_pages, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( compat_uptr_t *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( compat_uptr_t *)0), typeof(0ULL))), 0LL, 0L)) pages32, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( const int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( const int *)0), typeof(0ULL))), 0LL, 0L)) nodes, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int *)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int *)0), typeof(0ULL))), 0LL, 0L)) status, __typeof(__builtin_choose_expr((__builtin_types_compatible_p(typeof(( int)0), typeof(0LL)) || __builtin_types_compatible_p(typeof(( int)0), typeof(0ULL))), 0LL, 0L)) flags) { return __do_compat_sys_move_pages((( pid_t)(unsigned long)(pid)), (( compat_ulong_t)(unsigned long)(nr_pages)), (( compat_uptr_t *)(unsigned long)(pages32)), (( const int *)(unsigned long)(nodes)), (( int *)(unsigned long)(status)), (( int)(unsigned long)(flags))); } static inline __attribute__((__gnu_inline__)) __attribute__((__unused__)) __attribute__((no_instrument_function)) long __do_compat_sys_move_pages(pid_t pid, compat_ulong_t nr_pages, compat_uptr_t * pages32, const int * nodes, int * status, int flags)" data-ref="_M/COMPAT_SYSCALL_DEFINE6">COMPAT_SYSCALL_DEFINE6</a>(move_pages, <a class="typedef" href="../include/linux/types.h.html#pid_t" title='pid_t' data-type='__kernel_pid_t' data-ref="pid_t" data-ref-filename="pid_t">pid_t</a>, <dfn class="local col3 decl" id="333pid" title='pid' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((pid_t)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((pid_t)0), typeof (0ULL))), 0LL, 0L))' data-ref="333pid" data-ref-filename="333pid"><dfn class="local col9 decl" id="339pid" title='pid' data-type='pid_t' data-ref="339pid" data-ref-filename="339pid"><dfn class="local col5 decl" id="345pid" title='pid' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((pid_t)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((pid_t)0), typeof (0ULL))), 0LL, 0L))' data-ref="345pid" data-ref-filename="345pid"><a class="local col5 ref" href="#1824" title='pid' data-ref="345pid" data-ref-filename="345pid"><dfn class="local col1 decl" id="351pid" title='pid' data-type='pid_t' data-ref="351pid" data-ref-filename="351pid">pid</dfn></a></dfn></dfn></dfn>, <a class="typedef" href="../include/asm-generic/compat.h.html#compat_ulong_t" title='compat_ulong_t' data-type='u32' data-ref="compat_ulong_t" data-ref-filename="compat_ulong_t">compat_ulong_t</a>, <dfn class="local col4 decl" id="334nr_pages" title='nr_pages' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((compat_ulong_t)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((compat_ulong_t)0), typeof (0ULL))), 0LL, 0L))' data-ref="334nr_pages" data-ref-filename="334nr_pages"><dfn class="local col0 decl" id="340nr_pages" title='nr_pages' data-type='compat_ulong_t' data-ref="340nr_pages" data-ref-filename="340nr_pages"><dfn class="local col6 decl" id="346nr_pages" title='nr_pages' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((compat_ulong_t)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((compat_ulong_t)0), typeof (0ULL))), 0LL, 0L))' data-ref="346nr_pages" data-ref-filename="346nr_pages"><a class="local col6 ref" href="#1824" title='nr_pages' data-ref="346nr_pages" data-ref-filename="346nr_pages"><dfn class="local col2 decl" id="352nr_pages" title='nr_pages' data-type='compat_ulong_t' data-ref="352nr_pages" data-ref-filename="352nr_pages">nr_pages</dfn></a></dfn></dfn></dfn>,</td></tr>
<tr><th id="1825">1825</th><td>		       <a class="typedef" href="../include/asm-generic/compat.h.html#compat_uptr_t" title='compat_uptr_t' data-type='u32' data-ref="compat_uptr_t" data-ref-filename="compat_uptr_t">compat_uptr_t</a> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *, <dfn class="local col5 decl" id="335pages32" title='pages32' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((compat_uptr_t *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((compat_uptr_t *)0), typeof (0ULL))), 0LL, 0L))' data-ref="335pages32" data-ref-filename="335pages32"><dfn class="local col1 decl" id="341pages32" title='pages32' data-type='compat_uptr_t *' data-ref="341pages32" data-ref-filename="341pages32"><dfn class="local col7 decl" id="347pages32" title='pages32' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((compat_uptr_t *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((compat_uptr_t *)0), typeof (0ULL))), 0LL, 0L))' data-ref="347pages32" data-ref-filename="347pages32"><a class="local col7 ref" href="#1824" title='pages32' data-ref="347pages32" data-ref-filename="347pages32"><dfn class="local col3 decl" id="353pages32" title='pages32' data-type='compat_uptr_t *' data-ref="353pages32" data-ref-filename="353pages32">pages32</dfn></a></dfn></dfn></dfn>,</td></tr>
<tr><th id="1826">1826</th><td>		       <em>const</em> <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *, <dfn class="local col6 decl" id="336nodes" title='nodes' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((const int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((const int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="336nodes" data-ref-filename="336nodes"><dfn class="local col2 decl" id="342nodes" title='nodes' data-type='const int *' data-ref="342nodes" data-ref-filename="342nodes"><dfn class="local col8 decl" id="348nodes" title='nodes' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((const int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((const int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="348nodes" data-ref-filename="348nodes"><a class="local col8 ref" href="#1824" title='nodes' data-ref="348nodes" data-ref-filename="348nodes"><dfn class="local col4 decl" id="354nodes" title='nodes' data-type='const int *' data-ref="354nodes" data-ref-filename="354nodes">nodes</dfn></a></dfn></dfn></dfn>,</td></tr>
<tr><th id="1827">1827</th><td>		       <em>int</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *, <dfn class="local col7 decl" id="337status" title='status' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="337status" data-ref-filename="337status"><dfn class="local col3 decl" id="343status" title='status' data-type='int *' data-ref="343status" data-ref-filename="343status"><dfn class="local col9 decl" id="349status" title='status' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int *)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int *)0), typeof (0ULL))), 0LL, 0L))' data-ref="349status" data-ref-filename="349status"><a class="local col9 ref" href="#1824" title='status' data-ref="349status" data-ref-filename="349status"><dfn class="local col5 decl" id="355status" title='status' data-type='int *' data-ref="355status" data-ref-filename="355status">status</dfn></a></dfn></dfn></dfn>,</td></tr>
<tr><th id="1828">1828</th><td>		       <em>int</em>, <dfn class="local col8 decl" id="338flags" title='flags' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int)0), typeof (0ULL))), 0LL, 0L))' data-ref="338flags" data-ref-filename="338flags"><dfn class="local col4 decl" id="344flags" title='flags' data-type='int' data-ref="344flags" data-ref-filename="344flags"><dfn class="local col0 decl" id="350flags" title='flags' data-type='typeof (__builtin_choose_expr((__builtin_types_compatible_p(typeof ((int)0), typeof (0LL)) || __builtin_types_compatible_p(typeof ((int)0), typeof (0ULL))), 0LL, 0L))' data-ref="350flags" data-ref-filename="350flags"><a class="local col0 ref" href="#1824" title='flags' data-ref="350flags" data-ref-filename="350flags"><dfn class="local col6 decl" id="356flags" title='flags' data-type='int' data-ref="356flags" data-ref-filename="356flags">flags</dfn></a></dfn></dfn></dfn>)</td></tr>
<tr><th id="1829">1829</th><td>{</td></tr>
<tr><th id="1830">1830</th><td>	<em>const</em> <em>void</em> <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> * <a class="macro" href="../include/linux/compiler_types.h.html#30" title="" data-ref="_M/__user">__user</a> *<dfn class="local col7 decl" id="357pages" title='pages' data-type='const void **' data-ref="357pages" data-ref-filename="357pages">pages</dfn>;</td></tr>
<tr><th id="1831">1831</th><td>	<em>int</em> <dfn class="local col8 decl" id="358i" title='i' data-type='int' data-ref="358i" data-ref-filename="358i">i</dfn>;</td></tr>
<tr><th id="1832">1832</th><td></td></tr>
<tr><th id="1833">1833</th><td>	<a class="local col7 ref" href="#357pages" title='pages' data-ref="357pages" data-ref-filename="357pages">pages</a> = <a class="ref fn" href="../include/linux/compat.h.html#compat_alloc_user_space" title='compat_alloc_user_space' data-ref="compat_alloc_user_space" data-ref-filename="compat_alloc_user_space">compat_alloc_user_space</a>(<a class="local col2 ref" href="#1824" title='nr_pages' data-ref="352nr_pages" data-ref-filename="352nr_pages">nr_pages</a> * <b>sizeof</b>(<em>void</em> *));</td></tr>
<tr><th id="1834">1834</th><td>	<b>for</b> (<a class="local col8 ref" href="#358i" title='i' data-ref="358i" data-ref-filename="358i">i</a> = <var>0</var>; <a class="local col8 ref" href="#358i" title='i' data-ref="358i" data-ref-filename="358i">i</a> &lt; <a class="local col2 ref" href="#1824" title='nr_pages' data-ref="352nr_pages" data-ref-filename="352nr_pages">nr_pages</a>; <a class="local col8 ref" href="#358i" title='i' data-ref="358i" data-ref-filename="358i">i</a>++) {</td></tr>
<tr><th id="1835">1835</th><td>		<a class="typedef" href="../include/asm-generic/compat.h.html#compat_uptr_t" title='compat_uptr_t' data-type='u32' data-ref="compat_uptr_t" data-ref-filename="compat_uptr_t">compat_uptr_t</a> <dfn class="local col9 decl" id="359p" title='p' data-type='compat_uptr_t' data-ref="359p" data-ref-filename="359p">p</dfn>;</td></tr>
<tr><th id="1836">1836</th><td></td></tr>
<tr><th id="1837">1837</th><td>		<b>if</b> (<a class="macro" href="../arch/x86/include/asm/uaccess.h.html#166" title="({ int __ret_gu; register __typeof__(__builtin_choose_expr(sizeof(*(pages32 + i)) &gt; sizeof(0UL), 0ULL, 0UL)) __val_gu asm(&quot;%&quot;&quot;rdx&quot;); (void)0; might_fault(); asm volatile(&quot;call __get_user_%P4&quot; : &quot;=a&quot; (__ret_gu), &quot;=r&quot; (__val_gu), &quot;+r&quot; (current_stack_pointer) : &quot;0&quot; (pages32 + i), &quot;i&quot; (sizeof(*(pages32 + i)))); (p) = ( __typeof__(*(pages32 + i))) __val_gu; __builtin_expect(__ret_gu, 0); })" data-ref="_M/get_user">get_user</a>(<a class="local col9 ref" href="#359p" title='p' data-ref="359p" data-ref-filename="359p">p</a>, <a class="local col3 ref" href="#1824" title='pages32' data-ref="353pages32" data-ref-filename="353pages32">pages32</a> + <a class="local col8 ref" href="#358i" title='i' data-ref="358i" data-ref-filename="358i">i</a>) ||</td></tr>
<tr><th id="1838">1838</th><td>			<a class="macro" href="../arch/x86/include/asm/uaccess.h.html#244" title="({ int __ret_pu; __typeof__(*(pages + i)) __pu_val; (void)0; might_fault(); __pu_val = compat_ptr(p); switch (sizeof(*(pages + i))) { case 1: asm volatile(&quot;call __put_user_&quot; &quot;1&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(pages + i)))(__pu_val)), &quot;c&quot; (pages + i) : &quot;ebx&quot;); break; case 2: asm volatile(&quot;call __put_user_&quot; &quot;2&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(pages + i)))(__pu_val)), &quot;c&quot; (pages + i) : &quot;ebx&quot;); break; case 4: asm volatile(&quot;call __put_user_&quot; &quot;4&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(pages + i)))(__pu_val)), &quot;c&quot; (pages + i) : &quot;ebx&quot;); break; case 8: asm volatile(&quot;call __put_user_&quot; &quot;8&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(pages + i)))(__pu_val)), &quot;c&quot; (pages + i) : &quot;ebx&quot;); break; default: asm volatile(&quot;call __put_user_&quot; &quot;X&quot; : &quot;=a&quot; (__ret_pu) : &quot;0&quot; ((typeof(*(pages + i)))(__pu_val)), &quot;c&quot; (pages + i) : &quot;ebx&quot;); break; } __builtin_expect(__ret_pu, 0); })" data-ref="_M/put_user">put_user</a>(<a class="ref fn" href="../arch/x86/include/asm/compat.h.html#compat_ptr" title='compat_ptr' data-ref="compat_ptr" data-ref-filename="compat_ptr">compat_ptr</a>(<a class="local col9 ref" href="#359p" title='p' data-ref="359p" data-ref-filename="359p">p</a>), <a class="local col7 ref" href="#357pages" title='pages' data-ref="357pages" data-ref-filename="357pages">pages</a> + <a class="local col8 ref" href="#358i" title='i' data-ref="358i" data-ref-filename="358i">i</a>))</td></tr>
<tr><th id="1839">1839</th><td>			<b>return</b> -<a class="macro" href="../include/uapi/asm-generic/errno-base.h.html#18" title="14" data-ref="_M/EFAULT">EFAULT</a>;</td></tr>
<tr><th id="1840">1840</th><td>	}</td></tr>
<tr><th id="1841">1841</th><td>	<b>return</b> <a class="tu ref fn" href="#kernel_move_pages" title='kernel_move_pages' data-use='c' data-ref="kernel_move_pages" data-ref-filename="kernel_move_pages">kernel_move_pages</a>(<a class="local col1 ref" href="#1824" title='pid' data-ref="351pid" data-ref-filename="351pid">pid</a>, <a class="local col2 ref" href="#1824" title='nr_pages' data-ref="352nr_pages" data-ref-filename="352nr_pages">nr_pages</a>, <a class="local col7 ref" href="#357pages" title='pages' data-ref="357pages" data-ref-filename="357pages">pages</a>, <a class="local col4 ref" href="#1824" title='nodes' data-ref="354nodes" data-ref-filename="354nodes">nodes</a>, <a class="local col5 ref" href="#1824" title='status' data-ref="355status" data-ref-filename="355status">status</a>, <a class="local col6 ref" href="#1824" title='flags' data-ref="356flags" data-ref-filename="356flags">flags</a>);</td></tr>
<tr><th id="1842">1842</th><td>}</td></tr>
<tr><th id="1843">1843</th><td><u>#<span data-ppcond="1823">endif</span> /* CONFIG_COMPAT */</u></td></tr>
<tr><th id="1844">1844</th><td></td></tr>
<tr><th id="1845">1845</th><td><u>#<span data-ppcond="1845">ifdef</span> <span class="macro" data-ref="_M/CONFIG_NUMA_BALANCING">CONFIG_NUMA_BALANCING</span></u></td></tr>
<tr><th id="1846">1846</th><td><i>/*</i></td></tr>
<tr><th id="1847">1847</th><td><i> * Returns true if this is a safe migration target node for misplaced NUMA</i></td></tr>
<tr><th id="1848">1848</th><td><i> * pages. Currently it only checks the watermarks which crude</i></td></tr>
<tr><th id="1849">1849</th><td><i> */</i></td></tr>
<tr><th id="1850">1850</th><td><em>static</em> bool migrate_balanced_pgdat(<b>struct</b> pglist_data *pgdat,</td></tr>
<tr><th id="1851">1851</th><td>				   <em>unsigned</em> <em>long</em> nr_migrate_pages)</td></tr>
<tr><th id="1852">1852</th><td>{</td></tr>
<tr><th id="1853">1853</th><td>	<em>int</em> z;</td></tr>
<tr><th id="1854">1854</th><td></td></tr>
<tr><th id="1855">1855</th><td>	<b>for</b> (z = pgdat-&gt;nr_zones - <var>1</var>; z &gt;= <var>0</var>; z--) {</td></tr>
<tr><th id="1856">1856</th><td>		<b>struct</b> zone *zone = pgdat-&gt;node_zones + z;</td></tr>
<tr><th id="1857">1857</th><td></td></tr>
<tr><th id="1858">1858</th><td>		<b>if</b> (!populated_zone(zone))</td></tr>
<tr><th id="1859">1859</th><td>			<b>continue</b>;</td></tr>
<tr><th id="1860">1860</th><td></td></tr>
<tr><th id="1861">1861</th><td>		<i>/* Avoid waking kswapd by allocating pages_to_migrate pages. */</i></td></tr>
<tr><th id="1862">1862</th><td>		<b>if</b> (!zone_watermark_ok(zone, <var>0</var>,</td></tr>
<tr><th id="1863">1863</th><td>				       high_wmark_pages(zone) +</td></tr>
<tr><th id="1864">1864</th><td>				       nr_migrate_pages,</td></tr>
<tr><th id="1865">1865</th><td>				       <var>0</var>, <var>0</var>))</td></tr>
<tr><th id="1866">1866</th><td>			<b>continue</b>;</td></tr>
<tr><th id="1867">1867</th><td>		<b>return</b> true;</td></tr>
<tr><th id="1868">1868</th><td>	}</td></tr>
<tr><th id="1869">1869</th><td>	<b>return</b> false;</td></tr>
<tr><th id="1870">1870</th><td>}</td></tr>
<tr><th id="1871">1871</th><td></td></tr>
<tr><th id="1872">1872</th><td><em>static</em> <b>struct</b> page *alloc_misplaced_dst_page(<b>struct</b> page *page,</td></tr>
<tr><th id="1873">1873</th><td>					   <em>unsigned</em> <em>long</em> data)</td></tr>
<tr><th id="1874">1874</th><td>{</td></tr>
<tr><th id="1875">1875</th><td>	<em>int</em> nid = (<em>int</em>) data;</td></tr>
<tr><th id="1876">1876</th><td>	<b>struct</b> page *newpage;</td></tr>
<tr><th id="1877">1877</th><td></td></tr>
<tr><th id="1878">1878</th><td>	newpage = __alloc_pages_node(nid,</td></tr>
<tr><th id="1879">1879</th><td>					 (GFP_HIGHUSER_MOVABLE |</td></tr>
<tr><th id="1880">1880</th><td>					  __GFP_THISNODE | __GFP_NOMEMALLOC |</td></tr>
<tr><th id="1881">1881</th><td>					  __GFP_NORETRY | __GFP_NOWARN) &amp;</td></tr>
<tr><th id="1882">1882</th><td>					 ~__GFP_RECLAIM, <var>0</var>);</td></tr>
<tr><th id="1883">1883</th><td></td></tr>
<tr><th id="1884">1884</th><td>	<b>return</b> newpage;</td></tr>
<tr><th id="1885">1885</th><td>}</td></tr>
<tr><th id="1886">1886</th><td></td></tr>
<tr><th id="1887">1887</th><td><em>static</em> <em>int</em> numamigrate_isolate_page(pg_data_t *pgdat, <b>struct</b> page *page)</td></tr>
<tr><th id="1888">1888</th><td>{</td></tr>
<tr><th id="1889">1889</th><td>	<em>int</em> page_lru;</td></tr>
<tr><th id="1890">1890</th><td></td></tr>
<tr><th id="1891">1891</th><td>	VM_BUG_ON_PAGE(compound_order(page) &amp;&amp; !PageTransHuge(page), page);</td></tr>
<tr><th id="1892">1892</th><td></td></tr>
<tr><th id="1893">1893</th><td>	<i>/* Avoid migrating to a node that is nearly full */</i></td></tr>
<tr><th id="1894">1894</th><td>	<b>if</b> (!migrate_balanced_pgdat(pgdat, <var>1UL</var> &lt;&lt; compound_order(page)))</td></tr>
<tr><th id="1895">1895</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="1896">1896</th><td></td></tr>
<tr><th id="1897">1897</th><td>	<b>if</b> (isolate_lru_page(page))</td></tr>
<tr><th id="1898">1898</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="1899">1899</th><td></td></tr>
<tr><th id="1900">1900</th><td>	<i>/*</i></td></tr>
<tr><th id="1901">1901</th><td><i>	 * migrate_misplaced_transhuge_page() skips page migration's usual</i></td></tr>
<tr><th id="1902">1902</th><td><i>	 * check on page_count(), so we must do it here, now that the page</i></td></tr>
<tr><th id="1903">1903</th><td><i>	 * has been isolated: a GUP pin, or any other pin, prevents migration.</i></td></tr>
<tr><th id="1904">1904</th><td><i>	 * The expected page count is 3: 1 for page's mapcount and 1 for the</i></td></tr>
<tr><th id="1905">1905</th><td><i>	 * caller's pin and 1 for the reference taken by isolate_lru_page().</i></td></tr>
<tr><th id="1906">1906</th><td><i>	 */</i></td></tr>
<tr><th id="1907">1907</th><td>	<b>if</b> (PageTransHuge(page) &amp;&amp; page_count(page) != <var>3</var>) {</td></tr>
<tr><th id="1908">1908</th><td>		putback_lru_page(page);</td></tr>
<tr><th id="1909">1909</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="1910">1910</th><td>	}</td></tr>
<tr><th id="1911">1911</th><td></td></tr>
<tr><th id="1912">1912</th><td>	page_lru = page_is_file_cache(page);</td></tr>
<tr><th id="1913">1913</th><td>	mod_node_page_state(page_pgdat(page), NR_ISOLATED_ANON + page_lru,</td></tr>
<tr><th id="1914">1914</th><td>				hpage_nr_pages(page));</td></tr>
<tr><th id="1915">1915</th><td></td></tr>
<tr><th id="1916">1916</th><td>	<i>/*</i></td></tr>
<tr><th id="1917">1917</th><td><i>	 * Isolating the page has taken another reference, so the</i></td></tr>
<tr><th id="1918">1918</th><td><i>	 * caller's reference can be safely dropped without the page</i></td></tr>
<tr><th id="1919">1919</th><td><i>	 * disappearing underneath us during migration.</i></td></tr>
<tr><th id="1920">1920</th><td><i>	 */</i></td></tr>
<tr><th id="1921">1921</th><td>	put_page(page);</td></tr>
<tr><th id="1922">1922</th><td>	<b>return</b> <var>1</var>;</td></tr>
<tr><th id="1923">1923</th><td>}</td></tr>
<tr><th id="1924">1924</th><td></td></tr>
<tr><th id="1925">1925</th><td>bool pmd_trans_migrating(pmd_t pmd)</td></tr>
<tr><th id="1926">1926</th><td>{</td></tr>
<tr><th id="1927">1927</th><td>	<b>struct</b> page *page = pmd_page(pmd);</td></tr>
<tr><th id="1928">1928</th><td>	<b>return</b> PageLocked(page);</td></tr>
<tr><th id="1929">1929</th><td>}</td></tr>
<tr><th id="1930">1930</th><td></td></tr>
<tr><th id="1931">1931</th><td><i>/*</i></td></tr>
<tr><th id="1932">1932</th><td><i> * Attempt to migrate a misplaced page to the specified destination</i></td></tr>
<tr><th id="1933">1933</th><td><i> * node. Caller is expected to have an elevated reference count on</i></td></tr>
<tr><th id="1934">1934</th><td><i> * the page that will be dropped by this function before returning.</i></td></tr>
<tr><th id="1935">1935</th><td><i> */</i></td></tr>
<tr><th id="1936">1936</th><td><em>int</em> migrate_misplaced_page(<b>struct</b> page *page, <b>struct</b> vm_area_struct *vma,</td></tr>
<tr><th id="1937">1937</th><td>			   <em>int</em> node)</td></tr>
<tr><th id="1938">1938</th><td>{</td></tr>
<tr><th id="1939">1939</th><td>	pg_data_t *pgdat = NODE_DATA(node);</td></tr>
<tr><th id="1940">1940</th><td>	<em>int</em> isolated;</td></tr>
<tr><th id="1941">1941</th><td>	<em>int</em> nr_remaining;</td></tr>
<tr><th id="1942">1942</th><td>	LIST_HEAD(migratepages);</td></tr>
<tr><th id="1943">1943</th><td></td></tr>
<tr><th id="1944">1944</th><td>	<i>/*</i></td></tr>
<tr><th id="1945">1945</th><td><i>	 * Don't migrate file pages that are mapped in multiple processes</i></td></tr>
<tr><th id="1946">1946</th><td><i>	 * with execute permissions as they are probably shared libraries.</i></td></tr>
<tr><th id="1947">1947</th><td><i>	 */</i></td></tr>
<tr><th id="1948">1948</th><td>	<b>if</b> (page_mapcount(page) != <var>1</var> &amp;&amp; page_is_file_cache(page) &amp;&amp;</td></tr>
<tr><th id="1949">1949</th><td>	    (vma-&gt;vm_flags &amp; VM_EXEC))</td></tr>
<tr><th id="1950">1950</th><td>		<b>goto</b> out;</td></tr>
<tr><th id="1951">1951</th><td></td></tr>
<tr><th id="1952">1952</th><td>	<i>/*</i></td></tr>
<tr><th id="1953">1953</th><td><i>	 * Also do not migrate dirty pages as not all filesystems can move</i></td></tr>
<tr><th id="1954">1954</th><td><i>	 * dirty pages in MIGRATE_ASYNC mode which is a waste of cycles.</i></td></tr>
<tr><th id="1955">1955</th><td><i>	 */</i></td></tr>
<tr><th id="1956">1956</th><td>	<b>if</b> (page_is_file_cache(page) &amp;&amp; PageDirty(page))</td></tr>
<tr><th id="1957">1957</th><td>		<b>goto</b> out;</td></tr>
<tr><th id="1958">1958</th><td></td></tr>
<tr><th id="1959">1959</th><td>	isolated = numamigrate_isolate_page(pgdat, page);</td></tr>
<tr><th id="1960">1960</th><td>	<b>if</b> (!isolated)</td></tr>
<tr><th id="1961">1961</th><td>		<b>goto</b> out;</td></tr>
<tr><th id="1962">1962</th><td></td></tr>
<tr><th id="1963">1963</th><td>	list_add(&amp;page-&gt;lru, &amp;migratepages);</td></tr>
<tr><th id="1964">1964</th><td>	nr_remaining = migrate_pages(&amp;migratepages, alloc_misplaced_dst_page,</td></tr>
<tr><th id="1965">1965</th><td>				     NULL, node, MIGRATE_ASYNC,</td></tr>
<tr><th id="1966">1966</th><td>				     MR_NUMA_MISPLACED);</td></tr>
<tr><th id="1967">1967</th><td>	<b>if</b> (nr_remaining) {</td></tr>
<tr><th id="1968">1968</th><td>		<b>if</b> (!list_empty(&amp;migratepages)) {</td></tr>
<tr><th id="1969">1969</th><td>			list_del(&amp;page-&gt;lru);</td></tr>
<tr><th id="1970">1970</th><td>			dec_node_page_state(page, NR_ISOLATED_ANON +</td></tr>
<tr><th id="1971">1971</th><td>					page_is_file_cache(page));</td></tr>
<tr><th id="1972">1972</th><td>			putback_lru_page(page);</td></tr>
<tr><th id="1973">1973</th><td>		}</td></tr>
<tr><th id="1974">1974</th><td>		isolated = <var>0</var>;</td></tr>
<tr><th id="1975">1975</th><td>	} <b>else</b></td></tr>
<tr><th id="1976">1976</th><td>		count_vm_numa_event(NUMA_PAGE_MIGRATE);</td></tr>
<tr><th id="1977">1977</th><td>	BUG_ON(!list_empty(&amp;migratepages));</td></tr>
<tr><th id="1978">1978</th><td>	<b>return</b> isolated;</td></tr>
<tr><th id="1979">1979</th><td></td></tr>
<tr><th id="1980">1980</th><td>out:</td></tr>
<tr><th id="1981">1981</th><td>	put_page(page);</td></tr>
<tr><th id="1982">1982</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="1983">1983</th><td>}</td></tr>
<tr><th id="1984">1984</th><td><u>#<span data-ppcond="1845">endif</span> /* CONFIG_NUMA_BALANCING */</u></td></tr>
<tr><th id="1985">1985</th><td></td></tr>
<tr><th id="1986">1986</th><td><u>#<span data-ppcond="1986">if</span> defined(<span class="macro" data-ref="_M/CONFIG_NUMA_BALANCING">CONFIG_NUMA_BALANCING</span>) &amp;&amp; defined(<span class="macro" data-ref="_M/CONFIG_TRANSPARENT_HUGEPAGE">CONFIG_TRANSPARENT_HUGEPAGE</span>)</u></td></tr>
<tr><th id="1987">1987</th><td><i>/*</i></td></tr>
<tr><th id="1988">1988</th><td><i> * Migrates a THP to a given target node. page must be locked and is unlocked</i></td></tr>
<tr><th id="1989">1989</th><td><i> * before returning.</i></td></tr>
<tr><th id="1990">1990</th><td><i> */</i></td></tr>
<tr><th id="1991">1991</th><td><em>int</em> migrate_misplaced_transhuge_page(<b>struct</b> mm_struct *mm,</td></tr>
<tr><th id="1992">1992</th><td>				<b>struct</b> vm_area_struct *vma,</td></tr>
<tr><th id="1993">1993</th><td>				pmd_t *pmd, pmd_t entry,</td></tr>
<tr><th id="1994">1994</th><td>				<em>unsigned</em> <em>long</em> address,</td></tr>
<tr><th id="1995">1995</th><td>				<b>struct</b> page *page, <em>int</em> node)</td></tr>
<tr><th id="1996">1996</th><td>{</td></tr>
<tr><th id="1997">1997</th><td>	spinlock_t *ptl;</td></tr>
<tr><th id="1998">1998</th><td>	pg_data_t *pgdat = NODE_DATA(node);</td></tr>
<tr><th id="1999">1999</th><td>	<em>int</em> isolated = <var>0</var>;</td></tr>
<tr><th id="2000">2000</th><td>	<b>struct</b> page *new_page = NULL;</td></tr>
<tr><th id="2001">2001</th><td>	<em>int</em> page_lru = page_is_file_cache(page);</td></tr>
<tr><th id="2002">2002</th><td>	<em>unsigned</em> <em>long</em> start = address &amp; HPAGE_PMD_MASK;</td></tr>
<tr><th id="2003">2003</th><td></td></tr>
<tr><th id="2004">2004</th><td>	new_page = alloc_pages_node(node,</td></tr>
<tr><th id="2005">2005</th><td>		(GFP_TRANSHUGE_LIGHT | __GFP_THISNODE),</td></tr>
<tr><th id="2006">2006</th><td>		HPAGE_PMD_ORDER);</td></tr>
<tr><th id="2007">2007</th><td>	<b>if</b> (!new_page)</td></tr>
<tr><th id="2008">2008</th><td>		<b>goto</b> out_fail;</td></tr>
<tr><th id="2009">2009</th><td>	prep_transhuge_page(new_page);</td></tr>
<tr><th id="2010">2010</th><td></td></tr>
<tr><th id="2011">2011</th><td>	isolated = numamigrate_isolate_page(pgdat, page);</td></tr>
<tr><th id="2012">2012</th><td>	<b>if</b> (!isolated) {</td></tr>
<tr><th id="2013">2013</th><td>		put_page(new_page);</td></tr>
<tr><th id="2014">2014</th><td>		<b>goto</b> out_fail;</td></tr>
<tr><th id="2015">2015</th><td>	}</td></tr>
<tr><th id="2016">2016</th><td></td></tr>
<tr><th id="2017">2017</th><td>	<i>/* Prepare a page as a migration target */</i></td></tr>
<tr><th id="2018">2018</th><td>	__SetPageLocked(new_page);</td></tr>
<tr><th id="2019">2019</th><td>	<b>if</b> (PageSwapBacked(page))</td></tr>
<tr><th id="2020">2020</th><td>		__SetPageSwapBacked(new_page);</td></tr>
<tr><th id="2021">2021</th><td></td></tr>
<tr><th id="2022">2022</th><td>	<i>/* anon mapping, we can simply copy page-&gt;mapping to the new page: */</i></td></tr>
<tr><th id="2023">2023</th><td>	new_page-&gt;mapping = page-&gt;mapping;</td></tr>
<tr><th id="2024">2024</th><td>	new_page-&gt;index = page-&gt;index;</td></tr>
<tr><th id="2025">2025</th><td>	<i>/* flush the cache before copying using the kernel virtual address */</i></td></tr>
<tr><th id="2026">2026</th><td>	flush_cache_range(vma, start, start + HPAGE_PMD_SIZE);</td></tr>
<tr><th id="2027">2027</th><td>	migrate_page_copy(new_page, page);</td></tr>
<tr><th id="2028">2028</th><td>	WARN_ON(PageLRU(new_page));</td></tr>
<tr><th id="2029">2029</th><td></td></tr>
<tr><th id="2030">2030</th><td>	<i>/* Recheck the target PMD */</i></td></tr>
<tr><th id="2031">2031</th><td>	ptl = pmd_lock(mm, pmd);</td></tr>
<tr><th id="2032">2032</th><td>	<b>if</b> (unlikely(!pmd_same(*pmd, entry) || !page_ref_freeze(page, <var>2</var>))) {</td></tr>
<tr><th id="2033">2033</th><td>		spin_unlock(ptl);</td></tr>
<tr><th id="2034">2034</th><td></td></tr>
<tr><th id="2035">2035</th><td>		<i>/* Reverse changes made by migrate_page_copy() */</i></td></tr>
<tr><th id="2036">2036</th><td>		<b>if</b> (TestClearPageActive(new_page))</td></tr>
<tr><th id="2037">2037</th><td>			SetPageActive(page);</td></tr>
<tr><th id="2038">2038</th><td>		<b>if</b> (TestClearPageUnevictable(new_page))</td></tr>
<tr><th id="2039">2039</th><td>			SetPageUnevictable(page);</td></tr>
<tr><th id="2040">2040</th><td></td></tr>
<tr><th id="2041">2041</th><td>		unlock_page(new_page);</td></tr>
<tr><th id="2042">2042</th><td>		put_page(new_page);		<i>/* Free it */</i></td></tr>
<tr><th id="2043">2043</th><td></td></tr>
<tr><th id="2044">2044</th><td>		<i>/* Retake the callers reference and putback on LRU */</i></td></tr>
<tr><th id="2045">2045</th><td>		get_page(page);</td></tr>
<tr><th id="2046">2046</th><td>		putback_lru_page(page);</td></tr>
<tr><th id="2047">2047</th><td>		mod_node_page_state(page_pgdat(page),</td></tr>
<tr><th id="2048">2048</th><td>			 NR_ISOLATED_ANON + page_lru, -HPAGE_PMD_NR);</td></tr>
<tr><th id="2049">2049</th><td></td></tr>
<tr><th id="2050">2050</th><td>		<b>goto</b> out_unlock;</td></tr>
<tr><th id="2051">2051</th><td>	}</td></tr>
<tr><th id="2052">2052</th><td></td></tr>
<tr><th id="2053">2053</th><td>	entry = mk_huge_pmd(new_page, vma-&gt;vm_page_prot);</td></tr>
<tr><th id="2054">2054</th><td>	entry = maybe_pmd_mkwrite(pmd_mkdirty(entry), vma);</td></tr>
<tr><th id="2055">2055</th><td></td></tr>
<tr><th id="2056">2056</th><td>	<i>/*</i></td></tr>
<tr><th id="2057">2057</th><td><i>	 * Overwrite the old entry under pagetable lock and establish</i></td></tr>
<tr><th id="2058">2058</th><td><i>	 * the new PTE. Any parallel GUP will either observe the old</i></td></tr>
<tr><th id="2059">2059</th><td><i>	 * page blocking on the page lock, block on the page table</i></td></tr>
<tr><th id="2060">2060</th><td><i>	 * lock or observe the new page. The SetPageUptodate on the</i></td></tr>
<tr><th id="2061">2061</th><td><i>	 * new page and page_add_new_anon_rmap guarantee the copy is</i></td></tr>
<tr><th id="2062">2062</th><td><i>	 * visible before the pagetable update.</i></td></tr>
<tr><th id="2063">2063</th><td><i>	 */</i></td></tr>
<tr><th id="2064">2064</th><td>	page_add_anon_rmap(new_page, vma, start, true);</td></tr>
<tr><th id="2065">2065</th><td>	<i>/*</i></td></tr>
<tr><th id="2066">2066</th><td><i>	 * At this point the pmd is numa/protnone (i.e. non present) and the TLB</i></td></tr>
<tr><th id="2067">2067</th><td><i>	 * has already been flushed globally.  So no TLB can be currently</i></td></tr>
<tr><th id="2068">2068</th><td><i>	 * caching this non present pmd mapping.  There's no need to clear the</i></td></tr>
<tr><th id="2069">2069</th><td><i>	 * pmd before doing set_pmd_at(), nor to flush the TLB after</i></td></tr>
<tr><th id="2070">2070</th><td><i>	 * set_pmd_at().  Clearing the pmd here would introduce a race</i></td></tr>
<tr><th id="2071">2071</th><td><i>	 * condition against MADV_DONTNEED, because MADV_DONTNEED only holds the</i></td></tr>
<tr><th id="2072">2072</th><td><i>	 * mmap_sem for reading.  If the pmd is set to NULL at any given time,</i></td></tr>
<tr><th id="2073">2073</th><td><i>	 * MADV_DONTNEED won't wait on the pmd lock and it'll skip clearing this</i></td></tr>
<tr><th id="2074">2074</th><td><i>	 * pmd.</i></td></tr>
<tr><th id="2075">2075</th><td><i>	 */</i></td></tr>
<tr><th id="2076">2076</th><td>	set_pmd_at(mm, start, pmd, entry);</td></tr>
<tr><th id="2077">2077</th><td>	update_mmu_cache_pmd(vma, address, &amp;entry);</td></tr>
<tr><th id="2078">2078</th><td></td></tr>
<tr><th id="2079">2079</th><td>	page_ref_unfreeze(page, <var>2</var>);</td></tr>
<tr><th id="2080">2080</th><td>	mlock_migrate_page(new_page, page);</td></tr>
<tr><th id="2081">2081</th><td>	page_remove_rmap(page, true);</td></tr>
<tr><th id="2082">2082</th><td>	set_page_owner_migrate_reason(new_page, MR_NUMA_MISPLACED);</td></tr>
<tr><th id="2083">2083</th><td></td></tr>
<tr><th id="2084">2084</th><td>	spin_unlock(ptl);</td></tr>
<tr><th id="2085">2085</th><td></td></tr>
<tr><th id="2086">2086</th><td>	<i>/* Take an "isolate" reference and put new page on the LRU. */</i></td></tr>
<tr><th id="2087">2087</th><td>	get_page(new_page);</td></tr>
<tr><th id="2088">2088</th><td>	putback_lru_page(new_page);</td></tr>
<tr><th id="2089">2089</th><td></td></tr>
<tr><th id="2090">2090</th><td>	unlock_page(new_page);</td></tr>
<tr><th id="2091">2091</th><td>	unlock_page(page);</td></tr>
<tr><th id="2092">2092</th><td>	put_page(page);			<i>/* Drop the rmap reference */</i></td></tr>
<tr><th id="2093">2093</th><td>	put_page(page);			<i>/* Drop the LRU isolation reference */</i></td></tr>
<tr><th id="2094">2094</th><td></td></tr>
<tr><th id="2095">2095</th><td>	count_vm_events(PGMIGRATE_SUCCESS, HPAGE_PMD_NR);</td></tr>
<tr><th id="2096">2096</th><td>	count_vm_numa_events(NUMA_PAGE_MIGRATE, HPAGE_PMD_NR);</td></tr>
<tr><th id="2097">2097</th><td></td></tr>
<tr><th id="2098">2098</th><td>	mod_node_page_state(page_pgdat(page),</td></tr>
<tr><th id="2099">2099</th><td>			NR_ISOLATED_ANON + page_lru,</td></tr>
<tr><th id="2100">2100</th><td>			-HPAGE_PMD_NR);</td></tr>
<tr><th id="2101">2101</th><td>	<b>return</b> isolated;</td></tr>
<tr><th id="2102">2102</th><td></td></tr>
<tr><th id="2103">2103</th><td>out_fail:</td></tr>
<tr><th id="2104">2104</th><td>	count_vm_events(PGMIGRATE_FAIL, HPAGE_PMD_NR);</td></tr>
<tr><th id="2105">2105</th><td>	ptl = pmd_lock(mm, pmd);</td></tr>
<tr><th id="2106">2106</th><td>	<b>if</b> (pmd_same(*pmd, entry)) {</td></tr>
<tr><th id="2107">2107</th><td>		entry = pmd_modify(entry, vma-&gt;vm_page_prot);</td></tr>
<tr><th id="2108">2108</th><td>		set_pmd_at(mm, start, pmd, entry);</td></tr>
<tr><th id="2109">2109</th><td>		update_mmu_cache_pmd(vma, address, &amp;entry);</td></tr>
<tr><th id="2110">2110</th><td>	}</td></tr>
<tr><th id="2111">2111</th><td>	spin_unlock(ptl);</td></tr>
<tr><th id="2112">2112</th><td></td></tr>
<tr><th id="2113">2113</th><td>out_unlock:</td></tr>
<tr><th id="2114">2114</th><td>	unlock_page(page);</td></tr>
<tr><th id="2115">2115</th><td>	put_page(page);</td></tr>
<tr><th id="2116">2116</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2117">2117</th><td>}</td></tr>
<tr><th id="2118">2118</th><td><u>#<span data-ppcond="1986">endif</span> /* CONFIG_NUMA_BALANCING */</u></td></tr>
<tr><th id="2119">2119</th><td></td></tr>
<tr><th id="2120">2120</th><td><u>#<span data-ppcond="1487">endif</span> /* CONFIG_NUMA */</u></td></tr>
<tr><th id="2121">2121</th><td></td></tr>
<tr><th id="2122">2122</th><td><u>#<span data-ppcond="2122">if</span> defined(<span class="macro" data-ref="_M/CONFIG_MIGRATE_VMA_HELPER">CONFIG_MIGRATE_VMA_HELPER</span>)</u></td></tr>
<tr><th id="2123">2123</th><td><b>struct</b> migrate_vma {</td></tr>
<tr><th id="2124">2124</th><td>	<b>struct</b> vm_area_struct	*vma;</td></tr>
<tr><th id="2125">2125</th><td>	<em>unsigned</em> <em>long</em>		*dst;</td></tr>
<tr><th id="2126">2126</th><td>	<em>unsigned</em> <em>long</em>		*src;</td></tr>
<tr><th id="2127">2127</th><td>	<em>unsigned</em> <em>long</em>		cpages;</td></tr>
<tr><th id="2128">2128</th><td>	<em>unsigned</em> <em>long</em>		npages;</td></tr>
<tr><th id="2129">2129</th><td>	<em>unsigned</em> <em>long</em>		start;</td></tr>
<tr><th id="2130">2130</th><td>	<em>unsigned</em> <em>long</em>		end;</td></tr>
<tr><th id="2131">2131</th><td>};</td></tr>
<tr><th id="2132">2132</th><td></td></tr>
<tr><th id="2133">2133</th><td><em>static</em> <em>int</em> migrate_vma_collect_hole(<em>unsigned</em> <em>long</em> start,</td></tr>
<tr><th id="2134">2134</th><td>				    <em>unsigned</em> <em>long</em> end,</td></tr>
<tr><th id="2135">2135</th><td>				    <b>struct</b> mm_walk *walk)</td></tr>
<tr><th id="2136">2136</th><td>{</td></tr>
<tr><th id="2137">2137</th><td>	<b>struct</b> migrate_vma *migrate = walk-&gt;private;</td></tr>
<tr><th id="2138">2138</th><td>	<em>unsigned</em> <em>long</em> addr;</td></tr>
<tr><th id="2139">2139</th><td></td></tr>
<tr><th id="2140">2140</th><td>	<b>for</b> (addr = start &amp; PAGE_MASK; addr &lt; end; addr += PAGE_SIZE) {</td></tr>
<tr><th id="2141">2141</th><td>		migrate-&gt;src[migrate-&gt;npages] = MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2142">2142</th><td>		migrate-&gt;dst[migrate-&gt;npages] = <var>0</var>;</td></tr>
<tr><th id="2143">2143</th><td>		migrate-&gt;npages++;</td></tr>
<tr><th id="2144">2144</th><td>		migrate-&gt;cpages++;</td></tr>
<tr><th id="2145">2145</th><td>	}</td></tr>
<tr><th id="2146">2146</th><td></td></tr>
<tr><th id="2147">2147</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2148">2148</th><td>}</td></tr>
<tr><th id="2149">2149</th><td></td></tr>
<tr><th id="2150">2150</th><td><em>static</em> <em>int</em> migrate_vma_collect_skip(<em>unsigned</em> <em>long</em> start,</td></tr>
<tr><th id="2151">2151</th><td>				    <em>unsigned</em> <em>long</em> end,</td></tr>
<tr><th id="2152">2152</th><td>				    <b>struct</b> mm_walk *walk)</td></tr>
<tr><th id="2153">2153</th><td>{</td></tr>
<tr><th id="2154">2154</th><td>	<b>struct</b> migrate_vma *migrate = walk-&gt;private;</td></tr>
<tr><th id="2155">2155</th><td>	<em>unsigned</em> <em>long</em> addr;</td></tr>
<tr><th id="2156">2156</th><td></td></tr>
<tr><th id="2157">2157</th><td>	<b>for</b> (addr = start &amp; PAGE_MASK; addr &lt; end; addr += PAGE_SIZE) {</td></tr>
<tr><th id="2158">2158</th><td>		migrate-&gt;dst[migrate-&gt;npages] = <var>0</var>;</td></tr>
<tr><th id="2159">2159</th><td>		migrate-&gt;src[migrate-&gt;npages++] = <var>0</var>;</td></tr>
<tr><th id="2160">2160</th><td>	}</td></tr>
<tr><th id="2161">2161</th><td></td></tr>
<tr><th id="2162">2162</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2163">2163</th><td>}</td></tr>
<tr><th id="2164">2164</th><td></td></tr>
<tr><th id="2165">2165</th><td><em>static</em> <em>int</em> migrate_vma_collect_pmd(pmd_t *pmdp,</td></tr>
<tr><th id="2166">2166</th><td>				   <em>unsigned</em> <em>long</em> start,</td></tr>
<tr><th id="2167">2167</th><td>				   <em>unsigned</em> <em>long</em> end,</td></tr>
<tr><th id="2168">2168</th><td>				   <b>struct</b> mm_walk *walk)</td></tr>
<tr><th id="2169">2169</th><td>{</td></tr>
<tr><th id="2170">2170</th><td>	<b>struct</b> migrate_vma *migrate = walk-&gt;private;</td></tr>
<tr><th id="2171">2171</th><td>	<b>struct</b> vm_area_struct *vma = walk-&gt;vma;</td></tr>
<tr><th id="2172">2172</th><td>	<b>struct</b> mm_struct *mm = vma-&gt;vm_mm;</td></tr>
<tr><th id="2173">2173</th><td>	<em>unsigned</em> <em>long</em> addr = start, unmapped = <var>0</var>;</td></tr>
<tr><th id="2174">2174</th><td>	spinlock_t *ptl;</td></tr>
<tr><th id="2175">2175</th><td>	pte_t *ptep;</td></tr>
<tr><th id="2176">2176</th><td></td></tr>
<tr><th id="2177">2177</th><td>again:</td></tr>
<tr><th id="2178">2178</th><td>	<b>if</b> (pmd_none(*pmdp))</td></tr>
<tr><th id="2179">2179</th><td>		<b>return</b> migrate_vma_collect_hole(start, end, walk);</td></tr>
<tr><th id="2180">2180</th><td></td></tr>
<tr><th id="2181">2181</th><td>	<b>if</b> (pmd_trans_huge(*pmdp)) {</td></tr>
<tr><th id="2182">2182</th><td>		<b>struct</b> page *page;</td></tr>
<tr><th id="2183">2183</th><td></td></tr>
<tr><th id="2184">2184</th><td>		ptl = pmd_lock(mm, pmdp);</td></tr>
<tr><th id="2185">2185</th><td>		<b>if</b> (unlikely(!pmd_trans_huge(*pmdp))) {</td></tr>
<tr><th id="2186">2186</th><td>			spin_unlock(ptl);</td></tr>
<tr><th id="2187">2187</th><td>			<b>goto</b> again;</td></tr>
<tr><th id="2188">2188</th><td>		}</td></tr>
<tr><th id="2189">2189</th><td></td></tr>
<tr><th id="2190">2190</th><td>		page = pmd_page(*pmdp);</td></tr>
<tr><th id="2191">2191</th><td>		<b>if</b> (is_huge_zero_page(page)) {</td></tr>
<tr><th id="2192">2192</th><td>			spin_unlock(ptl);</td></tr>
<tr><th id="2193">2193</th><td>			split_huge_pmd(vma, pmdp, addr);</td></tr>
<tr><th id="2194">2194</th><td>			<b>if</b> (pmd_trans_unstable(pmdp))</td></tr>
<tr><th id="2195">2195</th><td>				<b>return</b> migrate_vma_collect_skip(start, end,</td></tr>
<tr><th id="2196">2196</th><td>								walk);</td></tr>
<tr><th id="2197">2197</th><td>		} <b>else</b> {</td></tr>
<tr><th id="2198">2198</th><td>			<em>int</em> ret;</td></tr>
<tr><th id="2199">2199</th><td></td></tr>
<tr><th id="2200">2200</th><td>			get_page(page);</td></tr>
<tr><th id="2201">2201</th><td>			spin_unlock(ptl);</td></tr>
<tr><th id="2202">2202</th><td>			<b>if</b> (unlikely(!trylock_page(page)))</td></tr>
<tr><th id="2203">2203</th><td>				<b>return</b> migrate_vma_collect_skip(start, end,</td></tr>
<tr><th id="2204">2204</th><td>								walk);</td></tr>
<tr><th id="2205">2205</th><td>			ret = split_huge_page(page);</td></tr>
<tr><th id="2206">2206</th><td>			unlock_page(page);</td></tr>
<tr><th id="2207">2207</th><td>			put_page(page);</td></tr>
<tr><th id="2208">2208</th><td>			<b>if</b> (ret)</td></tr>
<tr><th id="2209">2209</th><td>				<b>return</b> migrate_vma_collect_skip(start, end,</td></tr>
<tr><th id="2210">2210</th><td>								walk);</td></tr>
<tr><th id="2211">2211</th><td>			<b>if</b> (pmd_none(*pmdp))</td></tr>
<tr><th id="2212">2212</th><td>				<b>return</b> migrate_vma_collect_hole(start, end,</td></tr>
<tr><th id="2213">2213</th><td>								walk);</td></tr>
<tr><th id="2214">2214</th><td>		}</td></tr>
<tr><th id="2215">2215</th><td>	}</td></tr>
<tr><th id="2216">2216</th><td></td></tr>
<tr><th id="2217">2217</th><td>	<b>if</b> (unlikely(pmd_bad(*pmdp)))</td></tr>
<tr><th id="2218">2218</th><td>		<b>return</b> migrate_vma_collect_skip(start, end, walk);</td></tr>
<tr><th id="2219">2219</th><td></td></tr>
<tr><th id="2220">2220</th><td>	ptep = pte_offset_map_lock(mm, pmdp, addr, &amp;ptl);</td></tr>
<tr><th id="2221">2221</th><td>	arch_enter_lazy_mmu_mode();</td></tr>
<tr><th id="2222">2222</th><td></td></tr>
<tr><th id="2223">2223</th><td>	<b>for</b> (; addr &lt; end; addr += PAGE_SIZE, ptep++) {</td></tr>
<tr><th id="2224">2224</th><td>		<em>unsigned</em> <em>long</em> mpfn, pfn;</td></tr>
<tr><th id="2225">2225</th><td>		<b>struct</b> page *page;</td></tr>
<tr><th id="2226">2226</th><td>		swp_entry_t entry;</td></tr>
<tr><th id="2227">2227</th><td>		pte_t pte;</td></tr>
<tr><th id="2228">2228</th><td></td></tr>
<tr><th id="2229">2229</th><td>		pte = *ptep;</td></tr>
<tr><th id="2230">2230</th><td>		pfn = pte_pfn(pte);</td></tr>
<tr><th id="2231">2231</th><td></td></tr>
<tr><th id="2232">2232</th><td>		<b>if</b> (pte_none(pte)) {</td></tr>
<tr><th id="2233">2233</th><td>			mpfn = MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2234">2234</th><td>			migrate-&gt;cpages++;</td></tr>
<tr><th id="2235">2235</th><td>			pfn = <var>0</var>;</td></tr>
<tr><th id="2236">2236</th><td>			<b>goto</b> next;</td></tr>
<tr><th id="2237">2237</th><td>		}</td></tr>
<tr><th id="2238">2238</th><td></td></tr>
<tr><th id="2239">2239</th><td>		<b>if</b> (!pte_present(pte)) {</td></tr>
<tr><th id="2240">2240</th><td>			mpfn = pfn = <var>0</var>;</td></tr>
<tr><th id="2241">2241</th><td></td></tr>
<tr><th id="2242">2242</th><td>			<i>/*</i></td></tr>
<tr><th id="2243">2243</th><td><i>			 * Only care about unaddressable device page special</i></td></tr>
<tr><th id="2244">2244</th><td><i>			 * page table entry. Other special swap entries are not</i></td></tr>
<tr><th id="2245">2245</th><td><i>			 * migratable, and we ignore regular swapped page.</i></td></tr>
<tr><th id="2246">2246</th><td><i>			 */</i></td></tr>
<tr><th id="2247">2247</th><td>			entry = pte_to_swp_entry(pte);</td></tr>
<tr><th id="2248">2248</th><td>			<b>if</b> (!is_device_private_entry(entry))</td></tr>
<tr><th id="2249">2249</th><td>				<b>goto</b> next;</td></tr>
<tr><th id="2250">2250</th><td></td></tr>
<tr><th id="2251">2251</th><td>			page = device_private_entry_to_page(entry);</td></tr>
<tr><th id="2252">2252</th><td>			mpfn = migrate_pfn(page_to_pfn(page))|</td></tr>
<tr><th id="2253">2253</th><td>				MIGRATE_PFN_DEVICE | MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2254">2254</th><td>			<b>if</b> (is_write_device_private_entry(entry))</td></tr>
<tr><th id="2255">2255</th><td>				mpfn |= MIGRATE_PFN_WRITE;</td></tr>
<tr><th id="2256">2256</th><td>		} <b>else</b> {</td></tr>
<tr><th id="2257">2257</th><td>			<b>if</b> (is_zero_pfn(pfn)) {</td></tr>
<tr><th id="2258">2258</th><td>				mpfn = MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2259">2259</th><td>				migrate-&gt;cpages++;</td></tr>
<tr><th id="2260">2260</th><td>				pfn = <var>0</var>;</td></tr>
<tr><th id="2261">2261</th><td>				<b>goto</b> next;</td></tr>
<tr><th id="2262">2262</th><td>			}</td></tr>
<tr><th id="2263">2263</th><td>			page = vm_normal_page(migrate-&gt;vma, addr, pte);</td></tr>
<tr><th id="2264">2264</th><td>			mpfn = migrate_pfn(pfn) | MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2265">2265</th><td>			mpfn |= pte_write(pte) ? MIGRATE_PFN_WRITE : <var>0</var>;</td></tr>
<tr><th id="2266">2266</th><td>		}</td></tr>
<tr><th id="2267">2267</th><td></td></tr>
<tr><th id="2268">2268</th><td>		<i>/* FIXME support THP */</i></td></tr>
<tr><th id="2269">2269</th><td>		<b>if</b> (!page || !page-&gt;mapping || PageTransCompound(page)) {</td></tr>
<tr><th id="2270">2270</th><td>			mpfn = pfn = <var>0</var>;</td></tr>
<tr><th id="2271">2271</th><td>			<b>goto</b> next;</td></tr>
<tr><th id="2272">2272</th><td>		}</td></tr>
<tr><th id="2273">2273</th><td>		pfn = page_to_pfn(page);</td></tr>
<tr><th id="2274">2274</th><td></td></tr>
<tr><th id="2275">2275</th><td>		<i>/*</i></td></tr>
<tr><th id="2276">2276</th><td><i>		 * By getting a reference on the page we pin it and that blocks</i></td></tr>
<tr><th id="2277">2277</th><td><i>		 * any kind of migration. Side effect is that it "freezes" the</i></td></tr>
<tr><th id="2278">2278</th><td><i>		 * pte.</i></td></tr>
<tr><th id="2279">2279</th><td><i>		 *</i></td></tr>
<tr><th id="2280">2280</th><td><i>		 * We drop this reference after isolating the page from the lru</i></td></tr>
<tr><th id="2281">2281</th><td><i>		 * for non device page (device page are not on the lru and thus</i></td></tr>
<tr><th id="2282">2282</th><td><i>		 * can't be dropped from it).</i></td></tr>
<tr><th id="2283">2283</th><td><i>		 */</i></td></tr>
<tr><th id="2284">2284</th><td>		get_page(page);</td></tr>
<tr><th id="2285">2285</th><td>		migrate-&gt;cpages++;</td></tr>
<tr><th id="2286">2286</th><td></td></tr>
<tr><th id="2287">2287</th><td>		<i>/*</i></td></tr>
<tr><th id="2288">2288</th><td><i>		 * Optimize for the common case where page is only mapped once</i></td></tr>
<tr><th id="2289">2289</th><td><i>		 * in one process. If we can lock the page, then we can safely</i></td></tr>
<tr><th id="2290">2290</th><td><i>		 * set up a special migration page table entry now.</i></td></tr>
<tr><th id="2291">2291</th><td><i>		 */</i></td></tr>
<tr><th id="2292">2292</th><td>		<b>if</b> (trylock_page(page)) {</td></tr>
<tr><th id="2293">2293</th><td>			pte_t swp_pte;</td></tr>
<tr><th id="2294">2294</th><td></td></tr>
<tr><th id="2295">2295</th><td>			mpfn |= MIGRATE_PFN_LOCKED;</td></tr>
<tr><th id="2296">2296</th><td>			ptep_get_and_clear(mm, addr, ptep);</td></tr>
<tr><th id="2297">2297</th><td></td></tr>
<tr><th id="2298">2298</th><td>			<i>/* Setup special migration page table entry */</i></td></tr>
<tr><th id="2299">2299</th><td>			entry = make_migration_entry(page, mpfn &amp;</td></tr>
<tr><th id="2300">2300</th><td>						     MIGRATE_PFN_WRITE);</td></tr>
<tr><th id="2301">2301</th><td>			swp_pte = swp_entry_to_pte(entry);</td></tr>
<tr><th id="2302">2302</th><td>			<b>if</b> (pte_soft_dirty(pte))</td></tr>
<tr><th id="2303">2303</th><td>				swp_pte = pte_swp_mksoft_dirty(swp_pte);</td></tr>
<tr><th id="2304">2304</th><td>			set_pte_at(mm, addr, ptep, swp_pte);</td></tr>
<tr><th id="2305">2305</th><td></td></tr>
<tr><th id="2306">2306</th><td>			<i>/*</i></td></tr>
<tr><th id="2307">2307</th><td><i>			 * This is like regular unmap: we remove the rmap and</i></td></tr>
<tr><th id="2308">2308</th><td><i>			 * drop page refcount. Page won't be freed, as we took</i></td></tr>
<tr><th id="2309">2309</th><td><i>			 * a reference just above.</i></td></tr>
<tr><th id="2310">2310</th><td><i>			 */</i></td></tr>
<tr><th id="2311">2311</th><td>			page_remove_rmap(page, false);</td></tr>
<tr><th id="2312">2312</th><td>			put_page(page);</td></tr>
<tr><th id="2313">2313</th><td></td></tr>
<tr><th id="2314">2314</th><td>			<b>if</b> (pte_present(pte))</td></tr>
<tr><th id="2315">2315</th><td>				unmapped++;</td></tr>
<tr><th id="2316">2316</th><td>		}</td></tr>
<tr><th id="2317">2317</th><td></td></tr>
<tr><th id="2318">2318</th><td>next:</td></tr>
<tr><th id="2319">2319</th><td>		migrate-&gt;dst[migrate-&gt;npages] = <var>0</var>;</td></tr>
<tr><th id="2320">2320</th><td>		migrate-&gt;src[migrate-&gt;npages++] = mpfn;</td></tr>
<tr><th id="2321">2321</th><td>	}</td></tr>
<tr><th id="2322">2322</th><td>	arch_leave_lazy_mmu_mode();</td></tr>
<tr><th id="2323">2323</th><td>	pte_unmap_unlock(ptep - <var>1</var>, ptl);</td></tr>
<tr><th id="2324">2324</th><td></td></tr>
<tr><th id="2325">2325</th><td>	<i>/* Only flush the TLB if we actually modified any entries */</i></td></tr>
<tr><th id="2326">2326</th><td>	<b>if</b> (unmapped)</td></tr>
<tr><th id="2327">2327</th><td>		flush_tlb_range(walk-&gt;vma, start, end);</td></tr>
<tr><th id="2328">2328</th><td></td></tr>
<tr><th id="2329">2329</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2330">2330</th><td>}</td></tr>
<tr><th id="2331">2331</th><td></td></tr>
<tr><th id="2332">2332</th><td><i>/*</i></td></tr>
<tr><th id="2333">2333</th><td><i> * migrate_vma_collect() - collect pages over a range of virtual addresses</i></td></tr>
<tr><th id="2334">2334</th><td><i> * @migrate: migrate struct containing all migration information</i></td></tr>
<tr><th id="2335">2335</th><td><i> *</i></td></tr>
<tr><th id="2336">2336</th><td><i> * This will walk the CPU page table. For each virtual address backed by a</i></td></tr>
<tr><th id="2337">2337</th><td><i> * valid page, it updates the src array and takes a reference on the page, in</i></td></tr>
<tr><th id="2338">2338</th><td><i> * order to pin the page until we lock it and unmap it.</i></td></tr>
<tr><th id="2339">2339</th><td><i> */</i></td></tr>
<tr><th id="2340">2340</th><td><em>static</em> <em>void</em> migrate_vma_collect(<b>struct</b> migrate_vma *migrate)</td></tr>
<tr><th id="2341">2341</th><td>{</td></tr>
<tr><th id="2342">2342</th><td>	<b>struct</b> mmu_notifier_range range;</td></tr>
<tr><th id="2343">2343</th><td>	<b>struct</b> mm_walk mm_walk = {</td></tr>
<tr><th id="2344">2344</th><td>		.pmd_entry = migrate_vma_collect_pmd,</td></tr>
<tr><th id="2345">2345</th><td>		.pte_hole = migrate_vma_collect_hole,</td></tr>
<tr><th id="2346">2346</th><td>		.vma = migrate-&gt;vma,</td></tr>
<tr><th id="2347">2347</th><td>		.mm = migrate-&gt;vma-&gt;vm_mm,</td></tr>
<tr><th id="2348">2348</th><td>		.private = migrate,</td></tr>
<tr><th id="2349">2349</th><td>	};</td></tr>
<tr><th id="2350">2350</th><td></td></tr>
<tr><th id="2351">2351</th><td>	mmu_notifier_range_init(&amp;range, MMU_NOTIFY_CLEAR, <var>0</var>, NULL, mm_walk.mm,</td></tr>
<tr><th id="2352">2352</th><td>				migrate-&gt;start,</td></tr>
<tr><th id="2353">2353</th><td>				migrate-&gt;end);</td></tr>
<tr><th id="2354">2354</th><td>	mmu_notifier_invalidate_range_start(&amp;range);</td></tr>
<tr><th id="2355">2355</th><td>	walk_page_range(migrate-&gt;start, migrate-&gt;end, &amp;mm_walk);</td></tr>
<tr><th id="2356">2356</th><td>	mmu_notifier_invalidate_range_end(&amp;range);</td></tr>
<tr><th id="2357">2357</th><td></td></tr>
<tr><th id="2358">2358</th><td>	migrate-&gt;end = migrate-&gt;start + (migrate-&gt;npages &lt;&lt; PAGE_SHIFT);</td></tr>
<tr><th id="2359">2359</th><td>}</td></tr>
<tr><th id="2360">2360</th><td></td></tr>
<tr><th id="2361">2361</th><td><i>/*</i></td></tr>
<tr><th id="2362">2362</th><td><i> * migrate_vma_check_page() - check if page is pinned or not</i></td></tr>
<tr><th id="2363">2363</th><td><i> * @page: struct page to check</i></td></tr>
<tr><th id="2364">2364</th><td><i> *</i></td></tr>
<tr><th id="2365">2365</th><td><i> * Pinned pages cannot be migrated. This is the same test as in</i></td></tr>
<tr><th id="2366">2366</th><td><i> * migrate_page_move_mapping(), except that here we allow migration of a</i></td></tr>
<tr><th id="2367">2367</th><td><i> * ZONE_DEVICE page.</i></td></tr>
<tr><th id="2368">2368</th><td><i> */</i></td></tr>
<tr><th id="2369">2369</th><td><em>static</em> bool migrate_vma_check_page(<b>struct</b> page *page)</td></tr>
<tr><th id="2370">2370</th><td>{</td></tr>
<tr><th id="2371">2371</th><td>	<i>/*</i></td></tr>
<tr><th id="2372">2372</th><td><i>	 * One extra ref because caller holds an extra reference, either from</i></td></tr>
<tr><th id="2373">2373</th><td><i>	 * isolate_lru_page() for a regular page, or migrate_vma_collect() for</i></td></tr>
<tr><th id="2374">2374</th><td><i>	 * a device page.</i></td></tr>
<tr><th id="2375">2375</th><td><i>	 */</i></td></tr>
<tr><th id="2376">2376</th><td>	<em>int</em> extra = <var>1</var>;</td></tr>
<tr><th id="2377">2377</th><td></td></tr>
<tr><th id="2378">2378</th><td>	<i>/*</i></td></tr>
<tr><th id="2379">2379</th><td><i>	 * FIXME support THP (transparent huge page), it is bit more complex to</i></td></tr>
<tr><th id="2380">2380</th><td><i>	 * check them than regular pages, because they can be mapped with a pmd</i></td></tr>
<tr><th id="2381">2381</th><td><i>	 * or with a pte (split pte mapping).</i></td></tr>
<tr><th id="2382">2382</th><td><i>	 */</i></td></tr>
<tr><th id="2383">2383</th><td>	<b>if</b> (PageCompound(page))</td></tr>
<tr><th id="2384">2384</th><td>		<b>return</b> false;</td></tr>
<tr><th id="2385">2385</th><td></td></tr>
<tr><th id="2386">2386</th><td>	<i>/* Page from ZONE_DEVICE have one extra reference */</i></td></tr>
<tr><th id="2387">2387</th><td>	<b>if</b> (is_zone_device_page(page)) {</td></tr>
<tr><th id="2388">2388</th><td>		<i>/*</i></td></tr>
<tr><th id="2389">2389</th><td><i>		 * Private page can never be pin as they have no valid pte and</i></td></tr>
<tr><th id="2390">2390</th><td><i>		 * GUP will fail for those. Yet if there is a pending migration</i></td></tr>
<tr><th id="2391">2391</th><td><i>		 * a thread might try to wait on the pte migration entry and</i></td></tr>
<tr><th id="2392">2392</th><td><i>		 * will bump the page reference count. Sadly there is no way to</i></td></tr>
<tr><th id="2393">2393</th><td><i>		 * differentiate a regular pin from migration wait. Hence to</i></td></tr>
<tr><th id="2394">2394</th><td><i>		 * avoid 2 racing thread trying to migrate back to CPU to enter</i></td></tr>
<tr><th id="2395">2395</th><td><i>		 * infinite loop (one stoping migration because the other is</i></td></tr>
<tr><th id="2396">2396</th><td><i>		 * waiting on pte migration entry). We always return true here.</i></td></tr>
<tr><th id="2397">2397</th><td><i>		 *</i></td></tr>
<tr><th id="2398">2398</th><td><i>		 * FIXME proper solution is to rework migration_entry_wait() so</i></td></tr>
<tr><th id="2399">2399</th><td><i>		 * it does not need to take a reference on page.</i></td></tr>
<tr><th id="2400">2400</th><td><i>		 */</i></td></tr>
<tr><th id="2401">2401</th><td>		<b>return</b> is_device_private_page(page);</td></tr>
<tr><th id="2402">2402</th><td>	}</td></tr>
<tr><th id="2403">2403</th><td></td></tr>
<tr><th id="2404">2404</th><td>	<i>/* For file back page */</i></td></tr>
<tr><th id="2405">2405</th><td>	<b>if</b> (page_mapping(page))</td></tr>
<tr><th id="2406">2406</th><td>		extra += <var>1</var> + page_has_private(page);</td></tr>
<tr><th id="2407">2407</th><td></td></tr>
<tr><th id="2408">2408</th><td>	<b>if</b> ((page_count(page) - extra) &gt; page_mapcount(page))</td></tr>
<tr><th id="2409">2409</th><td>		<b>return</b> false;</td></tr>
<tr><th id="2410">2410</th><td></td></tr>
<tr><th id="2411">2411</th><td>	<b>return</b> true;</td></tr>
<tr><th id="2412">2412</th><td>}</td></tr>
<tr><th id="2413">2413</th><td></td></tr>
<tr><th id="2414">2414</th><td><i>/*</i></td></tr>
<tr><th id="2415">2415</th><td><i> * migrate_vma_prepare() - lock pages and isolate them from the lru</i></td></tr>
<tr><th id="2416">2416</th><td><i> * @migrate: migrate struct containing all migration information</i></td></tr>
<tr><th id="2417">2417</th><td><i> *</i></td></tr>
<tr><th id="2418">2418</th><td><i> * This locks pages that have been collected by migrate_vma_collect(). Once each</i></td></tr>
<tr><th id="2419">2419</th><td><i> * page is locked it is isolated from the lru (for non-device pages). Finally,</i></td></tr>
<tr><th id="2420">2420</th><td><i> * the ref taken by migrate_vma_collect() is dropped, as locked pages cannot be</i></td></tr>
<tr><th id="2421">2421</th><td><i> * migrated by concurrent kernel threads.</i></td></tr>
<tr><th id="2422">2422</th><td><i> */</i></td></tr>
<tr><th id="2423">2423</th><td><em>static</em> <em>void</em> migrate_vma_prepare(<b>struct</b> migrate_vma *migrate)</td></tr>
<tr><th id="2424">2424</th><td>{</td></tr>
<tr><th id="2425">2425</th><td>	<em>const</em> <em>unsigned</em> <em>long</em> npages = migrate-&gt;npages;</td></tr>
<tr><th id="2426">2426</th><td>	<em>const</em> <em>unsigned</em> <em>long</em> start = migrate-&gt;start;</td></tr>
<tr><th id="2427">2427</th><td>	<em>unsigned</em> <em>long</em> addr, i, restore = <var>0</var>;</td></tr>
<tr><th id="2428">2428</th><td>	bool allow_drain = true;</td></tr>
<tr><th id="2429">2429</th><td></td></tr>
<tr><th id="2430">2430</th><td>	lru_add_drain();</td></tr>
<tr><th id="2431">2431</th><td></td></tr>
<tr><th id="2432">2432</th><td>	<b>for</b> (i = <var>0</var>; (i &lt; npages) &amp;&amp; migrate-&gt;cpages; i++) {</td></tr>
<tr><th id="2433">2433</th><td>		<b>struct</b> page *page = migrate_pfn_to_page(migrate-&gt;src[i]);</td></tr>
<tr><th id="2434">2434</th><td>		bool remap = true;</td></tr>
<tr><th id="2435">2435</th><td></td></tr>
<tr><th id="2436">2436</th><td>		<b>if</b> (!page)</td></tr>
<tr><th id="2437">2437</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2438">2438</th><td></td></tr>
<tr><th id="2439">2439</th><td>		<b>if</b> (!(migrate-&gt;src[i] &amp; MIGRATE_PFN_LOCKED)) {</td></tr>
<tr><th id="2440">2440</th><td>			<i>/*</i></td></tr>
<tr><th id="2441">2441</th><td><i>			 * Because we are migrating several pages there can be</i></td></tr>
<tr><th id="2442">2442</th><td><i>			 * a deadlock between 2 concurrent migration where each</i></td></tr>
<tr><th id="2443">2443</th><td><i>			 * are waiting on each other page lock.</i></td></tr>
<tr><th id="2444">2444</th><td><i>			 *</i></td></tr>
<tr><th id="2445">2445</th><td><i>			 * Make migrate_vma() a best effort thing and backoff</i></td></tr>
<tr><th id="2446">2446</th><td><i>			 * for any page we can not lock right away.</i></td></tr>
<tr><th id="2447">2447</th><td><i>			 */</i></td></tr>
<tr><th id="2448">2448</th><td>			<b>if</b> (!trylock_page(page)) {</td></tr>
<tr><th id="2449">2449</th><td>				migrate-&gt;src[i] = <var>0</var>;</td></tr>
<tr><th id="2450">2450</th><td>				migrate-&gt;cpages--;</td></tr>
<tr><th id="2451">2451</th><td>				put_page(page);</td></tr>
<tr><th id="2452">2452</th><td>				<b>continue</b>;</td></tr>
<tr><th id="2453">2453</th><td>			}</td></tr>
<tr><th id="2454">2454</th><td>			remap = false;</td></tr>
<tr><th id="2455">2455</th><td>			migrate-&gt;src[i] |= MIGRATE_PFN_LOCKED;</td></tr>
<tr><th id="2456">2456</th><td>		}</td></tr>
<tr><th id="2457">2457</th><td></td></tr>
<tr><th id="2458">2458</th><td>		<i>/* ZONE_DEVICE pages are not on LRU */</i></td></tr>
<tr><th id="2459">2459</th><td>		<b>if</b> (!is_zone_device_page(page)) {</td></tr>
<tr><th id="2460">2460</th><td>			<b>if</b> (!PageLRU(page) &amp;&amp; allow_drain) {</td></tr>
<tr><th id="2461">2461</th><td>				<i>/* Drain CPU's pagevec */</i></td></tr>
<tr><th id="2462">2462</th><td>				lru_add_drain_all();</td></tr>
<tr><th id="2463">2463</th><td>				allow_drain = false;</td></tr>
<tr><th id="2464">2464</th><td>			}</td></tr>
<tr><th id="2465">2465</th><td></td></tr>
<tr><th id="2466">2466</th><td>			<b>if</b> (isolate_lru_page(page)) {</td></tr>
<tr><th id="2467">2467</th><td>				<b>if</b> (remap) {</td></tr>
<tr><th id="2468">2468</th><td>					migrate-&gt;src[i] &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2469">2469</th><td>					migrate-&gt;cpages--;</td></tr>
<tr><th id="2470">2470</th><td>					restore++;</td></tr>
<tr><th id="2471">2471</th><td>				} <b>else</b> {</td></tr>
<tr><th id="2472">2472</th><td>					migrate-&gt;src[i] = <var>0</var>;</td></tr>
<tr><th id="2473">2473</th><td>					unlock_page(page);</td></tr>
<tr><th id="2474">2474</th><td>					migrate-&gt;cpages--;</td></tr>
<tr><th id="2475">2475</th><td>					put_page(page);</td></tr>
<tr><th id="2476">2476</th><td>				}</td></tr>
<tr><th id="2477">2477</th><td>				<b>continue</b>;</td></tr>
<tr><th id="2478">2478</th><td>			}</td></tr>
<tr><th id="2479">2479</th><td></td></tr>
<tr><th id="2480">2480</th><td>			<i>/* Drop the reference we took in collect */</i></td></tr>
<tr><th id="2481">2481</th><td>			put_page(page);</td></tr>
<tr><th id="2482">2482</th><td>		}</td></tr>
<tr><th id="2483">2483</th><td></td></tr>
<tr><th id="2484">2484</th><td>		<b>if</b> (!migrate_vma_check_page(page)) {</td></tr>
<tr><th id="2485">2485</th><td>			<b>if</b> (remap) {</td></tr>
<tr><th id="2486">2486</th><td>				migrate-&gt;src[i] &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2487">2487</th><td>				migrate-&gt;cpages--;</td></tr>
<tr><th id="2488">2488</th><td>				restore++;</td></tr>
<tr><th id="2489">2489</th><td></td></tr>
<tr><th id="2490">2490</th><td>				<b>if</b> (!is_zone_device_page(page)) {</td></tr>
<tr><th id="2491">2491</th><td>					get_page(page);</td></tr>
<tr><th id="2492">2492</th><td>					putback_lru_page(page);</td></tr>
<tr><th id="2493">2493</th><td>				}</td></tr>
<tr><th id="2494">2494</th><td>			} <b>else</b> {</td></tr>
<tr><th id="2495">2495</th><td>				migrate-&gt;src[i] = <var>0</var>;</td></tr>
<tr><th id="2496">2496</th><td>				unlock_page(page);</td></tr>
<tr><th id="2497">2497</th><td>				migrate-&gt;cpages--;</td></tr>
<tr><th id="2498">2498</th><td></td></tr>
<tr><th id="2499">2499</th><td>				<b>if</b> (!is_zone_device_page(page))</td></tr>
<tr><th id="2500">2500</th><td>					putback_lru_page(page);</td></tr>
<tr><th id="2501">2501</th><td>				<b>else</b></td></tr>
<tr><th id="2502">2502</th><td>					put_page(page);</td></tr>
<tr><th id="2503">2503</th><td>			}</td></tr>
<tr><th id="2504">2504</th><td>		}</td></tr>
<tr><th id="2505">2505</th><td>	}</td></tr>
<tr><th id="2506">2506</th><td></td></tr>
<tr><th id="2507">2507</th><td>	<b>for</b> (i = <var>0</var>, addr = start; i &lt; npages &amp;&amp; restore; i++, addr += PAGE_SIZE) {</td></tr>
<tr><th id="2508">2508</th><td>		<b>struct</b> page *page = migrate_pfn_to_page(migrate-&gt;src[i]);</td></tr>
<tr><th id="2509">2509</th><td></td></tr>
<tr><th id="2510">2510</th><td>		<b>if</b> (!page || (migrate-&gt;src[i] &amp; MIGRATE_PFN_MIGRATE))</td></tr>
<tr><th id="2511">2511</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2512">2512</th><td></td></tr>
<tr><th id="2513">2513</th><td>		remove_migration_pte(page, migrate-&gt;vma, addr, page);</td></tr>
<tr><th id="2514">2514</th><td></td></tr>
<tr><th id="2515">2515</th><td>		migrate-&gt;src[i] = <var>0</var>;</td></tr>
<tr><th id="2516">2516</th><td>		unlock_page(page);</td></tr>
<tr><th id="2517">2517</th><td>		put_page(page);</td></tr>
<tr><th id="2518">2518</th><td>		restore--;</td></tr>
<tr><th id="2519">2519</th><td>	}</td></tr>
<tr><th id="2520">2520</th><td>}</td></tr>
<tr><th id="2521">2521</th><td></td></tr>
<tr><th id="2522">2522</th><td><i>/*</i></td></tr>
<tr><th id="2523">2523</th><td><i> * migrate_vma_unmap() - replace page mapping with special migration pte entry</i></td></tr>
<tr><th id="2524">2524</th><td><i> * @migrate: migrate struct containing all migration information</i></td></tr>
<tr><th id="2525">2525</th><td><i> *</i></td></tr>
<tr><th id="2526">2526</th><td><i> * Replace page mapping (CPU page table pte) with a special migration pte entry</i></td></tr>
<tr><th id="2527">2527</th><td><i> * and check again if it has been pinned. Pinned pages are restored because we</i></td></tr>
<tr><th id="2528">2528</th><td><i> * cannot migrate them.</i></td></tr>
<tr><th id="2529">2529</th><td><i> *</i></td></tr>
<tr><th id="2530">2530</th><td><i> * This is the last step before we call the device driver callback to allocate</i></td></tr>
<tr><th id="2531">2531</th><td><i> * destination memory and copy contents of original page over to new page.</i></td></tr>
<tr><th id="2532">2532</th><td><i> */</i></td></tr>
<tr><th id="2533">2533</th><td><em>static</em> <em>void</em> migrate_vma_unmap(<b>struct</b> migrate_vma *migrate)</td></tr>
<tr><th id="2534">2534</th><td>{</td></tr>
<tr><th id="2535">2535</th><td>	<em>int</em> flags = TTU_MIGRATION | TTU_IGNORE_MLOCK | TTU_IGNORE_ACCESS;</td></tr>
<tr><th id="2536">2536</th><td>	<em>const</em> <em>unsigned</em> <em>long</em> npages = migrate-&gt;npages;</td></tr>
<tr><th id="2537">2537</th><td>	<em>const</em> <em>unsigned</em> <em>long</em> start = migrate-&gt;start;</td></tr>
<tr><th id="2538">2538</th><td>	<em>unsigned</em> <em>long</em> addr, i, restore = <var>0</var>;</td></tr>
<tr><th id="2539">2539</th><td></td></tr>
<tr><th id="2540">2540</th><td>	<b>for</b> (i = <var>0</var>; i &lt; npages; i++) {</td></tr>
<tr><th id="2541">2541</th><td>		<b>struct</b> page *page = migrate_pfn_to_page(migrate-&gt;src[i]);</td></tr>
<tr><th id="2542">2542</th><td></td></tr>
<tr><th id="2543">2543</th><td>		<b>if</b> (!page || !(migrate-&gt;src[i] &amp; MIGRATE_PFN_MIGRATE))</td></tr>
<tr><th id="2544">2544</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2545">2545</th><td></td></tr>
<tr><th id="2546">2546</th><td>		<b>if</b> (page_mapped(page)) {</td></tr>
<tr><th id="2547">2547</th><td>			try_to_unmap(page, flags);</td></tr>
<tr><th id="2548">2548</th><td>			<b>if</b> (page_mapped(page))</td></tr>
<tr><th id="2549">2549</th><td>				<b>goto</b> restore;</td></tr>
<tr><th id="2550">2550</th><td>		}</td></tr>
<tr><th id="2551">2551</th><td></td></tr>
<tr><th id="2552">2552</th><td>		<b>if</b> (migrate_vma_check_page(page))</td></tr>
<tr><th id="2553">2553</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2554">2554</th><td></td></tr>
<tr><th id="2555">2555</th><td>restore:</td></tr>
<tr><th id="2556">2556</th><td>		migrate-&gt;src[i] &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2557">2557</th><td>		migrate-&gt;cpages--;</td></tr>
<tr><th id="2558">2558</th><td>		restore++;</td></tr>
<tr><th id="2559">2559</th><td>	}</td></tr>
<tr><th id="2560">2560</th><td></td></tr>
<tr><th id="2561">2561</th><td>	<b>for</b> (addr = start, i = <var>0</var>; i &lt; npages &amp;&amp; restore; addr += PAGE_SIZE, i++) {</td></tr>
<tr><th id="2562">2562</th><td>		<b>struct</b> page *page = migrate_pfn_to_page(migrate-&gt;src[i]);</td></tr>
<tr><th id="2563">2563</th><td></td></tr>
<tr><th id="2564">2564</th><td>		<b>if</b> (!page || (migrate-&gt;src[i] &amp; MIGRATE_PFN_MIGRATE))</td></tr>
<tr><th id="2565">2565</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2566">2566</th><td></td></tr>
<tr><th id="2567">2567</th><td>		remove_migration_ptes(page, page, false);</td></tr>
<tr><th id="2568">2568</th><td></td></tr>
<tr><th id="2569">2569</th><td>		migrate-&gt;src[i] = <var>0</var>;</td></tr>
<tr><th id="2570">2570</th><td>		unlock_page(page);</td></tr>
<tr><th id="2571">2571</th><td>		restore--;</td></tr>
<tr><th id="2572">2572</th><td></td></tr>
<tr><th id="2573">2573</th><td>		<b>if</b> (is_zone_device_page(page))</td></tr>
<tr><th id="2574">2574</th><td>			put_page(page);</td></tr>
<tr><th id="2575">2575</th><td>		<b>else</b></td></tr>
<tr><th id="2576">2576</th><td>			putback_lru_page(page);</td></tr>
<tr><th id="2577">2577</th><td>	}</td></tr>
<tr><th id="2578">2578</th><td>}</td></tr>
<tr><th id="2579">2579</th><td></td></tr>
<tr><th id="2580">2580</th><td><em>static</em> <em>void</em> migrate_vma_insert_page(<b>struct</b> migrate_vma *migrate,</td></tr>
<tr><th id="2581">2581</th><td>				    <em>unsigned</em> <em>long</em> addr,</td></tr>
<tr><th id="2582">2582</th><td>				    <b>struct</b> page *page,</td></tr>
<tr><th id="2583">2583</th><td>				    <em>unsigned</em> <em>long</em> *src,</td></tr>
<tr><th id="2584">2584</th><td>				    <em>unsigned</em> <em>long</em> *dst)</td></tr>
<tr><th id="2585">2585</th><td>{</td></tr>
<tr><th id="2586">2586</th><td>	<b>struct</b> vm_area_struct *vma = migrate-&gt;vma;</td></tr>
<tr><th id="2587">2587</th><td>	<b>struct</b> mm_struct *mm = vma-&gt;vm_mm;</td></tr>
<tr><th id="2588">2588</th><td>	<b>struct</b> mem_cgroup *memcg;</td></tr>
<tr><th id="2589">2589</th><td>	bool flush = false;</td></tr>
<tr><th id="2590">2590</th><td>	spinlock_t *ptl;</td></tr>
<tr><th id="2591">2591</th><td>	pte_t entry;</td></tr>
<tr><th id="2592">2592</th><td>	pgd_t *pgdp;</td></tr>
<tr><th id="2593">2593</th><td>	p4d_t *p4dp;</td></tr>
<tr><th id="2594">2594</th><td>	pud_t *pudp;</td></tr>
<tr><th id="2595">2595</th><td>	pmd_t *pmdp;</td></tr>
<tr><th id="2596">2596</th><td>	pte_t *ptep;</td></tr>
<tr><th id="2597">2597</th><td></td></tr>
<tr><th id="2598">2598</th><td>	<i>/* Only allow populating anonymous memory */</i></td></tr>
<tr><th id="2599">2599</th><td>	<b>if</b> (!vma_is_anonymous(vma))</td></tr>
<tr><th id="2600">2600</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2601">2601</th><td></td></tr>
<tr><th id="2602">2602</th><td>	pgdp = pgd_offset(mm, addr);</td></tr>
<tr><th id="2603">2603</th><td>	p4dp = p4d_alloc(mm, pgdp, addr);</td></tr>
<tr><th id="2604">2604</th><td>	<b>if</b> (!p4dp)</td></tr>
<tr><th id="2605">2605</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2606">2606</th><td>	pudp = pud_alloc(mm, p4dp, addr);</td></tr>
<tr><th id="2607">2607</th><td>	<b>if</b> (!pudp)</td></tr>
<tr><th id="2608">2608</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2609">2609</th><td>	pmdp = pmd_alloc(mm, pudp, addr);</td></tr>
<tr><th id="2610">2610</th><td>	<b>if</b> (!pmdp)</td></tr>
<tr><th id="2611">2611</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2612">2612</th><td></td></tr>
<tr><th id="2613">2613</th><td>	<b>if</b> (pmd_trans_huge(*pmdp) || pmd_devmap(*pmdp))</td></tr>
<tr><th id="2614">2614</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2615">2615</th><td></td></tr>
<tr><th id="2616">2616</th><td>	<i>/*</i></td></tr>
<tr><th id="2617">2617</th><td><i>	 * Use pte_alloc() instead of pte_alloc_map().  We can't run</i></td></tr>
<tr><th id="2618">2618</th><td><i>	 * pte_offset_map() on pmds where a huge pmd might be created</i></td></tr>
<tr><th id="2619">2619</th><td><i>	 * from a different thread.</i></td></tr>
<tr><th id="2620">2620</th><td><i>	 *</i></td></tr>
<tr><th id="2621">2621</th><td><i>	 * pte_alloc_map() is safe to use under down_write(mmap_sem) or when</i></td></tr>
<tr><th id="2622">2622</th><td><i>	 * parallel threads are excluded by other means.</i></td></tr>
<tr><th id="2623">2623</th><td><i>	 *</i></td></tr>
<tr><th id="2624">2624</th><td><i>	 * Here we only have down_read(mmap_sem).</i></td></tr>
<tr><th id="2625">2625</th><td><i>	 */</i></td></tr>
<tr><th id="2626">2626</th><td>	<b>if</b> (pte_alloc(mm, pmdp))</td></tr>
<tr><th id="2627">2627</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2628">2628</th><td></td></tr>
<tr><th id="2629">2629</th><td>	<i>/* See the comment in pte_alloc_one_map() */</i></td></tr>
<tr><th id="2630">2630</th><td>	<b>if</b> (unlikely(pmd_trans_unstable(pmdp)))</td></tr>
<tr><th id="2631">2631</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2632">2632</th><td></td></tr>
<tr><th id="2633">2633</th><td>	<b>if</b> (unlikely(anon_vma_prepare(vma)))</td></tr>
<tr><th id="2634">2634</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2635">2635</th><td>	<b>if</b> (mem_cgroup_try_charge(page, vma-&gt;vm_mm, GFP_KERNEL, &amp;memcg, false))</td></tr>
<tr><th id="2636">2636</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2637">2637</th><td></td></tr>
<tr><th id="2638">2638</th><td>	<i>/*</i></td></tr>
<tr><th id="2639">2639</th><td><i>	 * The memory barrier inside __SetPageUptodate makes sure that</i></td></tr>
<tr><th id="2640">2640</th><td><i>	 * preceding stores to the page contents become visible before</i></td></tr>
<tr><th id="2641">2641</th><td><i>	 * the set_pte_at() write.</i></td></tr>
<tr><th id="2642">2642</th><td><i>	 */</i></td></tr>
<tr><th id="2643">2643</th><td>	__SetPageUptodate(page);</td></tr>
<tr><th id="2644">2644</th><td></td></tr>
<tr><th id="2645">2645</th><td>	<b>if</b> (is_zone_device_page(page)) {</td></tr>
<tr><th id="2646">2646</th><td>		<b>if</b> (is_device_private_page(page)) {</td></tr>
<tr><th id="2647">2647</th><td>			swp_entry_t swp_entry;</td></tr>
<tr><th id="2648">2648</th><td></td></tr>
<tr><th id="2649">2649</th><td>			swp_entry = make_device_private_entry(page, vma-&gt;vm_flags &amp; VM_WRITE);</td></tr>
<tr><th id="2650">2650</th><td>			entry = swp_entry_to_pte(swp_entry);</td></tr>
<tr><th id="2651">2651</th><td>		}</td></tr>
<tr><th id="2652">2652</th><td>	} <b>else</b> {</td></tr>
<tr><th id="2653">2653</th><td>		entry = mk_pte(page, vma-&gt;vm_page_prot);</td></tr>
<tr><th id="2654">2654</th><td>		<b>if</b> (vma-&gt;vm_flags &amp; VM_WRITE)</td></tr>
<tr><th id="2655">2655</th><td>			entry = pte_mkwrite(pte_mkdirty(entry));</td></tr>
<tr><th id="2656">2656</th><td>	}</td></tr>
<tr><th id="2657">2657</th><td></td></tr>
<tr><th id="2658">2658</th><td>	ptep = pte_offset_map_lock(mm, pmdp, addr, &amp;ptl);</td></tr>
<tr><th id="2659">2659</th><td></td></tr>
<tr><th id="2660">2660</th><td>	<b>if</b> (pte_present(*ptep)) {</td></tr>
<tr><th id="2661">2661</th><td>		<em>unsigned</em> <em>long</em> pfn = pte_pfn(*ptep);</td></tr>
<tr><th id="2662">2662</th><td></td></tr>
<tr><th id="2663">2663</th><td>		<b>if</b> (!is_zero_pfn(pfn)) {</td></tr>
<tr><th id="2664">2664</th><td>			pte_unmap_unlock(ptep, ptl);</td></tr>
<tr><th id="2665">2665</th><td>			mem_cgroup_cancel_charge(page, memcg, false);</td></tr>
<tr><th id="2666">2666</th><td>			<b>goto</b> abort;</td></tr>
<tr><th id="2667">2667</th><td>		}</td></tr>
<tr><th id="2668">2668</th><td>		flush = true;</td></tr>
<tr><th id="2669">2669</th><td>	} <b>else</b> <b>if</b> (!pte_none(*ptep)) {</td></tr>
<tr><th id="2670">2670</th><td>		pte_unmap_unlock(ptep, ptl);</td></tr>
<tr><th id="2671">2671</th><td>		mem_cgroup_cancel_charge(page, memcg, false);</td></tr>
<tr><th id="2672">2672</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2673">2673</th><td>	}</td></tr>
<tr><th id="2674">2674</th><td></td></tr>
<tr><th id="2675">2675</th><td>	<i>/*</i></td></tr>
<tr><th id="2676">2676</th><td><i>	 * Check for usefaultfd but do not deliver the fault. Instead,</i></td></tr>
<tr><th id="2677">2677</th><td><i>	 * just back off.</i></td></tr>
<tr><th id="2678">2678</th><td><i>	 */</i></td></tr>
<tr><th id="2679">2679</th><td>	<b>if</b> (userfaultfd_missing(vma)) {</td></tr>
<tr><th id="2680">2680</th><td>		pte_unmap_unlock(ptep, ptl);</td></tr>
<tr><th id="2681">2681</th><td>		mem_cgroup_cancel_charge(page, memcg, false);</td></tr>
<tr><th id="2682">2682</th><td>		<b>goto</b> abort;</td></tr>
<tr><th id="2683">2683</th><td>	}</td></tr>
<tr><th id="2684">2684</th><td></td></tr>
<tr><th id="2685">2685</th><td>	inc_mm_counter(mm, MM_ANONPAGES);</td></tr>
<tr><th id="2686">2686</th><td>	page_add_new_anon_rmap(page, vma, addr, false);</td></tr>
<tr><th id="2687">2687</th><td>	mem_cgroup_commit_charge(page, memcg, false, false);</td></tr>
<tr><th id="2688">2688</th><td>	<b>if</b> (!is_zone_device_page(page))</td></tr>
<tr><th id="2689">2689</th><td>		lru_cache_add_active_or_unevictable(page, vma);</td></tr>
<tr><th id="2690">2690</th><td>	get_page(page);</td></tr>
<tr><th id="2691">2691</th><td></td></tr>
<tr><th id="2692">2692</th><td>	<b>if</b> (flush) {</td></tr>
<tr><th id="2693">2693</th><td>		flush_cache_page(vma, addr, pte_pfn(*ptep));</td></tr>
<tr><th id="2694">2694</th><td>		ptep_clear_flush_notify(vma, addr, ptep);</td></tr>
<tr><th id="2695">2695</th><td>		set_pte_at_notify(mm, addr, ptep, entry);</td></tr>
<tr><th id="2696">2696</th><td>		update_mmu_cache(vma, addr, ptep);</td></tr>
<tr><th id="2697">2697</th><td>	} <b>else</b> {</td></tr>
<tr><th id="2698">2698</th><td>		<i>/* No need to invalidate - it was non-present before */</i></td></tr>
<tr><th id="2699">2699</th><td>		set_pte_at(mm, addr, ptep, entry);</td></tr>
<tr><th id="2700">2700</th><td>		update_mmu_cache(vma, addr, ptep);</td></tr>
<tr><th id="2701">2701</th><td>	}</td></tr>
<tr><th id="2702">2702</th><td></td></tr>
<tr><th id="2703">2703</th><td>	pte_unmap_unlock(ptep, ptl);</td></tr>
<tr><th id="2704">2704</th><td>	*src = MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2705">2705</th><td>	<b>return</b>;</td></tr>
<tr><th id="2706">2706</th><td></td></tr>
<tr><th id="2707">2707</th><td>abort:</td></tr>
<tr><th id="2708">2708</th><td>	*src &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2709">2709</th><td>}</td></tr>
<tr><th id="2710">2710</th><td></td></tr>
<tr><th id="2711">2711</th><td><i>/*</i></td></tr>
<tr><th id="2712">2712</th><td><i> * migrate_vma_pages() - migrate meta-data from src page to dst page</i></td></tr>
<tr><th id="2713">2713</th><td><i> * @migrate: migrate struct containing all migration information</i></td></tr>
<tr><th id="2714">2714</th><td><i> *</i></td></tr>
<tr><th id="2715">2715</th><td><i> * This migrates struct page meta-data from source struct page to destination</i></td></tr>
<tr><th id="2716">2716</th><td><i> * struct page. This effectively finishes the migration from source page to the</i></td></tr>
<tr><th id="2717">2717</th><td><i> * destination page.</i></td></tr>
<tr><th id="2718">2718</th><td><i> */</i></td></tr>
<tr><th id="2719">2719</th><td><em>static</em> <em>void</em> migrate_vma_pages(<b>struct</b> migrate_vma *migrate)</td></tr>
<tr><th id="2720">2720</th><td>{</td></tr>
<tr><th id="2721">2721</th><td>	<em>const</em> <em>unsigned</em> <em>long</em> npages = migrate-&gt;npages;</td></tr>
<tr><th id="2722">2722</th><td>	<em>const</em> <em>unsigned</em> <em>long</em> start = migrate-&gt;start;</td></tr>
<tr><th id="2723">2723</th><td>	<b>struct</b> mmu_notifier_range range;</td></tr>
<tr><th id="2724">2724</th><td>	<em>unsigned</em> <em>long</em> addr, i;</td></tr>
<tr><th id="2725">2725</th><td>	bool notified = false;</td></tr>
<tr><th id="2726">2726</th><td></td></tr>
<tr><th id="2727">2727</th><td>	<b>for</b> (i = <var>0</var>, addr = start; i &lt; npages; addr += PAGE_SIZE, i++) {</td></tr>
<tr><th id="2728">2728</th><td>		<b>struct</b> page *newpage = migrate_pfn_to_page(migrate-&gt;dst[i]);</td></tr>
<tr><th id="2729">2729</th><td>		<b>struct</b> page *page = migrate_pfn_to_page(migrate-&gt;src[i]);</td></tr>
<tr><th id="2730">2730</th><td>		<b>struct</b> address_space *mapping;</td></tr>
<tr><th id="2731">2731</th><td>		<em>int</em> r;</td></tr>
<tr><th id="2732">2732</th><td></td></tr>
<tr><th id="2733">2733</th><td>		<b>if</b> (!newpage) {</td></tr>
<tr><th id="2734">2734</th><td>			migrate-&gt;src[i] &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2735">2735</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2736">2736</th><td>		}</td></tr>
<tr><th id="2737">2737</th><td></td></tr>
<tr><th id="2738">2738</th><td>		<b>if</b> (!page) {</td></tr>
<tr><th id="2739">2739</th><td>			<b>if</b> (!(migrate-&gt;src[i] &amp; MIGRATE_PFN_MIGRATE)) {</td></tr>
<tr><th id="2740">2740</th><td>				<b>continue</b>;</td></tr>
<tr><th id="2741">2741</th><td>			}</td></tr>
<tr><th id="2742">2742</th><td>			<b>if</b> (!notified) {</td></tr>
<tr><th id="2743">2743</th><td>				notified = true;</td></tr>
<tr><th id="2744">2744</th><td></td></tr>
<tr><th id="2745">2745</th><td>				mmu_notifier_range_init(&amp;range,</td></tr>
<tr><th id="2746">2746</th><td>							MMU_NOTIFY_CLEAR, <var>0</var>,</td></tr>
<tr><th id="2747">2747</th><td>							NULL,</td></tr>
<tr><th id="2748">2748</th><td>							migrate-&gt;vma-&gt;vm_mm,</td></tr>
<tr><th id="2749">2749</th><td>							addr, migrate-&gt;end);</td></tr>
<tr><th id="2750">2750</th><td>				mmu_notifier_invalidate_range_start(&amp;range);</td></tr>
<tr><th id="2751">2751</th><td>			}</td></tr>
<tr><th id="2752">2752</th><td>			migrate_vma_insert_page(migrate, addr, newpage,</td></tr>
<tr><th id="2753">2753</th><td>						&amp;migrate-&gt;src[i],</td></tr>
<tr><th id="2754">2754</th><td>						&amp;migrate-&gt;dst[i]);</td></tr>
<tr><th id="2755">2755</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2756">2756</th><td>		}</td></tr>
<tr><th id="2757">2757</th><td></td></tr>
<tr><th id="2758">2758</th><td>		mapping = page_mapping(page);</td></tr>
<tr><th id="2759">2759</th><td></td></tr>
<tr><th id="2760">2760</th><td>		<b>if</b> (is_zone_device_page(newpage)) {</td></tr>
<tr><th id="2761">2761</th><td>			<b>if</b> (is_device_private_page(newpage)) {</td></tr>
<tr><th id="2762">2762</th><td>				<i>/*</i></td></tr>
<tr><th id="2763">2763</th><td><i>				 * For now only support private anonymous when</i></td></tr>
<tr><th id="2764">2764</th><td><i>				 * migrating to un-addressable device memory.</i></td></tr>
<tr><th id="2765">2765</th><td><i>				 */</i></td></tr>
<tr><th id="2766">2766</th><td>				<b>if</b> (mapping) {</td></tr>
<tr><th id="2767">2767</th><td>					migrate-&gt;src[i] &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2768">2768</th><td>					<b>continue</b>;</td></tr>
<tr><th id="2769">2769</th><td>				}</td></tr>
<tr><th id="2770">2770</th><td>			} <b>else</b> {</td></tr>
<tr><th id="2771">2771</th><td>				<i>/*</i></td></tr>
<tr><th id="2772">2772</th><td><i>				 * Other types of ZONE_DEVICE page are not</i></td></tr>
<tr><th id="2773">2773</th><td><i>				 * supported.</i></td></tr>
<tr><th id="2774">2774</th><td><i>				 */</i></td></tr>
<tr><th id="2775">2775</th><td>				migrate-&gt;src[i] &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2776">2776</th><td>				<b>continue</b>;</td></tr>
<tr><th id="2777">2777</th><td>			}</td></tr>
<tr><th id="2778">2778</th><td>		}</td></tr>
<tr><th id="2779">2779</th><td></td></tr>
<tr><th id="2780">2780</th><td>		r = migrate_page(mapping, newpage, page, MIGRATE_SYNC_NO_COPY);</td></tr>
<tr><th id="2781">2781</th><td>		<b>if</b> (r != MIGRATEPAGE_SUCCESS)</td></tr>
<tr><th id="2782">2782</th><td>			migrate-&gt;src[i] &amp;= ~MIGRATE_PFN_MIGRATE;</td></tr>
<tr><th id="2783">2783</th><td>	}</td></tr>
<tr><th id="2784">2784</th><td></td></tr>
<tr><th id="2785">2785</th><td>	<i>/*</i></td></tr>
<tr><th id="2786">2786</th><td><i>	 * No need to double call mmu_notifier-&gt;invalidate_range() callback as</i></td></tr>
<tr><th id="2787">2787</th><td><i>	 * the above ptep_clear_flush_notify() inside migrate_vma_insert_page()</i></td></tr>
<tr><th id="2788">2788</th><td><i>	 * did already call it.</i></td></tr>
<tr><th id="2789">2789</th><td><i>	 */</i></td></tr>
<tr><th id="2790">2790</th><td>	<b>if</b> (notified)</td></tr>
<tr><th id="2791">2791</th><td>		mmu_notifier_invalidate_range_only_end(&amp;range);</td></tr>
<tr><th id="2792">2792</th><td>}</td></tr>
<tr><th id="2793">2793</th><td></td></tr>
<tr><th id="2794">2794</th><td><i>/*</i></td></tr>
<tr><th id="2795">2795</th><td><i> * migrate_vma_finalize() - restore CPU page table entry</i></td></tr>
<tr><th id="2796">2796</th><td><i> * @migrate: migrate struct containing all migration information</i></td></tr>
<tr><th id="2797">2797</th><td><i> *</i></td></tr>
<tr><th id="2798">2798</th><td><i> * This replaces the special migration pte entry with either a mapping to the</i></td></tr>
<tr><th id="2799">2799</th><td><i> * new page if migration was successful for that page, or to the original page</i></td></tr>
<tr><th id="2800">2800</th><td><i> * otherwise.</i></td></tr>
<tr><th id="2801">2801</th><td><i> *</i></td></tr>
<tr><th id="2802">2802</th><td><i> * This also unlocks the pages and puts them back on the lru, or drops the extra</i></td></tr>
<tr><th id="2803">2803</th><td><i> * refcount, for device pages.</i></td></tr>
<tr><th id="2804">2804</th><td><i> */</i></td></tr>
<tr><th id="2805">2805</th><td><em>static</em> <em>void</em> migrate_vma_finalize(<b>struct</b> migrate_vma *migrate)</td></tr>
<tr><th id="2806">2806</th><td>{</td></tr>
<tr><th id="2807">2807</th><td>	<em>const</em> <em>unsigned</em> <em>long</em> npages = migrate-&gt;npages;</td></tr>
<tr><th id="2808">2808</th><td>	<em>unsigned</em> <em>long</em> i;</td></tr>
<tr><th id="2809">2809</th><td></td></tr>
<tr><th id="2810">2810</th><td>	<b>for</b> (i = <var>0</var>; i &lt; npages; i++) {</td></tr>
<tr><th id="2811">2811</th><td>		<b>struct</b> page *newpage = migrate_pfn_to_page(migrate-&gt;dst[i]);</td></tr>
<tr><th id="2812">2812</th><td>		<b>struct</b> page *page = migrate_pfn_to_page(migrate-&gt;src[i]);</td></tr>
<tr><th id="2813">2813</th><td></td></tr>
<tr><th id="2814">2814</th><td>		<b>if</b> (!page) {</td></tr>
<tr><th id="2815">2815</th><td>			<b>if</b> (newpage) {</td></tr>
<tr><th id="2816">2816</th><td>				unlock_page(newpage);</td></tr>
<tr><th id="2817">2817</th><td>				put_page(newpage);</td></tr>
<tr><th id="2818">2818</th><td>			}</td></tr>
<tr><th id="2819">2819</th><td>			<b>continue</b>;</td></tr>
<tr><th id="2820">2820</th><td>		}</td></tr>
<tr><th id="2821">2821</th><td></td></tr>
<tr><th id="2822">2822</th><td>		<b>if</b> (!(migrate-&gt;src[i] &amp; MIGRATE_PFN_MIGRATE) || !newpage) {</td></tr>
<tr><th id="2823">2823</th><td>			<b>if</b> (newpage) {</td></tr>
<tr><th id="2824">2824</th><td>				unlock_page(newpage);</td></tr>
<tr><th id="2825">2825</th><td>				put_page(newpage);</td></tr>
<tr><th id="2826">2826</th><td>			}</td></tr>
<tr><th id="2827">2827</th><td>			newpage = page;</td></tr>
<tr><th id="2828">2828</th><td>		}</td></tr>
<tr><th id="2829">2829</th><td></td></tr>
<tr><th id="2830">2830</th><td>		remove_migration_ptes(page, newpage, false);</td></tr>
<tr><th id="2831">2831</th><td>		unlock_page(page);</td></tr>
<tr><th id="2832">2832</th><td>		migrate-&gt;cpages--;</td></tr>
<tr><th id="2833">2833</th><td></td></tr>
<tr><th id="2834">2834</th><td>		<b>if</b> (is_zone_device_page(page))</td></tr>
<tr><th id="2835">2835</th><td>			put_page(page);</td></tr>
<tr><th id="2836">2836</th><td>		<b>else</b></td></tr>
<tr><th id="2837">2837</th><td>			putback_lru_page(page);</td></tr>
<tr><th id="2838">2838</th><td></td></tr>
<tr><th id="2839">2839</th><td>		<b>if</b> (newpage != page) {</td></tr>
<tr><th id="2840">2840</th><td>			unlock_page(newpage);</td></tr>
<tr><th id="2841">2841</th><td>			<b>if</b> (is_zone_device_page(newpage))</td></tr>
<tr><th id="2842">2842</th><td>				put_page(newpage);</td></tr>
<tr><th id="2843">2843</th><td>			<b>else</b></td></tr>
<tr><th id="2844">2844</th><td>				putback_lru_page(newpage);</td></tr>
<tr><th id="2845">2845</th><td>		}</td></tr>
<tr><th id="2846">2846</th><td>	}</td></tr>
<tr><th id="2847">2847</th><td>}</td></tr>
<tr><th id="2848">2848</th><td></td></tr>
<tr><th id="2849">2849</th><td><i>/*</i></td></tr>
<tr><th id="2850">2850</th><td><i> * migrate_vma() - migrate a range of memory inside vma</i></td></tr>
<tr><th id="2851">2851</th><td><i> *</i></td></tr>
<tr><th id="2852">2852</th><td><i> * @ops: migration callback for allocating destination memory and copying</i></td></tr>
<tr><th id="2853">2853</th><td><i> * @vma: virtual memory area containing the range to be migrated</i></td></tr>
<tr><th id="2854">2854</th><td><i> * @start: start address of the range to migrate (inclusive)</i></td></tr>
<tr><th id="2855">2855</th><td><i> * @end: end address of the range to migrate (exclusive)</i></td></tr>
<tr><th id="2856">2856</th><td><i> * @src: array of hmm_pfn_t containing source pfns</i></td></tr>
<tr><th id="2857">2857</th><td><i> * @dst: array of hmm_pfn_t containing destination pfns</i></td></tr>
<tr><th id="2858">2858</th><td><i> * @private: pointer passed back to each of the callback</i></td></tr>
<tr><th id="2859">2859</th><td><i> * Returns: 0 on success, error code otherwise</i></td></tr>
<tr><th id="2860">2860</th><td><i> *</i></td></tr>
<tr><th id="2861">2861</th><td><i> * This function tries to migrate a range of memory virtual address range, using</i></td></tr>
<tr><th id="2862">2862</th><td><i> * callbacks to allocate and copy memory from source to destination. First it</i></td></tr>
<tr><th id="2863">2863</th><td><i> * collects all the pages backing each virtual address in the range, saving this</i></td></tr>
<tr><th id="2864">2864</th><td><i> * inside the src array. Then it locks those pages and unmaps them. Once the pages</i></td></tr>
<tr><th id="2865">2865</th><td><i> * are locked and unmapped, it checks whether each page is pinned or not. Pages</i></td></tr>
<tr><th id="2866">2866</th><td><i> * that aren't pinned have the MIGRATE_PFN_MIGRATE flag set (by this function)</i></td></tr>
<tr><th id="2867">2867</th><td><i> * in the corresponding src array entry. It then restores any pages that are</i></td></tr>
<tr><th id="2868">2868</th><td><i> * pinned, by remapping and unlocking those pages.</i></td></tr>
<tr><th id="2869">2869</th><td><i> *</i></td></tr>
<tr><th id="2870">2870</th><td><i> * At this point it calls the alloc_and_copy() callback. For documentation on</i></td></tr>
<tr><th id="2871">2871</th><td><i> * what is expected from that callback, see struct migrate_vma_ops comments in</i></td></tr>
<tr><th id="2872">2872</th><td><i> * include/linux/migrate.h</i></td></tr>
<tr><th id="2873">2873</th><td><i> *</i></td></tr>
<tr><th id="2874">2874</th><td><i> * After the alloc_and_copy() callback, this function goes over each entry in</i></td></tr>
<tr><th id="2875">2875</th><td><i> * the src array that has the MIGRATE_PFN_VALID and MIGRATE_PFN_MIGRATE flag</i></td></tr>
<tr><th id="2876">2876</th><td><i> * set. If the corresponding entry in dst array has MIGRATE_PFN_VALID flag set,</i></td></tr>
<tr><th id="2877">2877</th><td><i> * then the function tries to migrate struct page information from the source</i></td></tr>
<tr><th id="2878">2878</th><td><i> * struct page to the destination struct page. If it fails to migrate the struct</i></td></tr>
<tr><th id="2879">2879</th><td><i> * page information, then it clears the MIGRATE_PFN_MIGRATE flag in the src</i></td></tr>
<tr><th id="2880">2880</th><td><i> * array.</i></td></tr>
<tr><th id="2881">2881</th><td><i> *</i></td></tr>
<tr><th id="2882">2882</th><td><i> * At this point all successfully migrated pages have an entry in the src</i></td></tr>
<tr><th id="2883">2883</th><td><i> * array with MIGRATE_PFN_VALID and MIGRATE_PFN_MIGRATE flag set and the dst</i></td></tr>
<tr><th id="2884">2884</th><td><i> * array entry with MIGRATE_PFN_VALID flag set.</i></td></tr>
<tr><th id="2885">2885</th><td><i> *</i></td></tr>
<tr><th id="2886">2886</th><td><i> * It then calls the finalize_and_map() callback. See comments for "struct</i></td></tr>
<tr><th id="2887">2887</th><td><i> * migrate_vma_ops", in include/linux/migrate.h for details about</i></td></tr>
<tr><th id="2888">2888</th><td><i> * finalize_and_map() behavior.</i></td></tr>
<tr><th id="2889">2889</th><td><i> *</i></td></tr>
<tr><th id="2890">2890</th><td><i> * After the finalize_and_map() callback, for successfully migrated pages, this</i></td></tr>
<tr><th id="2891">2891</th><td><i> * function updates the CPU page table to point to new pages, otherwise it</i></td></tr>
<tr><th id="2892">2892</th><td><i> * restores the CPU page table to point to the original source pages.</i></td></tr>
<tr><th id="2893">2893</th><td><i> *</i></td></tr>
<tr><th id="2894">2894</th><td><i> * Function returns 0 after the above steps, even if no pages were migrated</i></td></tr>
<tr><th id="2895">2895</th><td><i> * (The function only returns an error if any of the arguments are invalid.)</i></td></tr>
<tr><th id="2896">2896</th><td><i> *</i></td></tr>
<tr><th id="2897">2897</th><td><i> * Both src and dst array must be big enough for (end - start) &gt;&gt; PAGE_SHIFT</i></td></tr>
<tr><th id="2898">2898</th><td><i> * unsigned long entries.</i></td></tr>
<tr><th id="2899">2899</th><td><i> */</i></td></tr>
<tr><th id="2900">2900</th><td><em>int</em> migrate_vma(<em>const</em> <b>struct</b> migrate_vma_ops *ops,</td></tr>
<tr><th id="2901">2901</th><td>		<b>struct</b> vm_area_struct *vma,</td></tr>
<tr><th id="2902">2902</th><td>		<em>unsigned</em> <em>long</em> start,</td></tr>
<tr><th id="2903">2903</th><td>		<em>unsigned</em> <em>long</em> end,</td></tr>
<tr><th id="2904">2904</th><td>		<em>unsigned</em> <em>long</em> *src,</td></tr>
<tr><th id="2905">2905</th><td>		<em>unsigned</em> <em>long</em> *dst,</td></tr>
<tr><th id="2906">2906</th><td>		<em>void</em> *private)</td></tr>
<tr><th id="2907">2907</th><td>{</td></tr>
<tr><th id="2908">2908</th><td>	<b>struct</b> migrate_vma migrate;</td></tr>
<tr><th id="2909">2909</th><td></td></tr>
<tr><th id="2910">2910</th><td>	<i>/* Sanity check the arguments */</i></td></tr>
<tr><th id="2911">2911</th><td>	start &amp;= PAGE_MASK;</td></tr>
<tr><th id="2912">2912</th><td>	end &amp;= PAGE_MASK;</td></tr>
<tr><th id="2913">2913</th><td>	<b>if</b> (!vma || is_vm_hugetlb_page(vma) || (vma-&gt;vm_flags &amp; VM_SPECIAL) ||</td></tr>
<tr><th id="2914">2914</th><td>			vma_is_dax(vma))</td></tr>
<tr><th id="2915">2915</th><td>		<b>return</b> -EINVAL;</td></tr>
<tr><th id="2916">2916</th><td>	<b>if</b> (start &lt; vma-&gt;vm_start || start &gt;= vma-&gt;vm_end)</td></tr>
<tr><th id="2917">2917</th><td>		<b>return</b> -EINVAL;</td></tr>
<tr><th id="2918">2918</th><td>	<b>if</b> (end &lt;= vma-&gt;vm_start || end &gt; vma-&gt;vm_end)</td></tr>
<tr><th id="2919">2919</th><td>		<b>return</b> -EINVAL;</td></tr>
<tr><th id="2920">2920</th><td>	<b>if</b> (!ops || !src || !dst || start &gt;= end)</td></tr>
<tr><th id="2921">2921</th><td>		<b>return</b> -EINVAL;</td></tr>
<tr><th id="2922">2922</th><td></td></tr>
<tr><th id="2923">2923</th><td>	memset(src, <var>0</var>, <b>sizeof</b>(*src) * ((end - start) &gt;&gt; PAGE_SHIFT));</td></tr>
<tr><th id="2924">2924</th><td>	migrate.src = src;</td></tr>
<tr><th id="2925">2925</th><td>	migrate.dst = dst;</td></tr>
<tr><th id="2926">2926</th><td>	migrate.start = start;</td></tr>
<tr><th id="2927">2927</th><td>	migrate.npages = <var>0</var>;</td></tr>
<tr><th id="2928">2928</th><td>	migrate.cpages = <var>0</var>;</td></tr>
<tr><th id="2929">2929</th><td>	migrate.end = end;</td></tr>
<tr><th id="2930">2930</th><td>	migrate.vma = vma;</td></tr>
<tr><th id="2931">2931</th><td></td></tr>
<tr><th id="2932">2932</th><td>	<i>/* Collect, and try to unmap source pages */</i></td></tr>
<tr><th id="2933">2933</th><td>	migrate_vma_collect(&amp;migrate);</td></tr>
<tr><th id="2934">2934</th><td>	<b>if</b> (!migrate.cpages)</td></tr>
<tr><th id="2935">2935</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2936">2936</th><td></td></tr>
<tr><th id="2937">2937</th><td>	<i>/* Lock and isolate page */</i></td></tr>
<tr><th id="2938">2938</th><td>	migrate_vma_prepare(&amp;migrate);</td></tr>
<tr><th id="2939">2939</th><td>	<b>if</b> (!migrate.cpages)</td></tr>
<tr><th id="2940">2940</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2941">2941</th><td></td></tr>
<tr><th id="2942">2942</th><td>	<i>/* Unmap pages */</i></td></tr>
<tr><th id="2943">2943</th><td>	migrate_vma_unmap(&amp;migrate);</td></tr>
<tr><th id="2944">2944</th><td>	<b>if</b> (!migrate.cpages)</td></tr>
<tr><th id="2945">2945</th><td>		<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2946">2946</th><td></td></tr>
<tr><th id="2947">2947</th><td>	<i>/*</i></td></tr>
<tr><th id="2948">2948</th><td><i>	 * At this point pages are locked and unmapped, and thus they have</i></td></tr>
<tr><th id="2949">2949</th><td><i>	 * stable content and can safely be copied to destination memory that</i></td></tr>
<tr><th id="2950">2950</th><td><i>	 * is allocated by the callback.</i></td></tr>
<tr><th id="2951">2951</th><td><i>	 *</i></td></tr>
<tr><th id="2952">2952</th><td><i>	 * Note that migration can fail in migrate_vma_struct_page() for each</i></td></tr>
<tr><th id="2953">2953</th><td><i>	 * individual page.</i></td></tr>
<tr><th id="2954">2954</th><td><i>	 */</i></td></tr>
<tr><th id="2955">2955</th><td>	ops-&gt;alloc_and_copy(vma, src, dst, start, end, private);</td></tr>
<tr><th id="2956">2956</th><td></td></tr>
<tr><th id="2957">2957</th><td>	<i>/* This does the real migration of struct page */</i></td></tr>
<tr><th id="2958">2958</th><td>	migrate_vma_pages(&amp;migrate);</td></tr>
<tr><th id="2959">2959</th><td></td></tr>
<tr><th id="2960">2960</th><td>	ops-&gt;finalize_and_map(vma, src, dst, start, end, private);</td></tr>
<tr><th id="2961">2961</th><td></td></tr>
<tr><th id="2962">2962</th><td>	<i>/* Unlock and remap pages */</i></td></tr>
<tr><th id="2963">2963</th><td>	migrate_vma_finalize(&amp;migrate);</td></tr>
<tr><th id="2964">2964</th><td></td></tr>
<tr><th id="2965">2965</th><td>	<b>return</b> <var>0</var>;</td></tr>
<tr><th id="2966">2966</th><td>}</td></tr>
<tr><th id="2967">2967</th><td>EXPORT_SYMBOL(migrate_vma);</td></tr>
<tr><th id="2968">2968</th><td><u>#<span data-ppcond="2122">endif</span> /* defined(MIGRATE_VMA_HELPER) */</u></td></tr>
<tr><th id="2969">2969</th><td></td></tr>
</table><hr/><p id='footer'>
Generated on <em>2020-Jun-10</em> from project linux-5.3.1 revision <em>5.3.1</em><br />Powered by <a href='https://woboq.com'><img alt='Woboq' src='https://code.woboq.org/woboq-16.png' width='41' height='16' /></a> <a href='https://code.woboq.org'>Code Browser</a> 2.1
<br/>Generator usage only permitted with license.</p>
</div></body></html>
